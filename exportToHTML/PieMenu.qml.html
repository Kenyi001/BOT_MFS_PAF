<html>
<head>
<title>PieMenu.qml</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #2aacb8;}
.s4 { color: #bcbec4;}
.s5 { color: #7a7e85;}
.s6 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
PieMenu.qml</font>
</center></td></tr></table>
<pre><span class="s0">/****************************************************************************</span>
<span class="s0">**</span>
<span class="s0">** Copyright (C) 2016 The Qt Company Ltd.</span>
<span class="s0">** Contact: https://www.qt.io/licensing/</span>
<span class="s0">**</span>
<span class="s0">** This file is part of the Qt Quick Extras module of the Qt Toolkit.</span>
<span class="s0">**</span>
<span class="s0">** $QT_BEGIN_LICENSE:LGPL$</span>
<span class="s0">** Commercial License Usage</span>
<span class="s0">** Licensees holding valid commercial Qt licenses may use this file in</span>
<span class="s0">** accordance with the commercial license agreement provided with the</span>
<span class="s0">** Software or, alternatively, in accordance with the terms contained in</span>
<span class="s0">** a written agreement between you and The Qt Company. For licensing terms</span>
<span class="s0">** and conditions see https://www.qt.io/terms-conditions. For further</span>
<span class="s0">** information use the contact form at https://www.qt.io/contact-us.</span>
<span class="s0">**</span>
<span class="s0">** GNU Lesser General Public License Usage</span>
<span class="s0">** Alternatively, this file may be used under the terms of the GNU Lesser</span>
<span class="s0">** General Public License version 3 as published by the Free Software</span>
<span class="s0">** Foundation and appearing in the file LICENSE.LGPL3 included in the</span>
<span class="s0">** packaging of this file. Please review the following information to</span>
<span class="s0">** ensure the GNU Lesser General Public License version 3 requirements</span>
<span class="s0">** will be met: https://www.gnu.org/licenses/lgpl-3.0.html.</span>
<span class="s0">**</span>
<span class="s0">** GNU General Public License Usage</span>
<span class="s0">** Alternatively, this file may be used under the terms of the GNU</span>
<span class="s0">** General Public License version 2.0 or (at your option) the GNU General</span>
<span class="s0">** Public license version 3 or any later version approved by the KDE Free</span>
<span class="s0">** Qt Foundation. The licenses are as published by the Free Software</span>
<span class="s0">** Foundation and appearing in the file LICENSE.GPL2 and LICENSE.GPL3</span>
<span class="s0">** included in the packaging of this file. Please review the following</span>
<span class="s0">** information to ensure the GNU General Public License requirements will</span>
<span class="s0">** be met: https://www.gnu.org/licenses/gpl-2.0.html and</span>
<span class="s0">** https://www.gnu.org/licenses/gpl-3.0.html.</span>
<span class="s0">**</span>
<span class="s0">** $QT_END_LICENSE$</span>
<span class="s0">**</span>
<span class="s0">****************************************************************************/</span>

<span class="s2">import </span><span class="s1">QtQuick </span><span class="s3">2.2</span>
<span class="s2">import </span><span class="s1">QtQuick</span><span class="s4">.</span><span class="s1">Controls </span><span class="s3">1.4</span>
<span class="s2">import </span><span class="s1">QtQuick</span><span class="s4">.</span><span class="s1">Controls</span><span class="s4">.</span><span class="s1">Styles </span><span class="s3">1.4</span>
<span class="s2">import </span><span class="s1">QtQuick</span><span class="s4">.</span><span class="s1">Controls</span><span class="s4">.</span><span class="s1">Private </span><span class="s3">1.0</span>
<span class="s2">import </span><span class="s1">QtQuick</span><span class="s4">.</span><span class="s1">Extras </span><span class="s3">1.4</span>
<span class="s2">import </span><span class="s1">QtQuick</span><span class="s4">.</span><span class="s1">Extras</span><span class="s4">.</span><span class="s1">Private </span><span class="s3">1.0</span>
<span class="s2">import </span><span class="s1">QtQuick</span><span class="s4">.</span><span class="s1">Extras</span><span class="s4">.</span><span class="s1">Private</span><span class="s4">.</span><span class="s1">CppUtils </span><span class="s3">1.0 </span><span class="s4">as </span><span class="s1">CppUtils</span>

<span class="s5">/*! 
    \qmltype PieMenu 
    \inqmlmodule QtQuick.Extras 
    \since 5.5 
    \ingroup extras 
    \ingroup extras-interactive 
    \brief A popup menu that displays several menu items along an arc. 
 
    \image piemenu.png A PieMenu 
 
    The PieMenu provides a radial context menu as an alternative to a 
    traditional menu. All of the items in a PieMenu are an equal distance 
    from the center of the control. 
 
    \section2 Populating the Menu 
 
    To create a menu, define at least one MenuItem as a child of it: 
    \code 
    PieMenu { 
        id: pieMenu 
 
        MenuItem { 
            text: &quot;Action 1&quot; 
            onTriggered: print(&quot;Action 1&quot;) 
        } 
        MenuItem { 
            text: &quot;Action 2&quot; 
            onTriggered: print(&quot;Action 2&quot;) 
        } 
        MenuItem { 
            text: &quot;Action 3&quot; 
            onTriggered: print(&quot;Action 3&quot;) 
        } 
    } 
    \endcode 
 
    By default, only the currently selected item's text is displayed above the 
    menu. To provide text that is always visible when there is no current item, 
    set the \l title property. 
 
    \section2 Displaying the Menu 
 
    The typical use case for a menu is to open at the point of the mouse 
    cursor after a right click occurs. To do that, define a MouseArea that 
    covers the region upon which clicks should open the menu. When the 
    MouseArea is right-clicked, call the popup() function: 
    \code 
    MouseArea { 
        anchors.fill: parent 
        acceptedButtons: Qt.RightButton 
 
        onClicked: pieMenu.popup(mouseX, mouseY) 
    } 
    \endcode 
 
    If the menu is opened in a position where some of its menu items would be 
    outside of \l boundingItem, it is automatically moved to a position where 
    they will not be hidden. By default, the boundingItem is set to the parent 
    of the menu. It can also be set to \c null to prevent this behavior. 
 
    PieMenu can be displayed at any position on the screen. With a traditional 
    context menu, the menu would be positioned with its top left corner at the 
    position of the right click, but since PieMenu is radial, we position it 
    centered over the position of the right click. 
 
    To create a PieMenu that opens after a long press and selects items upon 
    releasing, you can combine ActivationMode.ActivateOnRelease with a 
    MouseArea using a Timer: 
    \code 
    MouseArea { 
        id: touchArea 
        anchors.fill: parent 
 
        Timer { 
            id: pressAndHoldTimer 
            interval: 300 
            onTriggered: pieMenu.popup(touchArea.mouseX, touchArea.mouseY); 
        } 
 
        onPressed: pressAndHoldTimer.start() 
        onReleased: pressAndHoldTimer.stop(); 
    } 
 
    PieMenu { 
        id: pieMenu 
 
        triggerMode: TriggerMode.TriggerOnRelease 
 
        MenuItem { 
            text: &quot;Action 1&quot; 
            onTriggered: print(&quot;Action 1&quot;) 
        } 
        MenuItem { 
            text: &quot;Action 2&quot; 
            onTriggered: print(&quot;Action 2&quot;) 
        } 
        MenuItem { 
            text: &quot;Action 3&quot; 
            onTriggered: print(&quot;Action 3&quot;) 
        } 
    } 
    \endcode 
 
    You can hide individual menu items by setting their visible property to 
    \c false. Hiding items does not affect the 
    \l {PieMenuStyle::}{startAngle} or 
    \l {PieMenuStyle::}{endAngle}; the 
    remaining items will grow to consume the available space. 
 
    You can create a custom appearance for a PieMenu by assigning a \l {PieMenuStyle} 
*/</span>

<span class="s1">Control </span><span class="s4">{</span>
    <span class="s1">id</span><span class="s4">: </span><span class="s1">pieMenu</span>
    <span class="s1">visible</span><span class="s4">: </span><span class="s2">false</span>

    <span class="s1">style</span><span class="s4">: </span><span class="s1">Settings</span><span class="s4">.</span><span class="s1">styleComponent</span><span class="s4">(</span><span class="s1">Settings</span><span class="s4">.</span><span class="s1">style</span><span class="s4">, </span><span class="s6">&quot;PieMenuStyle.qml&quot;</span><span class="s4">, </span><span class="s1">pieMenu</span><span class="s4">)</span>

    <span class="s5">/*! 
        This property reflects the angle (in radians) created by the imaginary 
        line from the center of the menu to the position of the cursor. 
 
        Its value is undefined when the menu is not visible. 
    */</span>
    <span class="s1">readonly property real selectionAngle</span><span class="s4">: {</span>
        <span class="s2">var </span><span class="s1">centerX </span><span class="s4">= </span><span class="s1">width </span><span class="s4">/ </span><span class="s3">2</span><span class="s4">;</span>
        <span class="s2">var </span><span class="s1">centerY </span><span class="s4">= </span><span class="s1">height </span><span class="s4">/ </span><span class="s3">2</span><span class="s4">;</span>
        <span class="s2">var </span><span class="s1">targetX </span><span class="s4">= </span><span class="s1">__protectedScope</span><span class="s4">.</span><span class="s1">selectionPos</span><span class="s4">.</span><span class="s1">x</span><span class="s4">;</span>
        <span class="s2">var </span><span class="s1">targetY </span><span class="s4">= </span><span class="s1">__protectedScope</span><span class="s4">.</span><span class="s1">selectionPos</span><span class="s4">.</span><span class="s1">y</span><span class="s4">;</span>

        <span class="s2">var </span><span class="s1">xDistance </span><span class="s4">= </span><span class="s1">centerX </span><span class="s4">- </span><span class="s1">targetX</span><span class="s4">;</span>
        <span class="s2">var </span><span class="s1">yDistance </span><span class="s4">= </span><span class="s1">centerY </span><span class="s4">- </span><span class="s1">targetY</span><span class="s4">;</span>

        <span class="s2">var </span><span class="s1">angleToTarget </span><span class="s4">= </span><span class="s1">Math</span><span class="s4">.</span><span class="s1">atan2</span><span class="s4">(</span><span class="s1">xDistance</span><span class="s4">, </span><span class="s1">yDistance</span><span class="s4">) * -</span><span class="s3">1</span><span class="s4">;</span>
        <span class="s1">angleToTarget</span><span class="s4">;</span>
    <span class="s4">}</span>

    <span class="s5">/*! 
        \qmlproperty enumeration PieMenu::activationMode 
 
        This property determines the method for selecting items in the menu. 
 
        \list 
        \li An activationMode of \a ActivationMode.ActivateOnPress means that menu 
        items will only be selected when a mouse press event occurs over them. 
 
        \li An activationMode of \a ActivationMode.ActivateOnRelease means that menu 
        items will only be selected when a mouse release event occurs over them. 
        This means that the user must keep the mouse button down after opening 
        the menu and release the mouse over the item they wish to select. 
 
        \li An activationMode of \a ActivationMode.ActivateOnClick means that menu 
        items will only be selected when the user clicks once over them. 
        \endlist 
 
        \warning Changing the activationMode while the menu is visible will 
        result in undefined behavior. 
 
        \deprecated Use triggerMode instead. 
    */</span>
    <span class="s1">property alias activationMode</span><span class="s4">: </span><span class="s1">pieMenu</span><span class="s4">.</span><span class="s1">triggerMode</span>

    <span class="s5">/*! 
        \qmlproperty enumeration PieMenu::triggerMode 
 
        This property determines the method for selecting items in the menu. 
 
        \list 
        \li A triggerMode of \a TriggerMode.TriggerOnPress means that menu 
        items will only be selected when a mouse press event occurs over them. 
 
        \li A triggerMode of \a TriggerMode.TriggerOnRelease means that menu 
        items will only be selected when a mouse release event occurs over them. 
        This means that the user must keep the mouse button down after opening 
        the menu and release the mouse over the item they wish to select. 
 
        \li A triggerMode of \a TriggerMode.TriggerOnClick means that menu 
        items will only be selected when the user clicks once over them. 
        \endlist 
 
        \warning Changing the triggerMode while the menu is visible will 
        result in undefined behavior. 
    */</span>
    <span class="s1">property int triggerMode</span><span class="s4">: </span><span class="s1">TriggerMode</span><span class="s4">.</span><span class="s1">TriggerOnClick</span>

    <span class="s5">/*! 
        \qmlproperty list&lt;MenuItem&gt; menuItems 
 
        The list of menu items displayed by this menu. 
 
        You can assign menu items by declaring them as children of PieMenu: 
        \code 
        PieMenu { 
            MenuItem { 
                text: &quot;Action 1&quot; 
                onTriggered: function() { print(&quot;Action 1&quot;); } 
            } 
            MenuItem { 
                text: &quot;Action 2&quot; 
                onTriggered: function() { print(&quot;Action 2&quot;); } 
            } 
            MenuItem { 
                text: &quot;Action 3&quot; 
                onTriggered: function() { print(&quot;Action 3&quot;); } 
            } 
        } 
        \endcode 
    */</span>
    <span class="s2">default </span><span class="s1">property alias menuItems</span><span class="s4">: </span><span class="s1">defaultPropertyHack</span><span class="s4">.</span><span class="s1">menuItems</span>

    <span class="s1">QtObject </span><span class="s4">{</span>
        <span class="s5">// Can't specify a list as a default property (QTBUG-10822)</span>
        <span class="s1">id</span><span class="s4">: </span><span class="s1">defaultPropertyHack</span>
        <span class="s1">property list</span><span class="s4">&lt;</span><span class="s1">MenuItem</span><span class="s4">&gt; </span><span class="s1">menuItems</span>
    <span class="s4">}</span>

    <span class="s5">/*! 
        \qmlproperty int PieMenu::currentIndex 
 
        The index of the the menu item that is currently under the mouse, 
        or \c -1 if there is no such item. 
    */</span>
    <span class="s1">readonly property alias currentIndex</span><span class="s4">: </span><span class="s1">protectedScope</span><span class="s4">.</span><span class="s1">currentIndex</span>

    <span class="s5">/*! 
        \qmlproperty int PieMenu::currentItem 
 
        The menu item that is currently under the mouse, or \c null if there is 
        no such item. 
    */</span>
    <span class="s1">readonly property alias currentItem</span><span class="s4">: </span><span class="s1">protectedScope</span><span class="s4">.</span><span class="s1">currentItem</span>

    <span class="s5">/*! 
        This property defines the text that is shown above the menu when 
        there is no current menu item (currentIndex is \c -1). 
 
        The default value is \c &quot;&quot; (an empty string). 
    */</span>
    <span class="s1">property string title</span><span class="s4">: </span><span class="s6">&quot;&quot;</span>

    <span class="s5">/*! 
        The item which the menu must stay within. 
 
        A typical use case for PieMenu involves: 
 
        \list 
            \li A MouseArea that determines the clickable area within which the 
                menu can be opened. 
            \li The bounds that the menu must not go outside of. 
        \endlist 
 
        Although they sound similar, they have different purposes. Consider the 
        example below: 
 
        \image piemenu-boundingItem-example.png Canvas boundingItem example 
 
        The user can only open the menu within the inner rectangle. In this 
        case, they've opened the menu on the edge of the MouseArea, but there 
        would not be enough room to display the entire menu centered at the 
        cursor position, so it was moved to the left. 
 
        If for some reason we didn't want this restriction, we can set 
        boundingItem to \c null: 
 
        \image piemenu-boundingItem-null-example.png Canvas null boundingItem example 
 
        By default, the menu's \l {Item::}{parent} is the boundingItem. 
    */</span>
    <span class="s1">property Item boundingItem</span><span class="s4">: </span><span class="s1">parent</span>

    <span class="s5">/*! 
        \qmlmethod void popup(real x, real y) 
 
        Opens the menu at coordinates \a x, \a y. 
     */</span>
    <span class="s2">function </span><span class="s1">popup</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">) {</span>
        <span class="s2">if </span><span class="s4">(</span><span class="s1">x </span><span class="s4">!== </span><span class="s1">undefined</span><span class="s4">)</span>
            <span class="s1">pieMenu</span><span class="s4">.</span><span class="s1">x </span><span class="s4">= </span><span class="s1">x </span><span class="s4">- </span><span class="s1">pieMenu</span><span class="s4">.</span><span class="s1">width </span><span class="s4">/ </span><span class="s3">2</span><span class="s4">;</span>
        <span class="s2">if </span><span class="s4">(</span><span class="s1">y </span><span class="s4">!== </span><span class="s1">undefined</span><span class="s4">)</span>
            <span class="s1">pieMenu</span><span class="s4">.</span><span class="s1">y </span><span class="s4">= </span><span class="s1">y </span><span class="s4">- </span><span class="s1">pieMenu</span><span class="s4">.</span><span class="s1">height </span><span class="s4">/ </span><span class="s3">2</span><span class="s4">;</span>

        <span class="s1">pieMenu</span><span class="s4">.</span><span class="s1">visible </span><span class="s4">= </span><span class="s2">true</span><span class="s4">;</span>
    <span class="s4">}</span>

    <span class="s5">/*! 
        \qmlmethod void addItem(string text) 
 
        Adds a \a text item to the end of the menu items. 
 
        Equivalent to passing calling \c insertItem(menuItems.length, text). 
 
        Returns the newly added item. 
    */</span>
    <span class="s2">function </span><span class="s1">addItem</span><span class="s4">(</span><span class="s1">text</span><span class="s4">) {</span>
        <span class="s2">return </span><span class="s1">insertItem</span><span class="s4">(</span><span class="s1">menuItems</span><span class="s4">.</span><span class="s1">length</span><span class="s4">, </span><span class="s1">text</span><span class="s4">);</span>
    <span class="s4">}</span>

    <span class="s5">/*! 
        \qmlmethod void insertItem(int before, string text) 
 
        Inserts a MenuItem with \a text before the index at \a before. 
 
        To insert an item at the end, pass \c menuItems.length. 
 
        Returns the newly inserted item, or \c null if \a before is invalid. 
    */</span>
    <span class="s2">function </span><span class="s1">insertItem</span><span class="s4">(</span><span class="s1">before</span><span class="s4">, </span><span class="s1">text</span><span class="s4">) {</span>
        <span class="s2">if </span><span class="s4">(</span><span class="s1">before </span><span class="s4">&lt; </span><span class="s3">0 </span><span class="s4">|| </span><span class="s1">before </span><span class="s4">&gt; </span><span class="s1">menuItems</span><span class="s4">.</span><span class="s1">length</span><span class="s4">) {</span>
            <span class="s2">return null</span><span class="s4">;</span>
        <span class="s4">}</span>

        <span class="s2">var </span><span class="s1">newItems </span><span class="s4">= </span><span class="s1">__protectedScope</span><span class="s4">.</span><span class="s1">copyItemsToJsArray</span><span class="s4">();</span>
        <span class="s2">var </span><span class="s1">newItem </span><span class="s4">= </span><span class="s1">Qt</span><span class="s4">.</span><span class="s1">createQmlObject</span><span class="s4">(</span><span class="s6">&quot;import QtQuick.Controls 1.1; MenuItem {}&quot;</span><span class="s4">, </span><span class="s1">pieMenu</span><span class="s4">, </span><span class="s6">&quot;&quot;</span><span class="s4">);</span>
        <span class="s1">newItem</span><span class="s4">.</span><span class="s1">text </span><span class="s4">= </span><span class="s1">text</span><span class="s4">;</span>
        <span class="s1">newItems</span><span class="s4">.</span><span class="s1">splice</span><span class="s4">(</span><span class="s1">before</span><span class="s4">, </span><span class="s3">0</span><span class="s4">, </span><span class="s1">newItem</span><span class="s4">);</span>

        <span class="s1">menuItems </span><span class="s4">= </span><span class="s1">newItems</span><span class="s4">;</span>
        <span class="s2">return </span><span class="s1">newItem</span><span class="s4">;</span>
    <span class="s4">}</span>

    <span class="s5">/*! 
        \qmlmethod void removeItem(item) 
 
        Removes \a item from the menu. 
    */</span>
    <span class="s2">function </span><span class="s1">removeItem</span><span class="s4">(</span><span class="s1">item</span><span class="s4">) {</span>
        <span class="s2">for </span><span class="s4">(</span><span class="s2">var </span><span class="s1">i </span><span class="s4">= </span><span class="s3">0</span><span class="s4">; </span><span class="s1">i </span><span class="s4">&lt; </span><span class="s1">menuItems</span><span class="s4">.</span><span class="s1">length</span><span class="s4">; ++</span><span class="s1">i</span><span class="s4">) {</span>
            <span class="s2">if </span><span class="s4">(</span><span class="s1">menuItems</span><span class="s4">[</span><span class="s1">i</span><span class="s4">] === </span><span class="s1">item</span><span class="s4">) {</span>
                <span class="s2">var </span><span class="s1">newItems </span><span class="s4">= </span><span class="s1">__protectedScope</span><span class="s4">.</span><span class="s1">copyItemsToJsArray</span><span class="s4">();</span>

                <span class="s1">newItems</span><span class="s4">.</span><span class="s1">splice</span><span class="s4">(</span><span class="s1">i</span><span class="s4">, </span><span class="s3">1</span><span class="s4">);</span>
                <span class="s1">menuItems </span><span class="s4">= </span><span class="s1">newItems</span><span class="s4">;</span>
                <span class="s2">break</span><span class="s4">;</span>
            <span class="s4">}</span>
        <span class="s4">}</span>
    <span class="s4">}</span>

    <span class="s1">MouseArea </span><span class="s4">{</span>
        <span class="s1">id</span><span class="s4">: </span><span class="s1">mouseArea</span>
        <span class="s1">anchors</span><span class="s4">.</span><span class="s1">fill</span><span class="s4">: </span><span class="s1">parent</span>
        <span class="s1">hoverEnabled</span><span class="s4">: !</span><span class="s1">Settings</span><span class="s4">.</span><span class="s1">hasTouchScreen </span><span class="s4">&amp;&amp; </span><span class="s1">triggerMode </span><span class="s4">!== </span><span class="s1">TriggerMode</span><span class="s4">.</span><span class="s1">TriggerOnRelease</span>
        <span class="s1">acceptedButtons</span><span class="s4">: </span><span class="s1">Qt</span><span class="s4">.</span><span class="s1">LeftButton </span><span class="s4">| </span><span class="s1">Qt</span><span class="s4">.</span><span class="s1">RightButton</span>
        <span class="s1">onContainsMouseChanged</span><span class="s4">: </span><span class="s2">if </span><span class="s4">(!</span><span class="s1">containsMouse</span><span class="s4">) </span><span class="s1">__protectedScope</span><span class="s4">.</span><span class="s1">currentIndex </span><span class="s4">= -</span><span class="s3">1</span>
        <span class="s1">objectName</span><span class="s4">: </span><span class="s6">&quot;PieMenu internal MouseArea&quot;</span>

        <span class="s5">// The mouse thief also updates the selectionPos, so we can't bind to</span>
        <span class="s5">// this mouseArea's mouseX/mouseY.</span>
        <span class="s1">onPositionChanged</span><span class="s4">: {</span>
            <span class="s1">__protectedScope</span><span class="s4">.</span><span class="s1">selectionPos </span><span class="s4">= </span><span class="s1">Qt</span><span class="s4">.</span><span class="s1">point</span><span class="s4">(</span><span class="s1">mouseX</span><span class="s4">, </span><span class="s1">mouseY</span><span class="s4">)</span>
        <span class="s4">}</span>
    <span class="s4">}</span>

    <span class="s5">/*! \internal */</span>
    <span class="s1">property alias __mouseThief</span><span class="s4">: </span><span class="s1">mouseThief</span>

    <span class="s1">CppUtils</span><span class="s4">.</span><span class="s1">MouseThief </span><span class="s4">{</span>
        <span class="s1">id</span><span class="s4">: </span><span class="s1">mouseThief</span>

        <span class="s1">onPressed</span><span class="s4">: {</span>
            <span class="s1">__protectedScope</span><span class="s4">.</span><span class="s1">selectionPos </span><span class="s4">= </span><span class="s1">Qt</span><span class="s4">.</span><span class="s1">point</span><span class="s4">(</span><span class="s1">mouseX</span><span class="s4">, </span><span class="s1">mouseY</span><span class="s4">);</span>
            <span class="s2">if </span><span class="s4">(</span><span class="s1">__protectedScope</span><span class="s4">.</span><span class="s1">handleEvent</span><span class="s4">(</span><span class="s1">ActivationMode</span><span class="s4">.</span><span class="s1">ActivateOnPress</span><span class="s4">)) {</span>
                <span class="s1">mouseThief</span><span class="s4">.</span><span class="s1">acceptCurrentEvent</span><span class="s4">();</span>
                <span class="s5">// We handled the press event, so we can reset this now.</span>
                <span class="s1">mouseThief</span><span class="s4">.</span><span class="s1">receivedPressEvent </span><span class="s4">= </span><span class="s2">false</span><span class="s4">;</span>
            <span class="s4">}</span>
        <span class="s4">}</span>
        <span class="s1">onReleased</span><span class="s4">: {</span>
            <span class="s1">__protectedScope</span><span class="s4">.</span><span class="s1">selectionPos </span><span class="s4">= </span><span class="s1">Qt</span><span class="s4">.</span><span class="s1">point</span><span class="s4">(</span><span class="s1">mouseX</span><span class="s4">, </span><span class="s1">mouseY</span><span class="s4">);</span>
            <span class="s2">if </span><span class="s4">(</span><span class="s1">__protectedScope</span><span class="s4">.</span><span class="s1">handleEvent</span><span class="s4">(</span><span class="s1">ActivationMode</span><span class="s4">.</span><span class="s1">ActivateOnRelease</span><span class="s4">)) {</span>
                <span class="s1">mouseThief</span><span class="s4">.</span><span class="s1">acceptCurrentEvent</span><span class="s4">();</span>
                <span class="s5">// We handled the press event, so we can reset this now.</span>
                <span class="s1">mouseThief</span><span class="s4">.</span><span class="s1">receivedPressEvent </span><span class="s4">= </span><span class="s2">false</span><span class="s4">;</span>
            <span class="s4">}</span>
            <span class="s1">__protectedScope</span><span class="s4">.</span><span class="s1">pressedIndex </span><span class="s4">= -</span><span class="s3">1</span><span class="s4">;</span>
        <span class="s4">}</span>
        <span class="s1">onClicked</span><span class="s4">: {</span>
            <span class="s1">__protectedScope</span><span class="s4">.</span><span class="s1">selectionPos </span><span class="s4">= </span><span class="s1">Qt</span><span class="s4">.</span><span class="s1">point</span><span class="s4">(</span><span class="s1">mouseX</span><span class="s4">, </span><span class="s1">mouseY</span><span class="s4">);</span>
            <span class="s2">if </span><span class="s4">(</span><span class="s1">__protectedScope</span><span class="s4">.</span><span class="s1">handleEvent</span><span class="s4">(</span><span class="s1">ActivationMode</span><span class="s4">.</span><span class="s1">ActivateOnClick</span><span class="s4">)) {</span>
                <span class="s1">mouseThief</span><span class="s4">.</span><span class="s1">acceptCurrentEvent</span><span class="s4">();</span>
            <span class="s4">}</span>

            <span class="s5">// Clicked is the last stage in a click event (press, release, click),</span>
            <span class="s5">// so we can safely set this to false now.</span>
            <span class="s1">mouseThief</span><span class="s4">.</span><span class="s1">receivedPressEvent </span><span class="s4">= </span><span class="s2">false</span><span class="s4">;</span>
        <span class="s4">}</span>
        <span class="s1">onTouchUpdate</span><span class="s4">: </span><span class="s1">__protectedScope</span><span class="s4">.</span><span class="s1">selectionPos </span><span class="s4">= </span><span class="s1">Qt</span><span class="s4">.</span><span class="s1">point</span><span class="s4">(</span><span class="s1">mouseX</span><span class="s4">, </span><span class="s1">mouseY</span><span class="s4">)</span>
    <span class="s4">}</span>

    <span class="s1">onVisibleChanged</span><span class="s4">: {</span>
        <span class="s5">// parent check is for when it's created without a parent,</span>
        <span class="s5">// which we do in the tests, for example.</span>
        <span class="s2">if </span><span class="s4">(</span><span class="s1">parent</span><span class="s4">) {</span>
            <span class="s2">if </span><span class="s4">(</span><span class="s1">visible</span><span class="s4">) {</span>
                <span class="s2">if </span><span class="s4">(</span><span class="s1">boundingItem</span><span class="s4">)</span>
                    <span class="s1">__protectedScope</span><span class="s4">.</span><span class="s1">moveWithinBounds</span><span class="s4">();</span>

                <span class="s5">// We need to grab the mouse so that we can detect released()</span>
                <span class="s5">// (which is only emitted after pressed(), which our MouseArea can't</span>
                <span class="s5">// emit as it didn't have focus until we were made visible).</span>
                <span class="s1">mouseThief</span><span class="s4">.</span><span class="s1">grabMouse</span><span class="s4">(</span><span class="s1">mouseArea</span><span class="s4">);</span>
            <span class="s4">} </span><span class="s2">else </span><span class="s4">{</span>
                <span class="s1">mouseThief</span><span class="s4">.</span><span class="s1">ungrabMouse</span><span class="s4">();</span>
                <span class="s1">__protectedScope</span><span class="s4">.</span><span class="s1">selectionPos </span><span class="s4">= </span><span class="s1">Qt</span><span class="s4">.</span><span class="s1">point</span><span class="s4">(</span><span class="s1">width </span><span class="s4">/ </span><span class="s3">2</span><span class="s4">, </span><span class="s1">height </span><span class="s4">/ </span><span class="s3">2</span><span class="s4">);</span>
            <span class="s4">}</span>
        <span class="s4">}</span>
    <span class="s4">}</span>
    <span class="s1">onSelectionAngleChanged</span><span class="s4">: </span><span class="s1">__protectedScope</span><span class="s4">.</span><span class="s1">checkForCurrentItem</span><span class="s4">()</span>

    <span class="s5">/*! \internal */</span>
    <span class="s1">property QtObject __protectedScope</span><span class="s4">: </span><span class="s1">QtObject </span><span class="s4">{</span>
        <span class="s1">id</span><span class="s4">: </span><span class="s1">protectedScope</span>

        <span class="s1">property int currentIndex</span><span class="s4">: -</span><span class="s3">1</span>
        <span class="s1">property MenuItem currentItem</span><span class="s4">: </span><span class="s1">currentIndex </span><span class="s4">!= -</span><span class="s3">1 </span><span class="s4">? </span><span class="s1">visibleItems</span><span class="s4">[</span><span class="s1">currentIndex</span><span class="s4">] : </span><span class="s2">null</span>
        <span class="s1">property point selectionPos</span><span class="s4">: </span><span class="s1">Qt</span><span class="s4">.</span><span class="s1">point</span><span class="s4">(</span><span class="s1">width </span><span class="s4">/ </span><span class="s3">2</span><span class="s4">, </span><span class="s1">height </span><span class="s4">/ </span><span class="s3">2</span><span class="s4">)</span>
        <span class="s1">property int pressedIndex</span><span class="s4">: -</span><span class="s3">1</span>
        <span class="s1">readonly property </span><span class="s2">var </span><span class="s1">localRect</span><span class="s4">: </span><span class="s1">mapFromItem</span><span class="s4">(</span><span class="s1">mouseArea</span><span class="s4">, </span><span class="s1">mouseArea</span><span class="s4">.</span><span class="s1">mouseX</span><span class="s4">, </span><span class="s1">mouseArea</span><span class="s4">.</span><span class="s1">mouseY</span><span class="s4">)</span>
        <span class="s1">readonly property </span><span class="s2">var </span><span class="s1">visibleItems</span><span class="s4">: {</span>
            <span class="s2">var </span><span class="s1">items </span><span class="s4">= [];</span>
            <span class="s2">for </span><span class="s4">(</span><span class="s2">var </span><span class="s1">i </span><span class="s4">= </span><span class="s3">0</span><span class="s4">; </span><span class="s1">i </span><span class="s4">&lt; </span><span class="s1">menuItems</span><span class="s4">.</span><span class="s1">length</span><span class="s4">; ++</span><span class="s1">i</span><span class="s4">) {</span>
                <span class="s2">if </span><span class="s4">(</span><span class="s1">menuItems</span><span class="s4">[</span><span class="s1">i</span><span class="s4">].</span><span class="s1">visible</span><span class="s4">) {</span>
                    <span class="s1">items</span><span class="s4">.</span><span class="s1">push</span><span class="s4">(</span><span class="s1">menuItems</span><span class="s4">[</span><span class="s1">i</span><span class="s4">]);</span>
                <span class="s4">}</span>
            <span class="s4">}</span>
            <span class="s2">return </span><span class="s1">items</span><span class="s4">;</span>
        <span class="s4">}</span>

        <span class="s1">onSelectionPosChanged</span><span class="s4">: </span><span class="s1">__protectedScope</span><span class="s4">.</span><span class="s1">checkForCurrentItem</span><span class="s4">()</span>

        <span class="s5">// Can't bind directly, because the menu sets this to (0, 0) on closing.</span>
        <span class="s1">onLocalRectChanged</span><span class="s4">: {</span>
            <span class="s2">if </span><span class="s4">(</span><span class="s1">visible</span><span class="s4">)</span>
                <span class="s1">selectionPos </span><span class="s4">= </span><span class="s1">Qt</span><span class="s4">.</span><span class="s1">point</span><span class="s4">(</span><span class="s1">localRect</span><span class="s4">.</span><span class="s1">x</span><span class="s4">, </span><span class="s1">localRect</span><span class="s4">.</span><span class="s1">y</span><span class="s4">);</span>
        <span class="s4">}</span>

        <span class="s2">function </span><span class="s1">copyItemsToJsArray</span><span class="s4">() {</span>
            <span class="s2">var </span><span class="s1">newItems </span><span class="s4">= [];</span>
            <span class="s2">for </span><span class="s4">(</span><span class="s2">var </span><span class="s1">j </span><span class="s4">= </span><span class="s3">0</span><span class="s4">; </span><span class="s1">j </span><span class="s4">&lt; </span><span class="s1">menuItems</span><span class="s4">.</span><span class="s1">length</span><span class="s4">; ++</span><span class="s1">j</span><span class="s4">) {</span>
                <span class="s1">newItems</span><span class="s4">.</span><span class="s1">push</span><span class="s4">(</span><span class="s1">menuItems</span><span class="s4">[</span><span class="s1">j</span><span class="s4">]);</span>
            <span class="s4">}</span>
            <span class="s2">return </span><span class="s1">newItems</span><span class="s4">;</span>
        <span class="s4">}</span>

        <span class="s5">/*! 
            Returns \c true if the mouse is over the section at \a itemIndex. 
        */</span>
        <span class="s2">function </span><span class="s1">isMouseOver</span><span class="s4">(</span><span class="s1">itemIndex</span><span class="s4">) {</span>
            <span class="s2">if </span><span class="s4">(</span><span class="s1">__style </span><span class="s4">== </span><span class="s2">null</span><span class="s4">)</span>
                <span class="s2">return false</span><span class="s4">;</span>

            <span class="s5">// Our mouse angle's origin is north naturally, but the section angles need to be</span>
            <span class="s5">// altered to have their origin north, so we need to remove the alteration here in order to compare properly.</span>
            <span class="s5">// For example, section 0 will start at -1.57, whereas we want it to start at 0.</span>
            <span class="s2">var </span><span class="s1">sectionStart </span><span class="s4">= </span><span class="s1">__protectedScope</span><span class="s4">.</span><span class="s1">sectionStartAngle</span><span class="s4">(</span><span class="s1">itemIndex</span><span class="s4">) + </span><span class="s1">Math</span><span class="s4">.</span><span class="s1">PI </span><span class="s4">/ </span><span class="s3">2</span><span class="s4">;</span>
            <span class="s2">var </span><span class="s1">sectionEnd </span><span class="s4">= </span><span class="s1">__protectedScope</span><span class="s4">.</span><span class="s1">sectionEndAngle</span><span class="s4">(</span><span class="s1">itemIndex</span><span class="s4">) + </span><span class="s1">Math</span><span class="s4">.</span><span class="s1">PI </span><span class="s4">/ </span><span class="s3">2</span><span class="s4">;</span>

            <span class="s2">var </span><span class="s1">selAngle </span><span class="s4">= </span><span class="s1">selectionAngle</span><span class="s4">;</span>
            <span class="s2">var </span><span class="s1">isWithinOurAngle </span><span class="s4">= </span><span class="s2">false</span><span class="s4">;</span>

            <span class="s2">if </span><span class="s4">(</span><span class="s1">sectionStart </span><span class="s4">&gt; </span><span class="s1">CppUtils</span><span class="s4">.</span><span class="s1">MathUtils</span><span class="s4">.</span><span class="s1">pi2</span><span class="s4">) {</span>
                <span class="s1">sectionStart </span><span class="s4">%= </span><span class="s1">CppUtils</span><span class="s4">.</span><span class="s1">MathUtils</span><span class="s4">.</span><span class="s1">pi2</span><span class="s4">;</span>
            <span class="s4">} </span><span class="s2">else if </span><span class="s4">(</span><span class="s1">sectionStart </span><span class="s4">&lt; -</span><span class="s1">CppUtils</span><span class="s4">.</span><span class="s1">MathUtils</span><span class="s4">.</span><span class="s1">pi2</span><span class="s4">) {</span>
                <span class="s1">sectionStart </span><span class="s4">%= -</span><span class="s1">CppUtils</span><span class="s4">.</span><span class="s1">MathUtils</span><span class="s4">.</span><span class="s1">pi2</span><span class="s4">;</span>
            <span class="s4">}</span>

            <span class="s2">if </span><span class="s4">(</span><span class="s1">sectionEnd </span><span class="s4">&gt; </span><span class="s1">CppUtils</span><span class="s4">.</span><span class="s1">MathUtils</span><span class="s4">.</span><span class="s1">pi2</span><span class="s4">) {</span>
                <span class="s1">sectionEnd </span><span class="s4">%= </span><span class="s1">CppUtils</span><span class="s4">.</span><span class="s1">MathUtils</span><span class="s4">.</span><span class="s1">pi2</span><span class="s4">;</span>
            <span class="s4">} </span><span class="s2">else if </span><span class="s4">(</span><span class="s1">sectionEnd </span><span class="s4">&lt; -</span><span class="s1">CppUtils</span><span class="s4">.</span><span class="s1">MathUtils</span><span class="s4">.</span><span class="s1">pi2</span><span class="s4">) {</span>
                <span class="s1">sectionEnd </span><span class="s4">%= -</span><span class="s1">CppUtils</span><span class="s4">.</span><span class="s1">MathUtils</span><span class="s4">.</span><span class="s1">pi2</span><span class="s4">;</span>
            <span class="s4">}</span>

            <span class="s5">// If the section crosses the -180 =&gt; 180 wrap-around point (from atan2),</span>
            <span class="s5">// temporarily rotate the section so it doesn't.</span>
            <span class="s2">if </span><span class="s4">(</span><span class="s1">sectionStart </span><span class="s4">&gt; </span><span class="s1">Math</span><span class="s4">.</span><span class="s1">PI</span><span class="s4">) {</span>
                <span class="s2">var </span><span class="s1">difference </span><span class="s4">= </span><span class="s1">sectionStart </span><span class="s4">- </span><span class="s1">Math</span><span class="s4">.</span><span class="s1">PI</span><span class="s4">;</span>
                <span class="s1">selAngle </span><span class="s4">-= </span><span class="s1">difference</span><span class="s4">;</span>
                <span class="s1">sectionStart </span><span class="s4">-= </span><span class="s1">difference</span><span class="s4">;</span>
                <span class="s1">sectionEnd </span><span class="s4">-= </span><span class="s1">difference</span><span class="s4">;</span>
            <span class="s4">} </span><span class="s2">else if </span><span class="s4">(</span><span class="s1">sectionStart </span><span class="s4">&lt; -</span><span class="s1">Math</span><span class="s4">.</span><span class="s1">PI</span><span class="s4">) {</span>
                <span class="s1">difference </span><span class="s4">= </span><span class="s1">Math</span><span class="s4">.</span><span class="s1">abs</span><span class="s4">(</span><span class="s1">sectionStart </span><span class="s4">- (-</span><span class="s1">Math</span><span class="s4">.</span><span class="s1">PI</span><span class="s4">));</span>
                <span class="s1">selAngle </span><span class="s4">+= </span><span class="s1">difference</span><span class="s4">;</span>
                <span class="s1">sectionStart </span><span class="s4">+= </span><span class="s1">difference</span><span class="s4">;</span>
                <span class="s1">sectionEnd </span><span class="s4">+= </span><span class="s1">difference</span><span class="s4">;</span>
            <span class="s4">}</span>

            <span class="s2">if </span><span class="s4">(</span><span class="s1">sectionEnd </span><span class="s4">&gt; </span><span class="s1">Math</span><span class="s4">.</span><span class="s1">PI</span><span class="s4">) {</span>
                <span class="s1">difference </span><span class="s4">= </span><span class="s1">sectionEnd </span><span class="s4">- </span><span class="s1">Math</span><span class="s4">.</span><span class="s1">PI</span><span class="s4">;</span>
                <span class="s1">selAngle </span><span class="s4">-= </span><span class="s1">difference</span><span class="s4">;</span>
                <span class="s1">sectionStart </span><span class="s4">-= </span><span class="s1">difference</span><span class="s4">;</span>
                <span class="s1">sectionEnd </span><span class="s4">-= </span><span class="s1">difference</span><span class="s4">;</span>
            <span class="s4">} </span><span class="s2">else if </span><span class="s4">(</span><span class="s1">sectionEnd </span><span class="s4">&lt; -</span><span class="s1">Math</span><span class="s4">.</span><span class="s1">PI</span><span class="s4">) {</span>
                <span class="s1">difference </span><span class="s4">= </span><span class="s1">Math</span><span class="s4">.</span><span class="s1">abs</span><span class="s4">(</span><span class="s1">sectionEnd </span><span class="s4">- (-</span><span class="s1">Math</span><span class="s4">.</span><span class="s1">PI</span><span class="s4">));</span>
                <span class="s1">selAngle </span><span class="s4">+= </span><span class="s1">difference</span><span class="s4">;</span>
                <span class="s1">sectionStart </span><span class="s4">+= </span><span class="s1">difference</span><span class="s4">;</span>
                <span class="s1">sectionEnd </span><span class="s4">+= </span><span class="s1">difference</span><span class="s4">;</span>
            <span class="s4">}</span>

            <span class="s5">// If we moved the mouse past -180 or 180, we need to move it back within,</span>
            <span class="s5">// without changing its actual direction.</span>
            <span class="s2">if </span><span class="s4">(</span><span class="s1">selAngle </span><span class="s4">&gt; </span><span class="s1">Math</span><span class="s4">.</span><span class="s1">PI</span><span class="s4">) {</span>
                <span class="s1">selAngle </span><span class="s4">= </span><span class="s1">selAngle </span><span class="s4">- </span><span class="s1">CppUtils</span><span class="s4">.</span><span class="s1">MathUtils</span><span class="s4">.</span><span class="s1">pi2</span><span class="s4">;</span>
            <span class="s4">} </span><span class="s2">else if </span><span class="s4">(</span><span class="s1">selAngle </span><span class="s4">&lt; -</span><span class="s1">Math</span><span class="s4">.</span><span class="s1">PI</span><span class="s4">) {</span>
                <span class="s1">selAngle </span><span class="s4">+= </span><span class="s1">CppUtils</span><span class="s4">.</span><span class="s1">MathUtils</span><span class="s4">.</span><span class="s1">pi2</span><span class="s4">;</span>
            <span class="s4">}</span>

            <span class="s2">if </span><span class="s4">(</span><span class="s1">sectionStart </span><span class="s4">&gt; </span><span class="s1">sectionEnd</span><span class="s4">) {</span>
                <span class="s1">isWithinOurAngle </span><span class="s4">= </span><span class="s1">selAngle </span><span class="s4">&gt;= </span><span class="s1">sectionEnd </span><span class="s4">&amp;&amp; </span><span class="s1">selAngle </span><span class="s4">&lt; </span><span class="s1">sectionStart</span><span class="s4">;</span>
            <span class="s4">} </span><span class="s2">else </span><span class="s4">{</span>
                <span class="s1">isWithinOurAngle </span><span class="s4">= </span><span class="s1">selAngle </span><span class="s4">&gt;= </span><span class="s1">sectionStart </span><span class="s4">&amp;&amp; </span><span class="s1">selAngle </span><span class="s4">&lt; </span><span class="s1">sectionEnd</span><span class="s4">;</span>
            <span class="s4">}</span>

            <span class="s2">var </span><span class="s1">x1 </span><span class="s4">= </span><span class="s1">width </span><span class="s4">/ </span><span class="s3">2</span><span class="s4">;</span>
            <span class="s2">var </span><span class="s1">y1 </span><span class="s4">= </span><span class="s1">height </span><span class="s4">/ </span><span class="s3">2</span><span class="s4">;</span>
            <span class="s2">var </span><span class="s1">x2 </span><span class="s4">= </span><span class="s1">__protectedScope</span><span class="s4">.</span><span class="s1">selectionPos</span><span class="s4">.</span><span class="s1">x</span><span class="s4">;</span>
            <span class="s2">var </span><span class="s1">y2 </span><span class="s4">= </span><span class="s1">__protectedScope</span><span class="s4">.</span><span class="s1">selectionPos</span><span class="s4">.</span><span class="s1">y</span><span class="s4">;</span>
            <span class="s2">var </span><span class="s1">distanceFromCenter </span><span class="s4">= </span><span class="s1">Math</span><span class="s4">.</span><span class="s1">pow</span><span class="s4">(</span><span class="s1">x1 </span><span class="s4">- </span><span class="s1">x2</span><span class="s4">, </span><span class="s3">2</span><span class="s4">) + </span><span class="s1">Math</span><span class="s4">.</span><span class="s1">pow</span><span class="s4">(</span><span class="s1">y1 </span><span class="s4">- </span><span class="s1">y2</span><span class="s4">, </span><span class="s3">2</span><span class="s4">);</span>
            <span class="s2">var </span><span class="s1">cancelRadiusSquared </span><span class="s4">= </span><span class="s1">__style</span><span class="s4">.</span><span class="s1">cancelRadius </span><span class="s4">* </span><span class="s1">__style</span><span class="s4">.</span><span class="s1">cancelRadius</span><span class="s4">;</span>
            <span class="s2">var </span><span class="s1">styleRadiusSquared </span><span class="s4">= </span><span class="s1">__style</span><span class="s4">.</span><span class="s1">radius </span><span class="s4">* </span><span class="s1">__style</span><span class="s4">.</span><span class="s1">radius</span><span class="s4">;</span>
            <span class="s2">var </span><span class="s1">isWithinOurRadius </span><span class="s4">= </span><span class="s1">distanceFromCenter </span><span class="s4">&gt;= </span><span class="s1">cancelRadiusSquared</span>
                <span class="s4">&amp;&amp; </span><span class="s1">distanceFromCenter </span><span class="s4">&lt; </span><span class="s1">styleRadiusSquared</span><span class="s4">;</span>
            <span class="s2">return </span><span class="s1">isWithinOurAngle </span><span class="s4">&amp;&amp; </span><span class="s1">isWithinOurRadius</span><span class="s4">;</span>
        <span class="s4">}</span>

        <span class="s1">readonly property real arcRange</span><span class="s4">: </span><span class="s1">endAngleRadians </span><span class="s4">- </span><span class="s1">startAngleRadians</span>

        <span class="s5">/*! 
            The size of one section in radians. 
        */</span>
        <span class="s1">readonly property real sectionSize</span><span class="s4">: </span><span class="s1">arcRange </span><span class="s4">/ </span><span class="s1">visibleItems</span><span class="s4">.</span><span class="s1">length</span>
        <span class="s1">readonly property real startAngleRadians</span><span class="s4">: </span><span class="s1">CppUtils</span><span class="s4">.</span><span class="s1">MathUtils</span><span class="s4">.</span><span class="s1">degToRadOffset</span><span class="s4">(</span><span class="s1">__style</span><span class="s4">.</span><span class="s1">startAngle</span><span class="s4">)</span>
        <span class="s1">readonly property real endAngleRadians</span><span class="s4">: </span><span class="s1">CppUtils</span><span class="s4">.</span><span class="s1">MathUtils</span><span class="s4">.</span><span class="s1">degToRadOffset</span><span class="s4">(</span><span class="s1">__style</span><span class="s4">.</span><span class="s1">endAngle</span><span class="s4">)</span>

        <span class="s1">readonly property real circumferenceOfFullRange</span><span class="s4">: </span><span class="s3">2 </span><span class="s4">* </span><span class="s1">Math</span><span class="s4">.</span><span class="s1">PI </span><span class="s4">* </span><span class="s1">__style</span><span class="s4">.</span><span class="s1">radius</span>
        <span class="s1">readonly property real percentageOfFullRange</span><span class="s4">: (</span><span class="s1">arcRange </span><span class="s4">/ (</span><span class="s1">Math</span><span class="s4">.</span><span class="s1">PI </span><span class="s4">* </span><span class="s3">2</span><span class="s4">))</span>
        <span class="s1">readonly property real circumferenceOfSection</span><span class="s4">: (</span><span class="s1">sectionSize </span><span class="s4">/ </span><span class="s1">arcRange</span><span class="s4">) * (</span><span class="s1">percentageOfFullRange </span><span class="s4">* </span><span class="s1">circumferenceOfFullRange</span><span class="s4">)</span>

        <span class="s2">function </span><span class="s1">sectionStartAngle</span><span class="s4">(</span><span class="s1">section</span><span class="s4">) {</span>
            <span class="s2">var </span><span class="s1">start </span><span class="s4">= </span><span class="s1">startAngleRadians </span><span class="s4">+ </span><span class="s1">section </span><span class="s4">* </span><span class="s1">sectionSize</span><span class="s4">;</span>
            <span class="s2">return </span><span class="s1">start</span><span class="s4">;</span>
        <span class="s4">}</span>

        <span class="s2">function </span><span class="s1">sectionCenterAngle</span><span class="s4">(</span><span class="s1">section</span><span class="s4">) {</span>
            <span class="s2">return </span><span class="s4">(</span><span class="s1">sectionStartAngle</span><span class="s4">(</span><span class="s1">section</span><span class="s4">) + </span><span class="s1">sectionEndAngle</span><span class="s4">(</span><span class="s1">section</span><span class="s4">)) / </span><span class="s3">2</span><span class="s4">;</span>
        <span class="s4">}</span>

        <span class="s2">function </span><span class="s1">sectionEndAngle</span><span class="s4">(</span><span class="s1">section</span><span class="s4">) {</span>
            <span class="s2">var </span><span class="s1">end </span><span class="s4">= </span><span class="s1">startAngleRadians </span><span class="s4">+ </span><span class="s1">section </span><span class="s4">* </span><span class="s1">sectionSize </span><span class="s4">+ </span><span class="s1">sectionSize</span><span class="s4">;</span>
            <span class="s2">return </span><span class="s1">end</span><span class="s4">;</span>
        <span class="s4">}</span>

        <span class="s2">function </span><span class="s1">handleEvent</span><span class="s4">(</span><span class="s1">eventType</span><span class="s4">) {</span>
            <span class="s2">if </span><span class="s4">(!</span><span class="s1">visible</span><span class="s4">)</span>
                <span class="s2">return false</span><span class="s4">;</span>

            <span class="s1">checkForCurrentItem</span><span class="s4">();</span>

            <span class="s2">if </span><span class="s4">(</span><span class="s1">eventType </span><span class="s4">=== </span><span class="s1">TriggerMode</span><span class="s4">.</span><span class="s1">TriggerOnPress</span><span class="s4">)</span>
                <span class="s1">pressedIndex </span><span class="s4">= </span><span class="s1">currentIndex</span><span class="s4">;</span>

            <span class="s2">if </span><span class="s4">(</span><span class="s1">eventType </span><span class="s4">=== </span><span class="s1">TriggerMode</span><span class="s4">.</span><span class="s1">TriggerOnPress </span><span class="s4">&amp;&amp; </span><span class="s1">triggerMode </span><span class="s4">=== </span><span class="s1">TriggerMode</span><span class="s4">.</span><span class="s1">TriggerOnClick</span><span class="s4">) {</span>
                <span class="s5">// We *MUST* accept press events if we plan on also accepting the release</span>
                <span class="s5">// (aka click, since we create that ourselves) event. If we don't, the</span>
                <span class="s5">// external mouse area gets the press event but not the release event,</span>
                <span class="s5">// and won't open until a release event is received, which means until the</span>
                <span class="s5">// user taps twice on the external mouse area.</span>
                <span class="s5">// Usually, we accept the current event in the onX MouseThief event handlers above,</span>
                <span class="s5">// but there we set receivedPressEvent to false if this function says it handled</span>
                <span class="s5">// the event, which we don't want, since TriggerOnClick is expecting to have</span>
                <span class="s5">// received a press event. So, we ensure that receivedPressEvent stays true</span>
                <span class="s5">// by saying we didn't handle the event, even though we actually do.</span>
                <span class="s1">mouseThief</span><span class="s4">.</span><span class="s1">acceptCurrentEvent</span><span class="s4">();</span>
                <span class="s2">return false</span><span class="s4">;</span>
            <span class="s4">}</span>

            <span class="s2">if </span><span class="s4">(</span><span class="s1">triggerMode </span><span class="s4">=== </span><span class="s1">eventType</span><span class="s4">) {</span>
                <span class="s2">if </span><span class="s4">(</span><span class="s1">eventType </span><span class="s4">=== </span><span class="s1">TriggerMode</span><span class="s4">.</span><span class="s1">TriggerOnClick </span><span class="s4">&amp;&amp; !</span><span class="s1">mouseThief</span><span class="s4">.</span><span class="s1">receivedPressEvent</span><span class="s4">) {</span>
                    <span class="s5">// When the trigger mode is TriggerOnClick, we can't</span>
                    <span class="s5">// act on a click event if we didn't receive the press.</span>
                    <span class="s2">return false</span><span class="s4">;</span>
                <span class="s4">}</span>

                <span class="s5">// Setting visible to false resets the selectionPos to the center</span>
                <span class="s5">// of the menu, which in turn causes the currentItem check to be re-evaluated,</span>
                <span class="s5">// which sees that there's no current item because the selectionPos is centered.</span>
                <span class="s5">// To avoid all of that, we store these variables before setting visible to false.</span>
                <span class="s2">var </span><span class="s1">currentItemBeforeClosing </span><span class="s4">= </span><span class="s1">currentItem</span><span class="s4">;</span>
                <span class="s2">var </span><span class="s1">selectionPosBeforeClosing </span><span class="s4">= </span><span class="s1">selectionPos</span><span class="s4">;</span>
                <span class="s2">var </span><span class="s1">currentIndexBeforeClosing </span><span class="s4">= </span><span class="s1">currentIndex</span><span class="s4">;</span>

                <span class="s5">// If the cursor was over an item; trigger it. If it wasn't,</span>
                <span class="s5">// close our menu regardless. We do this first so that it's</span>
                <span class="s5">// possible to keep the menu open by setting visible to true in onTriggered.</span>
                <span class="s1">visible </span><span class="s4">= </span><span class="s2">false</span><span class="s4">;</span>

                <span class="s2">if </span><span class="s4">(</span><span class="s1">currentItemBeforeClosing</span><span class="s4">) {</span>
                    <span class="s1">currentItemBeforeClosing</span><span class="s4">.</span><span class="s1">trigger</span><span class="s4">();</span>
                <span class="s4">}</span>

                <span class="s2">if </span><span class="s4">(</span><span class="s1">visible </span><span class="s4">&amp;&amp; !</span><span class="s1">Settings</span><span class="s4">.</span><span class="s1">hasTouchScreen </span><span class="s4">&amp;&amp; !</span><span class="s1">Settings</span><span class="s4">.</span><span class="s1">isMobile</span><span class="s4">) {</span>
                    <span class="s5">// The user kept the menu open in onTriggered, so restore the hover stuff.</span>
                    <span class="s1">selectionPos </span><span class="s4">= </span><span class="s1">selectionPosBeforeClosing</span><span class="s4">;</span>
                    <span class="s1">currentIndex </span><span class="s4">= </span><span class="s1">currentIndexBeforeClosing</span><span class="s4">;</span>
                <span class="s4">}</span>

                <span class="s5">// If the trigger mode and event are Release, we should ensure</span>
                <span class="s5">// that we received a press event beforehand. If we didn't, we shouldn't steal</span>
                <span class="s5">// the event in MouseThief's event filter.</span>
                <span class="s2">return </span><span class="s1">mouseThief</span><span class="s4">.</span><span class="s1">receivedPressEvent</span><span class="s4">;</span>
            <span class="s4">}</span>
            <span class="s2">return false</span><span class="s4">;</span>
        <span class="s4">}</span>

        <span class="s2">function </span><span class="s1">checkForCurrentItem</span><span class="s4">() {</span>
            <span class="s5">// Use a temporary varibable because setting currentIndex to -1 here</span>
            <span class="s5">// will trigger onCurrentIndexChanged.</span>
            <span class="s2">if </span><span class="s4">(!!</span><span class="s1">visibleItems</span><span class="s4">) {</span>
                <span class="s2">var </span><span class="s1">hoveredIndex </span><span class="s4">= -</span><span class="s3">1</span><span class="s4">;</span>
                <span class="s2">for </span><span class="s4">(</span><span class="s2">var </span><span class="s1">i </span><span class="s4">= </span><span class="s3">0</span><span class="s4">; </span><span class="s1">i </span><span class="s4">&lt; </span><span class="s1">visibleItems</span><span class="s4">.</span><span class="s1">length</span><span class="s4">; ++</span><span class="s1">i</span><span class="s4">) {</span>
                    <span class="s2">if </span><span class="s4">(</span><span class="s1">isMouseOver</span><span class="s4">(</span><span class="s1">i</span><span class="s4">)) {</span>
                        <span class="s1">hoveredIndex </span><span class="s4">= </span><span class="s1">i</span><span class="s4">;</span>
                        <span class="s2">break</span><span class="s4">;</span>
                    <span class="s4">}</span>
                <span class="s4">}</span>
                <span class="s1">currentIndex </span><span class="s4">= </span><span class="s1">hoveredIndex</span><span class="s4">;</span>
            <span class="s4">}</span>
        <span class="s4">}</span>

        <span class="s2">function </span><span class="s1">simplifyAngle</span><span class="s4">(</span><span class="s1">angle</span><span class="s4">) {</span>
            <span class="s2">var </span><span class="s1">simplified </span><span class="s4">= </span><span class="s1">angle </span><span class="s4">% </span><span class="s3">360</span><span class="s4">;</span>
            <span class="s2">if </span><span class="s4">(</span><span class="s1">simplified </span><span class="s4">&lt; </span><span class="s3">0</span><span class="s4">)</span>
                <span class="s1">simplified </span><span class="s4">+= </span><span class="s3">360</span><span class="s4">;</span>
            <span class="s2">return </span><span class="s1">simplified</span><span class="s4">;</span>
        <span class="s4">}</span>

        <span class="s2">function </span><span class="s1">isWithinBottomEdge</span><span class="s4">() {</span>
            <span class="s2">var </span><span class="s1">start </span><span class="s4">= </span><span class="s1">simplifyAngle</span><span class="s4">(</span><span class="s1">pieMenu</span><span class="s4">.</span><span class="s1">__style</span><span class="s4">.</span><span class="s1">startAngle</span><span class="s4">);</span>
            <span class="s2">var </span><span class="s1">end </span><span class="s4">= </span><span class="s1">simplifyAngle</span><span class="s4">(</span><span class="s1">pieMenu</span><span class="s4">.</span><span class="s1">__style</span><span class="s4">.</span><span class="s1">endAngle</span><span class="s4">);</span>
            <span class="s2">return </span><span class="s1">start </span><span class="s4">&gt;= </span><span class="s3">270 </span><span class="s4">&amp;&amp; </span><span class="s1">end </span><span class="s4">&lt;= </span><span class="s3">90 </span><span class="s4">&amp;&amp; ((</span><span class="s1">start </span><span class="s4">&lt; </span><span class="s3">360 </span><span class="s4">&amp;&amp; </span><span class="s1">end </span><span class="s4">&lt;= </span><span class="s3">360</span><span class="s4">) || (</span><span class="s1">start </span><span class="s4">&gt;= </span><span class="s3">0 </span><span class="s4">&amp;&amp; </span><span class="s1">end </span><span class="s4">&gt; </span><span class="s3">0</span><span class="s4">));</span>
        <span class="s4">}</span>

        <span class="s2">function </span><span class="s1">isWithinTopEdge</span><span class="s4">() {</span>
            <span class="s2">var </span><span class="s1">start </span><span class="s4">= </span><span class="s1">simplifyAngle</span><span class="s4">(</span><span class="s1">pieMenu</span><span class="s4">.</span><span class="s1">__style</span><span class="s4">.</span><span class="s1">startAngle</span><span class="s4">);</span>
            <span class="s2">var </span><span class="s1">end </span><span class="s4">= </span><span class="s1">simplifyAngle</span><span class="s4">(</span><span class="s1">pieMenu</span><span class="s4">.</span><span class="s1">__style</span><span class="s4">.</span><span class="s1">endAngle</span><span class="s4">);</span>
            <span class="s2">return </span><span class="s1">start </span><span class="s4">&gt;= </span><span class="s3">90 </span><span class="s4">&amp;&amp; </span><span class="s1">start </span><span class="s4">&lt; </span><span class="s3">270 </span><span class="s4">&amp;&amp; </span><span class="s1">end </span><span class="s4">&gt; </span><span class="s3">90 </span><span class="s4">&amp;&amp; </span><span class="s1">end </span><span class="s4">&lt;= </span><span class="s3">270</span><span class="s4">;</span>
        <span class="s4">}</span>

        <span class="s2">function </span><span class="s1">isWithinLeftEdge</span><span class="s4">() {</span>
            <span class="s2">var </span><span class="s1">start </span><span class="s4">= </span><span class="s1">simplifyAngle</span><span class="s4">(</span><span class="s1">pieMenu</span><span class="s4">.</span><span class="s1">__style</span><span class="s4">.</span><span class="s1">startAngle</span><span class="s4">);</span>
            <span class="s2">var </span><span class="s1">end </span><span class="s4">= </span><span class="s1">simplifyAngle</span><span class="s4">(</span><span class="s1">pieMenu</span><span class="s4">.</span><span class="s1">__style</span><span class="s4">.</span><span class="s1">endAngle</span><span class="s4">);</span>
            <span class="s2">return </span><span class="s4">(</span><span class="s1">start </span><span class="s4">=== </span><span class="s3">360 </span><span class="s4">|| </span><span class="s1">start </span><span class="s4">&gt;= </span><span class="s3">0</span><span class="s4">) &amp;&amp; </span><span class="s1">start </span><span class="s4">&lt; </span><span class="s3">180 </span><span class="s4">&amp;&amp; </span><span class="s1">end </span><span class="s4">&gt; </span><span class="s3">0 </span><span class="s4">&amp;&amp; </span><span class="s1">end </span><span class="s4">&lt;= </span><span class="s3">180</span><span class="s4">;</span>
        <span class="s4">}</span>

        <span class="s2">function </span><span class="s1">isWithinRightEdge</span><span class="s4">() {</span>
            <span class="s2">var </span><span class="s1">start </span><span class="s4">= </span><span class="s1">simplifyAngle</span><span class="s4">(</span><span class="s1">pieMenu</span><span class="s4">.</span><span class="s1">__style</span><span class="s4">.</span><span class="s1">startAngle</span><span class="s4">);</span>
            <span class="s2">var </span><span class="s1">end </span><span class="s4">= </span><span class="s1">simplifyAngle</span><span class="s4">(</span><span class="s1">pieMenu</span><span class="s4">.</span><span class="s1">__style</span><span class="s4">.</span><span class="s1">endAngle</span><span class="s4">);</span>
            <span class="s2">return </span><span class="s1">start </span><span class="s4">&gt;= </span><span class="s3">180 </span><span class="s4">&amp;&amp; </span><span class="s1">start </span><span class="s4">&lt; </span><span class="s3">360 </span><span class="s4">&amp;&amp; </span><span class="s1">end </span><span class="s4">&gt; </span><span class="s3">180 </span><span class="s4">&amp;&amp; (</span><span class="s1">end </span><span class="s4">=== </span><span class="s3">360 </span><span class="s4">|| </span><span class="s1">end </span><span class="s4">=== </span><span class="s3">0</span><span class="s4">);</span>
        <span class="s4">}</span>

        <span class="s5">/*! 
            Moves the menu if it would open with parts outside of \a rootParent. 
        */</span>
        <span class="s2">function </span><span class="s1">moveWithinBounds</span><span class="s4">() {</span>
            <span class="s5">// Find the bounding rect of the bounding item in the parent's referential.</span>
            <span class="s2">var </span><span class="s1">topLeft </span><span class="s4">= </span><span class="s1">boundingItem</span><span class="s4">.</span><span class="s1">mapToItem</span><span class="s4">(</span><span class="s1">pieMenu</span><span class="s4">.</span><span class="s1">parent</span><span class="s4">, </span><span class="s3">0</span><span class="s4">, </span><span class="s3">0</span><span class="s4">);</span>
            <span class="s2">var </span><span class="s1">topRight </span><span class="s4">= </span><span class="s1">boundingItem</span><span class="s4">.</span><span class="s1">mapToItem</span><span class="s4">(</span><span class="s1">pieMenu</span><span class="s4">.</span><span class="s1">parent</span><span class="s4">, </span><span class="s1">boundingItem</span><span class="s4">.</span><span class="s1">width</span><span class="s4">, </span><span class="s3">0</span><span class="s4">);</span>
            <span class="s2">var </span><span class="s1">bottomLeft </span><span class="s4">= </span><span class="s1">boundingItem</span><span class="s4">.</span><span class="s1">mapToItem</span><span class="s4">(</span><span class="s1">pieMenu</span><span class="s4">.</span><span class="s1">parent</span><span class="s4">, </span><span class="s3">0</span><span class="s4">, </span><span class="s1">boundingItem</span><span class="s4">.</span><span class="s1">height</span><span class="s4">);</span>
            <span class="s2">var </span><span class="s1">bottomRight </span><span class="s4">= </span><span class="s1">boundingItem</span><span class="s4">.</span><span class="s1">mapToItem</span><span class="s4">(</span><span class="s1">pieMenu</span><span class="s4">.</span><span class="s1">parent</span><span class="s4">, </span><span class="s1">boundingItem</span><span class="s4">.</span><span class="s1">width</span><span class="s4">, </span><span class="s1">boundingItem</span><span class="s4">.</span><span class="s1">height</span><span class="s4">);</span>

            <span class="s5">// If the boundingItem is rotated, normalize the bounding rect.</span>
            <span class="s1">topLeft</span><span class="s4">.</span><span class="s1">x </span><span class="s4">= </span><span class="s1">Math</span><span class="s4">.</span><span class="s1">min</span><span class="s4">(</span><span class="s1">topLeft</span><span class="s4">.</span><span class="s1">x</span><span class="s4">, </span><span class="s1">topRight</span><span class="s4">.</span><span class="s1">x</span><span class="s4">, </span><span class="s1">bottomLeft</span><span class="s4">.</span><span class="s1">x</span><span class="s4">, </span><span class="s1">bottomRight</span><span class="s4">.</span><span class="s1">x</span><span class="s4">);</span>
            <span class="s1">topLeft</span><span class="s4">.</span><span class="s1">y </span><span class="s4">= </span><span class="s1">Math</span><span class="s4">.</span><span class="s1">min</span><span class="s4">(</span><span class="s1">topLeft</span><span class="s4">.</span><span class="s1">y</span><span class="s4">, </span><span class="s1">topRight</span><span class="s4">.</span><span class="s1">y</span><span class="s4">, </span><span class="s1">bottomLeft</span><span class="s4">.</span><span class="s1">y</span><span class="s4">, </span><span class="s1">bottomRight</span><span class="s4">.</span><span class="s1">y</span><span class="s4">);</span>
            <span class="s1">bottomRight</span><span class="s4">.</span><span class="s1">x </span><span class="s4">= </span><span class="s1">Math</span><span class="s4">.</span><span class="s1">max</span><span class="s4">(</span><span class="s1">topLeft</span><span class="s4">.</span><span class="s1">x</span><span class="s4">, </span><span class="s1">topRight</span><span class="s4">.</span><span class="s1">x</span><span class="s4">, </span><span class="s1">bottomLeft</span><span class="s4">.</span><span class="s1">x</span><span class="s4">, </span><span class="s1">bottomRight</span><span class="s4">.</span><span class="s1">x</span><span class="s4">);</span>
            <span class="s1">bottomRight</span><span class="s4">.</span><span class="s1">y </span><span class="s4">= </span><span class="s1">Math</span><span class="s4">.</span><span class="s1">max</span><span class="s4">(</span><span class="s1">topLeft</span><span class="s4">.</span><span class="s1">y</span><span class="s4">, </span><span class="s1">topRight</span><span class="s4">.</span><span class="s1">y</span><span class="s4">, </span><span class="s1">bottomLeft</span><span class="s4">.</span><span class="s1">y</span><span class="s4">, </span><span class="s1">bottomRight</span><span class="s4">.</span><span class="s1">y</span><span class="s4">);</span>

            <span class="s2">if </span><span class="s4">(</span><span class="s1">pieMenu</span><span class="s4">.</span><span class="s1">x </span><span class="s4">&lt; </span><span class="s1">topLeft</span><span class="s4">.</span><span class="s1">x </span><span class="s4">&amp;&amp; !</span><span class="s1">isWithinLeftEdge</span><span class="s4">()) {</span>
                <span class="s5">// The width and height of the menu is always that of a full circle,</span>
                <span class="s5">// so the menu is not always outside an edge when it's outside the edge -</span>
                <span class="s5">// it depends on the start and end angles.</span>
                <span class="s1">pieMenu</span><span class="s4">.</span><span class="s1">x </span><span class="s4">= </span><span class="s1">topLeft</span><span class="s4">.</span><span class="s1">x</span><span class="s4">;</span>
            <span class="s4">} </span><span class="s2">else if </span><span class="s4">(</span><span class="s1">pieMenu</span><span class="s4">.</span><span class="s1">x </span><span class="s4">+ </span><span class="s1">pieMenu</span><span class="s4">.</span><span class="s1">width </span><span class="s4">&gt; </span><span class="s1">bottomRight</span><span class="s4">.</span><span class="s1">x </span><span class="s4">&amp;&amp; !</span><span class="s1">isWithinRightEdge</span><span class="s4">()) {</span>
                <span class="s1">pieMenu</span><span class="s4">.</span><span class="s1">x </span><span class="s4">= </span><span class="s1">bottomRight</span><span class="s4">.</span><span class="s1">x </span><span class="s4">- </span><span class="s1">pieMenu</span><span class="s4">.</span><span class="s1">width</span><span class="s4">;</span>
            <span class="s4">}</span>

            <span class="s2">if </span><span class="s4">(</span><span class="s1">pieMenu</span><span class="s4">.</span><span class="s1">y </span><span class="s4">&lt; </span><span class="s1">topLeft</span><span class="s4">.</span><span class="s1">y </span><span class="s4">&amp;&amp; !</span><span class="s1">isWithinTopEdge</span><span class="s4">()) {</span>
                <span class="s1">pieMenu</span><span class="s4">.</span><span class="s1">y </span><span class="s4">= </span><span class="s1">topLeft</span><span class="s4">.</span><span class="s1">y</span><span class="s4">;</span>
            <span class="s4">} </span><span class="s2">else if </span><span class="s4">(</span><span class="s1">pieMenu</span><span class="s4">.</span><span class="s1">y </span><span class="s4">+ </span><span class="s1">pieMenu</span><span class="s4">.</span><span class="s1">height </span><span class="s4">&gt; </span><span class="s1">bottomRight</span><span class="s4">.</span><span class="s1">y </span><span class="s4">&amp;&amp; !</span><span class="s1">isWithinBottomEdge</span><span class="s4">()) {</span>
                <span class="s1">pieMenu</span><span class="s4">.</span><span class="s1">y </span><span class="s4">= </span><span class="s1">bottomRight</span><span class="s4">.</span><span class="s1">y </span><span class="s4">- </span><span class="s1">pieMenu</span><span class="s4">.</span><span class="s1">height</span><span class="s4">;</span>
            <span class="s4">}</span>
        <span class="s4">}</span>
    <span class="s4">}</span>
<span class="s4">}</span>
</pre>
</body>
</html>