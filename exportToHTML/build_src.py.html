<html>
<head>
<title>build_src.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #7a7e85;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
build_src.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; Build swig and f2py sources. 
&quot;&quot;&quot;</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">re</span>
<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">import </span><span class="s1">shlex</span>
<span class="s2">import </span><span class="s1">copy</span>

<span class="s2">from </span><span class="s1">distutils</span><span class="s3">.</span><span class="s1">command </span><span class="s2">import </span><span class="s1">build_ext</span>
<span class="s2">from </span><span class="s1">distutils</span><span class="s3">.</span><span class="s1">dep_util </span><span class="s2">import </span><span class="s1">newer_group</span><span class="s3">, </span><span class="s1">newer</span>
<span class="s2">from </span><span class="s1">distutils</span><span class="s3">.</span><span class="s1">util </span><span class="s2">import </span><span class="s1">get_platform</span>
<span class="s2">from </span><span class="s1">distutils</span><span class="s3">.</span><span class="s1">errors </span><span class="s2">import </span><span class="s1">DistutilsError</span><span class="s3">, </span><span class="s1">DistutilsSetupError</span>


<span class="s4"># this import can't be done here, as it uses numpy stuff only available</span>
<span class="s4"># after it's installed</span>
<span class="s4">#import numpy.f2py</span>
<span class="s2">from </span><span class="s1">numpy</span><span class="s3">.</span><span class="s1">distutils </span><span class="s2">import </span><span class="s1">log</span>
<span class="s2">from </span><span class="s1">numpy</span><span class="s3">.</span><span class="s1">distutils</span><span class="s3">.</span><span class="s1">misc_util </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">fortran_ext_match</span><span class="s3">, </span><span class="s1">appendpath</span><span class="s3">, </span><span class="s1">is_string</span><span class="s3">, </span><span class="s1">is_sequence</span><span class="s3">, </span><span class="s1">get_cmd</span>
    <span class="s3">)</span>
<span class="s2">from </span><span class="s1">numpy</span><span class="s3">.</span><span class="s1">distutils</span><span class="s3">.</span><span class="s1">from_template </span><span class="s2">import </span><span class="s1">process_file </span><span class="s2">as </span><span class="s1">process_f_file</span>
<span class="s2">from </span><span class="s1">numpy</span><span class="s3">.</span><span class="s1">distutils</span><span class="s3">.</span><span class="s1">conv_template </span><span class="s2">import </span><span class="s1">process_file </span><span class="s2">as </span><span class="s1">process_c_file</span>

<span class="s2">def </span><span class="s1">subst_vars</span><span class="s3">(</span><span class="s1">target</span><span class="s3">, </span><span class="s1">source</span><span class="s3">, </span><span class="s1">d</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Substitute any occurrence of @foo@ by d['foo'] from source file into 
    target.&quot;&quot;&quot;</span>
    <span class="s1">var </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span><span class="s5">'@([a-zA-Z_]+)@'</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">source</span><span class="s3">, </span><span class="s5">'r'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">fs</span><span class="s3">:</span>
        <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">target</span><span class="s3">, </span><span class="s5">'w'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">ft</span><span class="s3">:</span>
            <span class="s2">for </span><span class="s1">l </span><span class="s2">in </span><span class="s1">fs</span><span class="s3">:</span>
                <span class="s1">m </span><span class="s3">= </span><span class="s1">var</span><span class="s3">.</span><span class="s1">search</span><span class="s3">(</span><span class="s1">l</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">m</span><span class="s3">:</span>
                    <span class="s1">ft</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">l</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s5">'@%s@' </span><span class="s3">% </span><span class="s1">m</span><span class="s3">.</span><span class="s1">group</span><span class="s3">(</span><span class="s6">1</span><span class="s3">), </span><span class="s1">d</span><span class="s3">[</span><span class="s1">m</span><span class="s3">.</span><span class="s1">group</span><span class="s3">(</span><span class="s6">1</span><span class="s3">)]))</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">ft</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">l</span><span class="s3">)</span>

<span class="s2">class </span><span class="s1">build_src</span><span class="s3">(</span><span class="s1">build_ext</span><span class="s3">.</span><span class="s1">build_ext</span><span class="s3">):</span>

    <span class="s1">description </span><span class="s3">= </span><span class="s5">&quot;build sources from SWIG, F2PY files or a function&quot;</span>

    <span class="s1">user_options </span><span class="s3">= [</span>
        <span class="s3">(</span><span class="s5">'build-src='</span><span class="s3">, </span><span class="s5">'d'</span><span class="s3">, </span><span class="s5">&quot;directory to </span><span class="s2">\&quot;</span><span class="s5">build</span><span class="s2">\&quot; </span><span class="s5">sources to&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s5">'f2py-opts='</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s5">&quot;list of f2py command line options&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s5">'swig='</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s5">&quot;path to the SWIG executable&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s5">'swig-opts='</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s5">&quot;list of SWIG command line options&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s5">'swig-cpp'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s5">&quot;make SWIG create C++ files (default is autodetected from sources)&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s5">'f2pyflags='</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s5">&quot;additional flags to f2py (use --f2py-opts= instead)&quot;</span><span class="s3">), </span><span class="s4"># obsolete</span>
        <span class="s3">(</span><span class="s5">'swigflags='</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s5">&quot;additional flags to swig (use --swig-opts= instead)&quot;</span><span class="s3">), </span><span class="s4"># obsolete</span>
        <span class="s3">(</span><span class="s5">'force'</span><span class="s3">, </span><span class="s5">'f'</span><span class="s3">, </span><span class="s5">&quot;forcibly build everything (ignore file timestamps)&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s5">'inplace'</span><span class="s3">, </span><span class="s5">'i'</span><span class="s3">,</span>
         <span class="s5">&quot;ignore build-lib and put compiled extensions into the source &quot; </span><span class="s3">+</span>
         <span class="s5">&quot;directory alongside your pure Python modules&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s5">'verbose-cfg'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">,</span>
         <span class="s5">&quot;change logging level from WARN to INFO which will show all &quot; </span><span class="s3">+</span>
         <span class="s5">&quot;compiler output&quot;</span><span class="s3">)</span>
        <span class="s3">]</span>

    <span class="s1">boolean_options </span><span class="s3">= [</span><span class="s5">'force'</span><span class="s3">, </span><span class="s5">'inplace'</span><span class="s3">, </span><span class="s5">'verbose-cfg'</span><span class="s3">]</span>

    <span class="s1">help_options </span><span class="s3">= []</span>

    <span class="s2">def </span><span class="s1">initialize_options</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">extensions </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">package </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">py_modules </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">py_modules_dict </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">build_src </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">build_lib </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">build_base </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">force </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">inplace </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">package_dir </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">f2pyflags </span><span class="s3">= </span><span class="s2">None </span><span class="s4"># obsolete</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">f2py_opts </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">swigflags </span><span class="s3">= </span><span class="s2">None </span><span class="s4"># obsolete</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">swig_opts </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">swig_cpp </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">swig </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">verbose_cfg </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s2">def </span><span class="s1">finalize_options</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">set_undefined_options</span><span class="s3">(</span><span class="s5">'build'</span><span class="s3">,</span>
                                   <span class="s3">(</span><span class="s5">'build_base'</span><span class="s3">, </span><span class="s5">'build_base'</span><span class="s3">),</span>
                                   <span class="s3">(</span><span class="s5">'build_lib'</span><span class="s3">, </span><span class="s5">'build_lib'</span><span class="s3">),</span>
                                   <span class="s3">(</span><span class="s5">'force'</span><span class="s3">, </span><span class="s5">'force'</span><span class="s3">))</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">package </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">package </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">distribution</span><span class="s3">.</span><span class="s1">ext_package</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">extensions </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">distribution</span><span class="s3">.</span><span class="s1">ext_modules</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">libraries </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">distribution</span><span class="s3">.</span><span class="s1">libraries </span><span class="s2">or </span><span class="s3">[]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">py_modules </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">distribution</span><span class="s3">.</span><span class="s1">py_modules </span><span class="s2">or </span><span class="s3">[]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">data_files </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">distribution</span><span class="s3">.</span><span class="s1">data_files </span><span class="s2">or </span><span class="s3">[]</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">build_src </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">plat_specifier </span><span class="s3">= </span><span class="s5">&quot;.{}-{}.{}&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">get_platform</span><span class="s3">(), *</span><span class="s1">sys</span><span class="s3">.</span><span class="s1">version_info</span><span class="s3">[:</span><span class="s6">2</span><span class="s3">])</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">build_src </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">build_base</span><span class="s3">, </span><span class="s5">'src'</span><span class="s3">+</span><span class="s1">plat_specifier</span><span class="s3">)</span>

        <span class="s4"># py_modules_dict is used in build_py.find_package_modules</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">py_modules_dict </span><span class="s3">= {}</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">f2pyflags</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">f2py_opts</span><span class="s3">:</span>
                <span class="s1">log</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s5">'ignoring --f2pyflags as --f2py-opts already used'</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">f2py_opts </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">f2pyflags</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">f2pyflags </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">f2py_opts </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">f2py_opts </span><span class="s3">= []</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">f2py_opts </span><span class="s3">= </span><span class="s1">shlex</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">f2py_opts</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">swigflags</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">swig_opts</span><span class="s3">:</span>
                <span class="s1">log</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s5">'ignoring --swigflags as --swig-opts already used'</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">swig_opts </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">swigflags</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">swigflags </span><span class="s3">= </span><span class="s2">None</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">swig_opts </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">swig_opts </span><span class="s3">= []</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">swig_opts </span><span class="s3">= </span><span class="s1">shlex</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">swig_opts</span><span class="s3">)</span>

        <span class="s4"># use options from build_ext command</span>
        <span class="s1">build_ext </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_finalized_command</span><span class="s3">(</span><span class="s5">'build_ext'</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">inplace </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">inplace </span><span class="s3">= </span><span class="s1">build_ext</span><span class="s3">.</span><span class="s1">inplace</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">swig_cpp </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">swig_cpp </span><span class="s3">= </span><span class="s1">build_ext</span><span class="s3">.</span><span class="s1">swig_cpp</span>
        <span class="s2">for </span><span class="s1">c </span><span class="s2">in </span><span class="s3">[</span><span class="s5">'swig'</span><span class="s3">, </span><span class="s5">'swig_opt'</span><span class="s3">]:</span>
            <span class="s1">o </span><span class="s3">= </span><span class="s5">'--'</span><span class="s3">+</span><span class="s1">c</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s5">'_'</span><span class="s3">, </span><span class="s5">'-'</span><span class="s3">)</span>
            <span class="s1">v </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">build_ext</span><span class="s3">, </span><span class="s1">c</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">v</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
                    <span class="s1">log</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s5">'both build_src and build_ext define %s option' </span><span class="s3">% (</span><span class="s1">o</span><span class="s3">))</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">log</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s5">'using &quot;%s=%s&quot; option from build_ext command' </span><span class="s3">% (</span><span class="s1">o</span><span class="s3">, </span><span class="s1">v</span><span class="s3">))</span>
                    <span class="s1">setattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">c</span><span class="s3">, </span><span class="s1">v</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">run</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">log</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s5">&quot;build_src&quot;</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">extensions </span><span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">libraries</span><span class="s3">):</span>
            <span class="s2">return</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">build_sources</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">build_sources</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">inplace</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">get_package_dir </span><span class="s3">= </span><span class="s1">\</span>
                     <span class="s1">self</span><span class="s3">.</span><span class="s1">get_finalized_command</span><span class="s3">(</span><span class="s5">'build_py'</span><span class="s3">).</span><span class="s1">get_package_dir</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">build_py_modules_sources</span><span class="s3">()</span>

        <span class="s2">for </span><span class="s1">libname_info </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">libraries</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">build_library_sources</span><span class="s3">(*</span><span class="s1">libname_info</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">extensions</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_extensions_list</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">extensions</span><span class="s3">)</span>

            <span class="s2">for </span><span class="s1">ext </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">extensions</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">build_extension_sources</span><span class="s3">(</span><span class="s1">ext</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">build_data_files_sources</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">build_npy_pkg_config</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">build_data_files_sources</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">data_files</span><span class="s3">:</span>
            <span class="s2">return</span>
        <span class="s1">log</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s5">'building data_files sources'</span><span class="s3">)</span>
        <span class="s2">from </span><span class="s1">numpy</span><span class="s3">.</span><span class="s1">distutils</span><span class="s3">.</span><span class="s1">misc_util </span><span class="s2">import </span><span class="s1">get_data_files</span>
        <span class="s1">new_data_files </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">data </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">data_files</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
                <span class="s1">new_data_files</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">tuple</span><span class="s3">):</span>
                <span class="s1">d</span><span class="s3">, </span><span class="s1">files </span><span class="s3">= </span><span class="s1">data</span>
                <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">inplace</span><span class="s3">:</span>
                    <span class="s1">build_dir </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_package_dir</span><span class="s3">(</span><span class="s5">'.'</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">d</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">)))</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">build_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">build_src</span><span class="s3">, </span><span class="s1">d</span><span class="s3">)</span>
                <span class="s1">funcs </span><span class="s3">= [</span><span class="s1">f </span><span class="s2">for </span><span class="s1">f </span><span class="s2">in </span><span class="s1">files </span><span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s5">'__call__'</span><span class="s3">)]</span>
                <span class="s1">files </span><span class="s3">= [</span><span class="s1">f </span><span class="s2">for </span><span class="s1">f </span><span class="s2">in </span><span class="s1">files </span><span class="s2">if not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s5">'__call__'</span><span class="s3">)]</span>
                <span class="s2">for </span><span class="s1">f </span><span class="s2">in </span><span class="s1">funcs</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">f</span><span class="s3">.</span><span class="s1">__code__</span><span class="s3">.</span><span class="s1">co_argcount</span><span class="s3">==</span><span class="s6">1</span><span class="s3">:</span>
                        <span class="s1">s </span><span class="s3">= </span><span class="s1">f</span><span class="s3">(</span><span class="s1">build_dir</span><span class="s3">)</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">s </span><span class="s3">= </span><span class="s1">f</span><span class="s3">()</span>
                    <span class="s2">if </span><span class="s1">s </span><span class="s2">is not None</span><span class="s3">:</span>
                        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s1">list</span><span class="s3">):</span>
                            <span class="s1">files</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">s</span><span class="s3">)</span>
                        <span class="s2">elif </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
                            <span class="s1">files</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">s</span><span class="s3">)</span>
                        <span class="s2">else</span><span class="s3">:</span>
                            <span class="s2">raise </span><span class="s1">TypeError</span><span class="s3">(</span><span class="s1">repr</span><span class="s3">(</span><span class="s1">s</span><span class="s3">))</span>
                <span class="s1">filenames </span><span class="s3">= </span><span class="s1">get_data_files</span><span class="s3">((</span><span class="s1">d</span><span class="s3">, </span><span class="s1">files</span><span class="s3">))</span>
                <span class="s1">new_data_files</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">d</span><span class="s3">, </span><span class="s1">filenames</span><span class="s3">))</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">TypeError</span><span class="s3">(</span><span class="s1">repr</span><span class="s3">(</span><span class="s1">data</span><span class="s3">))</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">data_files</span><span class="s3">[:] = </span><span class="s1">new_data_files</span>


    <span class="s2">def </span><span class="s1">_build_npy_pkg_config</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">info</span><span class="s3">, </span><span class="s1">gd</span><span class="s3">):</span>
        <span class="s1">template</span><span class="s3">, </span><span class="s1">install_dir</span><span class="s3">, </span><span class="s1">subst_dict </span><span class="s3">= </span><span class="s1">info</span>
        <span class="s1">template_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">template</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">k</span><span class="s3">, </span><span class="s1">v </span><span class="s2">in </span><span class="s1">gd</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
            <span class="s1">subst_dict</span><span class="s3">[</span><span class="s1">k</span><span class="s3">] = </span><span class="s1">v</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">inplace </span><span class="s3">== </span><span class="s6">1</span><span class="s3">:</span>
            <span class="s1">generated_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">template_dir</span><span class="s3">, </span><span class="s1">install_dir</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">generated_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">build_src</span><span class="s3">, </span><span class="s1">template_dir</span><span class="s3">,</span>
                    <span class="s1">install_dir</span><span class="s3">)</span>
        <span class="s1">generated </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">splitext</span><span class="s3">(</span><span class="s1">template</span><span class="s3">)[</span><span class="s6">0</span><span class="s3">])</span>
        <span class="s1">generated_path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">generated_dir</span><span class="s3">, </span><span class="s1">generated</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">generated_dir</span><span class="s3">):</span>
            <span class="s1">os</span><span class="s3">.</span><span class="s1">makedirs</span><span class="s3">(</span><span class="s1">generated_dir</span><span class="s3">)</span>

        <span class="s1">subst_vars</span><span class="s3">(</span><span class="s1">generated_path</span><span class="s3">, </span><span class="s1">template</span><span class="s3">, </span><span class="s1">subst_dict</span><span class="s3">)</span>

        <span class="s4"># Where to install relatively to install prefix</span>
        <span class="s1">full_install_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">template_dir</span><span class="s3">, </span><span class="s1">install_dir</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">full_install_dir</span><span class="s3">, </span><span class="s1">generated_path</span>

    <span class="s2">def </span><span class="s1">build_npy_pkg_config</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">log</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s5">'build_src: building npy-pkg config files'</span><span class="s3">)</span>

        <span class="s4"># XXX: another ugly workaround to circumvent distutils brain damage. We</span>
        <span class="s4"># need the install prefix here, but finalizing the options of the</span>
        <span class="s4"># install command when only building sources cause error. Instead, we</span>
        <span class="s4"># copy the install command instance, and finalize the copy so that it</span>
        <span class="s4"># does not disrupt how distutils want to do things when with the</span>
        <span class="s4"># original install command instance.</span>
        <span class="s1">install_cmd </span><span class="s3">= </span><span class="s1">copy</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">(</span><span class="s1">get_cmd</span><span class="s3">(</span><span class="s5">'install'</span><span class="s3">))</span>
        <span class="s2">if not </span><span class="s1">install_cmd</span><span class="s3">.</span><span class="s1">finalized </span><span class="s3">== </span><span class="s6">1</span><span class="s3">:</span>
            <span class="s1">install_cmd</span><span class="s3">.</span><span class="s1">finalize_options</span><span class="s3">()</span>
        <span class="s1">build_npkg </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">inplace </span><span class="s3">== </span><span class="s6">1</span><span class="s3">:</span>
            <span class="s1">top_prefix </span><span class="s3">= </span><span class="s5">'.'</span>
            <span class="s1">build_npkg </span><span class="s3">= </span><span class="s2">True</span>
        <span class="s2">elif </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">install_cmd</span><span class="s3">, </span><span class="s5">'install_libbase'</span><span class="s3">):</span>
            <span class="s1">top_prefix </span><span class="s3">= </span><span class="s1">install_cmd</span><span class="s3">.</span><span class="s1">install_libbase</span>
            <span class="s1">build_npkg </span><span class="s3">= </span><span class="s2">True</span>

        <span class="s2">if </span><span class="s1">build_npkg</span><span class="s3">:</span>
            <span class="s2">for </span><span class="s1">pkg</span><span class="s3">, </span><span class="s1">infos </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">distribution</span><span class="s3">.</span><span class="s1">installed_pkg_config</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
                <span class="s1">pkg_path </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">distribution</span><span class="s3">.</span><span class="s1">package_dir</span><span class="s3">[</span><span class="s1">pkg</span><span class="s3">]</span>
                <span class="s1">prefix </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">abspath</span><span class="s3">(</span><span class="s1">top_prefix</span><span class="s3">), </span><span class="s1">pkg_path</span><span class="s3">)</span>
                <span class="s1">d </span><span class="s3">= {</span><span class="s5">'prefix'</span><span class="s3">: </span><span class="s1">prefix</span><span class="s3">}</span>
                <span class="s2">for </span><span class="s1">info </span><span class="s2">in </span><span class="s1">infos</span><span class="s3">:</span>
                    <span class="s1">install_dir</span><span class="s3">, </span><span class="s1">generated </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_build_npy_pkg_config</span><span class="s3">(</span><span class="s1">info</span><span class="s3">, </span><span class="s1">d</span><span class="s3">)</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">distribution</span><span class="s3">.</span><span class="s1">data_files</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">install_dir</span><span class="s3">,</span>
                        <span class="s3">[</span><span class="s1">generated</span><span class="s3">]))</span>

    <span class="s2">def </span><span class="s1">build_py_modules_sources</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">py_modules</span><span class="s3">:</span>
            <span class="s2">return</span>
        <span class="s1">log</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s5">'building py_modules sources'</span><span class="s3">)</span>
        <span class="s1">new_py_modules </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">source </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">py_modules</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">is_sequence</span><span class="s3">(</span><span class="s1">source</span><span class="s3">) </span><span class="s2">and </span><span class="s1">len</span><span class="s3">(</span><span class="s1">source</span><span class="s3">)==</span><span class="s6">3</span><span class="s3">:</span>
                <span class="s1">package</span><span class="s3">, </span><span class="s1">module_base</span><span class="s3">, </span><span class="s1">source </span><span class="s3">= </span><span class="s1">source</span>
                <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">inplace</span><span class="s3">:</span>
                    <span class="s1">build_dir </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_package_dir</span><span class="s3">(</span><span class="s1">package</span><span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">build_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">build_src</span><span class="s3">,</span>
                                             <span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(*</span><span class="s1">package</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s5">'.'</span><span class="s3">)))</span>
                <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">source</span><span class="s3">, </span><span class="s5">'__call__'</span><span class="s3">):</span>
                    <span class="s1">target </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">build_dir</span><span class="s3">, </span><span class="s1">module_base </span><span class="s3">+ </span><span class="s5">'.py'</span><span class="s3">)</span>
                    <span class="s1">source </span><span class="s3">= </span><span class="s1">source</span><span class="s3">(</span><span class="s1">target</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">source </span><span class="s2">is None</span><span class="s3">:</span>
                    <span class="s2">continue</span>
                <span class="s1">modules </span><span class="s3">= [(</span><span class="s1">package</span><span class="s3">, </span><span class="s1">module_base</span><span class="s3">, </span><span class="s1">source</span><span class="s3">)]</span>
                <span class="s2">if </span><span class="s1">package </span><span class="s2">not in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">py_modules_dict</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">py_modules_dict</span><span class="s3">[</span><span class="s1">package</span><span class="s3">] = []</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">py_modules_dict</span><span class="s3">[</span><span class="s1">package</span><span class="s3">] += </span><span class="s1">modules</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">new_py_modules</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">source</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">py_modules</span><span class="s3">[:] = </span><span class="s1">new_py_modules</span>

    <span class="s2">def </span><span class="s1">build_library_sources</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">lib_name</span><span class="s3">, </span><span class="s1">build_info</span><span class="s3">):</span>
        <span class="s1">sources </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">build_info</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s5">'sources'</span><span class="s3">, []))</span>

        <span class="s2">if not </span><span class="s1">sources</span><span class="s3">:</span>
            <span class="s2">return</span>

        <span class="s1">log</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s5">'building library &quot;%s&quot; sources' </span><span class="s3">% (</span><span class="s1">lib_name</span><span class="s3">))</span>

        <span class="s1">sources </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">generate_sources</span><span class="s3">(</span><span class="s1">sources</span><span class="s3">, (</span><span class="s1">lib_name</span><span class="s3">, </span><span class="s1">build_info</span><span class="s3">))</span>

        <span class="s1">sources </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">template_sources</span><span class="s3">(</span><span class="s1">sources</span><span class="s3">, (</span><span class="s1">lib_name</span><span class="s3">, </span><span class="s1">build_info</span><span class="s3">))</span>

        <span class="s1">sources</span><span class="s3">, </span><span class="s1">h_files </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">filter_h_files</span><span class="s3">(</span><span class="s1">sources</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">h_files</span><span class="s3">:</span>
            <span class="s1">log</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s5">'%s - nothing done with h_files = %s'</span><span class="s3">,</span>
                     <span class="s1">self</span><span class="s3">.</span><span class="s1">package</span><span class="s3">, </span><span class="s1">h_files</span><span class="s3">)</span>

        <span class="s4">#for f in h_files:</span>
        <span class="s4">#    self.distribution.headers.append((lib_name,f))</span>

        <span class="s1">build_info</span><span class="s3">[</span><span class="s5">'sources'</span><span class="s3">] = </span><span class="s1">sources</span>
        <span class="s2">return</span>

    <span class="s2">def </span><span class="s1">build_extension_sources</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">ext</span><span class="s3">):</span>

        <span class="s1">sources </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">ext</span><span class="s3">.</span><span class="s1">sources</span><span class="s3">)</span>

        <span class="s1">log</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s5">'building extension &quot;%s&quot; sources' </span><span class="s3">% (</span><span class="s1">ext</span><span class="s3">.</span><span class="s1">name</span><span class="s3">))</span>

        <span class="s1">fullname </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_ext_fullname</span><span class="s3">(</span><span class="s1">ext</span><span class="s3">.</span><span class="s1">name</span><span class="s3">)</span>

        <span class="s1">modpath </span><span class="s3">= </span><span class="s1">fullname</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s5">'.'</span><span class="s3">)</span>
        <span class="s1">package </span><span class="s3">= </span><span class="s5">'.'</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">modpath</span><span class="s3">[</span><span class="s6">0</span><span class="s3">:-</span><span class="s6">1</span><span class="s3">])</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">inplace</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">ext_target_dir </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_package_dir</span><span class="s3">(</span><span class="s1">package</span><span class="s3">)</span>

        <span class="s1">sources </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">generate_sources</span><span class="s3">(</span><span class="s1">sources</span><span class="s3">, </span><span class="s1">ext</span><span class="s3">)</span>
        <span class="s1">sources </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">template_sources</span><span class="s3">(</span><span class="s1">sources</span><span class="s3">, </span><span class="s1">ext</span><span class="s3">)</span>
        <span class="s1">sources </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">swig_sources</span><span class="s3">(</span><span class="s1">sources</span><span class="s3">, </span><span class="s1">ext</span><span class="s3">)</span>
        <span class="s1">sources </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">f2py_sources</span><span class="s3">(</span><span class="s1">sources</span><span class="s3">, </span><span class="s1">ext</span><span class="s3">)</span>
        <span class="s1">sources </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pyrex_sources</span><span class="s3">(</span><span class="s1">sources</span><span class="s3">, </span><span class="s1">ext</span><span class="s3">)</span>

        <span class="s1">sources</span><span class="s3">, </span><span class="s1">py_files </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">filter_py_files</span><span class="s3">(</span><span class="s1">sources</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">package </span><span class="s2">not in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">py_modules_dict</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">py_modules_dict</span><span class="s3">[</span><span class="s1">package</span><span class="s3">] = []</span>
        <span class="s1">modules </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">f </span><span class="s2">in </span><span class="s1">py_files</span><span class="s3">:</span>
            <span class="s1">module </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">splitext</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">f</span><span class="s3">))[</span><span class="s6">0</span><span class="s3">]</span>
            <span class="s1">modules</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">package</span><span class="s3">, </span><span class="s1">module</span><span class="s3">, </span><span class="s1">f</span><span class="s3">))</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">py_modules_dict</span><span class="s3">[</span><span class="s1">package</span><span class="s3">] += </span><span class="s1">modules</span>

        <span class="s1">sources</span><span class="s3">, </span><span class="s1">h_files </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">filter_h_files</span><span class="s3">(</span><span class="s1">sources</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">h_files</span><span class="s3">:</span>
            <span class="s1">log</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s5">'%s - nothing done with h_files = %s'</span><span class="s3">,</span>
                     <span class="s1">package</span><span class="s3">, </span><span class="s1">h_files</span><span class="s3">)</span>
        <span class="s4">#for f in h_files:</span>
        <span class="s4">#    self.distribution.headers.append((package,f))</span>

        <span class="s1">ext</span><span class="s3">.</span><span class="s1">sources </span><span class="s3">= </span><span class="s1">sources</span>

    <span class="s2">def </span><span class="s1">generate_sources</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">sources</span><span class="s3">, </span><span class="s1">extension</span><span class="s3">):</span>
        <span class="s1">new_sources </span><span class="s3">= []</span>
        <span class="s1">func_sources </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">source </span><span class="s2">in </span><span class="s1">sources</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">is_string</span><span class="s3">(</span><span class="s1">source</span><span class="s3">):</span>
                <span class="s1">new_sources</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">source</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">func_sources</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">source</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">func_sources</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">new_sources</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">inplace </span><span class="s2">and not </span><span class="s1">is_sequence</span><span class="s3">(</span><span class="s1">extension</span><span class="s3">):</span>
            <span class="s1">build_dir </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">ext_target_dir</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">is_sequence</span><span class="s3">(</span><span class="s1">extension</span><span class="s3">):</span>
                <span class="s1">name </span><span class="s3">= </span><span class="s1">extension</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]</span>
            <span class="s4">#    if 'include_dirs' not in extension[1]:</span>
            <span class="s4">#        extension[1]['include_dirs'] = []</span>
            <span class="s4">#    incl_dirs = extension[1]['include_dirs']</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">name </span><span class="s3">= </span><span class="s1">extension</span><span class="s3">.</span><span class="s1">name</span>
            <span class="s4">#    incl_dirs = extension.include_dirs</span>
            <span class="s4">#if self.build_src not in incl_dirs:</span>
            <span class="s4">#    incl_dirs.append(self.build_src)</span>
            <span class="s1">build_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(*([</span><span class="s1">self</span><span class="s3">.</span><span class="s1">build_src</span><span class="s3">]</span>
                                       <span class="s3">+</span><span class="s1">name</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s5">'.'</span><span class="s3">)[:-</span><span class="s6">1</span><span class="s3">]))</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">mkpath</span><span class="s3">(</span><span class="s1">build_dir</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">verbose_cfg</span><span class="s3">:</span>
            <span class="s1">new_level </span><span class="s3">= </span><span class="s1">log</span><span class="s3">.</span><span class="s1">INFO</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">new_level </span><span class="s3">= </span><span class="s1">log</span><span class="s3">.</span><span class="s1">WARN</span>
        <span class="s1">old_level </span><span class="s3">= </span><span class="s1">log</span><span class="s3">.</span><span class="s1">set_threshold</span><span class="s3">(</span><span class="s1">new_level</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">func </span><span class="s2">in </span><span class="s1">func_sources</span><span class="s3">:</span>
            <span class="s1">source </span><span class="s3">= </span><span class="s1">func</span><span class="s3">(</span><span class="s1">extension</span><span class="s3">, </span><span class="s1">build_dir</span><span class="s3">)</span>
            <span class="s2">if not </span><span class="s1">source</span><span class="s3">:</span>
                <span class="s2">continue</span>
            <span class="s2">if </span><span class="s1">is_sequence</span><span class="s3">(</span><span class="s1">source</span><span class="s3">):</span>
                <span class="s3">[</span><span class="s1">log</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s5">&quot;  adding '%s' to sources.&quot; </span><span class="s3">% (</span><span class="s1">s</span><span class="s3">,)) </span><span class="s2">for </span><span class="s1">s </span><span class="s2">in </span><span class="s1">source</span><span class="s3">]</span>
                <span class="s1">new_sources</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">source</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">log</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s5">&quot;  adding '%s' to sources.&quot; </span><span class="s3">% (</span><span class="s1">source</span><span class="s3">,))</span>
                <span class="s1">new_sources</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">source</span><span class="s3">)</span>
        <span class="s1">log</span><span class="s3">.</span><span class="s1">set_threshold</span><span class="s3">(</span><span class="s1">old_level</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">new_sources</span>

    <span class="s2">def </span><span class="s1">filter_py_files</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">sources</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">filter_files</span><span class="s3">(</span><span class="s1">sources</span><span class="s3">, [</span><span class="s5">'.py'</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">filter_h_files</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">sources</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">filter_files</span><span class="s3">(</span><span class="s1">sources</span><span class="s3">, [</span><span class="s5">'.h'</span><span class="s3">, </span><span class="s5">'.hpp'</span><span class="s3">, </span><span class="s5">'.inc'</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">filter_files</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">sources</span><span class="s3">, </span><span class="s1">exts </span><span class="s3">= []):</span>
        <span class="s1">new_sources </span><span class="s3">= []</span>
        <span class="s1">files </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">source </span><span class="s2">in </span><span class="s1">sources</span><span class="s3">:</span>
            <span class="s3">(</span><span class="s1">base</span><span class="s3">, </span><span class="s1">ext</span><span class="s3">) = </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">splitext</span><span class="s3">(</span><span class="s1">source</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">ext </span><span class="s2">in </span><span class="s1">exts</span><span class="s3">:</span>
                <span class="s1">files</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">source</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">new_sources</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">source</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">new_sources</span><span class="s3">, </span><span class="s1">files</span>

    <span class="s2">def </span><span class="s1">template_sources</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">sources</span><span class="s3">, </span><span class="s1">extension</span><span class="s3">):</span>
        <span class="s1">new_sources </span><span class="s3">= []</span>
        <span class="s2">if </span><span class="s1">is_sequence</span><span class="s3">(</span><span class="s1">extension</span><span class="s3">):</span>
            <span class="s1">depends </span><span class="s3">= </span><span class="s1">extension</span><span class="s3">[</span><span class="s6">1</span><span class="s3">].</span><span class="s1">get</span><span class="s3">(</span><span class="s5">'depends'</span><span class="s3">)</span>
            <span class="s1">include_dirs </span><span class="s3">= </span><span class="s1">extension</span><span class="s3">[</span><span class="s6">1</span><span class="s3">].</span><span class="s1">get</span><span class="s3">(</span><span class="s5">'include_dirs'</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">depends </span><span class="s3">= </span><span class="s1">extension</span><span class="s3">.</span><span class="s1">depends</span>
            <span class="s1">include_dirs </span><span class="s3">= </span><span class="s1">extension</span><span class="s3">.</span><span class="s1">include_dirs</span>
        <span class="s2">for </span><span class="s1">source </span><span class="s2">in </span><span class="s1">sources</span><span class="s3">:</span>
            <span class="s3">(</span><span class="s1">base</span><span class="s3">, </span><span class="s1">ext</span><span class="s3">) = </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">splitext</span><span class="s3">(</span><span class="s1">source</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">ext </span><span class="s3">== </span><span class="s5">'.src'</span><span class="s3">:  </span><span class="s4"># Template file</span>
                <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">inplace</span><span class="s3">:</span>
                    <span class="s1">target_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">base</span><span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">target_dir </span><span class="s3">= </span><span class="s1">appendpath</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">build_src</span><span class="s3">, </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">base</span><span class="s3">))</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">mkpath</span><span class="s3">(</span><span class="s1">target_dir</span><span class="s3">)</span>
                <span class="s1">target_file </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">target_dir</span><span class="s3">, </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">base</span><span class="s3">))</span>
                <span class="s2">if </span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">force </span><span class="s2">or </span><span class="s1">newer_group</span><span class="s3">([</span><span class="s1">source</span><span class="s3">] + </span><span class="s1">depends</span><span class="s3">, </span><span class="s1">target_file</span><span class="s3">)):</span>
                    <span class="s2">if </span><span class="s1">_f_pyf_ext_match</span><span class="s3">(</span><span class="s1">base</span><span class="s3">):</span>
                        <span class="s1">log</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s5">&quot;from_template:&gt; %s&quot; </span><span class="s3">% (</span><span class="s1">target_file</span><span class="s3">))</span>
                        <span class="s1">outstr </span><span class="s3">= </span><span class="s1">process_f_file</span><span class="s3">(</span><span class="s1">source</span><span class="s3">)</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">log</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s5">&quot;conv_template:&gt; %s&quot; </span><span class="s3">% (</span><span class="s1">target_file</span><span class="s3">))</span>
                        <span class="s1">outstr </span><span class="s3">= </span><span class="s1">process_c_file</span><span class="s3">(</span><span class="s1">source</span><span class="s3">)</span>
                    <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">target_file</span><span class="s3">, </span><span class="s5">'w'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">fid</span><span class="s3">:</span>
                        <span class="s1">fid</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">outstr</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">_header_ext_match</span><span class="s3">(</span><span class="s1">target_file</span><span class="s3">):</span>
                    <span class="s1">d </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">target_file</span><span class="s3">)</span>
                    <span class="s2">if </span><span class="s1">d </span><span class="s2">not in </span><span class="s1">include_dirs</span><span class="s3">:</span>
                        <span class="s1">log</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s5">&quot;  adding '%s' to include_dirs.&quot; </span><span class="s3">% (</span><span class="s1">d</span><span class="s3">))</span>
                        <span class="s1">include_dirs</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">d</span><span class="s3">)</span>
                <span class="s1">new_sources</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">target_file</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">new_sources</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">source</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">new_sources</span>

    <span class="s2">def </span><span class="s1">pyrex_sources</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">sources</span><span class="s3">, </span><span class="s1">extension</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Pyrex not supported; this remains for Cython support (see below)&quot;&quot;&quot;</span>
        <span class="s1">new_sources </span><span class="s3">= []</span>
        <span class="s1">ext_name </span><span class="s3">= </span><span class="s1">extension</span><span class="s3">.</span><span class="s1">name</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s5">'.'</span><span class="s3">)[-</span><span class="s6">1</span><span class="s3">]</span>
        <span class="s2">for </span><span class="s1">source </span><span class="s2">in </span><span class="s1">sources</span><span class="s3">:</span>
            <span class="s3">(</span><span class="s1">base</span><span class="s3">, </span><span class="s1">ext</span><span class="s3">) = </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">splitext</span><span class="s3">(</span><span class="s1">source</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">ext </span><span class="s3">== </span><span class="s5">'.pyx'</span><span class="s3">:</span>
                <span class="s1">target_file </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">generate_a_pyrex_source</span><span class="s3">(</span><span class="s1">base</span><span class="s3">, </span><span class="s1">ext_name</span><span class="s3">,</span>
                                                           <span class="s1">source</span><span class="s3">,</span>
                                                           <span class="s1">extension</span><span class="s3">)</span>
                <span class="s1">new_sources</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">target_file</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">new_sources</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">source</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">new_sources</span>

    <span class="s2">def </span><span class="s1">generate_a_pyrex_source</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">base</span><span class="s3">, </span><span class="s1">ext_name</span><span class="s3">, </span><span class="s1">source</span><span class="s3">, </span><span class="s1">extension</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Pyrex is not supported, but some projects monkeypatch this method. 
 
        That allows compiling Cython code, see gh-6955. 
        This method will remain here for compatibility reasons. 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s3">[]</span>

    <span class="s2">def </span><span class="s1">f2py_sources</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">sources</span><span class="s3">, </span><span class="s1">extension</span><span class="s3">):</span>
        <span class="s1">new_sources </span><span class="s3">= []</span>
        <span class="s1">f2py_sources </span><span class="s3">= []</span>
        <span class="s1">f_sources </span><span class="s3">= []</span>
        <span class="s1">f2py_targets </span><span class="s3">= {}</span>
        <span class="s1">target_dirs </span><span class="s3">= []</span>
        <span class="s1">ext_name </span><span class="s3">= </span><span class="s1">extension</span><span class="s3">.</span><span class="s1">name</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s5">'.'</span><span class="s3">)[-</span><span class="s6">1</span><span class="s3">]</span>
        <span class="s1">skip_f2py </span><span class="s3">= </span><span class="s6">0</span>

        <span class="s2">for </span><span class="s1">source </span><span class="s2">in </span><span class="s1">sources</span><span class="s3">:</span>
            <span class="s3">(</span><span class="s1">base</span><span class="s3">, </span><span class="s1">ext</span><span class="s3">) = </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">splitext</span><span class="s3">(</span><span class="s1">source</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">ext </span><span class="s3">== </span><span class="s5">'.pyf'</span><span class="s3">: </span><span class="s4"># F2PY interface file</span>
                <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">inplace</span><span class="s3">:</span>
                    <span class="s1">target_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">base</span><span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">target_dir </span><span class="s3">= </span><span class="s1">appendpath</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">build_src</span><span class="s3">, </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">base</span><span class="s3">))</span>
                <span class="s2">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isfile</span><span class="s3">(</span><span class="s1">source</span><span class="s3">):</span>
                    <span class="s1">name </span><span class="s3">= </span><span class="s1">get_f2py_modulename</span><span class="s3">(</span><span class="s1">source</span><span class="s3">)</span>
                    <span class="s2">if </span><span class="s1">name </span><span class="s3">!= </span><span class="s1">ext_name</span><span class="s3">:</span>
                        <span class="s2">raise </span><span class="s1">DistutilsSetupError</span><span class="s3">(</span><span class="s5">'mismatch of extension names: %s '</span>
                                                  <span class="s5">'provides %r but expected %r' </span><span class="s3">% (</span>
                            <span class="s1">source</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">ext_name</span><span class="s3">))</span>
                    <span class="s1">target_file </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">target_dir</span><span class="s3">, </span><span class="s1">name</span><span class="s3">+</span><span class="s5">'module.c'</span><span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">log</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s5">'  source %s does not exist: skipping f2py</span><span class="s2">\'</span><span class="s5">ing.' </span><span class="s1">\</span>
                              <span class="s3">% (</span><span class="s1">source</span><span class="s3">))</span>
                    <span class="s1">name </span><span class="s3">= </span><span class="s1">ext_name</span>
                    <span class="s1">skip_f2py </span><span class="s3">= </span><span class="s6">1</span>
                    <span class="s1">target_file </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">target_dir</span><span class="s3">, </span><span class="s1">name</span><span class="s3">+</span><span class="s5">'module.c'</span><span class="s3">)</span>
                    <span class="s2">if not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isfile</span><span class="s3">(</span><span class="s1">target_file</span><span class="s3">):</span>
                        <span class="s1">log</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s5">'  target %s does not exist:</span><span class="s2">\n   </span><span class="s5">'</span><span class="s1">\</span>
                                 <span class="s5">'Assuming %smodule.c was generated with '</span><span class="s1">\</span>
                                 <span class="s5">'&quot;build_src --inplace&quot; command.' </span><span class="s1">\</span>
                                 <span class="s3">% (</span><span class="s1">target_file</span><span class="s3">, </span><span class="s1">name</span><span class="s3">))</span>
                        <span class="s1">target_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">base</span><span class="s3">)</span>
                        <span class="s1">target_file </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">target_dir</span><span class="s3">, </span><span class="s1">name</span><span class="s3">+</span><span class="s5">'module.c'</span><span class="s3">)</span>
                        <span class="s2">if not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isfile</span><span class="s3">(</span><span class="s1">target_file</span><span class="s3">):</span>
                            <span class="s2">raise </span><span class="s1">DistutilsSetupError</span><span class="s3">(</span><span class="s5">&quot;%r missing&quot; </span><span class="s3">% (</span><span class="s1">target_file</span><span class="s3">,))</span>
                        <span class="s1">log</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s5">'   Yes! Using %r as up-to-date target.' </span><span class="s1">\</span>
                                 <span class="s3">% (</span><span class="s1">target_file</span><span class="s3">))</span>
                <span class="s1">target_dirs</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">target_dir</span><span class="s3">)</span>
                <span class="s1">f2py_sources</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">source</span><span class="s3">)</span>
                <span class="s1">f2py_targets</span><span class="s3">[</span><span class="s1">source</span><span class="s3">] = </span><span class="s1">target_file</span>
                <span class="s1">new_sources</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">target_file</span><span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">fortran_ext_match</span><span class="s3">(</span><span class="s1">ext</span><span class="s3">):</span>
                <span class="s1">f_sources</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">source</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">new_sources</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">source</span><span class="s3">)</span>

        <span class="s2">if not </span><span class="s3">(</span><span class="s1">f2py_sources </span><span class="s2">or </span><span class="s1">f_sources</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">new_sources</span>

        <span class="s2">for </span><span class="s1">d </span><span class="s2">in </span><span class="s1">target_dirs</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">mkpath</span><span class="s3">(</span><span class="s1">d</span><span class="s3">)</span>

        <span class="s1">f2py_options </span><span class="s3">= </span><span class="s1">extension</span><span class="s3">.</span><span class="s1">f2py_options </span><span class="s3">+ </span><span class="s1">self</span><span class="s3">.</span><span class="s1">f2py_opts</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">distribution</span><span class="s3">.</span><span class="s1">libraries</span><span class="s3">:</span>
            <span class="s2">for </span><span class="s1">name</span><span class="s3">, </span><span class="s1">build_info </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">distribution</span><span class="s3">.</span><span class="s1">libraries</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">name </span><span class="s2">in </span><span class="s1">extension</span><span class="s3">.</span><span class="s1">libraries</span><span class="s3">:</span>
                    <span class="s1">f2py_options</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">build_info</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s5">'f2py_options'</span><span class="s3">, []))</span>

        <span class="s1">log</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s5">&quot;f2py options: %s&quot; </span><span class="s3">% (</span><span class="s1">f2py_options</span><span class="s3">))</span>

        <span class="s2">if </span><span class="s1">f2py_sources</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">f2py_sources</span><span class="s3">) != </span><span class="s6">1</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">DistutilsSetupError</span><span class="s3">(</span>
                    <span class="s5">'only one .pyf file is allowed per extension module but got'</span><span class="s1">\</span>
                    <span class="s5">' more: %r' </span><span class="s3">% (</span><span class="s1">f2py_sources</span><span class="s3">,))</span>
            <span class="s1">source </span><span class="s3">= </span><span class="s1">f2py_sources</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]</span>
            <span class="s1">target_file </span><span class="s3">= </span><span class="s1">f2py_targets</span><span class="s3">[</span><span class="s1">source</span><span class="s3">]</span>
            <span class="s1">target_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">target_file</span><span class="s3">) </span><span class="s2">or </span><span class="s5">'.'</span>
            <span class="s1">depends </span><span class="s3">= [</span><span class="s1">source</span><span class="s3">] + </span><span class="s1">extension</span><span class="s3">.</span><span class="s1">depends</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">force </span><span class="s2">or </span><span class="s1">newer_group</span><span class="s3">(</span><span class="s1">depends</span><span class="s3">, </span><span class="s1">target_file</span><span class="s3">, </span><span class="s5">'newer'</span><span class="s3">)) </span><span class="s1">\</span>
                   <span class="s2">and not </span><span class="s1">skip_f2py</span><span class="s3">:</span>
                <span class="s1">log</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s5">&quot;f2py: %s&quot; </span><span class="s3">% (</span><span class="s1">source</span><span class="s3">))</span>
                <span class="s2">from </span><span class="s1">numpy</span><span class="s3">.</span><span class="s1">f2py </span><span class="s2">import </span><span class="s1">f2py2e</span>
                <span class="s1">f2py2e</span><span class="s3">.</span><span class="s1">run_main</span><span class="s3">(</span><span class="s1">f2py_options</span>
                                    <span class="s3">+ [</span><span class="s5">'--build-dir'</span><span class="s3">, </span><span class="s1">target_dir</span><span class="s3">, </span><span class="s1">source</span><span class="s3">])</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">log</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s5">&quot;  skipping '%s' f2py interface (up-to-date)&quot; </span><span class="s3">% (</span><span class="s1">source</span><span class="s3">))</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s4">#XXX TODO: --inplace support for sdist command</span>
            <span class="s2">if </span><span class="s1">is_sequence</span><span class="s3">(</span><span class="s1">extension</span><span class="s3">):</span>
                <span class="s1">name </span><span class="s3">= </span><span class="s1">extension</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]</span>
            <span class="s2">else</span><span class="s3">: </span><span class="s1">name </span><span class="s3">= </span><span class="s1">extension</span><span class="s3">.</span><span class="s1">name</span>
            <span class="s1">target_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(*([</span><span class="s1">self</span><span class="s3">.</span><span class="s1">build_src</span><span class="s3">]</span>
                                        <span class="s3">+</span><span class="s1">name</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s5">'.'</span><span class="s3">)[:-</span><span class="s6">1</span><span class="s3">]))</span>
            <span class="s1">target_file </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">target_dir</span><span class="s3">, </span><span class="s1">ext_name </span><span class="s3">+ </span><span class="s5">'module.c'</span><span class="s3">)</span>
            <span class="s1">new_sources</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">target_file</span><span class="s3">)</span>
            <span class="s1">depends </span><span class="s3">= </span><span class="s1">f_sources </span><span class="s3">+ </span><span class="s1">extension</span><span class="s3">.</span><span class="s1">depends</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">force </span><span class="s2">or </span><span class="s1">newer_group</span><span class="s3">(</span><span class="s1">depends</span><span class="s3">, </span><span class="s1">target_file</span><span class="s3">, </span><span class="s5">'newer'</span><span class="s3">)) </span><span class="s1">\</span>
                   <span class="s2">and not </span><span class="s1">skip_f2py</span><span class="s3">:</span>
                <span class="s1">log</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s5">&quot;f2py:&gt; %s&quot; </span><span class="s3">% (</span><span class="s1">target_file</span><span class="s3">))</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">mkpath</span><span class="s3">(</span><span class="s1">target_dir</span><span class="s3">)</span>
                <span class="s2">from </span><span class="s1">numpy</span><span class="s3">.</span><span class="s1">f2py </span><span class="s2">import </span><span class="s1">f2py2e</span>
                <span class="s1">f2py2e</span><span class="s3">.</span><span class="s1">run_main</span><span class="s3">(</span><span class="s1">f2py_options </span><span class="s3">+ [</span><span class="s5">'--lower'</span><span class="s3">,</span>
                                                <span class="s5">'--build-dir'</span><span class="s3">, </span><span class="s1">target_dir</span><span class="s3">]+</span><span class="s1">\</span>
                                <span class="s3">[</span><span class="s5">'-m'</span><span class="s3">, </span><span class="s1">ext_name</span><span class="s3">]+</span><span class="s1">f_sources</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">log</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s5">&quot;  skipping f2py fortran files for '%s' (up-to-date)&quot;</span><span class="s1">\</span>
                          <span class="s3">% (</span><span class="s1">target_file</span><span class="s3">))</span>

        <span class="s2">if not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isfile</span><span class="s3">(</span><span class="s1">target_file</span><span class="s3">):</span>
            <span class="s2">raise </span><span class="s1">DistutilsError</span><span class="s3">(</span><span class="s5">&quot;f2py target file %r not generated&quot; </span><span class="s3">% (</span><span class="s1">target_file</span><span class="s3">,))</span>

        <span class="s1">build_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">build_src</span><span class="s3">, </span><span class="s1">target_dir</span><span class="s3">)</span>
        <span class="s1">target_c </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">build_dir</span><span class="s3">, </span><span class="s5">'fortranobject.c'</span><span class="s3">)</span>
        <span class="s1">target_h </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">build_dir</span><span class="s3">, </span><span class="s5">'fortranobject.h'</span><span class="s3">)</span>
        <span class="s1">log</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s5">&quot;  adding '%s' to sources.&quot; </span><span class="s3">% (</span><span class="s1">target_c</span><span class="s3">))</span>
        <span class="s1">new_sources</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">target_c</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">build_dir </span><span class="s2">not in </span><span class="s1">extension</span><span class="s3">.</span><span class="s1">include_dirs</span><span class="s3">:</span>
            <span class="s1">log</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s5">&quot;  adding '%s' to include_dirs.&quot; </span><span class="s3">% (</span><span class="s1">build_dir</span><span class="s3">))</span>
            <span class="s1">extension</span><span class="s3">.</span><span class="s1">include_dirs</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">build_dir</span><span class="s3">)</span>

        <span class="s2">if not </span><span class="s1">skip_f2py</span><span class="s3">:</span>
            <span class="s2">import </span><span class="s1">numpy</span><span class="s3">.</span><span class="s1">f2py</span>
            <span class="s1">d </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">numpy</span><span class="s3">.</span><span class="s1">f2py</span><span class="s3">.</span><span class="s1">__file__</span><span class="s3">)</span>
            <span class="s1">source_c </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">d</span><span class="s3">, </span><span class="s5">'src'</span><span class="s3">, </span><span class="s5">'fortranobject.c'</span><span class="s3">)</span>
            <span class="s1">source_h </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">d</span><span class="s3">, </span><span class="s5">'src'</span><span class="s3">, </span><span class="s5">'fortranobject.h'</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">newer</span><span class="s3">(</span><span class="s1">source_c</span><span class="s3">, </span><span class="s1">target_c</span><span class="s3">) </span><span class="s2">or </span><span class="s1">newer</span><span class="s3">(</span><span class="s1">source_h</span><span class="s3">, </span><span class="s1">target_h</span><span class="s3">):</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">mkpath</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">target_c</span><span class="s3">))</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">copy_file</span><span class="s3">(</span><span class="s1">source_c</span><span class="s3">, </span><span class="s1">target_c</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">copy_file</span><span class="s3">(</span><span class="s1">source_h</span><span class="s3">, </span><span class="s1">target_h</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">if not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isfile</span><span class="s3">(</span><span class="s1">target_c</span><span class="s3">):</span>
                <span class="s2">raise </span><span class="s1">DistutilsSetupError</span><span class="s3">(</span><span class="s5">&quot;f2py target_c file %r not found&quot; </span><span class="s3">% (</span><span class="s1">target_c</span><span class="s3">,))</span>
            <span class="s2">if not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isfile</span><span class="s3">(</span><span class="s1">target_h</span><span class="s3">):</span>
                <span class="s2">raise </span><span class="s1">DistutilsSetupError</span><span class="s3">(</span><span class="s5">&quot;f2py target_h file %r not found&quot; </span><span class="s3">% (</span><span class="s1">target_h</span><span class="s3">,))</span>

        <span class="s2">for </span><span class="s1">name_ext </span><span class="s2">in </span><span class="s3">[</span><span class="s5">'-f2pywrappers.f'</span><span class="s3">, </span><span class="s5">'-f2pywrappers2.f90'</span><span class="s3">]:</span>
            <span class="s1">filename </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">target_dir</span><span class="s3">, </span><span class="s1">ext_name </span><span class="s3">+ </span><span class="s1">name_ext</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isfile</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">):</span>
                <span class="s1">log</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s5">&quot;  adding '%s' to sources.&quot; </span><span class="s3">% (</span><span class="s1">filename</span><span class="s3">))</span>
                <span class="s1">f_sources</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">)</span>

        <span class="s2">return </span><span class="s1">new_sources </span><span class="s3">+ </span><span class="s1">f_sources</span>

    <span class="s2">def </span><span class="s1">swig_sources</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">sources</span><span class="s3">, </span><span class="s1">extension</span><span class="s3">):</span>
        <span class="s4"># Assuming SWIG 1.3.14 or later. See compatibility note in</span>
        <span class="s4">#   http://www.swig.org/Doc1.3/Python.html#Python_nn6</span>

        <span class="s1">new_sources </span><span class="s3">= []</span>
        <span class="s1">swig_sources </span><span class="s3">= []</span>
        <span class="s1">swig_targets </span><span class="s3">= {}</span>
        <span class="s1">target_dirs </span><span class="s3">= []</span>
        <span class="s1">py_files </span><span class="s3">= []     </span><span class="s4"># swig generated .py files</span>
        <span class="s1">target_ext </span><span class="s3">= </span><span class="s5">'.c'</span>
        <span class="s2">if </span><span class="s5">'-c++' </span><span class="s2">in </span><span class="s1">extension</span><span class="s3">.</span><span class="s1">swig_opts</span><span class="s3">:</span>
            <span class="s1">typ </span><span class="s3">= </span><span class="s5">'c++'</span>
            <span class="s1">is_cpp </span><span class="s3">= </span><span class="s2">True</span>
            <span class="s1">extension</span><span class="s3">.</span><span class="s1">swig_opts</span><span class="s3">.</span><span class="s1">remove</span><span class="s3">(</span><span class="s5">'-c++'</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">self</span><span class="s3">.</span><span class="s1">swig_cpp</span><span class="s3">:</span>
            <span class="s1">typ </span><span class="s3">= </span><span class="s5">'c++'</span>
            <span class="s1">is_cpp </span><span class="s3">= </span><span class="s2">True</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">typ </span><span class="s3">= </span><span class="s2">None</span>
            <span class="s1">is_cpp </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s1">skip_swig </span><span class="s3">= </span><span class="s6">0</span>
        <span class="s1">ext_name </span><span class="s3">= </span><span class="s1">extension</span><span class="s3">.</span><span class="s1">name</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s5">'.'</span><span class="s3">)[-</span><span class="s6">1</span><span class="s3">]</span>

        <span class="s2">for </span><span class="s1">source </span><span class="s2">in </span><span class="s1">sources</span><span class="s3">:</span>
            <span class="s3">(</span><span class="s1">base</span><span class="s3">, </span><span class="s1">ext</span><span class="s3">) = </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">splitext</span><span class="s3">(</span><span class="s1">source</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">ext </span><span class="s3">== </span><span class="s5">'.i'</span><span class="s3">: </span><span class="s4"># SWIG interface file</span>
                <span class="s4"># the code below assumes that the sources list</span>
                <span class="s4"># contains not more than one .i SWIG interface file</span>
                <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">inplace</span><span class="s3">:</span>
                    <span class="s1">target_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">base</span><span class="s3">)</span>
                    <span class="s1">py_target_dir </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">ext_target_dir</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">target_dir </span><span class="s3">= </span><span class="s1">appendpath</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">build_src</span><span class="s3">, </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">base</span><span class="s3">))</span>
                    <span class="s1">py_target_dir </span><span class="s3">= </span><span class="s1">target_dir</span>
                <span class="s2">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isfile</span><span class="s3">(</span><span class="s1">source</span><span class="s3">):</span>
                    <span class="s1">name </span><span class="s3">= </span><span class="s1">get_swig_modulename</span><span class="s3">(</span><span class="s1">source</span><span class="s3">)</span>
                    <span class="s2">if </span><span class="s1">name </span><span class="s3">!= </span><span class="s1">ext_name</span><span class="s3">[</span><span class="s6">1</span><span class="s3">:]:</span>
                        <span class="s2">raise </span><span class="s1">DistutilsSetupError</span><span class="s3">(</span>
                            <span class="s5">'mismatch of extension names: %s provides %r'</span>
                            <span class="s5">' but expected %r' </span><span class="s3">% (</span><span class="s1">source</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">ext_name</span><span class="s3">[</span><span class="s6">1</span><span class="s3">:]))</span>
                    <span class="s2">if </span><span class="s1">typ </span><span class="s2">is None</span><span class="s3">:</span>
                        <span class="s1">typ </span><span class="s3">= </span><span class="s1">get_swig_target</span><span class="s3">(</span><span class="s1">source</span><span class="s3">)</span>
                        <span class="s1">is_cpp </span><span class="s3">= </span><span class="s1">typ</span><span class="s3">==</span><span class="s5">'c++'</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">typ2 </span><span class="s3">= </span><span class="s1">get_swig_target</span><span class="s3">(</span><span class="s1">source</span><span class="s3">)</span>
                        <span class="s2">if </span><span class="s1">typ2 </span><span class="s2">is None</span><span class="s3">:</span>
                            <span class="s1">log</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s5">'source %r does not define swig target, assuming %s swig target' </span><span class="s1">\</span>
                                     <span class="s3">% (</span><span class="s1">source</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">))</span>
                        <span class="s2">elif </span><span class="s1">typ</span><span class="s3">!=</span><span class="s1">typ2</span><span class="s3">:</span>
                            <span class="s1">log</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s5">'expected %r but source %r defines %r swig target' </span><span class="s1">\</span>
                                     <span class="s3">% (</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">source</span><span class="s3">, </span><span class="s1">typ2</span><span class="s3">))</span>
                            <span class="s2">if </span><span class="s1">typ2</span><span class="s3">==</span><span class="s5">'c++'</span><span class="s3">:</span>
                                <span class="s1">log</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s5">'resetting swig target to c++ (some targets may have .c extension)'</span><span class="s3">)</span>
                                <span class="s1">is_cpp </span><span class="s3">= </span><span class="s2">True</span>
                            <span class="s2">else</span><span class="s3">:</span>
                                <span class="s1">log</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s5">'assuming that %r has c++ swig target' </span><span class="s3">% (</span><span class="s1">source</span><span class="s3">))</span>
                    <span class="s2">if </span><span class="s1">is_cpp</span><span class="s3">:</span>
                        <span class="s1">target_ext </span><span class="s3">= </span><span class="s5">'.cpp'</span>
                    <span class="s1">target_file </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">target_dir</span><span class="s3">, </span><span class="s5">'%s_wrap%s' </span><span class="s1">\</span>
                                               <span class="s3">% (</span><span class="s1">name</span><span class="s3">, </span><span class="s1">target_ext</span><span class="s3">))</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">log</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s5">'  source %s does not exist: skipping swig</span><span class="s2">\'</span><span class="s5">ing.' </span><span class="s1">\</span>
                             <span class="s3">% (</span><span class="s1">source</span><span class="s3">))</span>
                    <span class="s1">name </span><span class="s3">= </span><span class="s1">ext_name</span><span class="s3">[</span><span class="s6">1</span><span class="s3">:]</span>
                    <span class="s1">skip_swig </span><span class="s3">= </span><span class="s6">1</span>
                    <span class="s1">target_file </span><span class="s3">= </span><span class="s1">_find_swig_target</span><span class="s3">(</span><span class="s1">target_dir</span><span class="s3">, </span><span class="s1">name</span><span class="s3">)</span>
                    <span class="s2">if not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isfile</span><span class="s3">(</span><span class="s1">target_file</span><span class="s3">):</span>
                        <span class="s1">log</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s5">'  target %s does not exist:</span><span class="s2">\n   </span><span class="s5">'</span><span class="s1">\</span>
                                 <span class="s5">'Assuming %s_wrap.{c,cpp} was generated with '</span><span class="s1">\</span>
                                 <span class="s5">'&quot;build_src --inplace&quot; command.' </span><span class="s1">\</span>
                                 <span class="s3">% (</span><span class="s1">target_file</span><span class="s3">, </span><span class="s1">name</span><span class="s3">))</span>
                        <span class="s1">target_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">base</span><span class="s3">)</span>
                        <span class="s1">target_file </span><span class="s3">= </span><span class="s1">_find_swig_target</span><span class="s3">(</span><span class="s1">target_dir</span><span class="s3">, </span><span class="s1">name</span><span class="s3">)</span>
                        <span class="s2">if not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isfile</span><span class="s3">(</span><span class="s1">target_file</span><span class="s3">):</span>
                            <span class="s2">raise </span><span class="s1">DistutilsSetupError</span><span class="s3">(</span><span class="s5">&quot;%r missing&quot; </span><span class="s3">% (</span><span class="s1">target_file</span><span class="s3">,))</span>
                        <span class="s1">log</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s5">'   Yes! Using %r as up-to-date target.' </span><span class="s1">\</span>
                                 <span class="s3">% (</span><span class="s1">target_file</span><span class="s3">))</span>
                <span class="s1">target_dirs</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">target_dir</span><span class="s3">)</span>
                <span class="s1">new_sources</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">target_file</span><span class="s3">)</span>
                <span class="s1">py_files</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">py_target_dir</span><span class="s3">, </span><span class="s1">name</span><span class="s3">+</span><span class="s5">'.py'</span><span class="s3">))</span>
                <span class="s1">swig_sources</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">source</span><span class="s3">)</span>
                <span class="s1">swig_targets</span><span class="s3">[</span><span class="s1">source</span><span class="s3">] = </span><span class="s1">new_sources</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">]</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">new_sources</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">source</span><span class="s3">)</span>

        <span class="s2">if not </span><span class="s1">swig_sources</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">new_sources</span>

        <span class="s2">if </span><span class="s1">skip_swig</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">new_sources </span><span class="s3">+ </span><span class="s1">py_files</span>

        <span class="s2">for </span><span class="s1">d </span><span class="s2">in </span><span class="s1">target_dirs</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">mkpath</span><span class="s3">(</span><span class="s1">d</span><span class="s3">)</span>

        <span class="s1">swig </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">swig </span><span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">find_swig</span><span class="s3">()</span>
        <span class="s1">swig_cmd </span><span class="s3">= [</span><span class="s1">swig</span><span class="s3">, </span><span class="s5">&quot;-python&quot;</span><span class="s3">] + </span><span class="s1">extension</span><span class="s3">.</span><span class="s1">swig_opts</span>
        <span class="s2">if </span><span class="s1">is_cpp</span><span class="s3">:</span>
            <span class="s1">swig_cmd</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s5">'-c++'</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">d </span><span class="s2">in </span><span class="s1">extension</span><span class="s3">.</span><span class="s1">include_dirs</span><span class="s3">:</span>
            <span class="s1">swig_cmd</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s5">'-I'</span><span class="s3">+</span><span class="s1">d</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">source </span><span class="s2">in </span><span class="s1">swig_sources</span><span class="s3">:</span>
            <span class="s1">target </span><span class="s3">= </span><span class="s1">swig_targets</span><span class="s3">[</span><span class="s1">source</span><span class="s3">]</span>
            <span class="s1">depends </span><span class="s3">= [</span><span class="s1">source</span><span class="s3">] + </span><span class="s1">extension</span><span class="s3">.</span><span class="s1">depends</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">force </span><span class="s2">or </span><span class="s1">newer_group</span><span class="s3">(</span><span class="s1">depends</span><span class="s3">, </span><span class="s1">target</span><span class="s3">, </span><span class="s5">'newer'</span><span class="s3">):</span>
                <span class="s1">log</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s5">&quot;%s: %s&quot; </span><span class="s3">% (</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">swig</span><span class="s3">) </span><span class="s1">\</span>
                                     <span class="s3">+ (</span><span class="s1">is_cpp </span><span class="s2">and </span><span class="s5">'++' </span><span class="s2">or </span><span class="s5">''</span><span class="s3">), </span><span class="s1">source</span><span class="s3">))</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">spawn</span><span class="s3">(</span><span class="s1">swig_cmd </span><span class="s3">+ </span><span class="s1">self</span><span class="s3">.</span><span class="s1">swig_opts \</span>
                           <span class="s3">+ [</span><span class="s5">&quot;-o&quot;</span><span class="s3">, </span><span class="s1">target</span><span class="s3">, </span><span class="s5">'-outdir'</span><span class="s3">, </span><span class="s1">py_target_dir</span><span class="s3">, </span><span class="s1">source</span><span class="s3">])</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">log</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s5">&quot;  skipping '%s' swig interface (up-to-date)&quot; </span><span class="s1">\</span>
                         <span class="s3">% (</span><span class="s1">source</span><span class="s3">))</span>

        <span class="s2">return </span><span class="s1">new_sources </span><span class="s3">+ </span><span class="s1">py_files</span>

<span class="s1">_f_pyf_ext_match </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span><span class="s5">r'.*\.(f90|f95|f77|for|ftn|f|pyf)\Z'</span><span class="s3">, </span><span class="s1">re</span><span class="s3">.</span><span class="s1">I</span><span class="s3">).</span><span class="s1">match</span>
<span class="s1">_header_ext_match </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span><span class="s5">r'.*\.(inc|h|hpp)\Z'</span><span class="s3">, </span><span class="s1">re</span><span class="s3">.</span><span class="s1">I</span><span class="s3">).</span><span class="s1">match</span>

<span class="s4">#### SWIG related auxiliary functions ####</span>
<span class="s1">_swig_module_name_match </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span><span class="s5">r'\s*%module\s*(.*\(\s*package\s*=\s*&quot;(?P&lt;package&gt;[\w_]+)&quot;.*\)|)\s*(?P&lt;name&gt;[\w_]+)'</span><span class="s3">,</span>
                                     <span class="s1">re</span><span class="s3">.</span><span class="s1">I</span><span class="s3">).</span><span class="s1">match</span>
<span class="s1">_has_c_header </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span><span class="s5">r'-\*-\s*c\s*-\*-'</span><span class="s3">, </span><span class="s1">re</span><span class="s3">.</span><span class="s1">I</span><span class="s3">).</span><span class="s1">search</span>
<span class="s1">_has_cpp_header </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span><span class="s5">r'-\*-\s*c\+\+\s*-\*-'</span><span class="s3">, </span><span class="s1">re</span><span class="s3">.</span><span class="s1">I</span><span class="s3">).</span><span class="s1">search</span>

<span class="s2">def </span><span class="s1">get_swig_target</span><span class="s3">(</span><span class="s1">source</span><span class="s3">):</span>
    <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">source</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">line </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">readline</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">_has_cpp_header</span><span class="s3">(</span><span class="s1">line</span><span class="s3">):</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s5">'c++'</span>
        <span class="s2">if </span><span class="s1">_has_c_header</span><span class="s3">(</span><span class="s1">line</span><span class="s3">):</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s5">'c'</span>
    <span class="s2">return </span><span class="s1">result</span>

<span class="s2">def </span><span class="s1">get_swig_modulename</span><span class="s3">(</span><span class="s1">source</span><span class="s3">):</span>
    <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">source</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
        <span class="s1">name </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">for </span><span class="s1">line </span><span class="s2">in </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s1">m </span><span class="s3">= </span><span class="s1">_swig_module_name_match</span><span class="s3">(</span><span class="s1">line</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">m</span><span class="s3">:</span>
                <span class="s1">name </span><span class="s3">= </span><span class="s1">m</span><span class="s3">.</span><span class="s1">group</span><span class="s3">(</span><span class="s5">'name'</span><span class="s3">)</span>
                <span class="s2">break</span>
    <span class="s2">return </span><span class="s1">name</span>

<span class="s2">def </span><span class="s1">_find_swig_target</span><span class="s3">(</span><span class="s1">target_dir</span><span class="s3">, </span><span class="s1">name</span><span class="s3">):</span>
    <span class="s2">for </span><span class="s1">ext </span><span class="s2">in </span><span class="s3">[</span><span class="s5">'.cpp'</span><span class="s3">, </span><span class="s5">'.c'</span><span class="s3">]:</span>
        <span class="s1">target </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">target_dir</span><span class="s3">, </span><span class="s5">'%s_wrap%s' </span><span class="s3">% (</span><span class="s1">name</span><span class="s3">, </span><span class="s1">ext</span><span class="s3">))</span>
        <span class="s2">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isfile</span><span class="s3">(</span><span class="s1">target</span><span class="s3">):</span>
            <span class="s2">break</span>
    <span class="s2">return </span><span class="s1">target</span>

<span class="s4">#### F2PY related auxiliary functions ####</span>

<span class="s1">_f2py_module_name_match </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span><span class="s5">r'\s*python\s*module\s*(?P&lt;name&gt;[\w_]+)'</span><span class="s3">,</span>
                                     <span class="s1">re</span><span class="s3">.</span><span class="s1">I</span><span class="s3">).</span><span class="s1">match</span>
<span class="s1">_f2py_user_module_name_match </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span><span class="s5">r'\s*python\s*module\s*(?P&lt;name&gt;[\w_]*?'</span>
                                          <span class="s5">r'__user__[\w_]*)'</span><span class="s3">, </span><span class="s1">re</span><span class="s3">.</span><span class="s1">I</span><span class="s3">).</span><span class="s1">match</span>

<span class="s2">def </span><span class="s1">get_f2py_modulename</span><span class="s3">(</span><span class="s1">source</span><span class="s3">):</span>
    <span class="s1">name </span><span class="s3">= </span><span class="s2">None</span>
    <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">source</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
        <span class="s2">for </span><span class="s1">line </span><span class="s2">in </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s1">m </span><span class="s3">= </span><span class="s1">_f2py_module_name_match</span><span class="s3">(</span><span class="s1">line</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">m</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">_f2py_user_module_name_match</span><span class="s3">(</span><span class="s1">line</span><span class="s3">): </span><span class="s4"># skip *__user__* names</span>
                    <span class="s2">continue</span>
                <span class="s1">name </span><span class="s3">= </span><span class="s1">m</span><span class="s3">.</span><span class="s1">group</span><span class="s3">(</span><span class="s5">'name'</span><span class="s3">)</span>
                <span class="s2">break</span>
    <span class="s2">return </span><span class="s1">name</span>

<span class="s4">##########################################</span>
</pre>
</body>
</html>