<html>
<head>
<title>ccompiler.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
ccompiler.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">re</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">platform</span>
<span class="s0">import </span><span class="s1">shlex</span>
<span class="s0">import </span><span class="s1">time</span>
<span class="s0">import </span><span class="s1">subprocess</span>
<span class="s0">from </span><span class="s1">copy </span><span class="s0">import </span><span class="s1">copy</span>
<span class="s0">from </span><span class="s1">pathlib </span><span class="s0">import </span><span class="s1">Path</span>
<span class="s0">from </span><span class="s1">distutils </span><span class="s0">import </span><span class="s1">ccompiler</span>
<span class="s0">from </span><span class="s1">distutils</span><span class="s2">.</span><span class="s1">ccompiler </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">compiler_class</span><span class="s2">, </span><span class="s1">gen_lib_options</span><span class="s2">, </span><span class="s1">get_default_compiler</span><span class="s2">, </span><span class="s1">new_compiler</span><span class="s2">,</span>
    <span class="s1">CCompiler</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">distutils</span><span class="s2">.</span><span class="s1">errors </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">DistutilsExecError</span><span class="s2">, </span><span class="s1">DistutilsModuleError</span><span class="s2">, </span><span class="s1">DistutilsPlatformError</span><span class="s2">,</span>
    <span class="s1">CompileError</span><span class="s2">, </span><span class="s1">UnknownFileError</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">distutils</span><span class="s2">.</span><span class="s1">sysconfig </span><span class="s0">import </span><span class="s1">customize_compiler</span>
<span class="s0">from </span><span class="s1">distutils</span><span class="s2">.</span><span class="s1">version </span><span class="s0">import </span><span class="s1">LooseVersion</span>

<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">distutils </span><span class="s0">import </span><span class="s1">log</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">distutils</span><span class="s2">.</span><span class="s1">exec_command </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">filepath_from_subprocess_output</span><span class="s2">, </span><span class="s1">forward_bytes_to_stdout</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">distutils</span><span class="s2">.</span><span class="s1">misc_util </span><span class="s0">import </span><span class="s1">cyg2win32</span><span class="s2">, </span><span class="s1">is_sequence</span><span class="s2">, </span><span class="s1">mingw32</span><span class="s2">, </span><span class="s1">\</span>
                                      <span class="s1">get_num_build_jobs</span><span class="s2">, </span><span class="s1">\</span>
                                      <span class="s1">_commandline_dep_string</span><span class="s2">, </span><span class="s1">\</span>
                                      <span class="s1">sanitize_cxx_flags</span>

<span class="s3"># globals for parallel build management</span>
<span class="s0">import </span><span class="s1">threading</span>

<span class="s1">_job_semaphore </span><span class="s2">= </span><span class="s0">None</span>
<span class="s1">_global_lock </span><span class="s2">= </span><span class="s1">threading</span><span class="s2">.</span><span class="s1">Lock</span><span class="s2">()</span>
<span class="s1">_processing_files </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">_needs_build</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">cc_args</span><span class="s2">, </span><span class="s1">extra_postargs</span><span class="s2">, </span><span class="s1">pp_opts</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Check if an objects needs to be rebuild based on its dependencies 
 
    Parameters 
    ---------- 
    obj : str 
        object file 
 
    Returns 
    ------- 
    bool 
    &quot;&quot;&quot;</span>
    <span class="s3"># defined in unixcompiler.py</span>
    <span class="s1">dep_file </span><span class="s2">= </span><span class="s1">obj </span><span class="s2">+ </span><span class="s5">'.d'</span>
    <span class="s0">if not </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">dep_file</span><span class="s2">):</span>
        <span class="s0">return True</span>

    <span class="s3"># dep_file is a makefile containing 'object: dependencies'</span>
    <span class="s3"># formatted like posix shell (spaces escaped, \ line continuations)</span>
    <span class="s3"># the last line contains the compiler commandline arguments as some</span>
    <span class="s3"># projects may compile an extension multiple times with different</span>
    <span class="s3"># arguments</span>
    <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">dep_file</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
        <span class="s1">lines </span><span class="s2">= </span><span class="s1">f</span><span class="s2">.</span><span class="s1">readlines</span><span class="s2">()</span>

    <span class="s1">cmdline </span><span class="s2">=</span><span class="s1">_commandline_dep_string</span><span class="s2">(</span><span class="s1">cc_args</span><span class="s2">, </span><span class="s1">extra_postargs</span><span class="s2">, </span><span class="s1">pp_opts</span><span class="s2">)</span>
    <span class="s1">last_cmdline </span><span class="s2">= </span><span class="s1">lines</span><span class="s2">[-</span><span class="s6">1</span><span class="s2">]</span>
    <span class="s0">if </span><span class="s1">last_cmdline </span><span class="s2">!= </span><span class="s1">cmdline</span><span class="s2">:</span>
        <span class="s0">return True</span>

    <span class="s1">contents </span><span class="s2">= </span><span class="s5">''</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">[:-</span><span class="s6">1</span><span class="s2">])</span>
    <span class="s1">deps </span><span class="s2">= [</span><span class="s1">x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">shlex</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s1">contents</span><span class="s2">, </span><span class="s1">posix</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">x </span><span class="s2">!= </span><span class="s5">&quot;</span><span class="s0">\n</span><span class="s5">&quot; </span><span class="s0">and not </span><span class="s1">x</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s5">&quot;:&quot;</span><span class="s2">)]</span>

    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">t_obj </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">stat</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">).</span><span class="s1">st_mtime</span>

        <span class="s3"># check if any of the dependencies is newer than the object</span>
        <span class="s3"># the dependencies includes the source used to create the object</span>
        <span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">deps</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">stat</span><span class="s2">(</span><span class="s1">f</span><span class="s2">).</span><span class="s1">st_mtime </span><span class="s2">&gt; </span><span class="s1">t_obj</span><span class="s2">:</span>
                <span class="s0">return True</span>
    <span class="s0">except </span><span class="s1">OSError</span><span class="s2">:</span>
        <span class="s3"># no object counts as newer (shouldn't happen if dep_file exists)</span>
        <span class="s0">return True</span>

    <span class="s0">return False</span>


<span class="s0">def </span><span class="s1">replace_method</span><span class="s2">(</span><span class="s1">klass</span><span class="s2">, </span><span class="s1">method_name</span><span class="s2">, </span><span class="s1">func</span><span class="s2">):</span>
    <span class="s3"># Py3k does not have unbound method anymore, MethodType does not work</span>
    <span class="s1">m </span><span class="s2">= </span><span class="s0">lambda </span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">: </span><span class="s1">func</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">)</span>
    <span class="s1">setattr</span><span class="s2">(</span><span class="s1">klass</span><span class="s2">, </span><span class="s1">method_name</span><span class="s2">, </span><span class="s1">m</span><span class="s2">)</span>


<span class="s3">######################################################################</span>
<span class="s3">## Method that subclasses may redefine. But don't call this method,</span>
<span class="s3">## it i private to CCompiler class and may return unexpected</span>
<span class="s3">## results if used elsewhere. So, you have been warned..</span>

<span class="s0">def </span><span class="s1">CCompiler_find_executables</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Does nothing here, but is called by the get_version method and can be 
    overridden by subclasses. In particular it is redefined in the `FCompiler` 
    class where more documentation can be found. 
 
    &quot;&quot;&quot;</span>
    <span class="s0">pass</span>


<span class="s1">replace_method</span><span class="s2">(</span><span class="s1">CCompiler</span><span class="s2">, </span><span class="s5">'find_executables'</span><span class="s2">, </span><span class="s1">CCompiler_find_executables</span><span class="s2">)</span>


<span class="s3"># Using customized CCompiler.spawn.</span>
<span class="s0">def </span><span class="s1">CCompiler_spawn</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cmd</span><span class="s2">, </span><span class="s1">display</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">env</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Execute a command in a sub-process. 
 
    Parameters 
    ---------- 
    cmd : str 
        The command to execute. 
    display : str or sequence of str, optional 
        The text to add to the log file kept by `numpy.distutils`. 
        If not given, `display` is equal to `cmd`. 
    env : a dictionary for environment variables, optional 
 
    Returns 
    ------- 
    None 
 
    Raises 
    ------ 
    DistutilsExecError 
        If the command failed, i.e. the exit status was not 0. 
 
    &quot;&quot;&quot;</span>
    <span class="s1">env </span><span class="s2">= </span><span class="s1">env </span><span class="s0">if </span><span class="s1">env </span><span class="s0">is not None else </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">display </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">display </span><span class="s2">= </span><span class="s1">cmd</span>
        <span class="s0">if </span><span class="s1">is_sequence</span><span class="s2">(</span><span class="s1">display</span><span class="s2">):</span>
            <span class="s1">display </span><span class="s2">= </span><span class="s5">' '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">display</span><span class="s2">))</span>
    <span class="s1">log</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s1">display</span><span class="s2">)</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">verbose</span><span class="s2">:</span>
            <span class="s1">subprocess</span><span class="s2">.</span><span class="s1">check_output</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">, </span><span class="s1">env</span><span class="s2">=</span><span class="s1">env</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">subprocess</span><span class="s2">.</span><span class="s1">check_output</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">, </span><span class="s1">stderr</span><span class="s2">=</span><span class="s1">subprocess</span><span class="s2">.</span><span class="s1">STDOUT</span><span class="s2">, </span><span class="s1">env</span><span class="s2">=</span><span class="s1">env</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">subprocess</span><span class="s2">.</span><span class="s1">CalledProcessError </span><span class="s0">as </span><span class="s1">exc</span><span class="s2">:</span>
        <span class="s1">o </span><span class="s2">= </span><span class="s1">exc</span><span class="s2">.</span><span class="s1">output</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">exc</span><span class="s2">.</span><span class="s1">returncode</span>
    <span class="s0">except </span><span class="s1">OSError </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
        <span class="s3"># OSError doesn't have the same hooks for the exception</span>
        <span class="s3"># output, but exec_command() historically would use an</span>
        <span class="s3"># empty string for EnvironmentError (base class for</span>
        <span class="s3"># OSError)</span>
        <span class="s3"># o = b''</span>
        <span class="s3"># still that would make the end-user lost in translation!</span>
        <span class="s1">o </span><span class="s2">= </span><span class="s5">f&quot;</span><span class="s0">\n\n{</span><span class="s1">e</span><span class="s0">}\n\n\n</span><span class="s5">&quot;</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">o </span><span class="s2">= </span><span class="s1">o</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">stdout</span><span class="s2">.</span><span class="s1">encoding</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">AttributeError</span><span class="s2">:</span>
            <span class="s1">o </span><span class="s2">= </span><span class="s1">o</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s5">'utf8'</span><span class="s2">)</span>
        <span class="s3"># status previously used by exec_command() for parent</span>
        <span class="s3"># of OSError</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s6">127</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s3"># use a convenience return here so that any kind of</span>
        <span class="s3"># caught exception will execute the default code after the</span>
        <span class="s3"># try / except block, which handles various exceptions</span>
        <span class="s0">return None</span>

    <span class="s0">if </span><span class="s1">is_sequence</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">):</span>
        <span class="s1">cmd </span><span class="s2">= </span><span class="s5">' '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">))</span>

    <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">verbose</span><span class="s2">:</span>
        <span class="s1">forward_bytes_to_stdout</span><span class="s2">(</span><span class="s1">o</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">re</span><span class="s2">.</span><span class="s1">search</span><span class="s2">(</span><span class="s7">b'Too many open files'</span><span class="s2">, </span><span class="s1">o</span><span class="s2">):</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s5">'</span><span class="s0">\n</span><span class="s5">Try rerunning setup command until build succeeds.'</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s5">''</span>
    <span class="s0">raise </span><span class="s1">DistutilsExecError</span><span class="s2">(</span><span class="s5">'Command &quot;%s&quot; failed with exit status %d%s' </span><span class="s2">%</span>
                            <span class="s2">(</span><span class="s1">cmd</span><span class="s2">, </span><span class="s1">s</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">))</span>

<span class="s1">replace_method</span><span class="s2">(</span><span class="s1">CCompiler</span><span class="s2">, </span><span class="s5">'spawn'</span><span class="s2">, </span><span class="s1">CCompiler_spawn</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">CCompiler_object_filenames</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">source_filenames</span><span class="s2">, </span><span class="s1">strip_dir</span><span class="s2">=</span><span class="s6">0</span><span class="s2">, </span><span class="s1">output_dir</span><span class="s2">=</span><span class="s5">''</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Return the name of the object files for the given source files. 
 
    Parameters 
    ---------- 
    source_filenames : list of str 
        The list of paths to source files. Paths can be either relative or 
        absolute, this is handled transparently. 
    strip_dir : bool, optional 
        Whether to strip the directory from the returned paths. If True, 
        the file name prepended by `output_dir` is returned. Default is False. 
    output_dir : str, optional 
        If given, this path is prepended to the returned paths to the 
        object files. 
 
    Returns 
    ------- 
    obj_names : list of str 
        The list of paths to the object files corresponding to the source 
        files in `source_filenames`. 
 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">output_dir </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">output_dir </span><span class="s2">= </span><span class="s5">''</span>
    <span class="s1">obj_names </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">src_name </span><span class="s0">in </span><span class="s1">source_filenames</span><span class="s2">:</span>
        <span class="s1">base</span><span class="s2">, </span><span class="s1">ext </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">splitext</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">normpath</span><span class="s2">(</span><span class="s1">src_name</span><span class="s2">))</span>
        <span class="s1">base </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">splitdrive</span><span class="s2">(</span><span class="s1">base</span><span class="s2">)[</span><span class="s6">1</span><span class="s2">] </span><span class="s3"># Chop off the drive</span>
        <span class="s1">base </span><span class="s2">= </span><span class="s1">base</span><span class="s2">[</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isabs</span><span class="s2">(</span><span class="s1">base</span><span class="s2">):]  </span><span class="s3"># If abs, chop off leading /</span>
        <span class="s0">if </span><span class="s1">base</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s5">'..'</span><span class="s2">):</span>
            <span class="s3"># Resolve starting relative path components, middle ones</span>
            <span class="s3"># (if any) have been handled by os.path.normpath above.</span>
            <span class="s1">i </span><span class="s2">= </span><span class="s1">base</span><span class="s2">.</span><span class="s1">rfind</span><span class="s2">(</span><span class="s5">'..'</span><span class="s2">)+</span><span class="s6">2</span>
            <span class="s1">d </span><span class="s2">= </span><span class="s1">base</span><span class="s2">[:</span><span class="s1">i</span><span class="s2">]</span>
            <span class="s1">d </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">basename</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">abspath</span><span class="s2">(</span><span class="s1">d</span><span class="s2">))</span>
            <span class="s1">base </span><span class="s2">= </span><span class="s1">d </span><span class="s2">+ </span><span class="s1">base</span><span class="s2">[</span><span class="s1">i</span><span class="s2">:]</span>
        <span class="s0">if </span><span class="s1">ext </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">src_extensions</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">UnknownFileError</span><span class="s2">(</span><span class="s5">&quot;unknown file type '%s' (from '%s')&quot; </span><span class="s2">% (</span><span class="s1">ext</span><span class="s2">, </span><span class="s1">src_name</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">strip_dir</span><span class="s2">:</span>
            <span class="s1">base </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">basename</span><span class="s2">(</span><span class="s1">base</span><span class="s2">)</span>
        <span class="s1">obj_name </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">output_dir</span><span class="s2">, </span><span class="s1">base </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">obj_extension</span><span class="s2">)</span>
        <span class="s1">obj_names</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">obj_name</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">obj_names</span>

<span class="s1">replace_method</span><span class="s2">(</span><span class="s1">CCompiler</span><span class="s2">, </span><span class="s5">'object_filenames'</span><span class="s2">, </span><span class="s1">CCompiler_object_filenames</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">CCompiler_compile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">sources</span><span class="s2">, </span><span class="s1">output_dir</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">macros</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                      <span class="s1">include_dirs</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">debug</span><span class="s2">=</span><span class="s6">0</span><span class="s2">, </span><span class="s1">extra_preargs</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                      <span class="s1">extra_postargs</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">depends</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Compile one or more source files. 
 
    Please refer to the Python distutils API reference for more details. 
 
    Parameters 
    ---------- 
    sources : list of str 
        A list of filenames 
    output_dir : str, optional 
        Path to the output directory. 
    macros : list of tuples 
        A list of macro definitions. 
    include_dirs : list of str, optional 
        The directories to add to the default include file search path for 
        this compilation only. 
    debug : bool, optional 
        Whether or not to output debug symbols in or alongside the object 
        file(s). 
    extra_preargs, extra_postargs : ? 
        Extra pre- and post-arguments. 
    depends : list of str, optional 
        A list of file names that all targets depend on. 
 
    Returns 
    ------- 
    objects : list of str 
        A list of object file names, one per source file `sources`. 
 
    Raises 
    ------ 
    CompileError 
        If compilation fails. 
 
    &quot;&quot;&quot;</span>
    <span class="s0">global </span><span class="s1">_job_semaphore</span>

    <span class="s1">jobs </span><span class="s2">= </span><span class="s1">get_num_build_jobs</span><span class="s2">()</span>

    <span class="s3"># setup semaphore to not exceed number of compile jobs when parallelized at</span>
    <span class="s3"># extension level (python &gt;= 3.5)</span>
    <span class="s0">with </span><span class="s1">_global_lock</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">_job_semaphore </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">_job_semaphore </span><span class="s2">= </span><span class="s1">threading</span><span class="s2">.</span><span class="s1">Semaphore</span><span class="s2">(</span><span class="s1">jobs</span><span class="s2">)</span>

    <span class="s0">if not </span><span class="s1">sources</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s2">[]</span>
    <span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">distutils</span><span class="s2">.</span><span class="s1">fcompiler </span><span class="s0">import </span><span class="s2">(</span><span class="s1">FCompiler</span><span class="s2">,</span>
                                           <span class="s1">FORTRAN_COMMON_FIXED_EXTENSIONS</span><span class="s2">,</span>
                                           <span class="s1">has_f90_header</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">FCompiler</span><span class="s2">):</span>
        <span class="s1">display </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">fc </span><span class="s0">in </span><span class="s2">[</span><span class="s5">'f77'</span><span class="s2">, </span><span class="s5">'f90'</span><span class="s2">, </span><span class="s5">'fix'</span><span class="s2">]:</span>
            <span class="s1">fcomp </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s5">'compiler_'</span><span class="s2">+</span><span class="s1">fc</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">fcomp </span><span class="s0">is None</span><span class="s2">:</span>
                <span class="s0">continue</span>
            <span class="s1">display</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s5">&quot;Fortran %s compiler: %s&quot; </span><span class="s2">% (</span><span class="s1">fc</span><span class="s2">, </span><span class="s5">' '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">fcomp</span><span class="s2">)))</span>
        <span class="s1">display </span><span class="s2">= </span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">display</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">ccomp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">compiler_so</span>
        <span class="s1">display </span><span class="s2">= </span><span class="s5">&quot;C compiler: %s</span><span class="s0">\n</span><span class="s5">&quot; </span><span class="s2">% (</span><span class="s5">' '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">ccomp</span><span class="s2">),)</span>
    <span class="s1">log</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s1">display</span><span class="s2">)</span>
    <span class="s1">macros</span><span class="s2">, </span><span class="s1">objects</span><span class="s2">, </span><span class="s1">extra_postargs</span><span class="s2">, </span><span class="s1">pp_opts</span><span class="s2">, </span><span class="s1">build </span><span class="s2">= </span><span class="s1">\</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_setup_compile</span><span class="s2">(</span><span class="s1">output_dir</span><span class="s2">, </span><span class="s1">macros</span><span class="s2">, </span><span class="s1">include_dirs</span><span class="s2">, </span><span class="s1">sources</span><span class="s2">,</span>
                                <span class="s1">depends</span><span class="s2">, </span><span class="s1">extra_postargs</span><span class="s2">)</span>
    <span class="s1">cc_args </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_cc_args</span><span class="s2">(</span><span class="s1">pp_opts</span><span class="s2">, </span><span class="s1">debug</span><span class="s2">, </span><span class="s1">extra_preargs</span><span class="s2">)</span>
    <span class="s1">display </span><span class="s2">= </span><span class="s5">&quot;compile options: '%s'&quot; </span><span class="s2">% (</span><span class="s5">' '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">cc_args</span><span class="s2">))</span>
    <span class="s0">if </span><span class="s1">extra_postargs</span><span class="s2">:</span>
        <span class="s1">display </span><span class="s2">+= </span><span class="s5">&quot;</span><span class="s0">\n</span><span class="s5">extra options: '%s'&quot; </span><span class="s2">% (</span><span class="s5">' '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">extra_postargs</span><span class="s2">))</span>
    <span class="s1">log</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s1">display</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">single_compile</span><span class="s2">(</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">obj</span><span class="s2">, (</span><span class="s1">src</span><span class="s2">, </span><span class="s1">ext</span><span class="s2">) = </span><span class="s1">args</span>
        <span class="s0">if not </span><span class="s1">_needs_build</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">cc_args</span><span class="s2">, </span><span class="s1">extra_postargs</span><span class="s2">, </span><span class="s1">pp_opts</span><span class="s2">):</span>
            <span class="s0">return</span>

        <span class="s3"># check if we are currently already processing the same object</span>
        <span class="s3"># happens when using the same source in multiple extensions</span>
        <span class="s0">while True</span><span class="s2">:</span>
            <span class="s3"># need explicit lock as there is no atomic check and add with GIL</span>
            <span class="s0">with </span><span class="s1">_global_lock</span><span class="s2">:</span>
                <span class="s3"># file not being worked on, start working</span>
                <span class="s0">if </span><span class="s1">obj </span><span class="s0">not in </span><span class="s1">_processing_files</span><span class="s2">:</span>
                    <span class="s1">_processing_files</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
                    <span class="s0">break</span>
            <span class="s3"># wait for the processing to end</span>
            <span class="s1">time</span><span class="s2">.</span><span class="s1">sleep</span><span class="s2">(</span><span class="s6">0.1</span><span class="s2">)</span>

        <span class="s0">try</span><span class="s2">:</span>
            <span class="s3"># retrieve slot from our #job semaphore and build</span>
            <span class="s0">with </span><span class="s1">_job_semaphore</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_compile</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">src</span><span class="s2">, </span><span class="s1">ext</span><span class="s2">, </span><span class="s1">cc_args</span><span class="s2">, </span><span class="s1">extra_postargs</span><span class="s2">, </span><span class="s1">pp_opts</span><span class="s2">)</span>
        <span class="s0">finally</span><span class="s2">:</span>
            <span class="s3"># register being done processing</span>
            <span class="s0">with </span><span class="s1">_global_lock</span><span class="s2">:</span>
                <span class="s1">_processing_files</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>


    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">FCompiler</span><span class="s2">):</span>
        <span class="s1">objects_to_build </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">build</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>
        <span class="s1">f77_objects</span><span class="s2">, </span><span class="s1">other_objects </span><span class="s2">= [], []</span>
        <span class="s0">for </span><span class="s1">obj </span><span class="s0">in </span><span class="s1">objects</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">obj </span><span class="s0">in </span><span class="s1">objects_to_build</span><span class="s2">:</span>
                <span class="s1">src</span><span class="s2">, </span><span class="s1">ext </span><span class="s2">= </span><span class="s1">build</span><span class="s2">[</span><span class="s1">obj</span><span class="s2">]</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">compiler_type</span><span class="s2">==</span><span class="s5">'absoft'</span><span class="s2">:</span>
                    <span class="s1">obj </span><span class="s2">= </span><span class="s1">cyg2win32</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
                    <span class="s1">src </span><span class="s2">= </span><span class="s1">cyg2win32</span><span class="s2">(</span><span class="s1">src</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">src</span><span class="s2">).</span><span class="s1">suffix</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">() </span><span class="s0">in </span><span class="s1">FORTRAN_COMMON_FIXED_EXTENSIONS \</span>
                   <span class="s0">and not </span><span class="s1">has_f90_header</span><span class="s2">(</span><span class="s1">src</span><span class="s2">):</span>
                    <span class="s1">f77_objects</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">obj</span><span class="s2">, (</span><span class="s1">src</span><span class="s2">, </span><span class="s1">ext</span><span class="s2">)))</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">other_objects</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">obj</span><span class="s2">, (</span><span class="s1">src</span><span class="s2">, </span><span class="s1">ext</span><span class="s2">)))</span>

        <span class="s3"># f77 objects can be built in parallel</span>
        <span class="s1">build_items </span><span class="s2">= </span><span class="s1">f77_objects</span>
        <span class="s3"># build f90 modules serial, module files are generated during</span>
        <span class="s3"># compilation and may be used by files later in the list so the</span>
        <span class="s3"># ordering is important</span>
        <span class="s0">for </span><span class="s1">o </span><span class="s0">in </span><span class="s1">other_objects</span><span class="s2">:</span>
            <span class="s1">single_compile</span><span class="s2">(</span><span class="s1">o</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">build_items </span><span class="s2">= </span><span class="s1">build</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()</span>

    <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">build</span><span class="s2">) &gt; </span><span class="s6">1 </span><span class="s0">and </span><span class="s1">jobs </span><span class="s2">&gt; </span><span class="s6">1</span><span class="s2">:</span>
        <span class="s3"># build parallel</span>
        <span class="s0">from </span><span class="s1">concurrent</span><span class="s2">.</span><span class="s1">futures </span><span class="s0">import </span><span class="s1">ThreadPoolExecutor</span>
        <span class="s0">with </span><span class="s1">ThreadPoolExecutor</span><span class="s2">(</span><span class="s1">jobs</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pool</span><span class="s2">:</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">pool</span><span class="s2">.</span><span class="s1">map</span><span class="s2">(</span><span class="s1">single_compile</span><span class="s2">, </span><span class="s1">build_items</span><span class="s2">)</span>
        <span class="s1">list</span><span class="s2">(</span><span class="s1">res</span><span class="s2">)  </span><span class="s3"># access result to raise errors</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s3"># build serial</span>
        <span class="s0">for </span><span class="s1">o </span><span class="s0">in </span><span class="s1">build_items</span><span class="s2">:</span>
            <span class="s1">single_compile</span><span class="s2">(</span><span class="s1">o</span><span class="s2">)</span>

    <span class="s3"># Return *all* object filenames, not just the ones we just built.</span>
    <span class="s0">return </span><span class="s1">objects</span>

<span class="s1">replace_method</span><span class="s2">(</span><span class="s1">CCompiler</span><span class="s2">, </span><span class="s5">'compile'</span><span class="s2">, </span><span class="s1">CCompiler_compile</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">CCompiler_customize_cmd</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cmd</span><span class="s2">, </span><span class="s1">ignore</span><span class="s2">=()):</span>
    <span class="s4">&quot;&quot;&quot; 
    Customize compiler using distutils command. 
 
    Parameters 
    ---------- 
    cmd : class instance 
        An instance inheriting from `distutils.cmd.Command`. 
    ignore : sequence of str, optional 
        List of `CCompiler` commands (without ``'set_'``) that should not be 
        altered. Strings that are checked for are: 
        ``('include_dirs', 'define', 'undef', 'libraries', 'library_dirs', 
        'rpath', 'link_objects')``. 
 
    Returns 
    ------- 
    None 
 
    &quot;&quot;&quot;</span>
    <span class="s1">log</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s5">'customize %s using %s' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">,</span>
                                        <span class="s1">cmd</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">))</span>

    <span class="s0">if </span><span class="s2">(</span>
        <span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s5">'compiler'</span><span class="s2">) </span><span class="s0">and</span>
        <span class="s5">'clang' </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">compiler</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] </span><span class="s0">and</span>
        <span class="s0">not </span><span class="s2">(</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">machine</span><span class="s2">() == </span><span class="s5">'arm64' </span><span class="s0">and </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s5">'darwin'</span><span class="s2">)</span>
    <span class="s2">):</span>
        <span class="s3"># clang defaults to a non-strict floating error point model.</span>
        <span class="s3"># However, '-ftrapping-math' is not currently supported (2023-04-08)</span>
        <span class="s3"># for macosx_arm64.</span>
        <span class="s3"># Since NumPy and most Python libs give warnings for these, override:</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">compiler</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s5">'-ftrapping-math'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">compiler_so</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s5">'-ftrapping-math'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">allow</span><span class="s2">(</span><span class="s1">attr</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">, </span><span class="s0">None</span><span class="s2">) </span><span class="s0">is not None and </span><span class="s1">attr </span><span class="s0">not in </span><span class="s1">ignore</span>

    <span class="s0">if </span><span class="s1">allow</span><span class="s2">(</span><span class="s5">'include_dirs'</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">set_include_dirs</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">.</span><span class="s1">include_dirs</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">allow</span><span class="s2">(</span><span class="s5">'define'</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">) </span><span class="s0">in </span><span class="s1">cmd</span><span class="s2">.</span><span class="s1">define</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">define_macro</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">allow</span><span class="s2">(</span><span class="s5">'undef'</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">macro </span><span class="s0">in </span><span class="s1">cmd</span><span class="s2">.</span><span class="s1">undef</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">undefine_macro</span><span class="s2">(</span><span class="s1">macro</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">allow</span><span class="s2">(</span><span class="s5">'libraries'</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">set_libraries</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">libraries </span><span class="s2">+ </span><span class="s1">cmd</span><span class="s2">.</span><span class="s1">libraries</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">allow</span><span class="s2">(</span><span class="s5">'library_dirs'</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">set_library_dirs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">library_dirs </span><span class="s2">+ </span><span class="s1">cmd</span><span class="s2">.</span><span class="s1">library_dirs</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">allow</span><span class="s2">(</span><span class="s5">'rpath'</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">set_runtime_library_dirs</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">.</span><span class="s1">rpath</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">allow</span><span class="s2">(</span><span class="s5">'link_objects'</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">set_link_objects</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">.</span><span class="s1">link_objects</span><span class="s2">)</span>

<span class="s1">replace_method</span><span class="s2">(</span><span class="s1">CCompiler</span><span class="s2">, </span><span class="s5">'customize_cmd'</span><span class="s2">, </span><span class="s1">CCompiler_customize_cmd</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">_compiler_to_string</span><span class="s2">(</span><span class="s1">compiler</span><span class="s2">):</span>
    <span class="s1">props </span><span class="s2">= []</span>
    <span class="s1">mx </span><span class="s2">= </span><span class="s6">0</span>
    <span class="s1">keys </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">compiler</span><span class="s2">.</span><span class="s1">executables</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>
    <span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s2">[</span><span class="s5">'version'</span><span class="s2">, </span><span class="s5">'libraries'</span><span class="s2">, </span><span class="s5">'library_dirs'</span><span class="s2">,</span>
                <span class="s5">'object_switch'</span><span class="s2">, </span><span class="s5">'compile_switch'</span><span class="s2">,</span>
                <span class="s5">'include_dirs'</span><span class="s2">, </span><span class="s5">'define'</span><span class="s2">, </span><span class="s5">'undef'</span><span class="s2">, </span><span class="s5">'rpath'</span><span class="s2">, </span><span class="s5">'link_objects'</span><span class="s2">]:</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s0">not in </span><span class="s1">keys</span><span class="s2">:</span>
            <span class="s1">keys</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s1">keys</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">compiler</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
            <span class="s1">v </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">compiler</span><span class="s2">, </span><span class="s1">key</span><span class="s2">)</span>
            <span class="s1">mx </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">mx</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">key</span><span class="s2">))</span>
            <span class="s1">props</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">key</span><span class="s2">, </span><span class="s1">repr</span><span class="s2">(</span><span class="s1">v</span><span class="s2">)))</span>
    <span class="s1">fmt </span><span class="s2">= </span><span class="s5">'%-' </span><span class="s2">+ </span><span class="s1">repr</span><span class="s2">(</span><span class="s1">mx</span><span class="s2">+</span><span class="s6">1</span><span class="s2">) + </span><span class="s5">'s = %s'</span>
    <span class="s1">lines </span><span class="s2">= [</span><span class="s1">fmt </span><span class="s2">% </span><span class="s1">prop </span><span class="s0">for </span><span class="s1">prop </span><span class="s0">in </span><span class="s1">props</span><span class="s2">]</span>
    <span class="s0">return </span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">CCompiler_show_customization</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Print the compiler customizations to stdout. 
 
    Parameters 
    ---------- 
    None 
 
    Returns 
    ------- 
    None 
 
    Notes 
    ----- 
    Printing is only done if the distutils log threshold is &lt; 2. 
 
    &quot;&quot;&quot;</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">get_version</span><span class="s2">()</span>
    <span class="s0">except </span><span class="s1">Exception</span><span class="s2">:</span>
        <span class="s0">pass</span>
    <span class="s0">if </span><span class="s1">log</span><span class="s2">.</span><span class="s1">_global_log</span><span class="s2">.</span><span class="s1">threshold</span><span class="s2">&lt;</span><span class="s6">2</span><span class="s2">:</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s5">'*'</span><span class="s2">*</span><span class="s6">80</span><span class="s2">)</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">)</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s1">_compiler_to_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">))</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s5">'*'</span><span class="s2">*</span><span class="s6">80</span><span class="s2">)</span>

<span class="s1">replace_method</span><span class="s2">(</span><span class="s1">CCompiler</span><span class="s2">, </span><span class="s5">'show_customization'</span><span class="s2">, </span><span class="s1">CCompiler_show_customization</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">CCompiler_customize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dist</span><span class="s2">, </span><span class="s1">need_cxx</span><span class="s2">=</span><span class="s6">0</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Do any platform-specific customization of a compiler instance. 
 
    This method calls `distutils.sysconfig.customize_compiler` for 
    platform-specific customization, as well as optionally remove a flag 
    to suppress spurious warnings in case C++ code is being compiled. 
 
    Parameters 
    ---------- 
    dist : object 
        This parameter is not used for anything. 
    need_cxx : bool, optional 
        Whether or not C++ has to be compiled. If so (True), the 
        ``&quot;-Wstrict-prototypes&quot;`` option is removed to prevent spurious 
        warnings. Default is False. 
 
    Returns 
    ------- 
    None 
 
    Notes 
    ----- 
    All the default options used by distutils can be extracted with:: 
 
      from distutils import sysconfig 
      sysconfig.get_config_vars('CC', 'CXX', 'OPT', 'BASECFLAGS', 
                                'CCSHARED', 'LDSHARED', 'SO') 
 
    &quot;&quot;&quot;</span>
    <span class="s3"># See FCompiler.customize for suggested usage.</span>
    <span class="s1">log</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s5">'customize %s' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">))</span>
    <span class="s1">customize_compiler</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">need_cxx</span><span class="s2">:</span>
        <span class="s3"># In general, distutils uses -Wstrict-prototypes, but this option is</span>
        <span class="s3"># not valid for C++ code, only for C.  Remove it if it's there to</span>
        <span class="s3"># avoid a spurious warning on every compilation.</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">compiler_so</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s5">'-Wstrict-prototypes'</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s2">(</span><span class="s1">AttributeError</span><span class="s2">, </span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s0">pass</span>

        <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s5">'compiler'</span><span class="s2">) </span><span class="s0">and </span><span class="s5">'cc' </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">compiler</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]:</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">compiler_cxx</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">compiler</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">startswith</span><span class="s2">(</span><span class="s5">'gcc'</span><span class="s2">):</span>
                    <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s5">'gcc'</span><span class="s2">, </span><span class="s5">'g++'</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s5">'cc'</span><span class="s2">, </span><span class="s5">'c++'</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">compiler_cxx </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">compiler</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)]</span><span class="s1">\</span>
                                    <span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">compiler</span><span class="s2">[</span><span class="s6">1</span><span class="s2">:]</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s5">'compiler'</span><span class="s2">):</span>
                <span class="s1">log</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s5">&quot;#### %s #######&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">compiler</span><span class="s2">,))</span>
            <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s5">'compiler_cxx'</span><span class="s2">):</span>
                <span class="s1">log</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s5">'Missing compiler_cxx fix for ' </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">)</span>


    <span class="s3"># check if compiler supports gcc style automatic dependencies</span>
    <span class="s3"># run on every extension so skip for known good compilers</span>
    <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s5">'compiler'</span><span class="s2">) </span><span class="s0">and </span><span class="s2">(</span><span class="s5">'gcc' </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">compiler</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] </span><span class="s0">or</span>
                                      <span class="s5">'g++' </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">compiler</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] </span><span class="s0">or</span>
                                      <span class="s5">'clang' </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">compiler</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_auto_depends </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s0">elif </span><span class="s1">os</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s5">'posix'</span><span class="s2">:</span>
        <span class="s0">import </span><span class="s1">tempfile</span>
        <span class="s0">import </span><span class="s1">shutil</span>
        <span class="s1">tmpdir </span><span class="s2">= </span><span class="s1">tempfile</span><span class="s2">.</span><span class="s1">mkdtemp</span><span class="s2">()</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">fn </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">, </span><span class="s5">&quot;file.c&quot;</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s5">&quot;w&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
                <span class="s1">f</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s5">&quot;int a;</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">([</span><span class="s1">fn</span><span class="s2">], </span><span class="s1">output_dir</span><span class="s2">=</span><span class="s1">tmpdir</span><span class="s2">,</span>
                         <span class="s1">extra_preargs</span><span class="s2">=[</span><span class="s5">'-MMD'</span><span class="s2">, </span><span class="s5">'-MF'</span><span class="s2">, </span><span class="s1">fn </span><span class="s2">+ </span><span class="s5">'.d'</span><span class="s2">])</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_auto_depends </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s0">except </span><span class="s1">CompileError</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_auto_depends </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s0">finally</span><span class="s2">:</span>
            <span class="s1">shutil</span><span class="s2">.</span><span class="s1">rmtree</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">)</span>

    <span class="s0">return</span>

<span class="s1">replace_method</span><span class="s2">(</span><span class="s1">CCompiler</span><span class="s2">, </span><span class="s5">'customize'</span><span class="s2">, </span><span class="s1">CCompiler_customize</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">simple_version_match</span><span class="s2">(</span><span class="s1">pat</span><span class="s2">=</span><span class="s5">r'[-.\d]+'</span><span class="s2">, </span><span class="s1">ignore</span><span class="s2">=</span><span class="s5">''</span><span class="s2">, </span><span class="s1">start</span><span class="s2">=</span><span class="s5">''</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Simple matching of version numbers, for use in CCompiler and FCompiler. 
 
    Parameters 
    ---------- 
    pat : str, optional 
        A regular expression matching version numbers. 
        Default is ``r'[-.\\d]+'``. 
    ignore : str, optional 
        A regular expression matching patterns to skip. 
        Default is ``''``, in which case nothing is skipped. 
    start : str, optional 
        A regular expression matching the start of where to start looking 
        for version numbers. 
        Default is ``''``, in which case searching is started at the 
        beginning of the version string given to `matcher`. 
 
    Returns 
    ------- 
    matcher : callable 
        A function that is appropriate to use as the ``.version_match`` 
        attribute of a `CCompiler` class. `matcher` takes a single parameter, 
        a version string. 
 
    &quot;&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">matcher</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">version_string</span><span class="s2">):</span>
        <span class="s3"># version string may appear in the second line, so getting rid</span>
        <span class="s3"># of new lines:</span>
        <span class="s1">version_string </span><span class="s2">= </span><span class="s1">version_string</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">, </span><span class="s5">' '</span><span class="s2">)</span>
        <span class="s1">pos </span><span class="s2">= </span><span class="s6">0</span>
        <span class="s0">if </span><span class="s1">start</span><span class="s2">:</span>
            <span class="s1">m </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">start</span><span class="s2">, </span><span class="s1">version_string</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">m</span><span class="s2">:</span>
                <span class="s0">return None</span>
            <span class="s1">pos </span><span class="s2">= </span><span class="s1">m</span><span class="s2">.</span><span class="s1">end</span><span class="s2">()</span>
        <span class="s0">while True</span><span class="s2">:</span>
            <span class="s1">m </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">search</span><span class="s2">(</span><span class="s1">pat</span><span class="s2">, </span><span class="s1">version_string</span><span class="s2">[</span><span class="s1">pos</span><span class="s2">:])</span>
            <span class="s0">if not </span><span class="s1">m</span><span class="s2">:</span>
                <span class="s0">return None</span>
            <span class="s0">if </span><span class="s1">ignore </span><span class="s0">and </span><span class="s1">re</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">ignore</span><span class="s2">, </span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)):</span>
                <span class="s1">pos </span><span class="s2">= </span><span class="s1">m</span><span class="s2">.</span><span class="s1">end</span><span class="s2">()</span>
                <span class="s0">continue</span>
            <span class="s0">break</span>
        <span class="s0">return </span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">matcher</span>

<span class="s0">def </span><span class="s1">CCompiler_get_version</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">force</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">ok_status</span><span class="s2">=[</span><span class="s6">0</span><span class="s2">]):</span>
    <span class="s4">&quot;&quot;&quot; 
    Return compiler version, or None if compiler is not available. 
 
    Parameters 
    ---------- 
    force : bool, optional 
        If True, force a new determination of the version, even if the 
        compiler already has a version attribute. Default is False. 
    ok_status : list of int, optional 
        The list of status values returned by the version look-up process 
        for which a version string is returned. If the status value is not 
        in `ok_status`, None is returned. Default is ``[0]``. 
 
    Returns 
    ------- 
    version : str or None 
        Version string, in the format of `distutils.version.LooseVersion`. 
 
    &quot;&quot;&quot;</span>
    <span class="s0">if not </span><span class="s1">force </span><span class="s0">and </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s5">'version'</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span>
    <span class="s1">self</span><span class="s2">.</span><span class="s1">find_executables</span><span class="s2">()</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">version_cmd </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version_cmd</span>
    <span class="s0">except </span><span class="s1">AttributeError</span><span class="s2">:</span>
        <span class="s0">return None</span>
    <span class="s0">if not </span><span class="s1">version_cmd </span><span class="s0">or not </span><span class="s1">version_cmd</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]:</span>
        <span class="s0">return None</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">matcher </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version_match</span>
    <span class="s0">except </span><span class="s1">AttributeError</span><span class="s2">:</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">pat </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version_pattern</span>
        <span class="s0">except </span><span class="s1">AttributeError</span><span class="s2">:</span>
            <span class="s0">return None</span>
        <span class="s0">def </span><span class="s1">matcher</span><span class="s2">(</span><span class="s1">version_string</span><span class="s2">):</span>
            <span class="s1">m </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">pat</span><span class="s2">, </span><span class="s1">version_string</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">m</span><span class="s2">:</span>
                <span class="s0">return None</span>
            <span class="s1">version </span><span class="s2">= </span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">'version'</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">version</span>

    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">output </span><span class="s2">= </span><span class="s1">subprocess</span><span class="s2">.</span><span class="s1">check_output</span><span class="s2">(</span><span class="s1">version_cmd</span><span class="s2">, </span><span class="s1">stderr</span><span class="s2">=</span><span class="s1">subprocess</span><span class="s2">.</span><span class="s1">STDOUT</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">subprocess</span><span class="s2">.</span><span class="s1">CalledProcessError </span><span class="s0">as </span><span class="s1">exc</span><span class="s2">:</span>
        <span class="s1">output </span><span class="s2">= </span><span class="s1">exc</span><span class="s2">.</span><span class="s1">output</span>
        <span class="s1">status </span><span class="s2">= </span><span class="s1">exc</span><span class="s2">.</span><span class="s1">returncode</span>
    <span class="s0">except </span><span class="s1">OSError</span><span class="s2">:</span>
        <span class="s3"># match the historical returns for a parent</span>
        <span class="s3"># exception class caught by exec_command()</span>
        <span class="s1">status </span><span class="s2">= </span><span class="s6">127</span>
        <span class="s1">output </span><span class="s2">= </span><span class="s7">b''</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s3"># output isn't actually a filepath but we do this</span>
        <span class="s3"># for now to match previous distutils behavior</span>
        <span class="s1">output </span><span class="s2">= </span><span class="s1">filepath_from_subprocess_output</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>
        <span class="s1">status </span><span class="s2">= </span><span class="s6">0</span>

    <span class="s1">version </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s0">if </span><span class="s1">status </span><span class="s0">in </span><span class="s1">ok_status</span><span class="s2">:</span>
        <span class="s1">version </span><span class="s2">= </span><span class="s1">matcher</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">version</span><span class="s2">:</span>
            <span class="s1">version </span><span class="s2">= </span><span class="s1">LooseVersion</span><span class="s2">(</span><span class="s1">version</span><span class="s2">)</span>
    <span class="s1">self</span><span class="s2">.</span><span class="s1">version </span><span class="s2">= </span><span class="s1">version</span>
    <span class="s0">return </span><span class="s1">version</span>

<span class="s1">replace_method</span><span class="s2">(</span><span class="s1">CCompiler</span><span class="s2">, </span><span class="s5">'get_version'</span><span class="s2">, </span><span class="s1">CCompiler_get_version</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">CCompiler_cxx_compiler</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Return the C++ compiler. 
 
    Parameters 
    ---------- 
    None 
 
    Returns 
    ------- 
    cxx : class instance 
        The C++ compiler, as a `CCompiler` instance. 
 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">compiler_type </span><span class="s0">in </span><span class="s2">(</span><span class="s5">'msvc'</span><span class="s2">, </span><span class="s5">'intelw'</span><span class="s2">, </span><span class="s5">'intelemw'</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span>

    <span class="s1">cxx </span><span class="s2">= </span><span class="s1">copy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
    <span class="s1">cxx</span><span class="s2">.</span><span class="s1">compiler_cxx </span><span class="s2">= </span><span class="s1">cxx</span><span class="s2">.</span><span class="s1">compiler_cxx</span>
    <span class="s1">cxx</span><span class="s2">.</span><span class="s1">compiler_so </span><span class="s2">= [</span><span class="s1">cxx</span><span class="s2">.</span><span class="s1">compiler_cxx</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]] + </span><span class="s1">\</span>
                      <span class="s1">sanitize_cxx_flags</span><span class="s2">(</span><span class="s1">cxx</span><span class="s2">.</span><span class="s1">compiler_so</span><span class="s2">[</span><span class="s6">1</span><span class="s2">:])</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">((</span><span class="s5">'aix'</span><span class="s2">, </span><span class="s5">'os400'</span><span class="s2">)) </span><span class="s0">and</span>
            <span class="s5">'ld_so_aix' </span><span class="s0">in </span><span class="s1">cxx</span><span class="s2">.</span><span class="s1">linker_so</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]):</span>
        <span class="s3"># AIX needs the ld_so_aix script included with Python</span>
        <span class="s1">cxx</span><span class="s2">.</span><span class="s1">linker_so </span><span class="s2">= [</span><span class="s1">cxx</span><span class="s2">.</span><span class="s1">linker_so</span><span class="s2">[</span><span class="s6">0</span><span class="s2">], </span><span class="s1">cxx</span><span class="s2">.</span><span class="s1">compiler_cxx</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]] </span><span class="s1">\</span>
                        <span class="s2">+ </span><span class="s1">cxx</span><span class="s2">.</span><span class="s1">linker_so</span><span class="s2">[</span><span class="s6">2</span><span class="s2">:]</span>
    <span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s5">'os400'</span><span class="s2">):</span>
        <span class="s3">#This is required by i 7.4 and prievous for PRId64 in printf() call.</span>
        <span class="s1">cxx</span><span class="s2">.</span><span class="s1">compiler_so</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s5">'-D__STDC_FORMAT_MACROS'</span><span class="s2">)</span>
        <span class="s3">#This a bug of gcc10.3, which failed to handle the TLS init.</span>
        <span class="s1">cxx</span><span class="s2">.</span><span class="s1">compiler_so</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s5">'-fno-extern-tls-init'</span><span class="s2">)</span>
        <span class="s1">cxx</span><span class="s2">.</span><span class="s1">linker_so</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s5">'-fno-extern-tls-init'</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">cxx</span><span class="s2">.</span><span class="s1">linker_so </span><span class="s2">= [</span><span class="s1">cxx</span><span class="s2">.</span><span class="s1">compiler_cxx</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]] + </span><span class="s1">cxx</span><span class="s2">.</span><span class="s1">linker_so</span><span class="s2">[</span><span class="s6">1</span><span class="s2">:]</span>
    <span class="s0">return </span><span class="s1">cxx</span>

<span class="s1">replace_method</span><span class="s2">(</span><span class="s1">CCompiler</span><span class="s2">, </span><span class="s5">'cxx_compiler'</span><span class="s2">, </span><span class="s1">CCompiler_cxx_compiler</span><span class="s2">)</span>

<span class="s1">compiler_class</span><span class="s2">[</span><span class="s5">'intel'</span><span class="s2">] = (</span><span class="s5">'intelccompiler'</span><span class="s2">, </span><span class="s5">'IntelCCompiler'</span><span class="s2">,</span>
                           <span class="s5">&quot;Intel C Compiler for 32-bit applications&quot;</span><span class="s2">)</span>
<span class="s1">compiler_class</span><span class="s2">[</span><span class="s5">'intele'</span><span class="s2">] = (</span><span class="s5">'intelccompiler'</span><span class="s2">, </span><span class="s5">'IntelItaniumCCompiler'</span><span class="s2">,</span>
                            <span class="s5">&quot;Intel C Itanium Compiler for Itanium-based applications&quot;</span><span class="s2">)</span>
<span class="s1">compiler_class</span><span class="s2">[</span><span class="s5">'intelem'</span><span class="s2">] = (</span><span class="s5">'intelccompiler'</span><span class="s2">, </span><span class="s5">'IntelEM64TCCompiler'</span><span class="s2">,</span>
                             <span class="s5">&quot;Intel C Compiler for 64-bit applications&quot;</span><span class="s2">)</span>
<span class="s1">compiler_class</span><span class="s2">[</span><span class="s5">'intelw'</span><span class="s2">] = (</span><span class="s5">'intelccompiler'</span><span class="s2">, </span><span class="s5">'IntelCCompilerW'</span><span class="s2">,</span>
                            <span class="s5">&quot;Intel C Compiler for 32-bit applications on Windows&quot;</span><span class="s2">)</span>
<span class="s1">compiler_class</span><span class="s2">[</span><span class="s5">'intelemw'</span><span class="s2">] = (</span><span class="s5">'intelccompiler'</span><span class="s2">, </span><span class="s5">'IntelEM64TCCompilerW'</span><span class="s2">,</span>
                              <span class="s5">&quot;Intel C Compiler for 64-bit applications on Windows&quot;</span><span class="s2">)</span>
<span class="s1">compiler_class</span><span class="s2">[</span><span class="s5">'pathcc'</span><span class="s2">] = (</span><span class="s5">'pathccompiler'</span><span class="s2">, </span><span class="s5">'PathScaleCCompiler'</span><span class="s2">,</span>
                            <span class="s5">&quot;PathScale Compiler for SiCortex-based applications&quot;</span><span class="s2">)</span>
<span class="s1">compiler_class</span><span class="s2">[</span><span class="s5">'arm'</span><span class="s2">] = (</span><span class="s5">'armccompiler'</span><span class="s2">, </span><span class="s5">'ArmCCompiler'</span><span class="s2">,</span>
                            <span class="s5">&quot;Arm C Compiler&quot;</span><span class="s2">)</span>
<span class="s1">compiler_class</span><span class="s2">[</span><span class="s5">'fujitsu'</span><span class="s2">] = (</span><span class="s5">'fujitsuccompiler'</span><span class="s2">, </span><span class="s5">'FujitsuCCompiler'</span><span class="s2">,</span>
                            <span class="s5">&quot;Fujitsu C Compiler&quot;</span><span class="s2">)</span>

<span class="s1">ccompiler</span><span class="s2">.</span><span class="s1">_default_compilers </span><span class="s2">+= ((</span><span class="s5">'linux.*'</span><span class="s2">, </span><span class="s5">'intel'</span><span class="s2">),</span>
                                 <span class="s2">(</span><span class="s5">'linux.*'</span><span class="s2">, </span><span class="s5">'intele'</span><span class="s2">),</span>
                                 <span class="s2">(</span><span class="s5">'linux.*'</span><span class="s2">, </span><span class="s5">'intelem'</span><span class="s2">),</span>
                                 <span class="s2">(</span><span class="s5">'linux.*'</span><span class="s2">, </span><span class="s5">'pathcc'</span><span class="s2">),</span>
                                 <span class="s2">(</span><span class="s5">'nt'</span><span class="s2">, </span><span class="s5">'intelw'</span><span class="s2">),</span>
                                 <span class="s2">(</span><span class="s5">'nt'</span><span class="s2">, </span><span class="s5">'intelemw'</span><span class="s2">))</span>

<span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s5">'win32'</span><span class="s2">:</span>
    <span class="s1">compiler_class</span><span class="s2">[</span><span class="s5">'mingw32'</span><span class="s2">] = (</span><span class="s5">'mingw32ccompiler'</span><span class="s2">, </span><span class="s5">'Mingw32CCompiler'</span><span class="s2">,</span>
                                 <span class="s5">&quot;Mingw32 port of GNU C Compiler for Win32&quot;</span><span class="s1">\</span>
                                 <span class="s5">&quot;(for MSC built Python)&quot;</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">mingw32</span><span class="s2">():</span>
        <span class="s3"># On windows platforms, we want to default to mingw32 (gcc)</span>
        <span class="s3"># because msvc can't build blitz stuff.</span>
        <span class="s1">log</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s5">'Setting mingw32 as default compiler for nt.'</span><span class="s2">)</span>
        <span class="s1">ccompiler</span><span class="s2">.</span><span class="s1">_default_compilers </span><span class="s2">= ((</span><span class="s5">'nt'</span><span class="s2">, </span><span class="s5">'mingw32'</span><span class="s2">),) </span><span class="s1">\</span>
                                       <span class="s2">+ </span><span class="s1">ccompiler</span><span class="s2">.</span><span class="s1">_default_compilers</span>


<span class="s1">_distutils_new_compiler </span><span class="s2">= </span><span class="s1">new_compiler</span>
<span class="s0">def </span><span class="s1">new_compiler </span><span class="s2">(</span><span class="s1">plat</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                  <span class="s1">compiler</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                  <span class="s1">verbose</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                  <span class="s1">dry_run</span><span class="s2">=</span><span class="s6">0</span><span class="s2">,</span>
                  <span class="s1">force</span><span class="s2">=</span><span class="s6">0</span><span class="s2">):</span>
    <span class="s3"># Try first C compilers from numpy.distutils.</span>
    <span class="s0">if </span><span class="s1">verbose </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">verbose </span><span class="s2">= </span><span class="s1">log</span><span class="s2">.</span><span class="s1">get_threshold</span><span class="s2">() &lt;= </span><span class="s1">log</span><span class="s2">.</span><span class="s1">INFO</span>
    <span class="s0">if </span><span class="s1">plat </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">plat </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">name</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">compiler </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">compiler </span><span class="s2">= </span><span class="s1">get_default_compiler</span><span class="s2">(</span><span class="s1">plat</span><span class="s2">)</span>
        <span class="s2">(</span><span class="s1">module_name</span><span class="s2">, </span><span class="s1">class_name</span><span class="s2">, </span><span class="s1">long_description</span><span class="s2">) = </span><span class="s1">compiler_class</span><span class="s2">[</span><span class="s1">compiler</span><span class="s2">]</span>
    <span class="s0">except </span><span class="s1">KeyError</span><span class="s2">:</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;don't know how to compile C/C++ code on platform '%s'&quot; </span><span class="s2">% </span><span class="s1">plat</span>
        <span class="s0">if </span><span class="s1">compiler </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s1">msg </span><span class="s2">+ </span><span class="s5">&quot; with '%s' compiler&quot; </span><span class="s2">% </span><span class="s1">compiler</span>
        <span class="s0">raise </span><span class="s1">DistutilsPlatformError</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">)</span>
    <span class="s1">module_name </span><span class="s2">= </span><span class="s5">&quot;numpy.distutils.&quot; </span><span class="s2">+ </span><span class="s1">module_name</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">__import__ </span><span class="s2">(</span><span class="s1">module_name</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">ImportError </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">)</span>
        <span class="s1">log</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s5">'%s in numpy.distutils; trying from distutils'</span><span class="s2">,</span>
                 <span class="s1">str</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">))</span>
        <span class="s1">module_name </span><span class="s2">= </span><span class="s1">module_name</span><span class="s2">[</span><span class="s6">6</span><span class="s2">:]</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">__import__</span><span class="s2">(</span><span class="s1">module_name</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">ImportError </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">)</span>
            <span class="s0">raise </span><span class="s1">DistutilsModuleError</span><span class="s2">(</span><span class="s5">&quot;can't compile C/C++ code: unable to load module '%s'&quot; </span><span class="s2">% </span><span class="s1">\</span>
                  <span class="s1">module_name</span><span class="s2">)</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">module </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">[</span><span class="s1">module_name</span><span class="s2">]</span>
        <span class="s1">klass </span><span class="s2">= </span><span class="s1">vars</span><span class="s2">(</span><span class="s1">module</span><span class="s2">)[</span><span class="s1">class_name</span><span class="s2">]</span>
    <span class="s0">except </span><span class="s1">KeyError</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">DistutilsModuleError</span><span class="s2">((</span><span class="s5">&quot;can't compile C/C++ code: unable to find class '%s' &quot; </span><span class="s2">+</span>
               <span class="s5">&quot;in module '%s'&quot;</span><span class="s2">) % (</span><span class="s1">class_name</span><span class="s2">, </span><span class="s1">module_name</span><span class="s2">))</span>
    <span class="s1">compiler </span><span class="s2">= </span><span class="s1">klass</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">dry_run</span><span class="s2">, </span><span class="s1">force</span><span class="s2">)</span>
    <span class="s1">compiler</span><span class="s2">.</span><span class="s1">verbose </span><span class="s2">= </span><span class="s1">verbose</span>
    <span class="s1">log</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s5">'new_compiler returns %s' </span><span class="s2">% (</span><span class="s1">klass</span><span class="s2">))</span>
    <span class="s0">return </span><span class="s1">compiler</span>

<span class="s1">ccompiler</span><span class="s2">.</span><span class="s1">new_compiler </span><span class="s2">= </span><span class="s1">new_compiler</span>

<span class="s1">_distutils_gen_lib_options </span><span class="s2">= </span><span class="s1">gen_lib_options</span>
<span class="s0">def </span><span class="s1">gen_lib_options</span><span class="s2">(</span><span class="s1">compiler</span><span class="s2">, </span><span class="s1">library_dirs</span><span class="s2">, </span><span class="s1">runtime_library_dirs</span><span class="s2">, </span><span class="s1">libraries</span><span class="s2">):</span>
    <span class="s3"># the version of this function provided by CPython allows the following</span>
    <span class="s3"># to return lists, which are unpacked automatically:</span>
    <span class="s3"># - compiler.runtime_library_dir_option</span>
    <span class="s3"># our version extends the behavior to:</span>
    <span class="s3"># - compiler.library_dir_option</span>
    <span class="s3"># - compiler.library_option</span>
    <span class="s3"># - compiler.find_library_file</span>
    <span class="s1">r </span><span class="s2">= </span><span class="s1">_distutils_gen_lib_options</span><span class="s2">(</span><span class="s1">compiler</span><span class="s2">, </span><span class="s1">library_dirs</span><span class="s2">,</span>
                                   <span class="s1">runtime_library_dirs</span><span class="s2">, </span><span class="s1">libraries</span><span class="s2">)</span>
    <span class="s1">lib_opts </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">r</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">is_sequence</span><span class="s2">(</span><span class="s1">i</span><span class="s2">):</span>
            <span class="s1">lib_opts</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">i</span><span class="s2">))</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">lib_opts</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">lib_opts</span>
<span class="s1">ccompiler</span><span class="s2">.</span><span class="s1">gen_lib_options </span><span class="s2">= </span><span class="s1">gen_lib_options</span>

<span class="s3"># Also fix up the various compiler modules, which do</span>
<span class="s3"># from distutils.ccompiler import gen_lib_options</span>
<span class="s3"># Don't bother with mwerks, as we don't support Classic Mac.</span>
<span class="s0">for </span><span class="s1">_cc </span><span class="s0">in </span><span class="s2">[</span><span class="s5">'msvc9'</span><span class="s2">, </span><span class="s5">'msvc'</span><span class="s2">, </span><span class="s5">'_msvc'</span><span class="s2">, </span><span class="s5">'bcpp'</span><span class="s2">, </span><span class="s5">'cygwinc'</span><span class="s2">, </span><span class="s5">'emxc'</span><span class="s2">, </span><span class="s5">'unixc'</span><span class="s2">]:</span>
    <span class="s1">_m </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s5">'distutils.' </span><span class="s2">+ </span><span class="s1">_cc </span><span class="s2">+ </span><span class="s5">'compiler'</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">_m </span><span class="s0">is not None</span><span class="s2">:</span>
        <span class="s1">setattr</span><span class="s2">(</span><span class="s1">_m</span><span class="s2">, </span><span class="s5">'gen_lib_options'</span><span class="s2">, </span><span class="s1">gen_lib_options</span><span class="s2">)</span>

</pre>
</body>
</html>