<html>
<head>
<title>conftest.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #7a7e85;}
.s5 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
conftest.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Pytest configuration and fixtures for the Numpy test suite. 
&quot;&quot;&quot;</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">tempfile</span>

<span class="s2">import </span><span class="s1">hypothesis</span>
<span class="s2">import </span><span class="s1">pytest</span>
<span class="s2">import </span><span class="s1">numpy</span>

<span class="s2">from </span><span class="s1">numpy</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">_multiarray_tests </span><span class="s2">import </span><span class="s1">get_fpu_mode</span>


<span class="s1">_old_fpu_mode </span><span class="s3">= </span><span class="s2">None</span>
<span class="s1">_collect_results </span><span class="s3">= {}</span>

<span class="s4"># Use a known and persistent tmpdir for hypothesis' caches, which</span>
<span class="s4"># can be automatically cleared by the OS or user.</span>
<span class="s1">hypothesis</span><span class="s3">.</span><span class="s1">configuration</span><span class="s3">.</span><span class="s1">set_hypothesis_home_dir</span><span class="s3">(</span>
    <span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">tempfile</span><span class="s3">.</span><span class="s1">gettempdir</span><span class="s3">(), </span><span class="s5">&quot;.hypothesis&quot;</span><span class="s3">)</span>
<span class="s3">)</span>

<span class="s4"># We register two custom profiles for Numpy - for details see</span>
<span class="s4"># https://hypothesis.readthedocs.io/en/latest/settings.html</span>
<span class="s4"># The first is designed for our own CI runs; the latter also </span>
<span class="s4"># forces determinism and is designed for use via np.test()</span>
<span class="s1">hypothesis</span><span class="s3">.</span><span class="s1">settings</span><span class="s3">.</span><span class="s1">register_profile</span><span class="s3">(</span>
    <span class="s1">name</span><span class="s3">=</span><span class="s5">&quot;numpy-profile&quot;</span><span class="s3">, </span><span class="s1">deadline</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">print_blob</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s1">hypothesis</span><span class="s3">.</span><span class="s1">settings</span><span class="s3">.</span><span class="s1">register_profile</span><span class="s3">(</span>
    <span class="s1">name</span><span class="s3">=</span><span class="s5">&quot;np.test() profile&quot;</span><span class="s3">,</span>
    <span class="s1">deadline</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">print_blob</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">database</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">derandomize</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
    <span class="s1">suppress_health_check</span><span class="s3">=</span><span class="s1">list</span><span class="s3">(</span><span class="s1">hypothesis</span><span class="s3">.</span><span class="s1">HealthCheck</span><span class="s3">),</span>
<span class="s3">)</span>
<span class="s4"># Note that the default profile is chosen based on the presence </span>
<span class="s4"># of pytest.ini, but can be overridden by passing the </span>
<span class="s4"># --hypothesis-profile=NAME argument to pytest.</span>
<span class="s1">_pytest_ini </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">__file__</span><span class="s3">), </span><span class="s5">&quot;..&quot;</span><span class="s3">, </span><span class="s5">&quot;pytest.ini&quot;</span><span class="s3">)</span>
<span class="s1">hypothesis</span><span class="s3">.</span><span class="s1">settings</span><span class="s3">.</span><span class="s1">load_profile</span><span class="s3">(</span>
    <span class="s5">&quot;numpy-profile&quot; </span><span class="s2">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isfile</span><span class="s3">(</span><span class="s1">_pytest_ini</span><span class="s3">) </span><span class="s2">else </span><span class="s5">&quot;np.test() profile&quot;</span>
<span class="s3">)</span>

<span class="s4"># The experimentalAPI is used in _umath_tests</span>
<span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s5">&quot;NUMPY_EXPERIMENTAL_DTYPE_API&quot;</span><span class="s3">] = </span><span class="s5">&quot;1&quot;</span>

<span class="s2">def </span><span class="s1">pytest_configure</span><span class="s3">(</span><span class="s1">config</span><span class="s3">):</span>
    <span class="s1">config</span><span class="s3">.</span><span class="s1">addinivalue_line</span><span class="s3">(</span><span class="s5">&quot;markers&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;valgrind_error: Tests that are known to error under valgrind.&quot;</span><span class="s3">)</span>
    <span class="s1">config</span><span class="s3">.</span><span class="s1">addinivalue_line</span><span class="s3">(</span><span class="s5">&quot;markers&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;leaks_references: Tests that are known to leak references.&quot;</span><span class="s3">)</span>
    <span class="s1">config</span><span class="s3">.</span><span class="s1">addinivalue_line</span><span class="s3">(</span><span class="s5">&quot;markers&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;slow: Tests that are very slow.&quot;</span><span class="s3">)</span>
    <span class="s1">config</span><span class="s3">.</span><span class="s1">addinivalue_line</span><span class="s3">(</span><span class="s5">&quot;markers&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;slow_pypy: Tests that are very slow on pypy.&quot;</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">pytest_addoption</span><span class="s3">(</span><span class="s1">parser</span><span class="s3">):</span>
    <span class="s1">parser</span><span class="s3">.</span><span class="s1">addoption</span><span class="s3">(</span><span class="s5">&quot;--available-memory&quot;</span><span class="s3">, </span><span class="s1">action</span><span class="s3">=</span><span class="s5">&quot;store&quot;</span><span class="s3">, </span><span class="s1">default</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
                     <span class="s1">help</span><span class="s3">=(</span><span class="s5">&quot;Set amount of memory available for running the &quot;</span>
                           <span class="s5">&quot;test suite. This can result to tests requiring &quot;</span>
                           <span class="s5">&quot;especially large amounts of memory to be skipped. &quot;</span>
                           <span class="s5">&quot;Equivalent to setting environment variable &quot;</span>
                           <span class="s5">&quot;NPY_AVAILABLE_MEM. Default: determined&quot;</span>
                           <span class="s5">&quot;automatically.&quot;</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">pytest_sessionstart</span><span class="s3">(</span><span class="s1">session</span><span class="s3">):</span>
    <span class="s1">available_mem </span><span class="s3">= </span><span class="s1">session</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">getoption</span><span class="s3">(</span><span class="s5">'available_memory'</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">available_mem </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s5">'NPY_AVAILABLE_MEM'</span><span class="s3">] = </span><span class="s1">available_mem</span>


<span class="s4">#FIXME when yield tests are gone.</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">hookimpl</span><span class="s3">()</span>
<span class="s2">def </span><span class="s1">pytest_itemcollected</span><span class="s3">(</span><span class="s1">item</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Check FPU precision mode was not changed during test collection. 
 
    The clumsy way we do it here is mainly necessary because numpy 
    still uses yield tests, which can execute code at test collection 
    time. 
    &quot;&quot;&quot;</span>
    <span class="s2">global </span><span class="s1">_old_fpu_mode</span>

    <span class="s1">mode </span><span class="s3">= </span><span class="s1">get_fpu_mode</span><span class="s3">()</span>

    <span class="s2">if </span><span class="s1">_old_fpu_mode </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s1">_old_fpu_mode </span><span class="s3">= </span><span class="s1">mode</span>
    <span class="s2">elif </span><span class="s1">mode </span><span class="s3">!= </span><span class="s1">_old_fpu_mode</span><span class="s3">:</span>
        <span class="s1">_collect_results</span><span class="s3">[</span><span class="s1">item</span><span class="s3">] = (</span><span class="s1">_old_fpu_mode</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">)</span>
        <span class="s1">_old_fpu_mode </span><span class="s3">= </span><span class="s1">mode</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span><span class="s3">(</span><span class="s1">scope</span><span class="s3">=</span><span class="s5">&quot;function&quot;</span><span class="s3">, </span><span class="s1">autouse</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">check_fpu_mode</span><span class="s3">(</span><span class="s1">request</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Check FPU precision mode was not changed during the test. 
    &quot;&quot;&quot;</span>
    <span class="s1">old_mode </span><span class="s3">= </span><span class="s1">get_fpu_mode</span><span class="s3">()</span>
    <span class="s2">yield</span>
    <span class="s1">new_mode </span><span class="s3">= </span><span class="s1">get_fpu_mode</span><span class="s3">()</span>

    <span class="s2">if </span><span class="s1">old_mode </span><span class="s3">!= </span><span class="s1">new_mode</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">AssertionError</span><span class="s3">(</span><span class="s5">&quot;FPU precision mode changed from {0:#x} to {1:#x}&quot;</span>
                             <span class="s5">&quot; during the test&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">old_mode</span><span class="s3">, </span><span class="s1">new_mode</span><span class="s3">))</span>

    <span class="s1">collect_result </span><span class="s3">= </span><span class="s1">_collect_results</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">request</span><span class="s3">.</span><span class="s1">node</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">collect_result </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s1">old_mode</span><span class="s3">, </span><span class="s1">new_mode </span><span class="s3">= </span><span class="s1">collect_result</span>
        <span class="s2">raise </span><span class="s1">AssertionError</span><span class="s3">(</span><span class="s5">&quot;FPU precision mode changed from {0:#x} to {1:#x}&quot;</span>
                             <span class="s5">&quot; when collecting the test&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">old_mode</span><span class="s3">,</span>
                                                                <span class="s1">new_mode</span><span class="s3">))</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span><span class="s3">(</span><span class="s1">autouse</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">add_np</span><span class="s3">(</span><span class="s1">doctest_namespace</span><span class="s3">):</span>
    <span class="s1">doctest_namespace</span><span class="s3">[</span><span class="s5">'np'</span><span class="s3">] = </span><span class="s1">numpy</span>

<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span><span class="s3">(</span><span class="s1">autouse</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">env_setup</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">):</span>
    <span class="s1">monkeypatch</span><span class="s3">.</span><span class="s1">setenv</span><span class="s3">(</span><span class="s5">'PYTHONHASHSEED'</span><span class="s3">, </span><span class="s5">'0'</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span><span class="s3">(</span><span class="s1">params</span><span class="s3">=[</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">weak_promotion</span><span class="s3">(</span><span class="s1">request</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Fixture to ensure &quot;legacy&quot; promotion state or change it to use the new 
    weak promotion (plus warning).  `old_promotion` should be used as a 
    parameter in the function. 
    &quot;&quot;&quot;</span>
    <span class="s1">state </span><span class="s3">= </span><span class="s1">numpy</span><span class="s3">.</span><span class="s1">_get_promotion_state</span><span class="s3">()</span>
    <span class="s2">if </span><span class="s1">request</span><span class="s3">.</span><span class="s1">param</span><span class="s3">:</span>
        <span class="s1">numpy</span><span class="s3">.</span><span class="s1">_set_promotion_state</span><span class="s3">(</span><span class="s5">&quot;weak_and_warn&quot;</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">numpy</span><span class="s3">.</span><span class="s1">_set_promotion_state</span><span class="s3">(</span><span class="s5">&quot;legacy&quot;</span><span class="s3">)</span>

    <span class="s2">yield </span><span class="s1">request</span><span class="s3">.</span><span class="s1">param</span>
    <span class="s1">numpy</span><span class="s3">.</span><span class="s1">_set_promotion_state</span><span class="s3">(</span><span class="s1">state</span><span class="s3">)</span>
</pre>
</body>
</html>