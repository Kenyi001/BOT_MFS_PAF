<html>
<head>
<title>func2subr.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
func2subr.py</font>
</center></td></tr></table>
<pre><span class="s0">#!/usr/bin/env python3</span>
<span class="s2">&quot;&quot;&quot; 
 
Rules for building C/API module with f2py2e. 
 
Copyright 1999,2000 Pearu Peterson all rights reserved, 
Pearu Peterson &lt;pearu@ioc.ee&gt; 
Permission to use, modify, and distribute this software is given under the 
terms of the NumPy License. 
 
NO WARRANTY IS EXPRESSED OR IMPLIED.  USE AT YOUR OWN RISK. 
$Date: 2004/11/26 11:13:06 $ 
Pearu Peterson 
 
&quot;&quot;&quot;</span>
<span class="s3">import </span><span class="s1">copy</span>

<span class="s3">from </span><span class="s4">.</span><span class="s1">auxfuncs </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">getfortranname</span><span class="s4">, </span><span class="s1">isexternal</span><span class="s4">, </span><span class="s1">isfunction</span><span class="s4">, </span><span class="s1">isfunction_wrap</span><span class="s4">, </span><span class="s1">isintent_in</span><span class="s4">,</span>
    <span class="s1">isintent_out</span><span class="s4">, </span><span class="s1">islogicalfunction</span><span class="s4">, </span><span class="s1">ismoduleroutine</span><span class="s4">, </span><span class="s1">isscalar</span><span class="s4">,</span>
    <span class="s1">issubroutine</span><span class="s4">, </span><span class="s1">issubroutine_wrap</span><span class="s4">, </span><span class="s1">outmess</span><span class="s4">, </span><span class="s1">show</span>
<span class="s4">)</span>

<span class="s3">from </span><span class="s4">.</span><span class="s1">_isocbind </span><span class="s3">import </span><span class="s1">isoc_kindmap</span>

<span class="s3">def </span><span class="s1">var2fixfortran</span><span class="s4">(</span><span class="s1">vars</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">fa</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">f90mode</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
    <span class="s3">if </span><span class="s1">fa </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s1">fa </span><span class="s4">= </span><span class="s1">a</span>
    <span class="s3">if </span><span class="s1">a </span><span class="s3">not in </span><span class="s1">vars</span><span class="s4">:</span>
        <span class="s1">show</span><span class="s4">(</span><span class="s1">vars</span><span class="s4">)</span>
        <span class="s1">outmess</span><span class="s4">(</span><span class="s5">'var2fixfortran: No definition for argument &quot;%s&quot;.</span><span class="s3">\n</span><span class="s5">' </span><span class="s4">% </span><span class="s1">a</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s5">''</span>
    <span class="s3">if </span><span class="s5">'typespec' </span><span class="s3">not in </span><span class="s1">vars</span><span class="s4">[</span><span class="s1">a</span><span class="s4">]:</span>
        <span class="s1">show</span><span class="s4">(</span><span class="s1">vars</span><span class="s4">[</span><span class="s1">a</span><span class="s4">])</span>
        <span class="s1">outmess</span><span class="s4">(</span><span class="s5">'var2fixfortran: No typespec for argument &quot;%s&quot;.</span><span class="s3">\n</span><span class="s5">' </span><span class="s4">% </span><span class="s1">a</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s5">''</span>
    <span class="s1">vardef </span><span class="s4">= </span><span class="s1">vars</span><span class="s4">[</span><span class="s1">a</span><span class="s4">][</span><span class="s5">'typespec'</span><span class="s4">]</span>
    <span class="s3">if </span><span class="s1">vardef </span><span class="s4">== </span><span class="s5">'type' </span><span class="s3">and </span><span class="s5">'typename' </span><span class="s3">in </span><span class="s1">vars</span><span class="s4">[</span><span class="s1">a</span><span class="s4">]:</span>
        <span class="s1">vardef </span><span class="s4">= </span><span class="s5">'%s(%s)' </span><span class="s4">% (</span><span class="s1">vardef</span><span class="s4">, </span><span class="s1">vars</span><span class="s4">[</span><span class="s1">a</span><span class="s4">][</span><span class="s5">'typename'</span><span class="s4">])</span>
    <span class="s1">selector </span><span class="s4">= {}</span>
    <span class="s1">lk </span><span class="s4">= </span><span class="s5">''</span>
    <span class="s3">if </span><span class="s5">'kindselector' </span><span class="s3">in </span><span class="s1">vars</span><span class="s4">[</span><span class="s1">a</span><span class="s4">]:</span>
        <span class="s1">selector </span><span class="s4">= </span><span class="s1">vars</span><span class="s4">[</span><span class="s1">a</span><span class="s4">][</span><span class="s5">'kindselector'</span><span class="s4">]</span>
        <span class="s1">lk </span><span class="s4">= </span><span class="s5">'kind'</span>
    <span class="s3">elif </span><span class="s5">'charselector' </span><span class="s3">in </span><span class="s1">vars</span><span class="s4">[</span><span class="s1">a</span><span class="s4">]:</span>
        <span class="s1">selector </span><span class="s4">= </span><span class="s1">vars</span><span class="s4">[</span><span class="s1">a</span><span class="s4">][</span><span class="s5">'charselector'</span><span class="s4">]</span>
        <span class="s1">lk </span><span class="s4">= </span><span class="s5">'len'</span>
    <span class="s3">if </span><span class="s5">'*' </span><span class="s3">in </span><span class="s1">selector</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">f90mode</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">selector</span><span class="s4">[</span><span class="s5">'*'</span><span class="s4">] </span><span class="s3">in </span><span class="s4">[</span><span class="s5">'*'</span><span class="s4">, </span><span class="s5">':'</span><span class="s4">, </span><span class="s5">'(*)'</span><span class="s4">]:</span>
                <span class="s1">vardef </span><span class="s4">= </span><span class="s5">'%s(len=*)' </span><span class="s4">% (</span><span class="s1">vardef</span><span class="s4">)</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">vardef </span><span class="s4">= </span><span class="s5">'%s(%s=%s)' </span><span class="s4">% (</span><span class="s1">vardef</span><span class="s4">, </span><span class="s1">lk</span><span class="s4">, </span><span class="s1">selector</span><span class="s4">[</span><span class="s5">'*'</span><span class="s4">])</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">selector</span><span class="s4">[</span><span class="s5">'*'</span><span class="s4">] </span><span class="s3">in </span><span class="s4">[</span><span class="s5">'*'</span><span class="s4">, </span><span class="s5">':'</span><span class="s4">]:</span>
                <span class="s1">vardef </span><span class="s4">= </span><span class="s5">'%s*(%s)' </span><span class="s4">% (</span><span class="s1">vardef</span><span class="s4">, </span><span class="s1">selector</span><span class="s4">[</span><span class="s5">'*'</span><span class="s4">])</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">vardef </span><span class="s4">= </span><span class="s5">'%s*%s' </span><span class="s4">% (</span><span class="s1">vardef</span><span class="s4">, </span><span class="s1">selector</span><span class="s4">[</span><span class="s5">'*'</span><span class="s4">])</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s5">'len' </span><span class="s3">in </span><span class="s1">selector</span><span class="s4">:</span>
            <span class="s1">vardef </span><span class="s4">= </span><span class="s5">'%s(len=%s' </span><span class="s4">% (</span><span class="s1">vardef</span><span class="s4">, </span><span class="s1">selector</span><span class="s4">[</span><span class="s5">'len'</span><span class="s4">])</span>
            <span class="s3">if </span><span class="s5">'kind' </span><span class="s3">in </span><span class="s1">selector</span><span class="s4">:</span>
                <span class="s1">vardef </span><span class="s4">= </span><span class="s5">'%s,kind=%s)' </span><span class="s4">% (</span><span class="s1">vardef</span><span class="s4">, </span><span class="s1">selector</span><span class="s4">[</span><span class="s5">'kind'</span><span class="s4">])</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">vardef </span><span class="s4">= </span><span class="s5">'%s)' </span><span class="s4">% (</span><span class="s1">vardef</span><span class="s4">)</span>
        <span class="s3">elif </span><span class="s5">'kind' </span><span class="s3">in </span><span class="s1">selector</span><span class="s4">:</span>
            <span class="s1">vardef </span><span class="s4">= </span><span class="s5">'%s(kind=%s)' </span><span class="s4">% (</span><span class="s1">vardef</span><span class="s4">, </span><span class="s1">selector</span><span class="s4">[</span><span class="s5">'kind'</span><span class="s4">])</span>

    <span class="s1">vardef </span><span class="s4">= </span><span class="s5">'%s %s' </span><span class="s4">% (</span><span class="s1">vardef</span><span class="s4">, </span><span class="s1">fa</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s5">'dimension' </span><span class="s3">in </span><span class="s1">vars</span><span class="s4">[</span><span class="s1">a</span><span class="s4">]:</span>
        <span class="s1">vardef </span><span class="s4">= </span><span class="s5">'%s(%s)' </span><span class="s4">% (</span><span class="s1">vardef</span><span class="s4">, </span><span class="s5">','</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">vars</span><span class="s4">[</span><span class="s1">a</span><span class="s4">][</span><span class="s5">'dimension'</span><span class="s4">]))</span>
    <span class="s3">return </span><span class="s1">vardef</span>

<span class="s3">def </span><span class="s1">useiso_c_binding</span><span class="s4">(</span><span class="s1">rout</span><span class="s4">):</span>
    <span class="s1">useisoc </span><span class="s4">= </span><span class="s3">False</span>
    <span class="s3">for </span><span class="s1">key</span><span class="s4">, </span><span class="s1">value </span><span class="s3">in </span><span class="s1">rout</span><span class="s4">[</span><span class="s5">'vars'</span><span class="s4">].</span><span class="s1">items</span><span class="s4">():</span>
        <span class="s1">kind_value </span><span class="s4">= </span><span class="s1">value</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">'kindselector'</span><span class="s4">, {}).</span><span class="s1">get</span><span class="s4">(</span><span class="s5">'kind'</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">kind_value </span><span class="s3">in </span><span class="s1">isoc_kindmap</span><span class="s4">:</span>
            <span class="s3">return True</span>
    <span class="s3">return </span><span class="s1">useisoc</span>

<span class="s3">def </span><span class="s1">createfuncwrapper</span><span class="s4">(</span><span class="s1">rout</span><span class="s4">, </span><span class="s1">signature</span><span class="s4">=</span><span class="s6">0</span><span class="s4">):</span>
    <span class="s3">assert </span><span class="s1">isfunction</span><span class="s4">(</span><span class="s1">rout</span><span class="s4">)</span>

    <span class="s1">extra_args </span><span class="s4">= []</span>
    <span class="s1">vars </span><span class="s4">= </span><span class="s1">rout</span><span class="s4">[</span><span class="s5">'vars'</span><span class="s4">]</span>
    <span class="s3">for </span><span class="s1">a </span><span class="s3">in </span><span class="s1">rout</span><span class="s4">[</span><span class="s5">'args'</span><span class="s4">]:</span>
        <span class="s1">v </span><span class="s4">= </span><span class="s1">rout</span><span class="s4">[</span><span class="s5">'vars'</span><span class="s4">][</span><span class="s1">a</span><span class="s4">]</span>
        <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">d </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">v</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">'dimension'</span><span class="s4">, [])):</span>
            <span class="s3">if </span><span class="s1">d </span><span class="s4">== </span><span class="s5">':'</span><span class="s4">:</span>
                <span class="s1">dn </span><span class="s4">= </span><span class="s5">'f2py_%s_d%s' </span><span class="s4">% (</span><span class="s1">a</span><span class="s4">, </span><span class="s1">i</span><span class="s4">)</span>
                <span class="s1">dv </span><span class="s4">= </span><span class="s1">dict</span><span class="s4">(</span><span class="s1">typespec</span><span class="s4">=</span><span class="s5">'integer'</span><span class="s4">, </span><span class="s1">intent</span><span class="s4">=[</span><span class="s5">'hide'</span><span class="s4">])</span>
                <span class="s1">dv</span><span class="s4">[</span><span class="s5">'='</span><span class="s4">] = </span><span class="s5">'shape(%s, %s)' </span><span class="s4">% (</span><span class="s1">a</span><span class="s4">, </span><span class="s1">i</span><span class="s4">)</span>
                <span class="s1">extra_args</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">dn</span><span class="s4">)</span>
                <span class="s1">vars</span><span class="s4">[</span><span class="s1">dn</span><span class="s4">] = </span><span class="s1">dv</span>
                <span class="s1">v</span><span class="s4">[</span><span class="s5">'dimension'</span><span class="s4">][</span><span class="s1">i</span><span class="s4">] = </span><span class="s1">dn</span>
    <span class="s1">rout</span><span class="s4">[</span><span class="s5">'args'</span><span class="s4">].</span><span class="s1">extend</span><span class="s4">(</span><span class="s1">extra_args</span><span class="s4">)</span>
    <span class="s1">need_interface </span><span class="s4">= </span><span class="s1">bool</span><span class="s4">(</span><span class="s1">extra_args</span><span class="s4">)</span>

    <span class="s1">ret </span><span class="s4">= [</span><span class="s5">''</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">add</span><span class="s4">(</span><span class="s1">line</span><span class="s4">, </span><span class="s1">ret</span><span class="s4">=</span><span class="s1">ret</span><span class="s4">):</span>
        <span class="s1">ret</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] = </span><span class="s5">'%s</span><span class="s3">\n      </span><span class="s5">%s' </span><span class="s4">% (</span><span class="s1">ret</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">line</span><span class="s4">)</span>
    <span class="s1">name </span><span class="s4">= </span><span class="s1">rout</span><span class="s4">[</span><span class="s5">'name'</span><span class="s4">]</span>
    <span class="s1">fortranname </span><span class="s4">= </span><span class="s1">getfortranname</span><span class="s4">(</span><span class="s1">rout</span><span class="s4">)</span>
    <span class="s1">f90mode </span><span class="s4">= </span><span class="s1">ismoduleroutine</span><span class="s4">(</span><span class="s1">rout</span><span class="s4">)</span>
    <span class="s1">newname </span><span class="s4">= </span><span class="s5">'%sf2pywrap' </span><span class="s4">% (</span><span class="s1">name</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">newname </span><span class="s3">not in </span><span class="s1">vars</span><span class="s4">:</span>
        <span class="s1">vars</span><span class="s4">[</span><span class="s1">newname</span><span class="s4">] = </span><span class="s1">vars</span><span class="s4">[</span><span class="s1">name</span><span class="s4">]</span>
        <span class="s1">args </span><span class="s4">= [</span><span class="s1">newname</span><span class="s4">] + </span><span class="s1">rout</span><span class="s4">[</span><span class="s5">'args'</span><span class="s4">][</span><span class="s6">1</span><span class="s4">:]</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">args </span><span class="s4">= [</span><span class="s1">newname</span><span class="s4">] + </span><span class="s1">rout</span><span class="s4">[</span><span class="s5">'args'</span><span class="s4">]</span>

    <span class="s1">l_tmpl </span><span class="s4">= </span><span class="s1">var2fixfortran</span><span class="s4">(</span><span class="s1">vars</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s5">'@@@NAME@@@'</span><span class="s4">, </span><span class="s1">f90mode</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">l_tmpl</span><span class="s4">[:</span><span class="s6">13</span><span class="s4">] == </span><span class="s5">'character*(*)'</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">f90mode</span><span class="s4">:</span>
            <span class="s1">l_tmpl </span><span class="s4">= </span><span class="s5">'character(len=10)' </span><span class="s4">+ </span><span class="s1">l_tmpl</span><span class="s4">[</span><span class="s6">13</span><span class="s4">:]</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">l_tmpl </span><span class="s4">= </span><span class="s5">'character*10' </span><span class="s4">+ </span><span class="s1">l_tmpl</span><span class="s4">[</span><span class="s6">13</span><span class="s4">:]</span>
        <span class="s1">charselect </span><span class="s4">= </span><span class="s1">vars</span><span class="s4">[</span><span class="s1">name</span><span class="s4">][</span><span class="s5">'charselector'</span><span class="s4">]</span>
        <span class="s3">if </span><span class="s1">charselect</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">'*'</span><span class="s4">, </span><span class="s5">''</span><span class="s4">) == </span><span class="s5">'(*)'</span><span class="s4">:</span>
            <span class="s1">charselect</span><span class="s4">[</span><span class="s5">'*'</span><span class="s4">] = </span><span class="s5">'10'</span>

    <span class="s1">l1 </span><span class="s4">= </span><span class="s1">l_tmpl</span><span class="s4">.</span><span class="s1">replace</span><span class="s4">(</span><span class="s5">'@@@NAME@@@'</span><span class="s4">, </span><span class="s1">newname</span><span class="s4">)</span>
    <span class="s1">rl </span><span class="s4">= </span><span class="s3">None</span>

    <span class="s1">useisoc </span><span class="s4">= </span><span class="s1">useiso_c_binding</span><span class="s4">(</span><span class="s1">rout</span><span class="s4">)</span>
    <span class="s1">sargs </span><span class="s4">= </span><span class="s5">', '</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">args</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">f90mode</span><span class="s4">:</span>
        <span class="s0"># gh-23598 fix warning</span>
        <span class="s0"># Essentially, this gets called again with modules where the name of the</span>
        <span class="s0"># function is added to the arguments, which is not required, and removed</span>
        <span class="s1">sargs </span><span class="s4">= </span><span class="s1">sargs</span><span class="s4">.</span><span class="s1">replace</span><span class="s4">(</span><span class="s5">f&quot;</span><span class="s3">{</span><span class="s1">name</span><span class="s3">}</span><span class="s5">, &quot;</span><span class="s4">, </span><span class="s5">''</span><span class="s4">)</span>
        <span class="s1">args </span><span class="s4">= [</span><span class="s1">arg </span><span class="s3">for </span><span class="s1">arg </span><span class="s3">in </span><span class="s1">args </span><span class="s3">if </span><span class="s1">arg </span><span class="s4">!= </span><span class="s1">name</span><span class="s4">]</span>
        <span class="s1">rout</span><span class="s4">[</span><span class="s5">'args'</span><span class="s4">] = </span><span class="s1">args</span>
        <span class="s1">add</span><span class="s4">(</span><span class="s5">'subroutine f2pywrap_%s_%s (%s)' </span><span class="s4">%</span>
            <span class="s4">(</span><span class="s1">rout</span><span class="s4">[</span><span class="s5">'modulename'</span><span class="s4">], </span><span class="s1">name</span><span class="s4">, </span><span class="s1">sargs</span><span class="s4">))</span>
        <span class="s3">if not </span><span class="s1">signature</span><span class="s4">:</span>
            <span class="s1">add</span><span class="s4">(</span><span class="s5">'use %s, only : %s' </span><span class="s4">% (</span><span class="s1">rout</span><span class="s4">[</span><span class="s5">'modulename'</span><span class="s4">], </span><span class="s1">fortranname</span><span class="s4">))</span>
        <span class="s3">if </span><span class="s1">useisoc</span><span class="s4">:</span>
            <span class="s1">add</span><span class="s4">(</span><span class="s5">'use iso_c_binding'</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">add</span><span class="s4">(</span><span class="s5">'subroutine f2pywrap%s (%s)' </span><span class="s4">% (</span><span class="s1">name</span><span class="s4">, </span><span class="s1">sargs</span><span class="s4">))</span>
        <span class="s3">if </span><span class="s1">useisoc</span><span class="s4">:</span>
            <span class="s1">add</span><span class="s4">(</span><span class="s5">'use iso_c_binding'</span><span class="s4">)</span>
        <span class="s3">if not </span><span class="s1">need_interface</span><span class="s4">:</span>
            <span class="s1">add</span><span class="s4">(</span><span class="s5">'external %s' </span><span class="s4">% (</span><span class="s1">fortranname</span><span class="s4">))</span>
            <span class="s1">rl </span><span class="s4">= </span><span class="s1">l_tmpl</span><span class="s4">.</span><span class="s1">replace</span><span class="s4">(</span><span class="s5">'@@@NAME@@@'</span><span class="s4">, </span><span class="s5">''</span><span class="s4">) + </span><span class="s5">' ' </span><span class="s4">+ </span><span class="s1">fortranname</span>

    <span class="s3">if </span><span class="s1">need_interface</span><span class="s4">:</span>
        <span class="s3">for </span><span class="s1">line </span><span class="s3">in </span><span class="s1">rout</span><span class="s4">[</span><span class="s5">'saved_interface'</span><span class="s4">].</span><span class="s1">split</span><span class="s4">(</span><span class="s5">'</span><span class="s3">\n</span><span class="s5">'</span><span class="s4">):</span>
            <span class="s3">if </span><span class="s1">line</span><span class="s4">.</span><span class="s1">lstrip</span><span class="s4">().</span><span class="s1">startswith</span><span class="s4">(</span><span class="s5">'use '</span><span class="s4">) </span><span class="s3">and </span><span class="s5">'__user__' </span><span class="s3">not in </span><span class="s1">line</span><span class="s4">:</span>
                <span class="s1">add</span><span class="s4">(</span><span class="s1">line</span><span class="s4">)</span>

    <span class="s1">args </span><span class="s4">= </span><span class="s1">args</span><span class="s4">[</span><span class="s6">1</span><span class="s4">:]</span>
    <span class="s1">dumped_args </span><span class="s4">= []</span>
    <span class="s3">for </span><span class="s1">a </span><span class="s3">in </span><span class="s1">args</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">isexternal</span><span class="s4">(</span><span class="s1">vars</span><span class="s4">[</span><span class="s1">a</span><span class="s4">]):</span>
            <span class="s1">add</span><span class="s4">(</span><span class="s5">'external %s' </span><span class="s4">% (</span><span class="s1">a</span><span class="s4">))</span>
            <span class="s1">dumped_args</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">a</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">a </span><span class="s3">in </span><span class="s1">args</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">a </span><span class="s3">in </span><span class="s1">dumped_args</span><span class="s4">:</span>
            <span class="s3">continue</span>
        <span class="s3">if </span><span class="s1">isscalar</span><span class="s4">(</span><span class="s1">vars</span><span class="s4">[</span><span class="s1">a</span><span class="s4">]):</span>
            <span class="s1">add</span><span class="s4">(</span><span class="s1">var2fixfortran</span><span class="s4">(</span><span class="s1">vars</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">f90mode</span><span class="s4">=</span><span class="s1">f90mode</span><span class="s4">))</span>
            <span class="s1">dumped_args</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">a</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">a </span><span class="s3">in </span><span class="s1">args</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">a </span><span class="s3">in </span><span class="s1">dumped_args</span><span class="s4">:</span>
            <span class="s3">continue</span>
        <span class="s3">if </span><span class="s1">isintent_in</span><span class="s4">(</span><span class="s1">vars</span><span class="s4">[</span><span class="s1">a</span><span class="s4">]):</span>
            <span class="s1">add</span><span class="s4">(</span><span class="s1">var2fixfortran</span><span class="s4">(</span><span class="s1">vars</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">f90mode</span><span class="s4">=</span><span class="s1">f90mode</span><span class="s4">))</span>
            <span class="s1">dumped_args</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">a</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">a </span><span class="s3">in </span><span class="s1">args</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">a </span><span class="s3">in </span><span class="s1">dumped_args</span><span class="s4">:</span>
            <span class="s3">continue</span>
        <span class="s1">add</span><span class="s4">(</span><span class="s1">var2fixfortran</span><span class="s4">(</span><span class="s1">vars</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">f90mode</span><span class="s4">=</span><span class="s1">f90mode</span><span class="s4">))</span>

    <span class="s1">add</span><span class="s4">(</span><span class="s1">l1</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">rl </span><span class="s3">is not None</span><span class="s4">:</span>
        <span class="s1">add</span><span class="s4">(</span><span class="s1">rl</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">need_interface</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">f90mode</span><span class="s4">:</span>
            <span class="s0"># f90 module already defines needed interface</span>
            <span class="s3">pass</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">add</span><span class="s4">(</span><span class="s5">'interface'</span><span class="s4">)</span>
            <span class="s1">add</span><span class="s4">(</span><span class="s1">rout</span><span class="s4">[</span><span class="s5">'saved_interface'</span><span class="s4">].</span><span class="s1">lstrip</span><span class="s4">())</span>
            <span class="s1">add</span><span class="s4">(</span><span class="s5">'end interface'</span><span class="s4">)</span>

    <span class="s1">sargs </span><span class="s4">= </span><span class="s5">', '</span><span class="s4">.</span><span class="s1">join</span><span class="s4">([</span><span class="s1">a </span><span class="s3">for </span><span class="s1">a </span><span class="s3">in </span><span class="s1">args </span><span class="s3">if </span><span class="s1">a </span><span class="s3">not in </span><span class="s1">extra_args</span><span class="s4">])</span>

    <span class="s3">if not </span><span class="s1">signature</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">islogicalfunction</span><span class="s4">(</span><span class="s1">rout</span><span class="s4">):</span>
            <span class="s1">add</span><span class="s4">(</span><span class="s5">'%s = .not.(.not.%s(%s))' </span><span class="s4">% (</span><span class="s1">newname</span><span class="s4">, </span><span class="s1">fortranname</span><span class="s4">, </span><span class="s1">sargs</span><span class="s4">))</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">add</span><span class="s4">(</span><span class="s5">'%s = %s(%s)' </span><span class="s4">% (</span><span class="s1">newname</span><span class="s4">, </span><span class="s1">fortranname</span><span class="s4">, </span><span class="s1">sargs</span><span class="s4">))</span>
    <span class="s3">if </span><span class="s1">f90mode</span><span class="s4">:</span>
        <span class="s1">add</span><span class="s4">(</span><span class="s5">'end subroutine f2pywrap_%s_%s' </span><span class="s4">% (</span><span class="s1">rout</span><span class="s4">[</span><span class="s5">'modulename'</span><span class="s4">], </span><span class="s1">name</span><span class="s4">))</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">add</span><span class="s4">(</span><span class="s5">'end'</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s1">ret</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>


<span class="s3">def </span><span class="s1">createsubrwrapper</span><span class="s4">(</span><span class="s1">rout</span><span class="s4">, </span><span class="s1">signature</span><span class="s4">=</span><span class="s6">0</span><span class="s4">):</span>
    <span class="s3">assert </span><span class="s1">issubroutine</span><span class="s4">(</span><span class="s1">rout</span><span class="s4">)</span>

    <span class="s1">extra_args </span><span class="s4">= []</span>
    <span class="s1">vars </span><span class="s4">= </span><span class="s1">rout</span><span class="s4">[</span><span class="s5">'vars'</span><span class="s4">]</span>
    <span class="s3">for </span><span class="s1">a </span><span class="s3">in </span><span class="s1">rout</span><span class="s4">[</span><span class="s5">'args'</span><span class="s4">]:</span>
        <span class="s1">v </span><span class="s4">= </span><span class="s1">rout</span><span class="s4">[</span><span class="s5">'vars'</span><span class="s4">][</span><span class="s1">a</span><span class="s4">]</span>
        <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">d </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">v</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">'dimension'</span><span class="s4">, [])):</span>
            <span class="s3">if </span><span class="s1">d </span><span class="s4">== </span><span class="s5">':'</span><span class="s4">:</span>
                <span class="s1">dn </span><span class="s4">= </span><span class="s5">'f2py_%s_d%s' </span><span class="s4">% (</span><span class="s1">a</span><span class="s4">, </span><span class="s1">i</span><span class="s4">)</span>
                <span class="s1">dv </span><span class="s4">= </span><span class="s1">dict</span><span class="s4">(</span><span class="s1">typespec</span><span class="s4">=</span><span class="s5">'integer'</span><span class="s4">, </span><span class="s1">intent</span><span class="s4">=[</span><span class="s5">'hide'</span><span class="s4">])</span>
                <span class="s1">dv</span><span class="s4">[</span><span class="s5">'='</span><span class="s4">] = </span><span class="s5">'shape(%s, %s)' </span><span class="s4">% (</span><span class="s1">a</span><span class="s4">, </span><span class="s1">i</span><span class="s4">)</span>
                <span class="s1">extra_args</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">dn</span><span class="s4">)</span>
                <span class="s1">vars</span><span class="s4">[</span><span class="s1">dn</span><span class="s4">] = </span><span class="s1">dv</span>
                <span class="s1">v</span><span class="s4">[</span><span class="s5">'dimension'</span><span class="s4">][</span><span class="s1">i</span><span class="s4">] = </span><span class="s1">dn</span>
    <span class="s1">rout</span><span class="s4">[</span><span class="s5">'args'</span><span class="s4">].</span><span class="s1">extend</span><span class="s4">(</span><span class="s1">extra_args</span><span class="s4">)</span>
    <span class="s1">need_interface </span><span class="s4">= </span><span class="s1">bool</span><span class="s4">(</span><span class="s1">extra_args</span><span class="s4">)</span>

    <span class="s1">ret </span><span class="s4">= [</span><span class="s5">''</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">add</span><span class="s4">(</span><span class="s1">line</span><span class="s4">, </span><span class="s1">ret</span><span class="s4">=</span><span class="s1">ret</span><span class="s4">):</span>
        <span class="s1">ret</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] = </span><span class="s5">'%s</span><span class="s3">\n      </span><span class="s5">%s' </span><span class="s4">% (</span><span class="s1">ret</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">line</span><span class="s4">)</span>
    <span class="s1">name </span><span class="s4">= </span><span class="s1">rout</span><span class="s4">[</span><span class="s5">'name'</span><span class="s4">]</span>
    <span class="s1">fortranname </span><span class="s4">= </span><span class="s1">getfortranname</span><span class="s4">(</span><span class="s1">rout</span><span class="s4">)</span>
    <span class="s1">f90mode </span><span class="s4">= </span><span class="s1">ismoduleroutine</span><span class="s4">(</span><span class="s1">rout</span><span class="s4">)</span>

    <span class="s1">args </span><span class="s4">= </span><span class="s1">rout</span><span class="s4">[</span><span class="s5">'args'</span><span class="s4">]</span>

    <span class="s1">useisoc </span><span class="s4">= </span><span class="s1">useiso_c_binding</span><span class="s4">(</span><span class="s1">rout</span><span class="s4">)</span>
    <span class="s1">sargs </span><span class="s4">= </span><span class="s5">', '</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">args</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">f90mode</span><span class="s4">:</span>
        <span class="s1">add</span><span class="s4">(</span><span class="s5">'subroutine f2pywrap_%s_%s (%s)' </span><span class="s4">%</span>
            <span class="s4">(</span><span class="s1">rout</span><span class="s4">[</span><span class="s5">'modulename'</span><span class="s4">], </span><span class="s1">name</span><span class="s4">, </span><span class="s1">sargs</span><span class="s4">))</span>
        <span class="s3">if </span><span class="s1">useisoc</span><span class="s4">:</span>
            <span class="s1">add</span><span class="s4">(</span><span class="s5">'use iso_c_binding'</span><span class="s4">)</span>
        <span class="s3">if not </span><span class="s1">signature</span><span class="s4">:</span>
            <span class="s1">add</span><span class="s4">(</span><span class="s5">'use %s, only : %s' </span><span class="s4">% (</span><span class="s1">rout</span><span class="s4">[</span><span class="s5">'modulename'</span><span class="s4">], </span><span class="s1">fortranname</span><span class="s4">))</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">add</span><span class="s4">(</span><span class="s5">'subroutine f2pywrap%s (%s)' </span><span class="s4">% (</span><span class="s1">name</span><span class="s4">, </span><span class="s1">sargs</span><span class="s4">))</span>
        <span class="s3">if </span><span class="s1">useisoc</span><span class="s4">:</span>
            <span class="s1">add</span><span class="s4">(</span><span class="s5">'use iso_c_binding'</span><span class="s4">)</span>
        <span class="s3">if not </span><span class="s1">need_interface</span><span class="s4">:</span>
            <span class="s1">add</span><span class="s4">(</span><span class="s5">'external %s' </span><span class="s4">% (</span><span class="s1">fortranname</span><span class="s4">))</span>

    <span class="s3">if </span><span class="s1">need_interface</span><span class="s4">:</span>
        <span class="s3">for </span><span class="s1">line </span><span class="s3">in </span><span class="s1">rout</span><span class="s4">[</span><span class="s5">'saved_interface'</span><span class="s4">].</span><span class="s1">split</span><span class="s4">(</span><span class="s5">'</span><span class="s3">\n</span><span class="s5">'</span><span class="s4">):</span>
            <span class="s3">if </span><span class="s1">line</span><span class="s4">.</span><span class="s1">lstrip</span><span class="s4">().</span><span class="s1">startswith</span><span class="s4">(</span><span class="s5">'use '</span><span class="s4">) </span><span class="s3">and </span><span class="s5">'__user__' </span><span class="s3">not in </span><span class="s1">line</span><span class="s4">:</span>
                <span class="s1">add</span><span class="s4">(</span><span class="s1">line</span><span class="s4">)</span>

    <span class="s1">dumped_args </span><span class="s4">= []</span>
    <span class="s3">for </span><span class="s1">a </span><span class="s3">in </span><span class="s1">args</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">isexternal</span><span class="s4">(</span><span class="s1">vars</span><span class="s4">[</span><span class="s1">a</span><span class="s4">]):</span>
            <span class="s1">add</span><span class="s4">(</span><span class="s5">'external %s' </span><span class="s4">% (</span><span class="s1">a</span><span class="s4">))</span>
            <span class="s1">dumped_args</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">a</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">a </span><span class="s3">in </span><span class="s1">args</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">a </span><span class="s3">in </span><span class="s1">dumped_args</span><span class="s4">:</span>
            <span class="s3">continue</span>
        <span class="s3">if </span><span class="s1">isscalar</span><span class="s4">(</span><span class="s1">vars</span><span class="s4">[</span><span class="s1">a</span><span class="s4">]):</span>
            <span class="s1">add</span><span class="s4">(</span><span class="s1">var2fixfortran</span><span class="s4">(</span><span class="s1">vars</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">f90mode</span><span class="s4">=</span><span class="s1">f90mode</span><span class="s4">))</span>
            <span class="s1">dumped_args</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">a</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">a </span><span class="s3">in </span><span class="s1">args</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">a </span><span class="s3">in </span><span class="s1">dumped_args</span><span class="s4">:</span>
            <span class="s3">continue</span>
        <span class="s1">add</span><span class="s4">(</span><span class="s1">var2fixfortran</span><span class="s4">(</span><span class="s1">vars</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">f90mode</span><span class="s4">=</span><span class="s1">f90mode</span><span class="s4">))</span>

    <span class="s3">if </span><span class="s1">need_interface</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">f90mode</span><span class="s4">:</span>
            <span class="s0"># f90 module already defines needed interface</span>
            <span class="s3">pass</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">add</span><span class="s4">(</span><span class="s5">'interface'</span><span class="s4">)</span>
            <span class="s3">for </span><span class="s1">line </span><span class="s3">in </span><span class="s1">rout</span><span class="s4">[</span><span class="s5">'saved_interface'</span><span class="s4">].</span><span class="s1">split</span><span class="s4">(</span><span class="s5">'</span><span class="s3">\n</span><span class="s5">'</span><span class="s4">):</span>
                <span class="s3">if </span><span class="s1">line</span><span class="s4">.</span><span class="s1">lstrip</span><span class="s4">().</span><span class="s1">startswith</span><span class="s4">(</span><span class="s5">'use '</span><span class="s4">) </span><span class="s3">and </span><span class="s5">'__user__' </span><span class="s3">in </span><span class="s1">line</span><span class="s4">:</span>
                    <span class="s3">continue</span>
                <span class="s1">add</span><span class="s4">(</span><span class="s1">line</span><span class="s4">)</span>
            <span class="s1">add</span><span class="s4">(</span><span class="s5">'end interface'</span><span class="s4">)</span>

    <span class="s1">sargs </span><span class="s4">= </span><span class="s5">', '</span><span class="s4">.</span><span class="s1">join</span><span class="s4">([</span><span class="s1">a </span><span class="s3">for </span><span class="s1">a </span><span class="s3">in </span><span class="s1">args </span><span class="s3">if </span><span class="s1">a </span><span class="s3">not in </span><span class="s1">extra_args</span><span class="s4">])</span>

    <span class="s3">if not </span><span class="s1">signature</span><span class="s4">:</span>
        <span class="s1">add</span><span class="s4">(</span><span class="s5">'call %s(%s)' </span><span class="s4">% (</span><span class="s1">fortranname</span><span class="s4">, </span><span class="s1">sargs</span><span class="s4">))</span>
    <span class="s3">if </span><span class="s1">f90mode</span><span class="s4">:</span>
        <span class="s1">add</span><span class="s4">(</span><span class="s5">'end subroutine f2pywrap_%s_%s' </span><span class="s4">% (</span><span class="s1">rout</span><span class="s4">[</span><span class="s5">'modulename'</span><span class="s4">], </span><span class="s1">name</span><span class="s4">))</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">add</span><span class="s4">(</span><span class="s5">'end'</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s1">ret</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>


<span class="s3">def </span><span class="s1">assubr</span><span class="s4">(</span><span class="s1">rout</span><span class="s4">):</span>
    <span class="s3">if </span><span class="s1">isfunction_wrap</span><span class="s4">(</span><span class="s1">rout</span><span class="s4">):</span>
        <span class="s1">fortranname </span><span class="s4">= </span><span class="s1">getfortranname</span><span class="s4">(</span><span class="s1">rout</span><span class="s4">)</span>
        <span class="s1">name </span><span class="s4">= </span><span class="s1">rout</span><span class="s4">[</span><span class="s5">'name'</span><span class="s4">]</span>
        <span class="s1">outmess</span><span class="s4">(</span><span class="s5">'</span><span class="s3">\t\t</span><span class="s5">Creating wrapper for Fortran function &quot;%s&quot;(&quot;%s&quot;)...</span><span class="s3">\n</span><span class="s5">' </span><span class="s4">% (</span>
            <span class="s1">name</span><span class="s4">, </span><span class="s1">fortranname</span><span class="s4">))</span>
        <span class="s1">rout </span><span class="s4">= </span><span class="s1">copy</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">(</span><span class="s1">rout</span><span class="s4">)</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">name</span>
        <span class="s1">rname </span><span class="s4">= </span><span class="s1">fname</span>
        <span class="s3">if </span><span class="s5">'result' </span><span class="s3">in </span><span class="s1">rout</span><span class="s4">:</span>
            <span class="s1">rname </span><span class="s4">= </span><span class="s1">rout</span><span class="s4">[</span><span class="s5">'result'</span><span class="s4">]</span>
            <span class="s1">rout</span><span class="s4">[</span><span class="s5">'vars'</span><span class="s4">][</span><span class="s1">fname</span><span class="s4">] = </span><span class="s1">rout</span><span class="s4">[</span><span class="s5">'vars'</span><span class="s4">][</span><span class="s1">rname</span><span class="s4">]</span>
        <span class="s1">fvar </span><span class="s4">= </span><span class="s1">rout</span><span class="s4">[</span><span class="s5">'vars'</span><span class="s4">][</span><span class="s1">fname</span><span class="s4">]</span>
        <span class="s3">if not </span><span class="s1">isintent_out</span><span class="s4">(</span><span class="s1">fvar</span><span class="s4">):</span>
            <span class="s3">if </span><span class="s5">'intent' </span><span class="s3">not in </span><span class="s1">fvar</span><span class="s4">:</span>
                <span class="s1">fvar</span><span class="s4">[</span><span class="s5">'intent'</span><span class="s4">] = []</span>
            <span class="s1">fvar</span><span class="s4">[</span><span class="s5">'intent'</span><span class="s4">].</span><span class="s1">append</span><span class="s4">(</span><span class="s5">'out'</span><span class="s4">)</span>
            <span class="s1">flag </span><span class="s4">= </span><span class="s6">1</span>
            <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">fvar</span><span class="s4">[</span><span class="s5">'intent'</span><span class="s4">]:</span>
                <span class="s3">if </span><span class="s1">i</span><span class="s4">.</span><span class="s1">startswith</span><span class="s4">(</span><span class="s5">'out='</span><span class="s4">):</span>
                    <span class="s1">flag </span><span class="s4">= </span><span class="s6">0</span>
                    <span class="s3">break</span>
            <span class="s3">if </span><span class="s1">flag</span><span class="s4">:</span>
                <span class="s1">fvar</span><span class="s4">[</span><span class="s5">'intent'</span><span class="s4">].</span><span class="s1">append</span><span class="s4">(</span><span class="s5">'out=%s' </span><span class="s4">% (</span><span class="s1">rname</span><span class="s4">))</span>
        <span class="s1">rout</span><span class="s4">[</span><span class="s5">'args'</span><span class="s4">][:] = [</span><span class="s1">fname</span><span class="s4">] + </span><span class="s1">rout</span><span class="s4">[</span><span class="s5">'args'</span><span class="s4">]</span>
        <span class="s3">return </span><span class="s1">rout</span><span class="s4">, </span><span class="s1">createfuncwrapper</span><span class="s4">(</span><span class="s1">rout</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">issubroutine_wrap</span><span class="s4">(</span><span class="s1">rout</span><span class="s4">):</span>
        <span class="s1">fortranname </span><span class="s4">= </span><span class="s1">getfortranname</span><span class="s4">(</span><span class="s1">rout</span><span class="s4">)</span>
        <span class="s1">name </span><span class="s4">= </span><span class="s1">rout</span><span class="s4">[</span><span class="s5">'name'</span><span class="s4">]</span>
        <span class="s1">outmess</span><span class="s4">(</span><span class="s5">'</span><span class="s3">\t\t</span><span class="s5">Creating wrapper for Fortran subroutine &quot;%s&quot;(&quot;%s&quot;)...</span><span class="s3">\n</span><span class="s5">'</span>
                <span class="s4">% (</span><span class="s1">name</span><span class="s4">, </span><span class="s1">fortranname</span><span class="s4">))</span>
        <span class="s1">rout </span><span class="s4">= </span><span class="s1">copy</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">(</span><span class="s1">rout</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">rout</span><span class="s4">, </span><span class="s1">createsubrwrapper</span><span class="s4">(</span><span class="s1">rout</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s1">rout</span><span class="s4">, </span><span class="s5">''</span>
</pre>
</body>
</html>