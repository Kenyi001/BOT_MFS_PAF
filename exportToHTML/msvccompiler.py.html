<html>
<head>
<title>msvccompiler.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #5f826b; font-style: italic;}
.s4 { color: #7a7e85;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
msvccompiler.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">os</span>
<span class="s0">from </span><span class="s1">distutils</span><span class="s2">.</span><span class="s1">msvccompiler </span><span class="s0">import </span><span class="s1">MSVCCompiler </span><span class="s0">as </span><span class="s1">_MSVCCompiler</span>

<span class="s0">from </span><span class="s2">.</span><span class="s1">system_info </span><span class="s0">import </span><span class="s1">platform_bits</span>


<span class="s0">def </span><span class="s1">_merge</span><span class="s2">(</span><span class="s1">old</span><span class="s2">, </span><span class="s1">new</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot;Concatenate two environment paths avoiding repeats. 
 
    Here `old` is the environment string before the base class initialize 
    function is called and `new` is the string after the call. The new string 
    will be a fixed string if it is not obtained from the current environment, 
    or the same as the old string if obtained from the same environment. The aim 
    here is not to append the new string if it is already contained in the old 
    string so as to limit the growth of the environment string. 
 
    Parameters 
    ---------- 
    old : string 
        Previous environment string. 
    new : string 
        New environment string. 
 
    Returns 
    ------- 
    ret : string 
        Updated environment string. 
 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">new </span><span class="s0">in </span><span class="s1">old</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">old</span>
    <span class="s0">if not </span><span class="s1">old</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">new</span>

    <span class="s4"># Neither new nor old is empty. Give old priority.</span>
    <span class="s0">return </span><span class="s5">';'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">([</span><span class="s1">old</span><span class="s2">, </span><span class="s1">new</span><span class="s2">])</span>


<span class="s0">class </span><span class="s1">MSVCCompiler</span><span class="s2">(</span><span class="s1">_MSVCCompiler</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">verbose</span><span class="s2">=</span><span class="s6">0</span><span class="s2">, </span><span class="s1">dry_run</span><span class="s2">=</span><span class="s6">0</span><span class="s2">, </span><span class="s1">force</span><span class="s2">=</span><span class="s6">0</span><span class="s2">):</span>
        <span class="s1">_MSVCCompiler</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">verbose</span><span class="s2">, </span><span class="s1">dry_run</span><span class="s2">, </span><span class="s1">force</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">initialize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># The 'lib' and 'include' variables may be overwritten</span>
        <span class="s4"># by MSVCCompiler.initialize, so save them for later merge.</span>
        <span class="s1">environ_lib </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">getenv</span><span class="s2">(</span><span class="s5">'lib'</span><span class="s2">, </span><span class="s5">''</span><span class="s2">)</span>
        <span class="s1">environ_include </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">getenv</span><span class="s2">(</span><span class="s5">'include'</span><span class="s2">, </span><span class="s5">''</span><span class="s2">)</span>
        <span class="s1">_MSVCCompiler</span><span class="s2">.</span><span class="s1">initialize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

        <span class="s4"># Merge current and previous values of 'lib' and 'include'</span>
        <span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">[</span><span class="s5">'lib'</span><span class="s2">] = </span><span class="s1">_merge</span><span class="s2">(</span><span class="s1">environ_lib</span><span class="s2">, </span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">[</span><span class="s5">'lib'</span><span class="s2">])</span>
        <span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">[</span><span class="s5">'include'</span><span class="s2">] = </span><span class="s1">_merge</span><span class="s2">(</span><span class="s1">environ_include</span><span class="s2">, </span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">[</span><span class="s5">'include'</span><span class="s2">])</span>

        <span class="s4"># msvc9 building for 32 bits requires SSE2 to work around a</span>
        <span class="s4"># compiler bug.</span>
        <span class="s0">if </span><span class="s1">platform_bits </span><span class="s2">== </span><span class="s6">32</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">compile_options </span><span class="s2">+= [</span><span class="s5">'/arch:SSE2'</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">compile_options_debug </span><span class="s2">+= [</span><span class="s5">'/arch:SSE2'</span><span class="s2">]</span>


<span class="s0">def </span><span class="s1">lib_opts_if_msvc</span><span class="s2">(</span><span class="s1">build_cmd</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot; Add flags if we are using MSVC compiler 
 
    We can't see `build_cmd` in our scope, because we have not initialized 
    the distutils build command, so use this deferred calculation to run 
    when we are building the library. 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">build_cmd</span><span class="s2">.</span><span class="s1">compiler</span><span class="s2">.</span><span class="s1">compiler_type </span><span class="s2">!= </span><span class="s5">'msvc'</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s2">[]</span>
    <span class="s4"># Explicitly disable whole-program optimization.</span>
    <span class="s1">flags </span><span class="s2">= [</span><span class="s5">'/GL-'</span><span class="s2">]</span>
    <span class="s4"># Disable voltbl section for vc142 to allow link using mingw-w64; see:</span>
    <span class="s4"># https://github.com/matthew-brett/dll_investigation/issues/1#issuecomment-1100468171</span>
    <span class="s0">if </span><span class="s1">build_cmd</span><span class="s2">.</span><span class="s1">compiler_opt</span><span class="s2">.</span><span class="s1">cc_test_flags</span><span class="s2">([</span><span class="s5">'-d2VolatileMetadata-'</span><span class="s2">]):</span>
        <span class="s1">flags</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s5">'-d2VolatileMetadata-'</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">flags</span>
</pre>
</body>
</html>