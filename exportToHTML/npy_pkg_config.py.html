<html>
<head>
<title>npy_pkg_config.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
npy_pkg_config.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">re</span>
<span class="s0">import </span><span class="s1">os</span>

<span class="s0">from </span><span class="s1">configparser </span><span class="s0">import </span><span class="s1">RawConfigParser</span>

<span class="s1">__all__ </span><span class="s2">= [</span><span class="s3">'FormatError'</span><span class="s2">, </span><span class="s3">'PkgNotFound'</span><span class="s2">, </span><span class="s3">'LibraryInfo'</span><span class="s2">, </span><span class="s3">'VariableSet'</span><span class="s2">,</span>
        <span class="s3">'read_config'</span><span class="s2">, </span><span class="s3">'parse_flags'</span><span class="s2">]</span>

<span class="s1">_VAR </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s3">r'\$\{([a-zA-Z0-9_-]+)\}'</span><span class="s2">)</span>

<span class="s0">class </span><span class="s1">FormatError</span><span class="s2">(</span><span class="s1">OSError</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Exception thrown when there is a problem parsing a configuration file. 
 
    &quot;&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">msg </span><span class="s2">= </span><span class="s1">msg</span>

    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">msg</span>

<span class="s0">class </span><span class="s1">PkgNotFound</span><span class="s2">(</span><span class="s1">OSError</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Exception raised when a package can not be located.&quot;&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">msg </span><span class="s2">= </span><span class="s1">msg</span>

    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">msg</span>

<span class="s0">def </span><span class="s1">parse_flags</span><span class="s2">(</span><span class="s1">line</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Parse a line from a config file containing compile flags. 
 
    Parameters 
    ---------- 
    line : str 
        A single line containing one or more compile flags. 
 
    Returns 
    ------- 
    d : dict 
        Dictionary of parsed flags, split into relevant categories. 
        These categories are the keys of `d`: 
 
        * 'include_dirs' 
        * 'library_dirs' 
        * 'libraries' 
        * 'macros' 
        * 'ignored' 
 
    &quot;&quot;&quot;</span>
    <span class="s1">d </span><span class="s2">= {</span><span class="s3">'include_dirs'</span><span class="s2">: [], </span><span class="s3">'library_dirs'</span><span class="s2">: [], </span><span class="s3">'libraries'</span><span class="s2">: [],</span>
         <span class="s3">'macros'</span><span class="s2">: [], </span><span class="s3">'ignored'</span><span class="s2">: []}</span>

    <span class="s1">flags </span><span class="s2">= (</span><span class="s3">' ' </span><span class="s2">+ </span><span class="s1">line</span><span class="s2">).</span><span class="s1">split</span><span class="s2">(</span><span class="s3">' -'</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">flag </span><span class="s0">in </span><span class="s1">flags</span><span class="s2">:</span>
        <span class="s1">flag </span><span class="s2">= </span><span class="s3">'-' </span><span class="s2">+ </span><span class="s1">flag</span>
        <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">flag</span><span class="s2">) &gt; </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">flag</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'-I'</span><span class="s2">):</span>
                <span class="s1">d</span><span class="s2">[</span><span class="s3">'include_dirs'</span><span class="s2">].</span><span class="s1">append</span><span class="s2">(</span><span class="s1">flag</span><span class="s2">[</span><span class="s5">2</span><span class="s2">:].</span><span class="s1">strip</span><span class="s2">())</span>
            <span class="s0">elif </span><span class="s1">flag</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'-L'</span><span class="s2">):</span>
                <span class="s1">d</span><span class="s2">[</span><span class="s3">'library_dirs'</span><span class="s2">].</span><span class="s1">append</span><span class="s2">(</span><span class="s1">flag</span><span class="s2">[</span><span class="s5">2</span><span class="s2">:].</span><span class="s1">strip</span><span class="s2">())</span>
            <span class="s0">elif </span><span class="s1">flag</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'-l'</span><span class="s2">):</span>
                <span class="s1">d</span><span class="s2">[</span><span class="s3">'libraries'</span><span class="s2">].</span><span class="s1">append</span><span class="s2">(</span><span class="s1">flag</span><span class="s2">[</span><span class="s5">2</span><span class="s2">:].</span><span class="s1">strip</span><span class="s2">())</span>
            <span class="s0">elif </span><span class="s1">flag</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'-D'</span><span class="s2">):</span>
                <span class="s1">d</span><span class="s2">[</span><span class="s3">'macros'</span><span class="s2">].</span><span class="s1">append</span><span class="s2">(</span><span class="s1">flag</span><span class="s2">[</span><span class="s5">2</span><span class="s2">:].</span><span class="s1">strip</span><span class="s2">())</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">d</span><span class="s2">[</span><span class="s3">'ignored'</span><span class="s2">].</span><span class="s1">append</span><span class="s2">(</span><span class="s1">flag</span><span class="s2">)</span>

    <span class="s0">return </span><span class="s1">d</span>

<span class="s0">def </span><span class="s1">_escape_backslash</span><span class="s2">(</span><span class="s1">val</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">val</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s3">'</span><span class="s0">\\</span><span class="s3">'</span><span class="s2">, </span><span class="s3">'</span><span class="s0">\\\\</span><span class="s3">'</span><span class="s2">)</span>

<span class="s0">class </span><span class="s1">LibraryInfo</span><span class="s2">:</span>
    <span class="s4">&quot;&quot;&quot; 
    Object containing build information about a library. 
 
    Parameters 
    ---------- 
    name : str 
        The library name. 
    description : str 
        Description of the library. 
    version : str 
        Version string. 
    sections : dict 
        The sections of the configuration file for the library. The keys are 
        the section headers, the values the text under each header. 
    vars : class instance 
        A `VariableSet` instance, which contains ``(name, value)`` pairs for 
        variables defined in the configuration file for the library. 
    requires : sequence, optional 
        The required libraries for the library to be installed. 
 
    Notes 
    ----- 
    All input parameters (except &quot;sections&quot; which is a method) are available as 
    attributes of the same name. 
 
    &quot;&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">description</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">sections</span><span class="s2">, </span><span class="s1">vars</span><span class="s2">, </span><span class="s1">requires</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">description </span><span class="s2">= </span><span class="s1">description</span>
        <span class="s0">if </span><span class="s1">requires</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">requires </span><span class="s2">= </span><span class="s1">requires</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">requires </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">version </span><span class="s2">= </span><span class="s1">version</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_sections </span><span class="s2">= </span><span class="s1">sections</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">vars </span><span class="s2">= </span><span class="s1">vars</span>

    <span class="s0">def </span><span class="s1">sections</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Return the section headers of the config file. 
 
        Parameters 
        ---------- 
        None 
 
        Returns 
        ------- 
        keys : list of str 
            The list of section headers. 
 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_sections</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">cflags</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">section</span><span class="s2">=</span><span class="s3">&quot;default&quot;</span><span class="s2">):</span>
        <span class="s1">val </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">vars</span><span class="s2">.</span><span class="s1">interpolate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_sections</span><span class="s2">[</span><span class="s1">section</span><span class="s2">][</span><span class="s3">'cflags'</span><span class="s2">])</span>
        <span class="s0">return </span><span class="s1">_escape_backslash</span><span class="s2">(</span><span class="s1">val</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">libs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">section</span><span class="s2">=</span><span class="s3">&quot;default&quot;</span><span class="s2">):</span>
        <span class="s1">val </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">vars</span><span class="s2">.</span><span class="s1">interpolate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_sections</span><span class="s2">[</span><span class="s1">section</span><span class="s2">][</span><span class="s3">'libs'</span><span class="s2">])</span>
        <span class="s0">return </span><span class="s1">_escape_backslash</span><span class="s2">(</span><span class="s1">val</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">m </span><span class="s2">= [</span><span class="s3">'Name: %s' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s3">'Description: %s' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">description</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">requires</span><span class="s2">:</span>
            <span class="s1">m</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">'Requires:'</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">m</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">'Requires: %s' </span><span class="s2">% </span><span class="s3">&quot;,&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">requires</span><span class="s2">))</span>
        <span class="s1">m</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">'Version: %s' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">)</span>

        <span class="s0">return </span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">m</span><span class="s2">)</span>

<span class="s0">class </span><span class="s1">VariableSet</span><span class="s2">:</span>
    <span class="s4">&quot;&quot;&quot; 
    Container object for the variables defined in a config file. 
 
    `VariableSet` can be used as a plain dictionary, with the variable names 
    as keys. 
 
    Parameters 
    ---------- 
    d : dict 
        Dict of items in the &quot;variables&quot; section of the configuration file. 
 
    &quot;&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">d</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_raw_data </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">([(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">v</span><span class="s2">) </span><span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">d</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()])</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_re </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_re_sub </span><span class="s2">= {}</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_init_parse</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">_init_parse</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_raw_data</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_init_parse_var</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_init_parse_var</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_re</span><span class="s2">[</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s3">r'\$\{%s\}' </span><span class="s2">% </span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_re_sub</span><span class="s2">[</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">value</span>

    <span class="s0">def </span><span class="s1">interpolate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s6"># Brute force: we keep interpolating until there is no '${var}' anymore</span>
        <span class="s6"># or until interpolated string is equal to input string</span>
        <span class="s0">def </span><span class="s1">_interpolate</span><span class="s2">(</span><span class="s1">value</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_re</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">():</span>
                <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_re</span><span class="s2">[</span><span class="s1">k</span><span class="s2">].</span><span class="s1">sub</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_re_sub</span><span class="s2">[</span><span class="s1">k</span><span class="s2">], </span><span class="s1">value</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">value</span>
        <span class="s0">while </span><span class="s1">_VAR</span><span class="s2">.</span><span class="s1">search</span><span class="s2">(</span><span class="s1">value</span><span class="s2">):</span>
            <span class="s1">nvalue </span><span class="s2">= </span><span class="s1">_interpolate</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">nvalue </span><span class="s2">== </span><span class="s1">value</span><span class="s2">:</span>
                <span class="s0">break</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">nvalue</span>

        <span class="s0">return </span><span class="s1">value</span>

    <span class="s0">def </span><span class="s1">variables</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Return the list of variable names. 
 
        Parameters 
        ---------- 
        None 
 
        Returns 
        ------- 
        names : list of str 
            The names of all variables in the `VariableSet` instance. 
 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_raw_data</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>

    <span class="s6"># Emulate a dict to set/get variables values</span>
    <span class="s0">def </span><span class="s1">__getitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_raw_data</span><span class="s2">[</span><span class="s1">name</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">__setitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_raw_data</span><span class="s2">[</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">value</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_init_parse_var</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">parse_meta</span><span class="s2">(</span><span class="s1">config</span><span class="s2">):</span>
    <span class="s0">if not </span><span class="s1">config</span><span class="s2">.</span><span class="s1">has_section</span><span class="s2">(</span><span class="s3">'meta'</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">FormatError</span><span class="s2">(</span><span class="s3">&quot;No meta section found !&quot;</span><span class="s2">)</span>

    <span class="s1">d </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">config</span><span class="s2">.</span><span class="s1">items</span><span class="s2">(</span><span class="s3">'meta'</span><span class="s2">))</span>

    <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s2">[</span><span class="s3">'name'</span><span class="s2">, </span><span class="s3">'description'</span><span class="s2">, </span><span class="s3">'version'</span><span class="s2">]:</span>
        <span class="s0">if not </span><span class="s1">k </span><span class="s0">in </span><span class="s1">d</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">FormatError</span><span class="s2">(</span><span class="s3">&quot;Option %s (section [meta]) is mandatory, &quot;</span>
                <span class="s3">&quot;but not found&quot; </span><span class="s2">% </span><span class="s1">k</span><span class="s2">)</span>

    <span class="s0">if not </span><span class="s3">'requires' </span><span class="s0">in </span><span class="s1">d</span><span class="s2">:</span>
        <span class="s1">d</span><span class="s2">[</span><span class="s3">'requires'</span><span class="s2">] = []</span>

    <span class="s0">return </span><span class="s1">d</span>

<span class="s0">def </span><span class="s1">parse_variables</span><span class="s2">(</span><span class="s1">config</span><span class="s2">):</span>
    <span class="s0">if not </span><span class="s1">config</span><span class="s2">.</span><span class="s1">has_section</span><span class="s2">(</span><span class="s3">'variables'</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">FormatError</span><span class="s2">(</span><span class="s3">&quot;No variables section found !&quot;</span><span class="s2">)</span>

    <span class="s1">d </span><span class="s2">= {}</span>

    <span class="s0">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">config</span><span class="s2">.</span><span class="s1">items</span><span class="s2">(</span><span class="s3">&quot;variables&quot;</span><span class="s2">):</span>
        <span class="s1">d</span><span class="s2">[</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">value</span>

    <span class="s0">return </span><span class="s1">VariableSet</span><span class="s2">(</span><span class="s1">d</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">parse_sections</span><span class="s2">(</span><span class="s1">config</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">meta_d</span><span class="s2">, </span><span class="s1">r</span>

<span class="s0">def </span><span class="s1">pkg_to_filename</span><span class="s2">(</span><span class="s1">pkg_name</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s3">&quot;%s.ini&quot; </span><span class="s2">% </span><span class="s1">pkg_name</span>

<span class="s0">def </span><span class="s1">parse_config</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">dirs</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">dirs</span><span class="s2">:</span>
        <span class="s1">filenames </span><span class="s2">= [</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">) </span><span class="s0">for </span><span class="s1">d </span><span class="s0">in </span><span class="s1">dirs</span><span class="s2">]</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">filenames </span><span class="s2">= [</span><span class="s1">filename</span><span class="s2">]</span>

    <span class="s1">config </span><span class="s2">= </span><span class="s1">RawConfigParser</span><span class="s2">()</span>

    <span class="s1">n </span><span class="s2">= </span><span class="s1">config</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">filenames</span><span class="s2">)</span>
    <span class="s0">if not </span><span class="s1">len</span><span class="s2">(</span><span class="s1">n</span><span class="s2">) &gt;= </span><span class="s5">1</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">PkgNotFound</span><span class="s2">(</span><span class="s3">&quot;Could not find file(s) %s&quot; </span><span class="s2">% </span><span class="s1">str</span><span class="s2">(</span><span class="s1">filenames</span><span class="s2">))</span>

    <span class="s6"># Parse meta and variables sections</span>
    <span class="s1">meta </span><span class="s2">= </span><span class="s1">parse_meta</span><span class="s2">(</span><span class="s1">config</span><span class="s2">)</span>

    <span class="s1">vars </span><span class="s2">= {}</span>
    <span class="s0">if </span><span class="s1">config</span><span class="s2">.</span><span class="s1">has_section</span><span class="s2">(</span><span class="s3">'variables'</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">config</span><span class="s2">.</span><span class="s1">items</span><span class="s2">(</span><span class="s3">&quot;variables&quot;</span><span class="s2">):</span>
            <span class="s1">vars</span><span class="s2">[</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">_escape_backslash</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s6"># Parse &quot;normal&quot; sections</span>
    <span class="s1">secs </span><span class="s2">= [</span><span class="s1">s </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">config</span><span class="s2">.</span><span class="s1">sections</span><span class="s2">() </span><span class="s0">if not </span><span class="s1">s </span><span class="s0">in </span><span class="s2">[</span><span class="s3">'meta'</span><span class="s2">, </span><span class="s3">'variables'</span><span class="s2">]]</span>
    <span class="s1">sections </span><span class="s2">= {}</span>

    <span class="s1">requires </span><span class="s2">= {}</span>
    <span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">secs</span><span class="s2">:</span>
        <span class="s1">d </span><span class="s2">= {}</span>
        <span class="s0">if </span><span class="s1">config</span><span class="s2">.</span><span class="s1">has_option</span><span class="s2">(</span><span class="s1">s</span><span class="s2">, </span><span class="s3">&quot;requires&quot;</span><span class="s2">):</span>
            <span class="s1">requires</span><span class="s2">[</span><span class="s1">s</span><span class="s2">] = </span><span class="s1">config</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">s</span><span class="s2">, </span><span class="s3">'requires'</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">config</span><span class="s2">.</span><span class="s1">items</span><span class="s2">(</span><span class="s1">s</span><span class="s2">):</span>
            <span class="s1">d</span><span class="s2">[</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">value</span>
        <span class="s1">sections</span><span class="s2">[</span><span class="s1">s</span><span class="s2">] = </span><span class="s1">d</span>

    <span class="s0">return </span><span class="s1">meta</span><span class="s2">, </span><span class="s1">vars</span><span class="s2">, </span><span class="s1">sections</span><span class="s2">, </span><span class="s1">requires</span>

<span class="s0">def </span><span class="s1">_read_config_imp</span><span class="s2">(</span><span class="s1">filenames</span><span class="s2">, </span><span class="s1">dirs</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">_read_config</span><span class="s2">(</span><span class="s1">f</span><span class="s2">):</span>
        <span class="s1">meta</span><span class="s2">, </span><span class="s1">vars</span><span class="s2">, </span><span class="s1">sections</span><span class="s2">, </span><span class="s1">reqs </span><span class="s2">= </span><span class="s1">parse_config</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">dirs</span><span class="s2">)</span>
        <span class="s6"># recursively add sections and variables of required libraries</span>
        <span class="s0">for </span><span class="s1">rname</span><span class="s2">, </span><span class="s1">rvalue </span><span class="s0">in </span><span class="s1">reqs</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">nmeta</span><span class="s2">, </span><span class="s1">nvars</span><span class="s2">, </span><span class="s1">nsections</span><span class="s2">, </span><span class="s1">nreqs </span><span class="s2">= </span><span class="s1">_read_config</span><span class="s2">(</span><span class="s1">pkg_to_filename</span><span class="s2">(</span><span class="s1">rvalue</span><span class="s2">))</span>

            <span class="s6"># Update var dict for variables not in 'top' config file</span>
            <span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">nvars</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                <span class="s0">if not </span><span class="s1">k </span><span class="s0">in </span><span class="s1">vars</span><span class="s2">:</span>
                    <span class="s1">vars</span><span class="s2">[</span><span class="s1">k</span><span class="s2">] = </span><span class="s1">v</span>

            <span class="s6"># Update sec dict</span>
            <span class="s0">for </span><span class="s1">oname</span><span class="s2">, </span><span class="s1">ovalue </span><span class="s0">in </span><span class="s1">nsections</span><span class="s2">[</span><span class="s1">rname</span><span class="s2">].</span><span class="s1">items</span><span class="s2">():</span>
                <span class="s0">if </span><span class="s1">ovalue</span><span class="s2">:</span>
                    <span class="s1">sections</span><span class="s2">[</span><span class="s1">rname</span><span class="s2">][</span><span class="s1">oname</span><span class="s2">] += </span><span class="s3">' %s' </span><span class="s2">% </span><span class="s1">ovalue</span>

        <span class="s0">return </span><span class="s1">meta</span><span class="s2">, </span><span class="s1">vars</span><span class="s2">, </span><span class="s1">sections</span><span class="s2">, </span><span class="s1">reqs</span>

    <span class="s1">meta</span><span class="s2">, </span><span class="s1">vars</span><span class="s2">, </span><span class="s1">sections</span><span class="s2">, </span><span class="s1">reqs </span><span class="s2">= </span><span class="s1">_read_config</span><span class="s2">(</span><span class="s1">filenames</span><span class="s2">)</span>

    <span class="s6"># FIXME: document this. If pkgname is defined in the variables section, and</span>
    <span class="s6"># there is no pkgdir variable defined, pkgdir is automatically defined to</span>
    <span class="s6"># the path of pkgname. This requires the package to be imported to work</span>
    <span class="s0">if not </span><span class="s3">'pkgdir' </span><span class="s0">in </span><span class="s1">vars </span><span class="s0">and </span><span class="s3">&quot;pkgname&quot; </span><span class="s0">in </span><span class="s1">vars</span><span class="s2">:</span>
        <span class="s1">pkgname </span><span class="s2">= </span><span class="s1">vars</span><span class="s2">[</span><span class="s3">&quot;pkgname&quot;</span><span class="s2">]</span>
        <span class="s0">if not </span><span class="s1">pkgname </span><span class="s0">in </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;You should import %s to get information on %s&quot; </span><span class="s2">%</span>
                             <span class="s2">(</span><span class="s1">pkgname</span><span class="s2">, </span><span class="s1">meta</span><span class="s2">[</span><span class="s3">&quot;name&quot;</span><span class="s2">]))</span>

        <span class="s1">mod </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">[</span><span class="s1">pkgname</span><span class="s2">]</span>
        <span class="s1">vars</span><span class="s2">[</span><span class="s3">&quot;pkgdir&quot;</span><span class="s2">] = </span><span class="s1">_escape_backslash</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">mod</span><span class="s2">.</span><span class="s1">__file__</span><span class="s2">))</span>

    <span class="s0">return </span><span class="s1">LibraryInfo</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s1">meta</span><span class="s2">[</span><span class="s3">&quot;name&quot;</span><span class="s2">], </span><span class="s1">description</span><span class="s2">=</span><span class="s1">meta</span><span class="s2">[</span><span class="s3">&quot;description&quot;</span><span class="s2">],</span>
            <span class="s1">version</span><span class="s2">=</span><span class="s1">meta</span><span class="s2">[</span><span class="s3">&quot;version&quot;</span><span class="s2">], </span><span class="s1">sections</span><span class="s2">=</span><span class="s1">sections</span><span class="s2">, </span><span class="s1">vars</span><span class="s2">=</span><span class="s1">VariableSet</span><span class="s2">(</span><span class="s1">vars</span><span class="s2">))</span>

<span class="s6"># Trivial cache to cache LibraryInfo instances creation. To be really</span>
<span class="s6"># efficient, the cache should be handled in read_config, since a same file can</span>
<span class="s6"># be parsed many time outside LibraryInfo creation, but I doubt this will be a</span>
<span class="s6"># problem in practice</span>
<span class="s1">_CACHE </span><span class="s2">= {}</span>
<span class="s0">def </span><span class="s1">read_config</span><span class="s2">(</span><span class="s1">pkgname</span><span class="s2">, </span><span class="s1">dirs</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Return library info for a package from its configuration file. 
 
    Parameters 
    ---------- 
    pkgname : str 
        Name of the package (should match the name of the .ini file, without 
        the extension, e.g. foo for the file foo.ini). 
    dirs : sequence, optional 
        If given, should be a sequence of directories - usually including 
        the NumPy base directory - where to look for npy-pkg-config files. 
 
    Returns 
    ------- 
    pkginfo : class instance 
        The `LibraryInfo` instance containing the build information. 
 
    Raises 
    ------ 
    PkgNotFound 
        If the package is not found. 
 
    See Also 
    -------- 
    misc_util.get_info, misc_util.get_pkg_info 
 
    Examples 
    -------- 
    &gt;&gt;&gt; npymath_info = np.distutils.npy_pkg_config.read_config('npymath') 
    &gt;&gt;&gt; type(npymath_info) 
    &lt;class 'numpy.distutils.npy_pkg_config.LibraryInfo'&gt; 
    &gt;&gt;&gt; print(npymath_info) 
    Name: npymath 
    Description: Portable, core math library implementing C99 standard 
    Requires: 
    Version: 0.1  #random 
 
    &quot;&quot;&quot;</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">_CACHE</span><span class="s2">[</span><span class="s1">pkgname</span><span class="s2">]</span>
    <span class="s0">except </span><span class="s1">KeyError</span><span class="s2">:</span>
        <span class="s1">v </span><span class="s2">= </span><span class="s1">_read_config_imp</span><span class="s2">(</span><span class="s1">pkg_to_filename</span><span class="s2">(</span><span class="s1">pkgname</span><span class="s2">), </span><span class="s1">dirs</span><span class="s2">)</span>
        <span class="s1">_CACHE</span><span class="s2">[</span><span class="s1">pkgname</span><span class="s2">] = </span><span class="s1">v</span>
        <span class="s0">return </span><span class="s1">v</span>

<span class="s6"># TODO:</span>
<span class="s6">#   - implements version comparison (modversion + atleast)</span>

<span class="s6"># pkg-config simple emulator - useful for debugging, and maybe later to query</span>
<span class="s6"># the system</span>
<span class="s0">if </span><span class="s1">__name__ </span><span class="s2">== </span><span class="s3">'__main__'</span><span class="s2">:</span>
    <span class="s0">from </span><span class="s1">optparse </span><span class="s0">import </span><span class="s1">OptionParser</span>
    <span class="s0">import </span><span class="s1">glob</span>

    <span class="s1">parser </span><span class="s2">= </span><span class="s1">OptionParser</span><span class="s2">()</span>
    <span class="s1">parser</span><span class="s2">.</span><span class="s1">add_option</span><span class="s2">(</span><span class="s3">&quot;--cflags&quot;</span><span class="s2">, </span><span class="s1">dest</span><span class="s2">=</span><span class="s3">&quot;cflags&quot;</span><span class="s2">, </span><span class="s1">action</span><span class="s2">=</span><span class="s3">&quot;store_true&quot;</span><span class="s2">,</span>
                      <span class="s1">help</span><span class="s2">=</span><span class="s3">&quot;output all preprocessor and compiler flags&quot;</span><span class="s2">)</span>
    <span class="s1">parser</span><span class="s2">.</span><span class="s1">add_option</span><span class="s2">(</span><span class="s3">&quot;--libs&quot;</span><span class="s2">, </span><span class="s1">dest</span><span class="s2">=</span><span class="s3">&quot;libs&quot;</span><span class="s2">, </span><span class="s1">action</span><span class="s2">=</span><span class="s3">&quot;store_true&quot;</span><span class="s2">,</span>
                      <span class="s1">help</span><span class="s2">=</span><span class="s3">&quot;output all linker flags&quot;</span><span class="s2">)</span>
    <span class="s1">parser</span><span class="s2">.</span><span class="s1">add_option</span><span class="s2">(</span><span class="s3">&quot;--use-section&quot;</span><span class="s2">, </span><span class="s1">dest</span><span class="s2">=</span><span class="s3">&quot;section&quot;</span><span class="s2">,</span>
                      <span class="s1">help</span><span class="s2">=</span><span class="s3">&quot;use this section instead of default for options&quot;</span><span class="s2">)</span>
    <span class="s1">parser</span><span class="s2">.</span><span class="s1">add_option</span><span class="s2">(</span><span class="s3">&quot;--version&quot;</span><span class="s2">, </span><span class="s1">dest</span><span class="s2">=</span><span class="s3">&quot;version&quot;</span><span class="s2">, </span><span class="s1">action</span><span class="s2">=</span><span class="s3">&quot;store_true&quot;</span><span class="s2">,</span>
                      <span class="s1">help</span><span class="s2">=</span><span class="s3">&quot;output version&quot;</span><span class="s2">)</span>
    <span class="s1">parser</span><span class="s2">.</span><span class="s1">add_option</span><span class="s2">(</span><span class="s3">&quot;--atleast-version&quot;</span><span class="s2">, </span><span class="s1">dest</span><span class="s2">=</span><span class="s3">&quot;min_version&quot;</span><span class="s2">,</span>
                      <span class="s1">help</span><span class="s2">=</span><span class="s3">&quot;Minimal version&quot;</span><span class="s2">)</span>
    <span class="s1">parser</span><span class="s2">.</span><span class="s1">add_option</span><span class="s2">(</span><span class="s3">&quot;--list-all&quot;</span><span class="s2">, </span><span class="s1">dest</span><span class="s2">=</span><span class="s3">&quot;list_all&quot;</span><span class="s2">, </span><span class="s1">action</span><span class="s2">=</span><span class="s3">&quot;store_true&quot;</span><span class="s2">,</span>
                      <span class="s1">help</span><span class="s2">=</span><span class="s3">&quot;Minimal version&quot;</span><span class="s2">)</span>
    <span class="s1">parser</span><span class="s2">.</span><span class="s1">add_option</span><span class="s2">(</span><span class="s3">&quot;--define-variable&quot;</span><span class="s2">, </span><span class="s1">dest</span><span class="s2">=</span><span class="s3">&quot;define_variable&quot;</span><span class="s2">,</span>
                      <span class="s1">help</span><span class="s2">=</span><span class="s3">&quot;Replace variable with the given value&quot;</span><span class="s2">)</span>

    <span class="s2">(</span><span class="s1">options</span><span class="s2">, </span><span class="s1">args</span><span class="s2">) = </span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parse_args</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">argv</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">args</span><span class="s2">) &lt; </span><span class="s5">2</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;Expect package name on the command line:&quot;</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">options</span><span class="s2">.</span><span class="s1">list_all</span><span class="s2">:</span>
        <span class="s1">files </span><span class="s2">= </span><span class="s1">glob</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">(</span><span class="s3">&quot;*.ini&quot;</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">files</span><span class="s2">:</span>
            <span class="s1">info </span><span class="s2">= </span><span class="s1">read_config</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;%s</span><span class="s0">\t</span><span class="s3">%s - %s&quot; </span><span class="s2">% (</span><span class="s1">info</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">info</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">info</span><span class="s2">.</span><span class="s1">description</span><span class="s2">))</span>

    <span class="s1">pkg_name </span><span class="s2">= </span><span class="s1">args</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">d </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'NPY_PKG_CONFIG_PATH'</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">d</span><span class="s2">:</span>
        <span class="s1">info </span><span class="s2">= </span><span class="s1">read_config</span><span class="s2">(</span><span class="s1">pkg_name</span><span class="s2">, [</span><span class="s3">'numpy/core/lib/npy-pkg-config'</span><span class="s2">, </span><span class="s3">'.'</span><span class="s2">, </span><span class="s1">d</span><span class="s2">])</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">info </span><span class="s2">= </span><span class="s1">read_config</span><span class="s2">(</span><span class="s1">pkg_name</span><span class="s2">, [</span><span class="s3">'numpy/core/lib/npy-pkg-config'</span><span class="s2">, </span><span class="s3">'.'</span><span class="s2">])</span>

    <span class="s0">if </span><span class="s1">options</span><span class="s2">.</span><span class="s1">section</span><span class="s2">:</span>
        <span class="s1">section </span><span class="s2">= </span><span class="s1">options</span><span class="s2">.</span><span class="s1">section</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">section </span><span class="s2">= </span><span class="s3">&quot;default&quot;</span>

    <span class="s0">if </span><span class="s1">options</span><span class="s2">.</span><span class="s1">define_variable</span><span class="s2">:</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">search</span><span class="s2">(</span><span class="s3">r'([\S]+)=([\S]+)'</span><span class="s2">, </span><span class="s1">options</span><span class="s2">.</span><span class="s1">define_variable</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">m</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;--define-variable option should be of &quot;</span>
                             <span class="s3">&quot;the form --define-variable=foo=bar&quot;</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)</span>
        <span class="s1">info</span><span class="s2">.</span><span class="s1">vars</span><span class="s2">[</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">value</span>

    <span class="s0">if </span><span class="s1">options</span><span class="s2">.</span><span class="s1">cflags</span><span class="s2">:</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s1">info</span><span class="s2">.</span><span class="s1">cflags</span><span class="s2">(</span><span class="s1">section</span><span class="s2">))</span>
    <span class="s0">if </span><span class="s1">options</span><span class="s2">.</span><span class="s1">libs</span><span class="s2">:</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s1">info</span><span class="s2">.</span><span class="s1">libs</span><span class="s2">(</span><span class="s1">section</span><span class="s2">))</span>
    <span class="s0">if </span><span class="s1">options</span><span class="s2">.</span><span class="s1">version</span><span class="s2">:</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s1">info</span><span class="s2">.</span><span class="s1">version</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">options</span><span class="s2">.</span><span class="s1">min_version</span><span class="s2">:</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s1">info</span><span class="s2">.</span><span class="s1">version </span><span class="s2">&gt;= </span><span class="s1">options</span><span class="s2">.</span><span class="s1">min_version</span><span class="s2">)</span>
</pre>
</body>
</html>