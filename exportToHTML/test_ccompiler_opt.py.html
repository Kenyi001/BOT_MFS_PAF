<html>
<head>
<title>test_ccompiler_opt.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_ccompiler_opt.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">re</span><span class="s2">, </span><span class="s1">textwrap</span><span class="s2">, </span><span class="s1">os</span>
<span class="s0">from </span><span class="s1">os </span><span class="s0">import </span><span class="s1">sys</span><span class="s2">, </span><span class="s1">path</span>
<span class="s0">from </span><span class="s1">distutils</span><span class="s2">.</span><span class="s1">errors </span><span class="s0">import </span><span class="s1">DistutilsError</span>

<span class="s1">is_standalone </span><span class="s2">= </span><span class="s1">__name__ </span><span class="s2">== </span><span class="s3">'__main__' </span><span class="s0">and </span><span class="s1">__package__ </span><span class="s0">is None</span>
<span class="s0">if </span><span class="s1">is_standalone</span><span class="s2">:</span>
    <span class="s0">import </span><span class="s1">unittest</span><span class="s2">, </span><span class="s1">contextlib</span><span class="s2">, </span><span class="s1">tempfile</span><span class="s2">, </span><span class="s1">shutil</span>
    <span class="s1">sys</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">path</span><span class="s2">.</span><span class="s1">abspath</span><span class="s2">(</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">path</span><span class="s2">.</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">__file__</span><span class="s2">), </span><span class="s3">&quot;..&quot;</span><span class="s2">)))</span>
    <span class="s0">from </span><span class="s1">ccompiler_opt </span><span class="s0">import </span><span class="s1">CCompilerOpt</span>

    <span class="s4"># from numpy/testing/_private/utils.py</span>
    <span class="s2">@</span><span class="s1">contextlib</span><span class="s2">.</span><span class="s1">contextmanager</span>
    <span class="s0">def </span><span class="s1">tempdir</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">tmpdir </span><span class="s2">= </span><span class="s1">tempfile</span><span class="s2">.</span><span class="s1">mkdtemp</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">yield </span><span class="s1">tmpdir</span>
        <span class="s0">finally</span><span class="s2">:</span>
            <span class="s1">shutil</span><span class="s2">.</span><span class="s1">rmtree</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">assert_</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">=</span><span class="s3">''</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">expr</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">)</span>
<span class="s0">else</span><span class="s2">:</span>
    <span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">distutils</span><span class="s2">.</span><span class="s1">ccompiler_opt </span><span class="s0">import </span><span class="s1">CCompilerOpt</span>
    <span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">assert_</span><span class="s2">, </span><span class="s1">tempdir</span>

<span class="s4"># architectures and compilers to test</span>
<span class="s1">arch_compilers </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span>
    <span class="s1">x86 </span><span class="s2">= (</span><span class="s3">&quot;gcc&quot;</span><span class="s2">, </span><span class="s3">&quot;clang&quot;</span><span class="s2">, </span><span class="s3">&quot;icc&quot;</span><span class="s2">, </span><span class="s3">&quot;iccw&quot;</span><span class="s2">, </span><span class="s3">&quot;msvc&quot;</span><span class="s2">),</span>
    <span class="s1">x64 </span><span class="s2">= (</span><span class="s3">&quot;gcc&quot;</span><span class="s2">, </span><span class="s3">&quot;clang&quot;</span><span class="s2">, </span><span class="s3">&quot;icc&quot;</span><span class="s2">, </span><span class="s3">&quot;iccw&quot;</span><span class="s2">, </span><span class="s3">&quot;msvc&quot;</span><span class="s2">),</span>
    <span class="s1">ppc64 </span><span class="s2">= (</span><span class="s3">&quot;gcc&quot;</span><span class="s2">, </span><span class="s3">&quot;clang&quot;</span><span class="s2">),</span>
    <span class="s1">ppc64le </span><span class="s2">= (</span><span class="s3">&quot;gcc&quot;</span><span class="s2">, </span><span class="s3">&quot;clang&quot;</span><span class="s2">),</span>
    <span class="s1">armhf </span><span class="s2">= (</span><span class="s3">&quot;gcc&quot;</span><span class="s2">, </span><span class="s3">&quot;clang&quot;</span><span class="s2">),</span>
    <span class="s1">aarch64 </span><span class="s2">= (</span><span class="s3">&quot;gcc&quot;</span><span class="s2">, </span><span class="s3">&quot;clang&quot;</span><span class="s2">, </span><span class="s3">&quot;fcc&quot;</span><span class="s2">),</span>
    <span class="s1">s390x </span><span class="s2">= (</span><span class="s3">&quot;gcc&quot;</span><span class="s2">, </span><span class="s3">&quot;clang&quot;</span><span class="s2">),</span>
    <span class="s1">noarch </span><span class="s2">= (</span><span class="s3">&quot;gcc&quot;</span><span class="s2">,)</span>
<span class="s2">)</span>

<span class="s0">class </span><span class="s1">FakeCCompilerOpt</span><span class="s2">(</span><span class="s1">CCompilerOpt</span><span class="s2">):</span>
    <span class="s1">fake_info </span><span class="s2">= </span><span class="s3">&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">trap_files</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">trap_flags</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">fake_trap_files </span><span class="s2">= </span><span class="s1">trap_files</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">fake_trap_flags </span><span class="s2">= </span><span class="s1">trap_flags</span>
        <span class="s1">CCompilerOpt</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">textwrap</span><span class="s2">.</span><span class="s1">dedent</span><span class="s2">(</span><span class="s3">&quot;&quot;&quot;</span><span class="s0">\ 
            </span><span class="s3">&lt;&lt;&lt;&lt; 
            march    : {} 
            compiler : {} 
            ---------------- 
            {} 
            &gt;&gt;&gt;&gt; 
        &quot;&quot;&quot;</span><span class="s2">).</span><span class="s1">format</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cc_march</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cc_name</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">report</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">dist_compile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">sources</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">assert</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">sources</span><span class="s2">, </span><span class="s1">list</span><span class="s2">))</span>
        <span class="s0">assert</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">flags</span><span class="s2">, </span><span class="s1">list</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fake_trap_files</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">src </span><span class="s0">in </span><span class="s1">sources</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">re</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fake_trap_files</span><span class="s2">, </span><span class="s1">src</span><span class="s2">):</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">dist_error</span><span class="s2">(</span><span class="s3">&quot;source is trapped by a fake interface&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fake_trap_flags</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">flags</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">re</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fake_trap_flags</span><span class="s2">, </span><span class="s1">f</span><span class="s2">):</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">dist_error</span><span class="s2">(</span><span class="s3">&quot;flag is trapped by a fake interface&quot;</span><span class="s2">)</span>
        <span class="s4"># fake objects</span>
        <span class="s0">return </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">sources</span><span class="s2">, [</span><span class="s3">' '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">flags</span><span class="s2">)] * </span><span class="s1">len</span><span class="s2">(</span><span class="s1">sources</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">dist_info</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">FakeCCompilerOpt</span><span class="s2">.</span><span class="s1">fake_info</span>

    <span class="s2">@</span><span class="s1">staticmethod</span>
    <span class="s0">def </span><span class="s1">dist_log</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, </span><span class="s1">stderr</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">pass</span>

<span class="s0">class </span><span class="s1">_Test_CCompilerOpt</span><span class="s2">:</span>
    <span class="s1">arch </span><span class="s2">= </span><span class="s0">None </span><span class="s4"># x86_64</span>
    <span class="s1">cc   </span><span class="s2">= </span><span class="s0">None </span><span class="s4"># gcc</span>

    <span class="s0">def </span><span class="s1">setup_class</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">FakeCCompilerOpt</span><span class="s2">.</span><span class="s1">conf_nocache </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_opt </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">nopt</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">FakeCCompilerOpt</span><span class="s2">.</span><span class="s1">fake_info </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">arch</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cc</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">FakeCCompilerOpt</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">opt</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_opt</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_opt </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">nopt</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_opt</span>

    <span class="s0">def </span><span class="s1">march</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opt</span><span class="s2">().</span><span class="s1">cc_march</span>

    <span class="s0">def </span><span class="s1">cc_name</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opt</span><span class="s2">().</span><span class="s1">cc_name</span>

    <span class="s0">def </span><span class="s1">get_targets</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">targets</span><span class="s2">, </span><span class="s1">groups</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">FakeCCompilerOpt</span><span class="s2">.</span><span class="s1">conf_target_groups </span><span class="s2">= </span><span class="s1">groups</span>
        <span class="s1">opt </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">nopt</span><span class="s2">(</span>
            <span class="s1">cpu_baseline</span><span class="s2">=</span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;baseline&quot;</span><span class="s2">, </span><span class="s3">&quot;min&quot;</span><span class="s2">),</span>
            <span class="s1">cpu_dispatch</span><span class="s2">=</span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;dispatch&quot;</span><span class="s2">, </span><span class="s3">&quot;max&quot;</span><span class="s2">),</span>
            <span class="s1">trap_files</span><span class="s2">=</span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;trap_files&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">),</span>
            <span class="s1">trap_flags</span><span class="s2">=</span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;trap_flags&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">tempdir</span><span class="s2">() </span><span class="s0">as </span><span class="s1">tmpdir</span><span class="s2">:</span>
            <span class="s1">file </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">, </span><span class="s3">&quot;test_targets.c&quot;</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">file</span><span class="s2">, </span><span class="s3">'w'</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
                <span class="s1">f</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">targets</span><span class="s2">)</span>
            <span class="s1">gtargets </span><span class="s2">= []</span>
            <span class="s1">gflags </span><span class="s2">= {}</span>
            <span class="s1">fake_objects </span><span class="s2">= </span><span class="s1">opt</span><span class="s2">.</span><span class="s1">try_dispatch</span><span class="s2">([</span><span class="s1">file</span><span class="s2">])</span>
            <span class="s0">for </span><span class="s1">source</span><span class="s2">, </span><span class="s1">flags </span><span class="s0">in </span><span class="s1">fake_objects</span><span class="s2">:</span>
                <span class="s1">gtar </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">basename</span><span class="s2">(</span><span class="s1">source</span><span class="s2">).</span><span class="s1">split</span><span class="s2">(</span><span class="s3">'.'</span><span class="s2">)[</span><span class="s5">1</span><span class="s2">:-</span><span class="s5">1</span><span class="s2">]</span>
                <span class="s1">glen </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">gtar</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">glen </span><span class="s2">== </span><span class="s5">0</span><span class="s2">:</span>
                    <span class="s1">gtar </span><span class="s2">= </span><span class="s3">&quot;baseline&quot;</span>
                <span class="s0">elif </span><span class="s1">glen </span><span class="s2">== </span><span class="s5">1</span><span class="s2">:</span>
                    <span class="s1">gtar </span><span class="s2">= </span><span class="s1">gtar</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">upper</span><span class="s2">()</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s4"># converting multi-target into parentheses str format to be equivalent</span>
                    <span class="s4"># to the configuration statements syntax.</span>
                    <span class="s1">gtar </span><span class="s2">= (</span><span class="s3">'('</span><span class="s2">+</span><span class="s3">' '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">gtar</span><span class="s2">)+</span><span class="s3">')'</span><span class="s2">).</span><span class="s1">upper</span><span class="s2">()</span>
                <span class="s1">gtargets</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">gtar</span><span class="s2">)</span>
                <span class="s1">gflags</span><span class="s2">[</span><span class="s1">gtar</span><span class="s2">] = </span><span class="s1">flags</span>

        <span class="s1">has_baseline</span><span class="s2">, </span><span class="s1">targets </span><span class="s2">= </span><span class="s1">opt</span><span class="s2">.</span><span class="s1">sources_status</span><span class="s2">[</span><span class="s1">file</span><span class="s2">]</span>
        <span class="s1">targets </span><span class="s2">= </span><span class="s1">targets </span><span class="s2">+ [</span><span class="s3">&quot;baseline&quot;</span><span class="s2">] </span><span class="s0">if </span><span class="s1">has_baseline </span><span class="s0">else </span><span class="s1">targets</span>
        <span class="s4"># convert tuple that represent multi-target into parentheses str format</span>
        <span class="s1">targets </span><span class="s2">= [</span>
            <span class="s3">'('</span><span class="s2">+</span><span class="s3">' '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">tar</span><span class="s2">)+</span><span class="s3">')' </span><span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">tar</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">) </span><span class="s0">else </span><span class="s1">tar</span>
            <span class="s0">for </span><span class="s1">tar </span><span class="s0">in </span><span class="s1">targets</span>
        <span class="s2">]</span>
        <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">targets</span><span class="s2">) != </span><span class="s1">len</span><span class="s2">(</span><span class="s1">gtargets</span><span class="s2">) </span><span class="s0">or not </span><span class="s1">all</span><span class="s2">(</span><span class="s1">t </span><span class="s0">in </span><span class="s1">gtargets </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">targets</span><span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span>
                <span class="s3">&quot;'sources_status' returns different targets than the compiled targets</span><span class="s0">\n</span><span class="s3">&quot;</span>
                <span class="s3">&quot;%s != %s&quot; </span><span class="s2">% (</span><span class="s1">targets</span><span class="s2">, </span><span class="s1">gtargets</span><span class="s2">)</span>
            <span class="s2">)</span>
        <span class="s4"># return targets from 'sources_status' since the order is matters</span>
        <span class="s0">return </span><span class="s1">targets</span><span class="s2">, </span><span class="s1">gflags</span>

    <span class="s0">def </span><span class="s1">arg_regex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">map2origin </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span>
            <span class="s1">x64 </span><span class="s2">= </span><span class="s3">&quot;x86&quot;</span><span class="s2">,</span>
            <span class="s1">ppc64le </span><span class="s2">= </span><span class="s3">&quot;ppc64&quot;</span><span class="s2">,</span>
            <span class="s1">aarch64 </span><span class="s2">= </span><span class="s3">&quot;armhf&quot;</span><span class="s2">,</span>
            <span class="s1">clang </span><span class="s2">= </span><span class="s3">&quot;gcc&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">march </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">march</span><span class="s2">()</span><span class="s1">; cc_name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cc_name</span><span class="s2">()</span>
        <span class="s1">map_march </span><span class="s2">= </span><span class="s1">map2origin</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">march</span><span class="s2">, </span><span class="s1">march</span><span class="s2">)</span>
        <span class="s1">map_cc </span><span class="s2">= </span><span class="s1">map2origin</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">cc_name</span><span class="s2">, </span><span class="s1">cc_name</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s2">(</span>
            <span class="s1">march</span><span class="s2">, </span><span class="s1">cc_name</span><span class="s2">, </span><span class="s1">map_march</span><span class="s2">, </span><span class="s1">map_cc</span><span class="s2">,</span>
            <span class="s1">march </span><span class="s2">+ </span><span class="s3">'_' </span><span class="s2">+ </span><span class="s1">cc_name</span><span class="s2">,</span>
            <span class="s1">map_march </span><span class="s2">+ </span><span class="s3">'_' </span><span class="s2">+ </span><span class="s1">cc_name</span><span class="s2">,</span>
            <span class="s1">march </span><span class="s2">+ </span><span class="s3">'_' </span><span class="s2">+ </span><span class="s1">map_cc</span><span class="s2">,</span>
            <span class="s1">map_march </span><span class="s2">+ </span><span class="s3">'_' </span><span class="s2">+ </span><span class="s1">map_cc</span><span class="s2">,</span>
        <span class="s2">) :</span>
            <span class="s1">regex </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">key</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">regex </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s0">break</span>
        <span class="s0">if </span><span class="s1">regex</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">regex</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">):</span>
                <span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">regex</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                    <span class="s0">if </span><span class="s1">v</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">:] </span><span class="s0">not in </span><span class="s3">')}$?</span><span class="s0">\\</span><span class="s3">.+*'</span><span class="s2">:</span>
                        <span class="s1">regex</span><span class="s2">[</span><span class="s1">k</span><span class="s2">] = </span><span class="s1">v </span><span class="s2">+ </span><span class="s3">'$'</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">assert</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">regex</span><span class="s2">, </span><span class="s1">str</span><span class="s2">))</span>
                <span class="s0">if </span><span class="s1">regex</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">:] </span><span class="s0">not in </span><span class="s3">')}$?</span><span class="s0">\\</span><span class="s3">.+*'</span><span class="s2">:</span>
                    <span class="s1">regex </span><span class="s2">+= </span><span class="s3">'$'</span>
        <span class="s0">return </span><span class="s1">regex</span>

    <span class="s0">def </span><span class="s1">expect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dispatch</span><span class="s2">, </span><span class="s1">baseline</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">match </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">arg_regex</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">match </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return</span>
        <span class="s1">opt </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">nopt</span><span class="s2">(</span>
            <span class="s1">cpu_baseline</span><span class="s2">=</span><span class="s1">baseline</span><span class="s2">, </span><span class="s1">cpu_dispatch</span><span class="s2">=</span><span class="s1">dispatch</span><span class="s2">,</span>
            <span class="s1">trap_files</span><span class="s2">=</span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;trap_files&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">),</span>
            <span class="s1">trap_flags</span><span class="s2">=</span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;trap_flags&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s1">features </span><span class="s2">= </span><span class="s3">' '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">opt</span><span class="s2">.</span><span class="s1">cpu_dispatch_names</span><span class="s2">())</span>
        <span class="s0">if not </span><span class="s1">match</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">features</span><span class="s2">) != </span><span class="s5">0</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span>
                    <span class="s3">'expected empty features, not &quot;%s&quot;' </span><span class="s2">% </span><span class="s1">features</span>
                <span class="s2">)</span>
            <span class="s0">return</span>
        <span class="s0">if not </span><span class="s1">re</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">match</span><span class="s2">, </span><span class="s1">features</span><span class="s2">, </span><span class="s1">re</span><span class="s2">.</span><span class="s1">IGNORECASE</span><span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span>
                <span class="s3">'dispatch features &quot;%s&quot; not match &quot;%s&quot;' </span><span class="s2">% (</span><span class="s1">features</span><span class="s2">, </span><span class="s1">match</span><span class="s2">)</span>
            <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">expect_baseline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">baseline</span><span class="s2">, </span><span class="s1">dispatch</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">match </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">arg_regex</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">match </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return</span>
        <span class="s1">opt </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">nopt</span><span class="s2">(</span>
            <span class="s1">cpu_baseline</span><span class="s2">=</span><span class="s1">baseline</span><span class="s2">, </span><span class="s1">cpu_dispatch</span><span class="s2">=</span><span class="s1">dispatch</span><span class="s2">,</span>
            <span class="s1">trap_files</span><span class="s2">=</span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;trap_files&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">),</span>
            <span class="s1">trap_flags</span><span class="s2">=</span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;trap_flags&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s1">features </span><span class="s2">= </span><span class="s3">' '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">opt</span><span class="s2">.</span><span class="s1">cpu_baseline_names</span><span class="s2">())</span>
        <span class="s0">if not </span><span class="s1">match</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">features</span><span class="s2">) != </span><span class="s5">0</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span>
                    <span class="s3">'expected empty features, not &quot;%s&quot;' </span><span class="s2">% </span><span class="s1">features</span>
                <span class="s2">)</span>
            <span class="s0">return</span>
        <span class="s0">if not </span><span class="s1">re</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">match</span><span class="s2">, </span><span class="s1">features</span><span class="s2">, </span><span class="s1">re</span><span class="s2">.</span><span class="s1">IGNORECASE</span><span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span>
                <span class="s3">'baseline features &quot;%s&quot; not match &quot;%s&quot;' </span><span class="s2">% (</span><span class="s1">features</span><span class="s2">, </span><span class="s1">match</span><span class="s2">)</span>
            <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">expect_flags</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">baseline</span><span class="s2">, </span><span class="s1">dispatch</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">match </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">arg_regex</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">match </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return</span>
        <span class="s1">opt </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">nopt</span><span class="s2">(</span>
            <span class="s1">cpu_baseline</span><span class="s2">=</span><span class="s1">baseline</span><span class="s2">, </span><span class="s1">cpu_dispatch</span><span class="s2">=</span><span class="s1">dispatch</span><span class="s2">,</span>
            <span class="s1">trap_files</span><span class="s2">=</span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;trap_files&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">),</span>
            <span class="s1">trap_flags</span><span class="s2">=</span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;trap_flags&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s1">flags </span><span class="s2">= </span><span class="s3">' '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">opt</span><span class="s2">.</span><span class="s1">cpu_baseline_flags</span><span class="s2">())</span>
        <span class="s0">if not </span><span class="s1">match</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">flags</span><span class="s2">) != </span><span class="s5">0</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span>
                    <span class="s3">'expected empty flags not &quot;%s&quot;' </span><span class="s2">% </span><span class="s1">flags</span>
                <span class="s2">)</span>
            <span class="s0">return</span>
        <span class="s0">if not </span><span class="s1">re</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">match</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span>
                <span class="s3">'flags &quot;%s&quot; not match &quot;%s&quot;' </span><span class="s2">% (</span><span class="s1">flags</span><span class="s2">, </span><span class="s1">match</span><span class="s2">)</span>
            <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">expect_targets</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">targets</span><span class="s2">, </span><span class="s1">groups</span><span class="s2">={}, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">match </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">arg_regex</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">match </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return</span>
        <span class="s1">targets</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_targets</span><span class="s2">(</span><span class="s1">targets</span><span class="s2">=</span><span class="s1">targets</span><span class="s2">, </span><span class="s1">groups</span><span class="s2">=</span><span class="s1">groups</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">targets </span><span class="s2">= </span><span class="s3">' '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">targets</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">match</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">targets</span><span class="s2">) != </span><span class="s5">0</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span>
                    <span class="s3">'expected empty targets, not &quot;%s&quot;' </span><span class="s2">% </span><span class="s1">targets</span>
                <span class="s2">)</span>
            <span class="s0">return</span>
        <span class="s0">if not </span><span class="s1">re</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">match</span><span class="s2">, </span><span class="s1">targets</span><span class="s2">, </span><span class="s1">re</span><span class="s2">.</span><span class="s1">IGNORECASE</span><span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span>
                <span class="s3">'targets &quot;%s&quot; not match &quot;%s&quot;' </span><span class="s2">% (</span><span class="s1">targets</span><span class="s2">, </span><span class="s1">match</span><span class="s2">)</span>
            <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">expect_target_flags</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">targets</span><span class="s2">, </span><span class="s1">groups</span><span class="s2">={}, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">match_dict </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">arg_regex</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">match_dict </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return</span>
        <span class="s0">assert</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">match_dict</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">))</span>
        <span class="s1">_</span><span class="s2">, </span><span class="s1">tar_flags </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_targets</span><span class="s2">(</span><span class="s1">targets</span><span class="s2">=</span><span class="s1">targets</span><span class="s2">, </span><span class="s1">groups</span><span class="s2">=</span><span class="s1">groups</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">match_tar</span><span class="s2">, </span><span class="s1">match_flags </span><span class="s0">in </span><span class="s1">match_dict</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s0">if </span><span class="s1">match_tar </span><span class="s0">not in </span><span class="s1">tar_flags</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span>
                    <span class="s3">'expected to find target &quot;%s&quot;' </span><span class="s2">% </span><span class="s1">match_tar</span>
                <span class="s2">)</span>
            <span class="s1">flags </span><span class="s2">= </span><span class="s1">tar_flags</span><span class="s2">[</span><span class="s1">match_tar</span><span class="s2">]</span>
            <span class="s0">if not </span><span class="s1">match_flags</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">flags</span><span class="s2">) != </span><span class="s5">0</span><span class="s2">:</span>
                    <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span>
                        <span class="s3">'expected to find empty flags in target &quot;%s&quot;' </span><span class="s2">% </span><span class="s1">match_tar</span>
                    <span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">re</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">match_flags</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">):</span>
                <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span>
                    <span class="s3">'&quot;%s&quot; flags &quot;%s&quot; not match &quot;%s&quot;' </span><span class="s2">% (</span><span class="s1">match_tar</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">, </span><span class="s1">match_flags</span><span class="s2">)</span>
                <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_interface</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">wrong_arch </span><span class="s2">= </span><span class="s3">&quot;ppc64&quot; </span><span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">arch </span><span class="s2">!= </span><span class="s3">&quot;ppc64&quot; </span><span class="s0">else </span><span class="s3">&quot;x86&quot;</span>
        <span class="s1">wrong_cc   </span><span class="s2">= </span><span class="s3">&quot;clang&quot; </span><span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cc   </span><span class="s2">!= </span><span class="s3">&quot;clang&quot; </span><span class="s0">else </span><span class="s3">&quot;icc&quot;</span>
        <span class="s1">opt </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opt</span><span class="s2">()</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">opt</span><span class="s2">, </span><span class="s3">&quot;cc_on_&quot; </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">arch</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s0">not </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">opt</span><span class="s2">, </span><span class="s3">&quot;cc_on_&quot; </span><span class="s2">+ </span><span class="s1">wrong_arch</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">opt</span><span class="s2">, </span><span class="s3">&quot;cc_is_&quot; </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cc</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s0">not </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">opt</span><span class="s2">, </span><span class="s3">&quot;cc_is_&quot; </span><span class="s2">+ </span><span class="s1">wrong_cc</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_args_empty</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">baseline</span><span class="s2">, </span><span class="s1">dispatch </span><span class="s0">in </span><span class="s2">(</span>
            <span class="s2">(</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s3">&quot;none&quot;</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s3">&quot;none +none&quot;</span><span class="s2">, </span><span class="s3">&quot;none - none&quot;</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s3">&quot;none -max&quot;</span><span class="s2">, </span><span class="s3">&quot;min - max&quot;</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s3">&quot;+vsx2 -VSX2&quot;</span><span class="s2">, </span><span class="s3">&quot;vsx avx2 avx512f -max&quot;</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s3">&quot;max -vsx - avx + avx512f neon -MAX &quot;</span><span class="s2">,</span>
             <span class="s3">&quot;min -min + max -max -vsx + avx2 -avx2 +NONE&quot;</span><span class="s2">)</span>
        <span class="s2">) :</span>
            <span class="s1">opt </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">nopt</span><span class="s2">(</span><span class="s1">cpu_baseline</span><span class="s2">=</span><span class="s1">baseline</span><span class="s2">, </span><span class="s1">cpu_dispatch</span><span class="s2">=</span><span class="s1">dispatch</span><span class="s2">)</span>
            <span class="s0">assert</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">opt</span><span class="s2">.</span><span class="s1">cpu_baseline_names</span><span class="s2">()) == </span><span class="s5">0</span><span class="s2">)</span>
            <span class="s0">assert</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">opt</span><span class="s2">.</span><span class="s1">cpu_dispatch_names</span><span class="s2">()) == </span><span class="s5">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_args_validation</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">march</span><span class="s2">() == </span><span class="s3">&quot;unknown&quot;</span><span class="s2">:</span>
            <span class="s0">return</span>
        <span class="s4"># check sanity of argument's validation</span>
        <span class="s0">for </span><span class="s1">baseline</span><span class="s2">, </span><span class="s1">dispatch </span><span class="s0">in </span><span class="s2">(</span>
            <span class="s2">(</span><span class="s3">&quot;unkown_feature - max +min&quot;</span><span class="s2">, </span><span class="s3">&quot;unknown max min&quot;</span><span class="s2">), </span><span class="s4"># unknowing features</span>
            <span class="s2">(</span><span class="s3">&quot;#avx2&quot;</span><span class="s2">, </span><span class="s3">&quot;$vsx&quot;</span><span class="s2">) </span><span class="s4"># groups and polices aren't acceptable</span>
        <span class="s2">) :</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">nopt</span><span class="s2">(</span><span class="s1">cpu_baseline</span><span class="s2">=</span><span class="s1">baseline</span><span class="s2">, </span><span class="s1">cpu_dispatch</span><span class="s2">=</span><span class="s1">dispatch</span><span class="s2">)</span>
                <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span><span class="s3">&quot;excepted an exception for invalid arguments&quot;</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">DistutilsError</span><span class="s2">:</span>
                <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">test_skip</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># only takes what platform supports and skip the others</span>
        <span class="s4"># without casing exceptions</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">expect</span><span class="s2">(</span>
            <span class="s3">&quot;sse vsx neon&quot;</span><span class="s2">,</span>
            <span class="s1">x86</span><span class="s2">=</span><span class="s3">&quot;sse&quot;</span><span class="s2">, </span><span class="s1">ppc64</span><span class="s2">=</span><span class="s3">&quot;vsx&quot;</span><span class="s2">, </span><span class="s1">armhf</span><span class="s2">=</span><span class="s3">&quot;neon&quot;</span><span class="s2">, </span><span class="s1">unknown</span><span class="s2">=</span><span class="s3">&quot;&quot;</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">expect</span><span class="s2">(</span>
            <span class="s3">&quot;sse41 avx avx2 vsx2 vsx3 neon_vfpv4 asimd&quot;</span><span class="s2">,</span>
            <span class="s1">x86   </span><span class="s2">= </span><span class="s3">&quot;sse41 avx avx2&quot;</span><span class="s2">,</span>
            <span class="s1">ppc64 </span><span class="s2">= </span><span class="s3">&quot;vsx2 vsx3&quot;</span><span class="s2">,</span>
            <span class="s1">armhf </span><span class="s2">= </span><span class="s3">&quot;neon_vfpv4 asimd&quot;</span><span class="s2">,</span>
            <span class="s1">unknown </span><span class="s2">= </span><span class="s3">&quot;&quot;</span>
        <span class="s2">)</span>
        <span class="s4"># any features in cpu_dispatch must be ignored if it's part of baseline</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">expect</span><span class="s2">(</span>
            <span class="s3">&quot;sse neon vsx&quot;</span><span class="s2">, </span><span class="s1">baseline</span><span class="s2">=</span><span class="s3">&quot;sse neon vsx&quot;</span><span class="s2">,</span>
            <span class="s1">x86</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">ppc64</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">armhf</span><span class="s2">=</span><span class="s3">&quot;&quot;</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">expect</span><span class="s2">(</span>
            <span class="s3">&quot;avx2 vsx3 asimdhp&quot;</span><span class="s2">, </span><span class="s1">baseline</span><span class="s2">=</span><span class="s3">&quot;avx2 vsx3 asimdhp&quot;</span><span class="s2">,</span>
            <span class="s1">x86</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">ppc64</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">armhf</span><span class="s2">=</span><span class="s3">&quot;&quot;</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_implies</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># baseline combining implied features, so we count</span>
        <span class="s4"># on it instead of testing 'feature_implies()'' directly</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">expect_baseline</span><span class="s2">(</span>
            <span class="s3">&quot;fma3 avx2 asimd vsx3&quot;</span><span class="s2">,</span>
            <span class="s4"># .* between two spaces can validate features in between</span>
            <span class="s1">x86   </span><span class="s2">= </span><span class="s3">&quot;sse .* sse41 .* fma3.*avx2&quot;</span><span class="s2">,</span>
            <span class="s1">ppc64 </span><span class="s2">= </span><span class="s3">&quot;vsx vsx2 vsx3&quot;</span><span class="s2">,</span>
            <span class="s1">armhf </span><span class="s2">= </span><span class="s3">&quot;neon neon_fp16 neon_vfpv4 asimd&quot;</span>
        <span class="s2">)</span>
        <span class="s3">&quot;&quot;&quot; 
        special cases 
        &quot;&quot;&quot;</span>
        <span class="s4"># in icc and msvc, FMA3 and AVX2 can't be separated</span>
        <span class="s4"># both need to implies each other, same for avx512f &amp; cd</span>
        <span class="s0">for </span><span class="s1">f0</span><span class="s2">, </span><span class="s1">f1 </span><span class="s0">in </span><span class="s2">(</span>
            <span class="s2">(</span><span class="s3">&quot;fma3&quot;</span><span class="s2">,    </span><span class="s3">&quot;avx2&quot;</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s3">&quot;avx512f&quot;</span><span class="s2">, </span><span class="s3">&quot;avx512cd&quot;</span><span class="s2">),</span>
        <span class="s2">):</span>
            <span class="s1">diff </span><span class="s2">= </span><span class="s3">&quot;.* sse42 .* %s .*%s$&quot; </span><span class="s2">% (</span><span class="s1">f0</span><span class="s2">, </span><span class="s1">f1</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">expect_baseline</span><span class="s2">(</span><span class="s1">f0</span><span class="s2">,</span>
                <span class="s1">x86_gcc</span><span class="s2">=</span><span class="s3">&quot;.* sse42 .* %s$&quot; </span><span class="s2">% </span><span class="s1">f0</span><span class="s2">,</span>
                <span class="s1">x86_icc</span><span class="s2">=</span><span class="s1">diff</span><span class="s2">, </span><span class="s1">x86_iccw</span><span class="s2">=</span><span class="s1">diff</span>
            <span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">expect_baseline</span><span class="s2">(</span><span class="s1">f1</span><span class="s2">,</span>
                <span class="s1">x86_gcc</span><span class="s2">=</span><span class="s3">&quot;.* avx .* %s$&quot; </span><span class="s2">% </span><span class="s1">f1</span><span class="s2">,</span>
                <span class="s1">x86_icc</span><span class="s2">=</span><span class="s1">diff</span><span class="s2">, </span><span class="s1">x86_iccw</span><span class="s2">=</span><span class="s1">diff</span>
            <span class="s2">)</span>
        <span class="s4"># in msvc, following features can't be separated too</span>
        <span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s2">((</span><span class="s3">&quot;fma3&quot;</span><span class="s2">, </span><span class="s3">&quot;avx2&quot;</span><span class="s2">), (</span><span class="s3">&quot;avx512f&quot;</span><span class="s2">, </span><span class="s3">&quot;avx512cd&quot;</span><span class="s2">, </span><span class="s3">&quot;avx512_skx&quot;</span><span class="s2">)):</span>
            <span class="s0">for </span><span class="s1">ff </span><span class="s0">in </span><span class="s1">f</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">expect_baseline</span><span class="s2">(</span><span class="s1">ff</span><span class="s2">,</span>
                    <span class="s1">x86_msvc</span><span class="s2">=</span><span class="s3">&quot;.*%s&quot; </span><span class="s2">% </span><span class="s3">' '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
                <span class="s2">)</span>

        <span class="s4"># in ppc64le VSX and VSX2 can't be separated</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">expect_baseline</span><span class="s2">(</span><span class="s3">&quot;vsx&quot;</span><span class="s2">, </span><span class="s1">ppc64le</span><span class="s2">=</span><span class="s3">&quot;vsx vsx2&quot;</span><span class="s2">)</span>
        <span class="s4"># in aarch64 following features can't be separated</span>
        <span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s2">(</span><span class="s3">&quot;neon&quot;</span><span class="s2">, </span><span class="s3">&quot;neon_fp16&quot;</span><span class="s2">, </span><span class="s3">&quot;neon_vfpv4&quot;</span><span class="s2">, </span><span class="s3">&quot;asimd&quot;</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">expect_baseline</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">aarch64</span><span class="s2">=</span><span class="s3">&quot;neon neon_fp16 neon_vfpv4 asimd&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_args_options</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># max &amp; native</span>
        <span class="s0">for </span><span class="s1">o </span><span class="s0">in </span><span class="s2">(</span><span class="s3">&quot;max&quot;</span><span class="s2">, </span><span class="s3">&quot;native&quot;</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">o </span><span class="s2">== </span><span class="s3">&quot;native&quot; </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cc_name</span><span class="s2">() == </span><span class="s3">&quot;msvc&quot;</span><span class="s2">:</span>
                <span class="s0">continue</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">expect</span><span class="s2">(</span><span class="s1">o</span><span class="s2">,</span>
                <span class="s1">trap_files</span><span class="s2">=</span><span class="s3">&quot;.*cpu_(sse|vsx|neon|vx).c&quot;</span><span class="s2">,</span>
                <span class="s1">x86</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">ppc64</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">armhf</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">s390x</span><span class="s2">=</span><span class="s3">&quot;&quot;</span>
            <span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">expect</span><span class="s2">(</span><span class="s1">o</span><span class="s2">,</span>
                <span class="s1">trap_files</span><span class="s2">=</span><span class="s3">&quot;.*cpu_(sse3|vsx2|neon_vfpv4|vxe).c&quot;</span><span class="s2">,</span>
                <span class="s1">x86</span><span class="s2">=</span><span class="s3">&quot;sse sse2&quot;</span><span class="s2">, </span><span class="s1">ppc64</span><span class="s2">=</span><span class="s3">&quot;vsx&quot;</span><span class="s2">, </span><span class="s1">armhf</span><span class="s2">=</span><span class="s3">&quot;neon neon_fp16&quot;</span><span class="s2">,</span>
                <span class="s1">aarch64</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">ppc64le</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">s390x</span><span class="s2">=</span><span class="s3">&quot;vx&quot;</span>
            <span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">expect</span><span class="s2">(</span><span class="s1">o</span><span class="s2">,</span>
                <span class="s1">trap_files</span><span class="s2">=</span><span class="s3">&quot;.*cpu_(popcnt|vsx3).c&quot;</span><span class="s2">,</span>
                <span class="s1">x86</span><span class="s2">=</span><span class="s3">&quot;sse .* sse41&quot;</span><span class="s2">, </span><span class="s1">ppc64</span><span class="s2">=</span><span class="s3">&quot;vsx vsx2&quot;</span><span class="s2">,</span>
                <span class="s1">armhf</span><span class="s2">=</span><span class="s3">&quot;neon neon_fp16 .* asimd .*&quot;</span><span class="s2">,</span>
                <span class="s1">s390x</span><span class="s2">=</span><span class="s3">&quot;vx vxe vxe2&quot;</span>
            <span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">expect</span><span class="s2">(</span><span class="s1">o</span><span class="s2">,</span>
                <span class="s1">x86_gcc</span><span class="s2">=</span><span class="s3">&quot;.* xop fma4 .* avx512f .* avx512_knl avx512_knm avx512_skx .*&quot;</span><span class="s2">,</span>
                <span class="s4"># in icc, xop and fam4 aren't supported</span>
                <span class="s1">x86_icc</span><span class="s2">=</span><span class="s3">&quot;.* avx512f .* avx512_knl avx512_knm avx512_skx .*&quot;</span><span class="s2">,</span>
                <span class="s1">x86_iccw</span><span class="s2">=</span><span class="s3">&quot;.* avx512f .* avx512_knl avx512_knm avx512_skx .*&quot;</span><span class="s2">,</span>
                <span class="s4"># in msvc, avx512_knl avx512_knm aren't supported</span>
                <span class="s1">x86_msvc</span><span class="s2">=</span><span class="s3">&quot;.* xop fma4 .* avx512f .* avx512_skx .*&quot;</span><span class="s2">,</span>
                <span class="s1">armhf</span><span class="s2">=</span><span class="s3">&quot;.* asimd asimdhp asimddp .*&quot;</span><span class="s2">,</span>
                <span class="s1">ppc64</span><span class="s2">=</span><span class="s3">&quot;vsx vsx2 vsx3 vsx4.*&quot;</span><span class="s2">,</span>
                <span class="s1">s390x</span><span class="s2">=</span><span class="s3">&quot;vx vxe vxe2.*&quot;</span>
            <span class="s2">)</span>
        <span class="s4"># min</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">expect</span><span class="s2">(</span><span class="s3">&quot;min&quot;</span><span class="s2">,</span>
            <span class="s1">x86</span><span class="s2">=</span><span class="s3">&quot;sse sse2&quot;</span><span class="s2">, </span><span class="s1">x64</span><span class="s2">=</span><span class="s3">&quot;sse sse2 sse3&quot;</span><span class="s2">,</span>
            <span class="s1">armhf</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">aarch64</span><span class="s2">=</span><span class="s3">&quot;neon neon_fp16 .* asimd&quot;</span><span class="s2">,</span>
            <span class="s1">ppc64</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">ppc64le</span><span class="s2">=</span><span class="s3">&quot;vsx vsx2&quot;</span><span class="s2">, </span><span class="s1">s390x</span><span class="s2">=</span><span class="s3">&quot;&quot;</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">expect</span><span class="s2">(</span>
            <span class="s3">&quot;min&quot;</span><span class="s2">, </span><span class="s1">trap_files</span><span class="s2">=</span><span class="s3">&quot;.*cpu_(sse2|vsx2).c&quot;</span><span class="s2">,</span>
            <span class="s1">x86</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">ppc64le</span><span class="s2">=</span><span class="s3">&quot;&quot;</span>
        <span class="s2">)</span>
        <span class="s4"># an exception must triggered if native flag isn't supported</span>
        <span class="s4"># when option &quot;native&quot; is activated through the args</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">expect</span><span class="s2">(</span><span class="s3">&quot;native&quot;</span><span class="s2">,</span>
                <span class="s1">trap_flags</span><span class="s2">=</span><span class="s3">&quot;.*(-march=native|-xHost|/QxHost|-mcpu=a64fx).*&quot;</span><span class="s2">,</span>
                <span class="s1">x86</span><span class="s2">=</span><span class="s3">&quot;.*&quot;</span><span class="s2">, </span><span class="s1">ppc64</span><span class="s2">=</span><span class="s3">&quot;.*&quot;</span><span class="s2">, </span><span class="s1">armhf</span><span class="s2">=</span><span class="s3">&quot;.*&quot;</span><span class="s2">, </span><span class="s1">s390x</span><span class="s2">=</span><span class="s3">&quot;.*&quot;</span><span class="s2">, </span><span class="s1">aarch64</span><span class="s2">=</span><span class="s3">&quot;.*&quot;</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">march</span><span class="s2">() != </span><span class="s3">&quot;unknown&quot;</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span>
                    <span class="s3">&quot;excepted an exception for %s&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">march</span><span class="s2">()</span>
                <span class="s2">)</span>
        <span class="s0">except </span><span class="s1">DistutilsError</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">march</span><span class="s2">() == </span><span class="s3">&quot;unknown&quot;</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span><span class="s3">&quot;excepted no exceptions&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_flags</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">expect_flags</span><span class="s2">(</span>
            <span class="s3">&quot;sse sse2 vsx vsx2 neon neon_fp16 vx vxe&quot;</span><span class="s2">,</span>
            <span class="s1">x86_gcc</span><span class="s2">=</span><span class="s3">&quot;-msse -msse2&quot;</span><span class="s2">, </span><span class="s1">x86_icc</span><span class="s2">=</span><span class="s3">&quot;-msse -msse2&quot;</span><span class="s2">,</span>
            <span class="s1">x86_iccw</span><span class="s2">=</span><span class="s3">&quot;/arch:SSE2&quot;</span><span class="s2">,</span>
            <span class="s1">x86_msvc</span><span class="s2">=</span><span class="s3">&quot;/arch:SSE2&quot; </span><span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">march</span><span class="s2">() == </span><span class="s3">&quot;x86&quot; </span><span class="s0">else </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
            <span class="s1">ppc64_gcc</span><span class="s2">= </span><span class="s3">&quot;-mcpu=power8&quot;</span><span class="s2">,</span>
            <span class="s1">ppc64_clang</span><span class="s2">=</span><span class="s3">&quot;-mcpu=power8&quot;</span><span class="s2">,</span>
            <span class="s1">armhf_gcc</span><span class="s2">=</span><span class="s3">&quot;-mfpu=neon-fp16 -mfp16-format=ieee&quot;</span><span class="s2">,</span>
            <span class="s1">aarch64</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
            <span class="s1">s390x</span><span class="s2">=</span><span class="s3">&quot;-mzvector -march=arch12&quot;</span>
        <span class="s2">)</span>
        <span class="s4"># testing normalize -march</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">expect_flags</span><span class="s2">(</span>
            <span class="s3">&quot;asimd&quot;</span><span class="s2">,</span>
            <span class="s1">aarch64</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
            <span class="s1">armhf_gcc</span><span class="s2">=</span><span class="s3">r&quot;-mfp16-format=ieee -mfpu=neon-fp-armv8 -march=armv8-a\+simd&quot;</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">expect_flags</span><span class="s2">(</span>
            <span class="s3">&quot;asimdhp&quot;</span><span class="s2">,</span>
            <span class="s1">aarch64_gcc</span><span class="s2">=</span><span class="s3">r&quot;-march=armv8.2-a\+fp16&quot;</span><span class="s2">,</span>
            <span class="s1">armhf_gcc</span><span class="s2">=</span><span class="s3">r&quot;-mfp16-format=ieee -mfpu=neon-fp-armv8 -march=armv8.2-a\+fp16&quot;</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">expect_flags</span><span class="s2">(</span>
            <span class="s3">&quot;asimddp&quot;</span><span class="s2">, </span><span class="s1">aarch64_gcc</span><span class="s2">=</span><span class="s3">r&quot;-march=armv8.2-a\+dotprod&quot;</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">expect_flags</span><span class="s2">(</span>
            <span class="s4"># asimdfhm implies asimdhp</span>
            <span class="s3">&quot;asimdfhm&quot;</span><span class="s2">, </span><span class="s1">aarch64_gcc</span><span class="s2">=</span><span class="s3">r&quot;-march=armv8.2-a\+fp16\+fp16fml&quot;</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">expect_flags</span><span class="s2">(</span>
            <span class="s3">&quot;asimddp asimdhp asimdfhm&quot;</span><span class="s2">,</span>
            <span class="s1">aarch64_gcc</span><span class="s2">=</span><span class="s3">r&quot;-march=armv8.2-a\+dotprod\+fp16\+fp16fml&quot;</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">expect_flags</span><span class="s2">(</span>
            <span class="s3">&quot;vx vxe vxe2&quot;</span><span class="s2">,</span>
            <span class="s1">s390x</span><span class="s2">=</span><span class="s3">r&quot;-mzvector -march=arch13&quot;</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_targets_exceptions</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">targets </span><span class="s0">in </span><span class="s2">(</span>
            <span class="s3">&quot;bla bla&quot;</span><span class="s2">, </span><span class="s3">&quot;/*@targets&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;/*@targets */&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;/*@targets unknown */&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;/*@targets $unknown_policy avx2 */&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;/*@targets #unknown_group avx2 */&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;/*@targets $ */&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;/*@targets # vsx */&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;/*@targets #$ vsx */&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;/*@targets vsx avx2 ) */&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;/*@targets vsx avx2 (avx2 */&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;/*@targets vsx avx2 () */&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;/*@targets vsx avx2 ($autovec) */&quot;</span><span class="s2">, </span><span class="s4"># no features</span>
            <span class="s3">&quot;/*@targets vsx avx2 (xxx) */&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;/*@targets vsx avx2 (baseline) */&quot;</span><span class="s2">,</span>
        <span class="s2">) :</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">expect_targets</span><span class="s2">(</span>
                    <span class="s1">targets</span><span class="s2">,</span>
                    <span class="s1">x86</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">armhf</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">ppc64</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">s390x</span><span class="s2">=</span><span class="s3">&quot;&quot;</span>
                <span class="s2">)</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">march</span><span class="s2">() != </span><span class="s3">&quot;unknown&quot;</span><span class="s2">:</span>
                    <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span>
                        <span class="s3">&quot;excepted an exception for %s&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">march</span><span class="s2">()</span>
                    <span class="s2">)</span>
            <span class="s0">except </span><span class="s1">DistutilsError</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">march</span><span class="s2">() == </span><span class="s3">&quot;unknown&quot;</span><span class="s2">:</span>
                    <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span><span class="s3">&quot;excepted no exceptions&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_targets_syntax</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">targets </span><span class="s0">in </span><span class="s2">(</span>
            <span class="s3">&quot;/*@targets $keep_baseline sse vsx neon vx*/&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;/*@targets,$keep_baseline,sse,vsx,neon vx*/&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;/*@targets*$keep_baseline*sse*vsx*neon*vx*/&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;&quot;&quot; 
            /* 
            ** @targets 
            ** $keep_baseline, sse vsx,neon, vx 
            */ 
            &quot;&quot;&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;&quot;&quot; 
            /* 
            ************@targets**************** 
            ** $keep_baseline, sse vsx, neon, vx 
            ************************************ 
            */ 
            &quot;&quot;&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;&quot;&quot; 
            /* 
            /////////////@targets///////////////// 
            //$keep_baseline//sse//vsx//neon//vx 
            ///////////////////////////////////// 
            */ 
            &quot;&quot;&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;&quot;&quot; 
            /* 
            @targets 
            $keep_baseline 
            SSE VSX NEON VX*/ 
            &quot;&quot;&quot;</span>
        <span class="s2">) :</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">expect_targets</span><span class="s2">(</span><span class="s1">targets</span><span class="s2">,</span>
                <span class="s1">x86</span><span class="s2">=</span><span class="s3">&quot;sse&quot;</span><span class="s2">, </span><span class="s1">ppc64</span><span class="s2">=</span><span class="s3">&quot;vsx&quot;</span><span class="s2">, </span><span class="s1">armhf</span><span class="s2">=</span><span class="s3">&quot;neon&quot;</span><span class="s2">, </span><span class="s1">s390x</span><span class="s2">=</span><span class="s3">&quot;vx&quot;</span><span class="s2">, </span><span class="s1">unknown</span><span class="s2">=</span><span class="s3">&quot;&quot;</span>
            <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_targets</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># test skipping baseline features</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">expect_targets</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            /*@targets 
                sse sse2 sse41 avx avx2 avx512f 
                vsx vsx2 vsx3 vsx4 
                neon neon_fp16 asimdhp asimddp 
                vx vxe vxe2 
            */ 
            &quot;&quot;&quot;</span><span class="s2">,</span>
            <span class="s1">baseline</span><span class="s2">=</span><span class="s3">&quot;avx vsx2 asimd vx vxe&quot;</span><span class="s2">,</span>
            <span class="s1">x86</span><span class="s2">=</span><span class="s3">&quot;avx512f avx2&quot;</span><span class="s2">, </span><span class="s1">armhf</span><span class="s2">=</span><span class="s3">&quot;asimddp asimdhp&quot;</span><span class="s2">, </span><span class="s1">ppc64</span><span class="s2">=</span><span class="s3">&quot;vsx4 vsx3&quot;</span><span class="s2">,</span>
            <span class="s1">s390x</span><span class="s2">=</span><span class="s3">&quot;vxe2&quot;</span>
        <span class="s2">)</span>
        <span class="s4"># test skipping non-dispatch features</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">expect_targets</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            /*@targets 
                sse41 avx avx2 avx512f 
                vsx2 vsx3 vsx4 
                asimd asimdhp asimddp 
                vx vxe vxe2 
            */ 
            &quot;&quot;&quot;</span><span class="s2">,</span>
            <span class="s1">baseline</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">dispatch</span><span class="s2">=</span><span class="s3">&quot;sse41 avx2 vsx2 asimd asimddp vxe2&quot;</span><span class="s2">,</span>
            <span class="s1">x86</span><span class="s2">=</span><span class="s3">&quot;avx2 sse41&quot;</span><span class="s2">, </span><span class="s1">armhf</span><span class="s2">=</span><span class="s3">&quot;asimddp asimd&quot;</span><span class="s2">, </span><span class="s1">ppc64</span><span class="s2">=</span><span class="s3">&quot;vsx2&quot;</span><span class="s2">, </span><span class="s1">s390x</span><span class="s2">=</span><span class="s3">&quot;vxe2&quot;</span>
        <span class="s2">)</span>
        <span class="s4"># test skipping features that not supported</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">expect_targets</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            /*@targets 
                sse2 sse41 avx2 avx512f 
                vsx2 vsx3 vsx4 
                neon asimdhp asimddp 
                vx vxe vxe2 
            */ 
            &quot;&quot;&quot;</span><span class="s2">,</span>
            <span class="s1">baseline</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
            <span class="s1">trap_files</span><span class="s2">=</span><span class="s3">&quot;.*(avx2|avx512f|vsx3|vsx4|asimddp|vxe2).c&quot;</span><span class="s2">,</span>
            <span class="s1">x86</span><span class="s2">=</span><span class="s3">&quot;sse41 sse2&quot;</span><span class="s2">, </span><span class="s1">ppc64</span><span class="s2">=</span><span class="s3">&quot;vsx2&quot;</span><span class="s2">, </span><span class="s1">armhf</span><span class="s2">=</span><span class="s3">&quot;asimdhp neon&quot;</span><span class="s2">,</span>
            <span class="s1">s390x</span><span class="s2">=</span><span class="s3">&quot;vxe vx&quot;</span>
        <span class="s2">)</span>
        <span class="s4"># test skipping features that implies each other</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">expect_targets</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            /*@targets 
                sse sse2 avx fma3 avx2 avx512f avx512cd 
                vsx vsx2 vsx3 
                neon neon_vfpv4 neon_fp16 neon_fp16 asimd asimdhp 
                asimddp asimdfhm 
            */ 
            &quot;&quot;&quot;</span><span class="s2">,</span>
            <span class="s1">baseline</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
            <span class="s1">x86_gcc</span><span class="s2">=</span><span class="s3">&quot;avx512cd avx512f avx2 fma3 avx sse2&quot;</span><span class="s2">,</span>
            <span class="s1">x86_msvc</span><span class="s2">=</span><span class="s3">&quot;avx512cd avx2 avx sse2&quot;</span><span class="s2">,</span>
            <span class="s1">x86_icc</span><span class="s2">=</span><span class="s3">&quot;avx512cd avx2 avx sse2&quot;</span><span class="s2">,</span>
            <span class="s1">x86_iccw</span><span class="s2">=</span><span class="s3">&quot;avx512cd avx2 avx sse2&quot;</span><span class="s2">,</span>
            <span class="s1">ppc64</span><span class="s2">=</span><span class="s3">&quot;vsx3 vsx2 vsx&quot;</span><span class="s2">,</span>
            <span class="s1">ppc64le</span><span class="s2">=</span><span class="s3">&quot;vsx3 vsx2&quot;</span><span class="s2">,</span>
            <span class="s1">armhf</span><span class="s2">=</span><span class="s3">&quot;asimdfhm asimddp asimdhp asimd neon_vfpv4 neon_fp16 neon&quot;</span><span class="s2">,</span>
            <span class="s1">aarch64</span><span class="s2">=</span><span class="s3">&quot;asimdfhm asimddp asimdhp asimd&quot;</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_targets_policies</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># 'keep_baseline', generate objects for baseline features</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">expect_targets</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            /*@targets 
                $keep_baseline 
                sse2 sse42 avx2 avx512f 
                vsx2 vsx3 
                neon neon_vfpv4 asimd asimddp 
                vx vxe vxe2 
            */ 
            &quot;&quot;&quot;</span><span class="s2">,</span>
            <span class="s1">baseline</span><span class="s2">=</span><span class="s3">&quot;sse41 avx2 vsx2 asimd vsx3 vxe&quot;</span><span class="s2">,</span>
            <span class="s1">x86</span><span class="s2">=</span><span class="s3">&quot;avx512f avx2 sse42 sse2&quot;</span><span class="s2">,</span>
            <span class="s1">ppc64</span><span class="s2">=</span><span class="s3">&quot;vsx3 vsx2&quot;</span><span class="s2">,</span>
            <span class="s1">armhf</span><span class="s2">=</span><span class="s3">&quot;asimddp asimd neon_vfpv4 neon&quot;</span><span class="s2">,</span>
            <span class="s4"># neon, neon_vfpv4, asimd implies each other</span>
            <span class="s1">aarch64</span><span class="s2">=</span><span class="s3">&quot;asimddp asimd&quot;</span><span class="s2">,</span>
            <span class="s1">s390x</span><span class="s2">=</span><span class="s3">&quot;vxe2 vxe vx&quot;</span>
        <span class="s2">)</span>
        <span class="s4"># 'keep_sort', leave the sort as-is</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">expect_targets</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            /*@targets 
                $keep_baseline $keep_sort 
                avx512f sse42 avx2 sse2 
                vsx2 vsx3 
                asimd neon neon_vfpv4 asimddp 
                vxe vxe2 
            */ 
            &quot;&quot;&quot;</span><span class="s2">,</span>
            <span class="s1">x86</span><span class="s2">=</span><span class="s3">&quot;avx512f sse42 avx2 sse2&quot;</span><span class="s2">,</span>
            <span class="s1">ppc64</span><span class="s2">=</span><span class="s3">&quot;vsx2 vsx3&quot;</span><span class="s2">,</span>
            <span class="s1">armhf</span><span class="s2">=</span><span class="s3">&quot;asimd neon neon_vfpv4 asimddp&quot;</span><span class="s2">,</span>
            <span class="s4"># neon, neon_vfpv4, asimd implies each other</span>
            <span class="s1">aarch64</span><span class="s2">=</span><span class="s3">&quot;asimd asimddp&quot;</span><span class="s2">,</span>
            <span class="s1">s390x</span><span class="s2">=</span><span class="s3">&quot;vxe vxe2&quot;</span>
        <span class="s2">)</span>
        <span class="s4"># 'autovec', skipping features that can't be</span>
        <span class="s4"># vectorized by the compiler</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">expect_targets</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            /*@targets 
                $keep_baseline $keep_sort $autovec 
                avx512f avx2 sse42 sse41 sse2 
                vsx3 vsx2 
                asimddp asimd neon_vfpv4 neon 
            */ 
            &quot;&quot;&quot;</span><span class="s2">,</span>
            <span class="s1">x86_gcc</span><span class="s2">=</span><span class="s3">&quot;avx512f avx2 sse42 sse41 sse2&quot;</span><span class="s2">,</span>
            <span class="s1">x86_icc</span><span class="s2">=</span><span class="s3">&quot;avx512f avx2 sse42 sse41 sse2&quot;</span><span class="s2">,</span>
            <span class="s1">x86_iccw</span><span class="s2">=</span><span class="s3">&quot;avx512f avx2 sse42 sse41 sse2&quot;</span><span class="s2">,</span>
            <span class="s1">x86_msvc</span><span class="s2">=</span><span class="s3">&quot;avx512f avx2 sse2&quot;</span>
                     <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">march</span><span class="s2">() == </span><span class="s3">'x86' </span><span class="s0">else </span><span class="s3">&quot;avx512f avx2&quot;</span><span class="s2">,</span>
            <span class="s1">ppc64</span><span class="s2">=</span><span class="s3">&quot;vsx3 vsx2&quot;</span><span class="s2">,</span>
            <span class="s1">armhf</span><span class="s2">=</span><span class="s3">&quot;asimddp asimd neon_vfpv4 neon&quot;</span><span class="s2">,</span>
            <span class="s4"># neon, neon_vfpv4, asimd implies each other</span>
            <span class="s1">aarch64</span><span class="s2">=</span><span class="s3">&quot;asimddp asimd&quot;</span>
        <span class="s2">)</span>
        <span class="s0">for </span><span class="s1">policy </span><span class="s0">in </span><span class="s2">(</span><span class="s3">&quot;$maxopt&quot;</span><span class="s2">, </span><span class="s3">&quot;$autovec&quot;</span><span class="s2">):</span>
            <span class="s4"># 'maxopt' and autovec set the max acceptable optimization flags</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">expect_target_flags</span><span class="s2">(</span>
                <span class="s3">&quot;/*@targets baseline %s */&quot; </span><span class="s2">% </span><span class="s1">policy</span><span class="s2">,</span>
                <span class="s1">gcc</span><span class="s2">={</span><span class="s3">&quot;baseline&quot;</span><span class="s2">:</span><span class="s3">&quot;.*-O3.*&quot;</span><span class="s2">}, </span><span class="s1">icc</span><span class="s2">={</span><span class="s3">&quot;baseline&quot;</span><span class="s2">:</span><span class="s3">&quot;.*-O3.*&quot;</span><span class="s2">},</span>
                <span class="s1">iccw</span><span class="s2">={</span><span class="s3">&quot;baseline&quot;</span><span class="s2">:</span><span class="s3">&quot;.*/O3.*&quot;</span><span class="s2">}, </span><span class="s1">msvc</span><span class="s2">={</span><span class="s3">&quot;baseline&quot;</span><span class="s2">:</span><span class="s3">&quot;.*/O2.*&quot;</span><span class="s2">},</span>
                <span class="s1">unknown</span><span class="s2">={</span><span class="s3">&quot;baseline&quot;</span><span class="s2">:</span><span class="s3">&quot;.*&quot;</span><span class="s2">}</span>
            <span class="s2">)</span>

        <span class="s4"># 'werror', force compilers to treat warnings as errors</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">expect_target_flags</span><span class="s2">(</span>
            <span class="s3">&quot;/*@targets baseline $werror */&quot;</span><span class="s2">,</span>
            <span class="s1">gcc</span><span class="s2">={</span><span class="s3">&quot;baseline&quot;</span><span class="s2">:</span><span class="s3">&quot;.*-Werror.*&quot;</span><span class="s2">}, </span><span class="s1">icc</span><span class="s2">={</span><span class="s3">&quot;baseline&quot;</span><span class="s2">:</span><span class="s3">&quot;.*-Werror.*&quot;</span><span class="s2">},</span>
            <span class="s1">iccw</span><span class="s2">={</span><span class="s3">&quot;baseline&quot;</span><span class="s2">:</span><span class="s3">&quot;.*/Werror.*&quot;</span><span class="s2">}, </span><span class="s1">msvc</span><span class="s2">={</span><span class="s3">&quot;baseline&quot;</span><span class="s2">:</span><span class="s3">&quot;.*/WX.*&quot;</span><span class="s2">},</span>
            <span class="s1">unknown</span><span class="s2">={</span><span class="s3">&quot;baseline&quot;</span><span class="s2">:</span><span class="s3">&quot;.*&quot;</span><span class="s2">}</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_targets_groups</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">expect_targets</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            /*@targets $keep_baseline baseline #test_group */ 
            &quot;&quot;&quot;</span><span class="s2">,</span>
            <span class="s1">groups</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span>
                <span class="s1">test_group</span><span class="s2">=(</span><span class="s3">&quot;&quot;&quot; 
                    $keep_baseline 
                    asimddp sse2 vsx2 avx2 vsx3 
                    avx512f asimdhp 
                &quot;&quot;&quot;</span><span class="s2">)</span>
            <span class="s2">),</span>
            <span class="s1">x86</span><span class="s2">=</span><span class="s3">&quot;avx512f avx2 sse2 baseline&quot;</span><span class="s2">,</span>
            <span class="s1">ppc64</span><span class="s2">=</span><span class="s3">&quot;vsx3 vsx2 baseline&quot;</span><span class="s2">,</span>
            <span class="s1">armhf</span><span class="s2">=</span><span class="s3">&quot;asimddp asimdhp baseline&quot;</span>
        <span class="s2">)</span>
        <span class="s4"># test skip duplicating and sorting</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">expect_targets</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            /*@targets 
             * sse42 avx avx512f 
             * #test_group_1 
             * vsx2 
             * #test_group_2 
             * asimddp asimdfhm 
            */ 
            &quot;&quot;&quot;</span><span class="s2">,</span>
            <span class="s1">groups</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span>
                <span class="s1">test_group_1</span><span class="s2">=(</span><span class="s3">&quot;&quot;&quot; 
                    VSX2 vsx3 asimd avx2 SSE41 
                &quot;&quot;&quot;</span><span class="s2">),</span>
                <span class="s1">test_group_2</span><span class="s2">=(</span><span class="s3">&quot;&quot;&quot; 
                    vsx2 vsx3 asImd aVx2 sse41 
                &quot;&quot;&quot;</span><span class="s2">)</span>
            <span class="s2">),</span>
            <span class="s1">x86</span><span class="s2">=</span><span class="s3">&quot;avx512f avx2 avx sse42 sse41&quot;</span><span class="s2">,</span>
            <span class="s1">ppc64</span><span class="s2">=</span><span class="s3">&quot;vsx3 vsx2&quot;</span><span class="s2">,</span>
            <span class="s4"># vsx2 part of the default baseline of ppc64le, option (&quot;min&quot;)</span>
            <span class="s1">ppc64le</span><span class="s2">=</span><span class="s3">&quot;vsx3&quot;</span><span class="s2">,</span>
            <span class="s1">armhf</span><span class="s2">=</span><span class="s3">&quot;asimdfhm asimddp asimd&quot;</span><span class="s2">,</span>
            <span class="s4"># asimd part of the default baseline of aarch64, option (&quot;min&quot;)</span>
            <span class="s1">aarch64</span><span class="s2">=</span><span class="s3">&quot;asimdfhm asimddp&quot;</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_targets_multi</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">expect_targets</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            /*@targets 
                (avx512_clx avx512_cnl) (asimdhp asimddp) 
            */ 
            &quot;&quot;&quot;</span><span class="s2">,</span>
            <span class="s1">x86</span><span class="s2">=</span><span class="s3">r&quot;\(avx512_clx avx512_cnl\)&quot;</span><span class="s2">,</span>
            <span class="s1">armhf</span><span class="s2">=</span><span class="s3">r&quot;\(asimdhp asimddp\)&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s4"># test skipping implied features and auto-sort</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">expect_targets</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            /*@targets 
                f16c (sse41 avx sse42) (sse3 avx2 avx512f) 
                vsx2 (vsx vsx3 vsx2) 
                (neon neon_vfpv4 asimd asimdhp asimddp) 
            */ 
            &quot;&quot;&quot;</span><span class="s2">,</span>
            <span class="s1">x86</span><span class="s2">=</span><span class="s3">&quot;avx512f f16c avx&quot;</span><span class="s2">,</span>
            <span class="s1">ppc64</span><span class="s2">=</span><span class="s3">&quot;vsx3 vsx2&quot;</span><span class="s2">,</span>
            <span class="s1">ppc64le</span><span class="s2">=</span><span class="s3">&quot;vsx3&quot;</span><span class="s2">, </span><span class="s4"># vsx2 part of baseline</span>
            <span class="s1">armhf</span><span class="s2">=</span><span class="s3">r&quot;\(asimdhp asimddp\)&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s4"># test skipping implied features and keep sort</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">expect_targets</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            /*@targets $keep_sort 
                (sse41 avx sse42) (sse3 avx2 avx512f) 
                (vsx vsx3 vsx2) 
                (asimddp neon neon_vfpv4 asimd asimdhp) 
                (vx vxe vxe2) 
            */ 
            &quot;&quot;&quot;</span><span class="s2">,</span>
            <span class="s1">x86</span><span class="s2">=</span><span class="s3">&quot;avx avx512f&quot;</span><span class="s2">,</span>
            <span class="s1">ppc64</span><span class="s2">=</span><span class="s3">&quot;vsx3&quot;</span><span class="s2">,</span>
            <span class="s1">armhf</span><span class="s2">=</span><span class="s3">r&quot;\(asimdhp asimddp\)&quot;</span><span class="s2">,</span>
            <span class="s1">s390x</span><span class="s2">=</span><span class="s3">&quot;vxe2&quot;</span>
        <span class="s2">)</span>
        <span class="s4"># test compiler variety and avoiding duplicating</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">expect_targets</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            /*@targets $keep_sort 
                fma3 avx2 (fma3 avx2) (avx2 fma3) avx2 fma3 
            */ 
            &quot;&quot;&quot;</span><span class="s2">,</span>
            <span class="s1">x86_gcc</span><span class="s2">=</span><span class="s3">r&quot;fma3 avx2 \(fma3 avx2\)&quot;</span><span class="s2">,</span>
            <span class="s1">x86_icc</span><span class="s2">=</span><span class="s3">&quot;avx2&quot;</span><span class="s2">, </span><span class="s1">x86_iccw</span><span class="s2">=</span><span class="s3">&quot;avx2&quot;</span><span class="s2">,</span>
            <span class="s1">x86_msvc</span><span class="s2">=</span><span class="s3">&quot;avx2&quot;</span>
        <span class="s2">)</span>

<span class="s0">def </span><span class="s1">new_test</span><span class="s2">(</span><span class="s1">arch</span><span class="s2">, </span><span class="s1">cc</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">is_standalone</span><span class="s2">: </span><span class="s0">return </span><span class="s1">textwrap</span><span class="s2">.</span><span class="s1">dedent</span><span class="s2">(</span><span class="s3">&quot;&quot;&quot;</span><span class="s0">\ 
    </span><span class="s3">class TestCCompilerOpt_{class_name}(_Test_CCompilerOpt, unittest.TestCase): 
        arch = '{arch}' 
        cc   = '{cc}' 
        def __init__(self, methodName=&quot;runTest&quot;): 
            unittest.TestCase.__init__(self, methodName) 
            self.setup_class() 
    &quot;&quot;&quot;</span><span class="s2">).</span><span class="s1">format</span><span class="s2">(</span>
        <span class="s1">class_name</span><span class="s2">=</span><span class="s1">arch </span><span class="s2">+ </span><span class="s3">'_' </span><span class="s2">+ </span><span class="s1">cc</span><span class="s2">, </span><span class="s1">arch</span><span class="s2">=</span><span class="s1">arch</span><span class="s2">, </span><span class="s1">cc</span><span class="s2">=</span><span class="s1">cc</span>
    <span class="s2">)</span>
    <span class="s0">return </span><span class="s1">textwrap</span><span class="s2">.</span><span class="s1">dedent</span><span class="s2">(</span><span class="s3">&quot;&quot;&quot;</span><span class="s0">\ 
    </span><span class="s3">class TestCCompilerOpt_{class_name}(_Test_CCompilerOpt): 
        arch = '{arch}' 
        cc   = '{cc}' 
    &quot;&quot;&quot;</span><span class="s2">).</span><span class="s1">format</span><span class="s2">(</span>
        <span class="s1">class_name</span><span class="s2">=</span><span class="s1">arch </span><span class="s2">+ </span><span class="s3">'_' </span><span class="s2">+ </span><span class="s1">cc</span><span class="s2">, </span><span class="s1">arch</span><span class="s2">=</span><span class="s1">arch</span><span class="s2">, </span><span class="s1">cc</span><span class="s2">=</span><span class="s1">cc</span>
    <span class="s2">)</span>
<span class="s3">&quot;&quot;&quot; 
if 1 and is_standalone: 
    FakeCCompilerOpt.fake_info = &quot;x86_icc&quot; 
    cco = FakeCCompilerOpt(None, cpu_baseline=&quot;avx2&quot;) 
    print(' '.join(cco.cpu_baseline_names())) 
    print(cco.cpu_baseline_flags()) 
    unittest.main() 
    sys.exit() 
&quot;&quot;&quot;</span>
<span class="s0">for </span><span class="s1">arch</span><span class="s2">, </span><span class="s1">compilers </span><span class="s0">in </span><span class="s1">arch_compilers</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
    <span class="s0">for </span><span class="s1">cc </span><span class="s0">in </span><span class="s1">compilers</span><span class="s2">:</span>
        <span class="s1">exec</span><span class="s2">(</span><span class="s1">new_test</span><span class="s2">(</span><span class="s1">arch</span><span class="s2">, </span><span class="s1">cc</span><span class="s2">))</span>

<span class="s0">if </span><span class="s1">is_standalone</span><span class="s2">:</span>
    <span class="s1">unittest</span><span class="s2">.</span><span class="s1">main</span><span class="s2">()</span>
</pre>
</body>
</html>