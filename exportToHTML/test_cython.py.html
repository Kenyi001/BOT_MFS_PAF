<html>
<head>
<title>test_cython.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_cython.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">shutil</span>
<span class="s0">import </span><span class="s1">subprocess</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">IS_WASM</span>

<span class="s3"># This import is copied from random.tests.test_extending</span>
<span class="s0">try</span><span class="s2">:</span>
    <span class="s0">import </span><span class="s1">cython</span>
    <span class="s0">from </span><span class="s1">Cython</span><span class="s2">.</span><span class="s1">Compiler</span><span class="s2">.</span><span class="s1">Version </span><span class="s0">import </span><span class="s1">version </span><span class="s0">as </span><span class="s1">cython_version</span>
<span class="s0">except </span><span class="s1">ImportError</span><span class="s2">:</span>
    <span class="s1">cython </span><span class="s2">= </span><span class="s0">None</span>
<span class="s0">else</span><span class="s2">:</span>
    <span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">_utils </span><span class="s0">import </span><span class="s1">_pep440</span>

    <span class="s3"># Cython 0.29.30 is required for Python 3.11 and there are</span>
    <span class="s3"># other fixes in the 0.29 series that are needed even for earlier</span>
    <span class="s3"># Python versions.</span>
    <span class="s3"># Note: keep in sync with the one in pyproject.toml</span>
    <span class="s1">required_version </span><span class="s2">= </span><span class="s4">&quot;0.29.30&quot;</span>
    <span class="s0">if </span><span class="s1">_pep440</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s1">cython_version</span><span class="s2">) &lt; </span><span class="s1">_pep440</span><span class="s2">.</span><span class="s1">Version</span><span class="s2">(</span><span class="s1">required_version</span><span class="s2">):</span>
        <span class="s3"># too old or wrong cython, skip the test</span>
        <span class="s1">cython </span><span class="s2">= </span><span class="s0">None</span>

<span class="s1">pytestmark </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">cython </span><span class="s0">is None</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;requires cython&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">install_temp</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">):</span>
    <span class="s3"># Based in part on test_cython from random.tests.test_extending</span>
    <span class="s0">if </span><span class="s1">IS_WASM</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">&quot;No subprocess&quot;</span><span class="s2">)</span>

    <span class="s1">srcdir </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">__file__</span><span class="s2">), </span><span class="s4">'examples'</span><span class="s2">, </span><span class="s4">'cython'</span><span class="s2">)</span>
    <span class="s1">build_dir </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;build&quot;</span>
    <span class="s1">os</span><span class="s2">.</span><span class="s1">makedirs</span><span class="s2">(</span><span class="s1">build_dir</span><span class="s2">, </span><span class="s1">exist_ok</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">subprocess</span><span class="s2">.</span><span class="s1">check_call</span><span class="s2">([</span><span class="s4">&quot;meson&quot;</span><span class="s2">, </span><span class="s4">&quot;--version&quot;</span><span class="s2">])</span>
    <span class="s0">except </span><span class="s1">FileNotFoundError</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">&quot;No usable 'meson' found&quot;</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s4">&quot;win32&quot;</span><span class="s2">:</span>
        <span class="s1">subprocess</span><span class="s2">.</span><span class="s1">check_call</span><span class="s2">([</span><span class="s4">&quot;meson&quot;</span><span class="s2">, </span><span class="s4">&quot;setup&quot;</span><span class="s2">,</span>
                               <span class="s4">&quot;--buildtype=release&quot;</span><span class="s2">,</span>
                               <span class="s4">&quot;--vsenv&quot;</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">srcdir</span><span class="s2">)],</span>
                              <span class="s1">cwd</span><span class="s2">=</span><span class="s1">build_dir</span><span class="s2">,</span>
                              <span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">subprocess</span><span class="s2">.</span><span class="s1">check_call</span><span class="s2">([</span><span class="s4">&quot;meson&quot;</span><span class="s2">, </span><span class="s4">&quot;setup&quot;</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">srcdir</span><span class="s2">)],</span>
                              <span class="s1">cwd</span><span class="s2">=</span><span class="s1">build_dir</span>
                              <span class="s2">)</span>
    <span class="s1">subprocess</span><span class="s2">.</span><span class="s1">check_call</span><span class="s2">([</span><span class="s4">&quot;meson&quot;</span><span class="s2">, </span><span class="s4">&quot;compile&quot;</span><span class="s2">, </span><span class="s4">&quot;-vv&quot;</span><span class="s2">], </span><span class="s1">cwd</span><span class="s2">=</span><span class="s1">build_dir</span><span class="s2">)</span>

    <span class="s1">sys</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">build_dir</span><span class="s2">))</span>

<span class="s0">def </span><span class="s1">test_is_timedelta64_object</span><span class="s2">(</span><span class="s1">install_temp</span><span class="s2">):</span>
    <span class="s0">import </span><span class="s1">checks</span>

    <span class="s0">assert </span><span class="s1">checks</span><span class="s2">.</span><span class="s1">is_td64</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s5">1234</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">checks</span><span class="s2">.</span><span class="s1">is_td64</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s5">1234</span><span class="s2">, </span><span class="s4">&quot;ns&quot;</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">checks</span><span class="s2">.</span><span class="s1">is_td64</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s4">&quot;NaT&quot;</span><span class="s2">, </span><span class="s4">&quot;ns&quot;</span><span class="s2">))</span>

    <span class="s0">assert not </span><span class="s1">checks</span><span class="s2">.</span><span class="s1">is_td64</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">checks</span><span class="s2">.</span><span class="s1">is_td64</span><span class="s2">(</span><span class="s0">None</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">checks</span><span class="s2">.</span><span class="s1">is_td64</span><span class="s2">(</span><span class="s4">&quot;foo&quot;</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">checks</span><span class="s2">.</span><span class="s1">is_td64</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s4">&quot;now&quot;</span><span class="s2">, </span><span class="s4">&quot;s&quot;</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_is_datetime64_object</span><span class="s2">(</span><span class="s1">install_temp</span><span class="s2">):</span>
    <span class="s0">import </span><span class="s1">checks</span>

    <span class="s0">assert </span><span class="s1">checks</span><span class="s2">.</span><span class="s1">is_dt64</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s5">1234</span><span class="s2">, </span><span class="s4">&quot;ns&quot;</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">checks</span><span class="s2">.</span><span class="s1">is_dt64</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s4">&quot;NaT&quot;</span><span class="s2">, </span><span class="s4">&quot;ns&quot;</span><span class="s2">))</span>

    <span class="s0">assert not </span><span class="s1">checks</span><span class="s2">.</span><span class="s1">is_dt64</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">checks</span><span class="s2">.</span><span class="s1">is_dt64</span><span class="s2">(</span><span class="s0">None</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">checks</span><span class="s2">.</span><span class="s1">is_dt64</span><span class="s2">(</span><span class="s4">&quot;foo&quot;</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">checks</span><span class="s2">.</span><span class="s1">is_dt64</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s5">1234</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_get_datetime64_value</span><span class="s2">(</span><span class="s1">install_temp</span><span class="s2">):</span>
    <span class="s0">import </span><span class="s1">checks</span>

    <span class="s1">dt64 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s4">&quot;2016-01-01&quot;</span><span class="s2">, </span><span class="s4">&quot;ns&quot;</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">checks</span><span class="s2">.</span><span class="s1">get_dt64_value</span><span class="s2">(</span><span class="s1">dt64</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">dt64</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s4">&quot;i8&quot;</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">result </span><span class="s2">== </span><span class="s1">expected</span>


<span class="s0">def </span><span class="s1">test_get_timedelta64_value</span><span class="s2">(</span><span class="s1">install_temp</span><span class="s2">):</span>
    <span class="s0">import </span><span class="s1">checks</span>

    <span class="s1">td64 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s5">12345</span><span class="s2">, </span><span class="s4">&quot;h&quot;</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">checks</span><span class="s2">.</span><span class="s1">get_td64_value</span><span class="s2">(</span><span class="s1">td64</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">td64</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s4">&quot;i8&quot;</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">result </span><span class="s2">== </span><span class="s1">expected</span>


<span class="s0">def </span><span class="s1">test_get_datetime64_unit</span><span class="s2">(</span><span class="s1">install_temp</span><span class="s2">):</span>
    <span class="s0">import </span><span class="s1">checks</span>

    <span class="s1">dt64 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s4">&quot;2016-01-01&quot;</span><span class="s2">, </span><span class="s4">&quot;ns&quot;</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">checks</span><span class="s2">.</span><span class="s1">get_dt64_unit</span><span class="s2">(</span><span class="s1">dt64</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s5">10</span>
    <span class="s0">assert </span><span class="s1">result </span><span class="s2">== </span><span class="s1">expected</span>

    <span class="s1">td64 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s5">12345</span><span class="s2">, </span><span class="s4">&quot;h&quot;</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">checks</span><span class="s2">.</span><span class="s1">get_dt64_unit</span><span class="s2">(</span><span class="s1">td64</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s5">5</span>
    <span class="s0">assert </span><span class="s1">result </span><span class="s2">== </span><span class="s1">expected</span>


<span class="s0">def </span><span class="s1">test_abstract_scalars</span><span class="s2">(</span><span class="s1">install_temp</span><span class="s2">):</span>
    <span class="s0">import </span><span class="s1">checks</span>

    <span class="s0">assert </span><span class="s1">checks</span><span class="s2">.</span><span class="s1">is_integer</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">checks</span><span class="s2">.</span><span class="s1">is_integer</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int8</span><span class="s2">(</span><span class="s5">1</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">checks</span><span class="s2">.</span><span class="s1">is_integer</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">(</span><span class="s5">1</span><span class="s2">))</span>

<span class="s0">def </span><span class="s1">test_conv_intp</span><span class="s2">(</span><span class="s1">install_temp</span><span class="s2">):</span>
    <span class="s0">import </span><span class="s1">checks</span>

    <span class="s0">class </span><span class="s1">myint</span><span class="s2">:</span>
        <span class="s0">def </span><span class="s1">__int__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s5">3</span>

    <span class="s3"># These conversion passes via `__int__`, not `__index__`:</span>
    <span class="s0">assert </span><span class="s1">checks</span><span class="s2">.</span><span class="s1">conv_intp</span><span class="s2">(</span><span class="s5">3.</span><span class="s2">) == </span><span class="s5">3</span>
    <span class="s0">assert </span><span class="s1">checks</span><span class="s2">.</span><span class="s1">conv_intp</span><span class="s2">(</span><span class="s1">myint</span><span class="s2">()) == </span><span class="s5">3</span>
</pre>
</body>
</html>