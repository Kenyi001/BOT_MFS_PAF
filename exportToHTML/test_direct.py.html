<html>
<head>
<title>test_direct.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #2aacb8;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_direct.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">os</span>
<span class="s0">from </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path </span><span class="s0">import </span><span class="s1">join</span>
<span class="s0">import </span><span class="s1">sys</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s2">(</span><span class="s1">assert_equal</span><span class="s2">, </span><span class="s1">assert_allclose</span><span class="s2">, </span><span class="s1">assert_array_equal</span><span class="s2">,</span>
                           <span class="s1">assert_raises</span><span class="s2">)</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">random </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">Generator</span><span class="s2">, </span><span class="s1">MT19937</span><span class="s2">, </span><span class="s1">PCG64</span><span class="s2">, </span><span class="s1">PCG64DXSM</span><span class="s2">, </span><span class="s1">Philox</span><span class="s2">, </span><span class="s1">RandomState</span><span class="s2">, </span><span class="s1">SeedSequence</span><span class="s2">,</span>
    <span class="s1">SFC64</span><span class="s2">, </span><span class="s1">default_rng</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">_common </span><span class="s0">import </span><span class="s1">interface</span>

<span class="s0">try</span><span class="s2">:</span>
    <span class="s0">import </span><span class="s1">cffi  </span><span class="s3"># noqa: F401</span>

    <span class="s1">MISSING_CFFI </span><span class="s2">= </span><span class="s0">False</span>
<span class="s0">except </span><span class="s1">ImportError</span><span class="s2">:</span>
    <span class="s1">MISSING_CFFI </span><span class="s2">= </span><span class="s0">True</span>

<span class="s0">try</span><span class="s2">:</span>
    <span class="s0">import </span><span class="s1">ctypes  </span><span class="s3"># noqa: F401</span>

    <span class="s1">MISSING_CTYPES </span><span class="s2">= </span><span class="s0">False</span>
<span class="s0">except </span><span class="s1">ImportError</span><span class="s2">:</span>
    <span class="s1">MISSING_CTYPES </span><span class="s2">= </span><span class="s0">False</span>

<span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">optimize </span><span class="s2">&gt; </span><span class="s4">1</span><span class="s2">:</span>
    <span class="s3"># no docstrings present to inspect when PYTHONOPTIMIZE/Py_OptimizeFlag &gt; 1</span>
    <span class="s3"># cffi cannot succeed</span>
    <span class="s1">MISSING_CFFI </span><span class="s2">= </span><span class="s0">True</span>


<span class="s1">pwd </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">abspath</span><span class="s2">(</span><span class="s1">__file__</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">assert_state_equal</span><span class="s2">(</span><span class="s1">actual</span><span class="s2">, </span><span class="s1">target</span><span class="s2">):</span>
    <span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s1">actual</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">actual</span><span class="s2">[</span><span class="s1">key</span><span class="s2">], </span><span class="s1">dict</span><span class="s2">):</span>
            <span class="s1">assert_state_equal</span><span class="s2">(</span><span class="s1">actual</span><span class="s2">[</span><span class="s1">key</span><span class="s2">], </span><span class="s1">target</span><span class="s2">[</span><span class="s1">key</span><span class="s2">])</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">actual</span><span class="s2">[</span><span class="s1">key</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">):</span>
            <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">actual</span><span class="s2">[</span><span class="s1">key</span><span class="s2">], </span><span class="s1">target</span><span class="s2">[</span><span class="s1">key</span><span class="s2">])</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">actual</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] == </span><span class="s1">target</span><span class="s2">[</span><span class="s1">key</span><span class="s2">]</span>


<span class="s0">def </span><span class="s1">uint32_to_float32</span><span class="s2">(</span><span class="s1">u</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s2">((</span><span class="s1">u </span><span class="s2">&gt;&gt; </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">(</span><span class="s4">8</span><span class="s2">)) * (</span><span class="s4">1.0 </span><span class="s2">/ </span><span class="s4">2</span><span class="s2">**</span><span class="s4">24</span><span class="s2">)).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">uniform32_from_uint64</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">upper </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">x </span><span class="s2">&gt;&gt; </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">(</span><span class="s4">32</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">)</span>
    <span class="s1">lower </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">(</span><span class="s4">0xffffffff</span><span class="s2">)</span>
    <span class="s1">lower </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">x </span><span class="s2">&amp; </span><span class="s1">lower</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">)</span>
    <span class="s1">joined </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">column_stack</span><span class="s2">([</span><span class="s1">lower</span><span class="s2">, </span><span class="s1">upper</span><span class="s2">]).</span><span class="s1">ravel</span><span class="s2">()</span>
    <span class="s0">return </span><span class="s1">uint32_to_float32</span><span class="s2">(</span><span class="s1">joined</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">uniform32_from_uint53</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) &gt;&gt; </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">(</span><span class="s4">16</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">(</span><span class="s1">x </span><span class="s2">&amp; </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">(</span><span class="s4">0xffffffff</span><span class="s2">))</span>
    <span class="s0">return </span><span class="s1">uint32_to_float32</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">uniform32_from_uint32</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">uint32_to_float32</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">uniform32_from_uint</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">bits</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">bits </span><span class="s2">== </span><span class="s4">64</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">uniform32_from_uint64</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">bits </span><span class="s2">== </span><span class="s4">53</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">uniform32_from_uint53</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">bits </span><span class="s2">== </span><span class="s4">32</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">uniform32_from_uint32</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span>


<span class="s0">def </span><span class="s1">uniform_from_uint</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">bits</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">bits </span><span class="s0">in </span><span class="s2">(</span><span class="s4">64</span><span class="s2">, </span><span class="s4">63</span><span class="s2">, </span><span class="s4">53</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">uniform_from_uint64</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">bits </span><span class="s2">== </span><span class="s4">32</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">uniform_from_uint32</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">uniform_from_uint64</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s2">(</span><span class="s1">x </span><span class="s2">&gt;&gt; </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">(</span><span class="s4">11</span><span class="s2">)) * (</span><span class="s4">1.0 </span><span class="s2">/ </span><span class="s4">9007199254740992.0</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">uniform_from_uint32</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) // </span><span class="s4">2</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), </span><span class="s4">2</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] &gt;&gt; </span><span class="s4">5</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[</span><span class="s1">i </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">] &gt;&gt; </span><span class="s4">6</span>
        <span class="s1">out</span><span class="s2">[</span><span class="s1">i </span><span class="s2">// </span><span class="s4">2</span><span class="s2">] = (</span><span class="s1">a </span><span class="s2">* </span><span class="s4">67108864.0 </span><span class="s2">+ </span><span class="s1">b</span><span class="s2">) / </span><span class="s4">9007199254740992.0</span>
    <span class="s0">return </span><span class="s1">out</span>


<span class="s0">def </span><span class="s1">uniform_from_dsfmt</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">x</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">double</span><span class="s2">) - </span><span class="s4">1.0</span>


<span class="s0">def </span><span class="s1">gauss_from_uint</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">bits</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">bits </span><span class="s0">in </span><span class="s2">(</span><span class="s4">64</span><span class="s2">, </span><span class="s4">63</span><span class="s2">):</span>
        <span class="s1">doubles </span><span class="s2">= </span><span class="s1">uniform_from_uint64</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">bits </span><span class="s2">== </span><span class="s4">32</span><span class="s2">:</span>
        <span class="s1">doubles </span><span class="s2">= </span><span class="s1">uniform_from_uint32</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:  </span><span class="s3"># bits == 'dsfmt'</span>
        <span class="s1">doubles </span><span class="s2">= </span><span class="s1">uniform_from_dsfmt</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">gauss </span><span class="s2">= []</span>
    <span class="s1">loc </span><span class="s2">= </span><span class="s4">0</span>
    <span class="s1">x1 </span><span class="s2">= </span><span class="s1">x2 </span><span class="s2">= </span><span class="s4">0.0</span>
    <span class="s0">while </span><span class="s1">len</span><span class="s2">(</span><span class="s1">gauss</span><span class="s2">) &lt; </span><span class="s1">n</span><span class="s2">:</span>
        <span class="s1">r2 </span><span class="s2">= </span><span class="s4">2</span>
        <span class="s0">while </span><span class="s1">r2 </span><span class="s2">&gt;= </span><span class="s4">1.0 </span><span class="s0">or </span><span class="s1">r2 </span><span class="s2">== </span><span class="s4">0.0</span><span class="s2">:</span>
            <span class="s1">x1 </span><span class="s2">= </span><span class="s4">2.0 </span><span class="s2">* </span><span class="s1">doubles</span><span class="s2">[</span><span class="s1">loc</span><span class="s2">] - </span><span class="s4">1.0</span>
            <span class="s1">x2 </span><span class="s2">= </span><span class="s4">2.0 </span><span class="s2">* </span><span class="s1">doubles</span><span class="s2">[</span><span class="s1">loc </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">] - </span><span class="s4">1.0</span>
            <span class="s1">r2 </span><span class="s2">= </span><span class="s1">x1 </span><span class="s2">* </span><span class="s1">x1 </span><span class="s2">+ </span><span class="s1">x2 </span><span class="s2">* </span><span class="s1">x2</span>
            <span class="s1">loc </span><span class="s2">+= </span><span class="s4">2</span>

        <span class="s1">f </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(-</span><span class="s4">2.0 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">r2</span><span class="s2">) / </span><span class="s1">r2</span><span class="s2">)</span>
        <span class="s1">gauss</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">f </span><span class="s2">* </span><span class="s1">x2</span><span class="s2">)</span>
        <span class="s1">gauss</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">f </span><span class="s2">* </span><span class="s1">x1</span><span class="s2">)</span>

    <span class="s0">return </span><span class="s1">gauss</span><span class="s2">[:</span><span class="s1">n</span><span class="s2">]</span>


<span class="s0">def </span><span class="s1">test_seedsequence</span><span class="s2">():</span>
    <span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">bit_generator </span><span class="s0">import </span><span class="s2">(</span><span class="s1">ISeedSequence</span><span class="s2">,</span>
                                            <span class="s1">ISpawnableSeedSequence</span><span class="s2">,</span>
                                            <span class="s1">SeedlessSeedSequence</span><span class="s2">)</span>

    <span class="s1">s1 </span><span class="s2">= </span><span class="s1">SeedSequence</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s4">10</span><span class="s2">), </span><span class="s1">spawn_key</span><span class="s2">=(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), </span><span class="s1">pool_size</span><span class="s2">=</span><span class="s4">6</span><span class="s2">)</span>
    <span class="s1">s1</span><span class="s2">.</span><span class="s1">spawn</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
    <span class="s1">s2 </span><span class="s2">= </span><span class="s1">SeedSequence</span><span class="s2">(**</span><span class="s1">s1</span><span class="s2">.</span><span class="s1">state</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">s1</span><span class="s2">.</span><span class="s1">state</span><span class="s2">, </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">state</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">s1</span><span class="s2">.</span><span class="s1">n_children_spawned</span><span class="s2">, </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">n_children_spawned</span><span class="s2">)</span>

    <span class="s3"># The interfaces cannot be instantiated themselves.</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">ISeedSequence</span><span class="s2">)</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">ISpawnableSeedSequence</span><span class="s2">)</span>
    <span class="s1">dummy </span><span class="s2">= </span><span class="s1">SeedlessSeedSequence</span><span class="s2">()</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">NotImplementedError</span><span class="s2">, </span><span class="s1">dummy</span><span class="s2">.</span><span class="s1">generate_state</span><span class="s2">, </span><span class="s4">10</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">dummy</span><span class="s2">.</span><span class="s1">spawn</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)) == </span><span class="s4">10</span>


<span class="s0">def </span><span class="s1">test_generator_spawning</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot; Test spawning new generators and bit_generators directly. 
    &quot;&quot;&quot;</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">()</span>
    <span class="s1">seq </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">seed_seq</span>
    <span class="s1">new_ss </span><span class="s2">= </span><span class="s1">seq</span><span class="s2">.</span><span class="s1">spawn</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)</span>
    <span class="s1">expected_keys </span><span class="s2">= [</span><span class="s1">seq</span><span class="s2">.</span><span class="s1">spawn_key </span><span class="s2">+ (</span><span class="s1">i</span><span class="s2">,) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)]</span>
    <span class="s0">assert </span><span class="s2">[</span><span class="s1">c</span><span class="s2">.</span><span class="s1">spawn_key </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">new_ss</span><span class="s2">] == </span><span class="s1">expected_keys</span>

    <span class="s1">new_bgs </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">spawn</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)</span>
    <span class="s1">expected_keys </span><span class="s2">= [</span><span class="s1">seq</span><span class="s2">.</span><span class="s1">spawn_key </span><span class="s2">+ (</span><span class="s1">i</span><span class="s2">,) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">5</span><span class="s2">, </span><span class="s4">10</span><span class="s2">)]</span>
    <span class="s0">assert </span><span class="s2">[</span><span class="s1">bg</span><span class="s2">.</span><span class="s1">seed_seq</span><span class="s2">.</span><span class="s1">spawn_key </span><span class="s0">for </span><span class="s1">bg </span><span class="s0">in </span><span class="s1">new_bgs</span><span class="s2">] == </span><span class="s1">expected_keys</span>

    <span class="s1">new_rngs </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">spawn</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)</span>
    <span class="s1">expected_keys </span><span class="s2">= [</span><span class="s1">seq</span><span class="s2">.</span><span class="s1">spawn_key </span><span class="s2">+ (</span><span class="s1">i</span><span class="s2">,) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">15</span><span class="s2">)]</span>
    <span class="s1">found_keys </span><span class="s2">= [</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">seed_seq</span><span class="s2">.</span><span class="s1">spawn_key </span><span class="s0">for </span><span class="s1">rng </span><span class="s0">in </span><span class="s1">new_rngs</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">found_keys </span><span class="s2">== </span><span class="s1">expected_keys</span>

    <span class="s3"># Sanity check that streams are actually different:</span>
    <span class="s0">assert </span><span class="s1">new_rngs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">uniform</span><span class="s2">() != </span><span class="s1">new_rngs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">uniform</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_non_spawnable</span><span class="s2">():</span>
    <span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">bit_generator </span><span class="s0">import </span><span class="s1">ISeedSequence</span>

    <span class="s0">class </span><span class="s1">FakeSeedSequence</span><span class="s2">:</span>
        <span class="s0">def </span><span class="s1">generate_state</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">n_words</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">n_words</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>

    <span class="s1">ISeedSequence</span><span class="s2">.</span><span class="s1">register</span><span class="s2">(</span><span class="s1">FakeSeedSequence</span><span class="s2">)</span>

    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s1">FakeSeedSequence</span><span class="s2">())</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s6">&quot;The underlying SeedSequence&quot;</span><span class="s2">):</span>
        <span class="s1">rng</span><span class="s2">.</span><span class="s1">spawn</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s6">&quot;The underlying SeedSequence&quot;</span><span class="s2">):</span>
        <span class="s1">rng</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">spawn</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Base</span><span class="s2">:</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span>
    <span class="s1">data2 </span><span class="s2">= </span><span class="s1">data1 </span><span class="s2">= {}</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">setup_class</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">):</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">bit_generator </span><span class="s2">= </span><span class="s1">PCG64</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">bits </span><span class="s2">= </span><span class="s4">64</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">seed_error_type </span><span class="s2">= </span><span class="s1">TypeError</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">invalid_init_types </span><span class="s2">= []</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">invalid_init_values </span><span class="s2">= []</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">_read_csv</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">) </span><span class="s0">as </span><span class="s1">csv</span><span class="s2">:</span>
            <span class="s1">seed </span><span class="s2">= </span><span class="s1">csv</span><span class="s2">.</span><span class="s1">readline</span><span class="s2">()</span>
            <span class="s1">seed </span><span class="s2">= </span><span class="s1">seed</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s6">','</span><span class="s2">)</span>
            <span class="s1">seed </span><span class="s2">= [</span><span class="s1">int</span><span class="s2">(</span><span class="s1">s</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">(), </span><span class="s4">0</span><span class="s2">) </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">seed</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:]]</span>
            <span class="s1">data </span><span class="s2">= []</span>
            <span class="s0">for </span><span class="s1">line </span><span class="s0">in </span><span class="s1">csv</span><span class="s2">:</span>
                <span class="s1">data</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">int</span><span class="s2">(</span><span class="s1">line</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s6">','</span><span class="s2">)[-</span><span class="s4">1</span><span class="s2">].</span><span class="s1">strip</span><span class="s2">(), </span><span class="s4">0</span><span class="s2">))</span>
            <span class="s0">return </span><span class="s2">{</span><span class="s6">'seed'</span><span class="s2">: </span><span class="s1">seed</span><span class="s2">, </span><span class="s6">'data'</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">cls</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)}</span>

    <span class="s0">def </span><span class="s1">test_raw</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">bit_generator </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data1</span><span class="s2">[</span><span class="s6">'seed'</span><span class="s2">])</span>
        <span class="s1">uints </span><span class="s2">= </span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">random_raw</span><span class="s2">(</span><span class="s4">1000</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">uints</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data1</span><span class="s2">[</span><span class="s6">'data'</span><span class="s2">])</span>

        <span class="s1">bit_generator </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data1</span><span class="s2">[</span><span class="s6">'seed'</span><span class="s2">])</span>
        <span class="s1">uints </span><span class="s2">= </span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">random_raw</span><span class="s2">()</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">uints</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data1</span><span class="s2">[</span><span class="s6">'data'</span><span class="s2">][</span><span class="s4">0</span><span class="s2">])</span>

        <span class="s1">bit_generator </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data2</span><span class="s2">[</span><span class="s6">'seed'</span><span class="s2">])</span>
        <span class="s1">uints </span><span class="s2">= </span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">random_raw</span><span class="s2">(</span><span class="s4">1000</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">uints</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data2</span><span class="s2">[</span><span class="s6">'data'</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_random_raw</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">bit_generator </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data1</span><span class="s2">[</span><span class="s6">'seed'</span><span class="s2">])</span>
        <span class="s1">uints </span><span class="s2">= </span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">random_raw</span><span class="s2">(</span><span class="s1">output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">uints </span><span class="s0">is None</span>
        <span class="s1">uints </span><span class="s2">= </span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">random_raw</span><span class="s2">(</span><span class="s4">1000</span><span class="s2">, </span><span class="s1">output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">uints </span><span class="s0">is None</span>

    <span class="s0">def </span><span class="s1">test_gauss_inv</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">25</span>
        <span class="s1">rs </span><span class="s2">= </span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data1</span><span class="s2">[</span><span class="s6">'seed'</span><span class="s2">]))</span>
        <span class="s1">gauss </span><span class="s2">= </span><span class="s1">rs</span><span class="s2">.</span><span class="s1">standard_normal</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">gauss</span><span class="s2">,</span>
                        <span class="s1">gauss_from_uint</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data1</span><span class="s2">[</span><span class="s6">'data'</span><span class="s2">], </span><span class="s1">n</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bits</span><span class="s2">))</span>

        <span class="s1">rs </span><span class="s2">= </span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data2</span><span class="s2">[</span><span class="s6">'seed'</span><span class="s2">]))</span>
        <span class="s1">gauss </span><span class="s2">= </span><span class="s1">rs</span><span class="s2">.</span><span class="s1">standard_normal</span><span class="s2">(</span><span class="s4">25</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">gauss</span><span class="s2">,</span>
                        <span class="s1">gauss_from_uint</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data2</span><span class="s2">[</span><span class="s6">'data'</span><span class="s2">], </span><span class="s1">n</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bits</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_uniform_double</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rs </span><span class="s2">= </span><span class="s1">Generator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data1</span><span class="s2">[</span><span class="s6">'seed'</span><span class="s2">]))</span>
        <span class="s1">vals </span><span class="s2">= </span><span class="s1">uniform_from_uint</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data1</span><span class="s2">[</span><span class="s6">'data'</span><span class="s2">], </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bits</span><span class="s2">)</span>
        <span class="s1">uniforms </span><span class="s2">= </span><span class="s1">rs</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">uniforms</span><span class="s2">, </span><span class="s1">vals</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">uniforms</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>

        <span class="s1">rs </span><span class="s2">= </span><span class="s1">Generator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data2</span><span class="s2">[</span><span class="s6">'seed'</span><span class="s2">]))</span>
        <span class="s1">vals </span><span class="s2">= </span><span class="s1">uniform_from_uint</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data2</span><span class="s2">[</span><span class="s6">'data'</span><span class="s2">], </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bits</span><span class="s2">)</span>
        <span class="s1">uniforms </span><span class="s2">= </span><span class="s1">rs</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">uniforms</span><span class="s2">, </span><span class="s1">vals</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">uniforms</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_uniform_float</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rs </span><span class="s2">= </span><span class="s1">Generator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data1</span><span class="s2">[</span><span class="s6">'seed'</span><span class="s2">]))</span>
        <span class="s1">vals </span><span class="s2">= </span><span class="s1">uniform32_from_uint</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data1</span><span class="s2">[</span><span class="s6">'data'</span><span class="s2">], </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bits</span><span class="s2">)</span>
        <span class="s1">uniforms </span><span class="s2">= </span><span class="s1">rs</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">uniforms</span><span class="s2">, </span><span class="s1">vals</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">uniforms</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>

        <span class="s1">rs </span><span class="s2">= </span><span class="s1">Generator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data2</span><span class="s2">[</span><span class="s6">'seed'</span><span class="s2">]))</span>
        <span class="s1">vals </span><span class="s2">= </span><span class="s1">uniform32_from_uint</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data2</span><span class="s2">[</span><span class="s6">'data'</span><span class="s2">], </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bits</span><span class="s2">)</span>
        <span class="s1">uniforms </span><span class="s2">= </span><span class="s1">rs</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">uniforms</span><span class="s2">, </span><span class="s1">vals</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">uniforms</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_repr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rs </span><span class="s2">= </span><span class="s1">Generator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data1</span><span class="s2">[</span><span class="s6">'seed'</span><span class="s2">]))</span>
        <span class="s0">assert </span><span class="s6">'Generator' </span><span class="s0">in </span><span class="s1">repr</span><span class="s2">(</span><span class="s1">rs</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s6">f'</span><span class="s0">{</span><span class="s1">id</span><span class="s2">(</span><span class="s1">rs</span><span class="s2">)</span><span class="s0">:</span><span class="s6">#x</span><span class="s0">}</span><span class="s6">'</span><span class="s2">.</span><span class="s1">upper</span><span class="s2">().</span><span class="s1">replace</span><span class="s2">(</span><span class="s6">'X'</span><span class="s2">, </span><span class="s6">'x'</span><span class="s2">) </span><span class="s0">in </span><span class="s1">repr</span><span class="s2">(</span><span class="s1">rs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_str</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rs </span><span class="s2">= </span><span class="s1">Generator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data1</span><span class="s2">[</span><span class="s6">'seed'</span><span class="s2">]))</span>
        <span class="s0">assert </span><span class="s6">'Generator' </span><span class="s0">in </span><span class="s1">str</span><span class="s2">(</span><span class="s1">rs</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">str</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">) </span><span class="s0">in </span><span class="s1">str</span><span class="s2">(</span><span class="s1">rs</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s6">f'</span><span class="s0">{</span><span class="s1">id</span><span class="s2">(</span><span class="s1">rs</span><span class="s2">)</span><span class="s0">:</span><span class="s6">#x</span><span class="s0">}</span><span class="s6">'</span><span class="s2">.</span><span class="s1">upper</span><span class="s2">().</span><span class="s1">replace</span><span class="s2">(</span><span class="s6">'X'</span><span class="s2">, </span><span class="s6">'x'</span><span class="s2">) </span><span class="s0">not in </span><span class="s1">str</span><span class="s2">(</span><span class="s1">rs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_pickle</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">import </span><span class="s1">pickle</span>

        <span class="s1">bit_generator </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data1</span><span class="s2">[</span><span class="s6">'seed'</span><span class="s2">])</span>
        <span class="s1">state </span><span class="s2">= </span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">state</span>
        <span class="s1">bitgen_pkl </span><span class="s2">= </span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">dumps</span><span class="s2">(</span><span class="s1">bit_generator</span><span class="s2">)</span>
        <span class="s1">reloaded </span><span class="s2">= </span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">loads</span><span class="s2">(</span><span class="s1">bitgen_pkl</span><span class="s2">)</span>
        <span class="s1">reloaded_state </span><span class="s2">= </span><span class="s1">reloaded</span><span class="s2">.</span><span class="s1">state</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">Generator</span><span class="s2">(</span><span class="s1">bit_generator</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">(</span><span class="s4">1000</span><span class="s2">),</span>
                           <span class="s1">Generator</span><span class="s2">(</span><span class="s1">reloaded</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">(</span><span class="s4">1000</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">bit_generator </span><span class="s0">is not </span><span class="s1">reloaded</span>
        <span class="s1">assert_state_equal</span><span class="s2">(</span><span class="s1">reloaded_state</span><span class="s2">, </span><span class="s1">state</span><span class="s2">)</span>

        <span class="s1">ss </span><span class="s2">= </span><span class="s1">SeedSequence</span><span class="s2">(</span><span class="s4">100</span><span class="s2">)</span>
        <span class="s1">aa </span><span class="s2">= </span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">loads</span><span class="s2">(</span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">dumps</span><span class="s2">(</span><span class="s1">ss</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">ss</span><span class="s2">.</span><span class="s1">state</span><span class="s2">, </span><span class="s1">aa</span><span class="s2">.</span><span class="s1">state</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_invalid_state_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">bit_generator </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data1</span><span class="s2">[</span><span class="s6">'seed'</span><span class="s2">])</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
            <span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= {</span><span class="s6">'1'</span><span class="s2">}</span>

    <span class="s0">def </span><span class="s1">test_invalid_state_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">bit_generator </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data1</span><span class="s2">[</span><span class="s6">'seed'</span><span class="s2">])</span>
        <span class="s1">state </span><span class="s2">= </span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">state</span>
        <span class="s1">state</span><span class="s2">[</span><span class="s6">'bit_generator'</span><span class="s2">] = </span><span class="s6">'otherBitGenerator'</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s1">state</span>

    <span class="s0">def </span><span class="s1">test_invalid_init_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">bit_generator </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span>
        <span class="s0">for </span><span class="s1">st </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">invalid_init_types</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
                <span class="s1">bit_generator</span><span class="s2">(*</span><span class="s1">st</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_invalid_init_values</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">bit_generator </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span>
        <span class="s0">for </span><span class="s1">st </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">invalid_init_values</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">((</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">OverflowError</span><span class="s2">)):</span>
                <span class="s1">bit_generator</span><span class="s2">(*</span><span class="s1">st</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_benchmark</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">bit_generator </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data1</span><span class="s2">[</span><span class="s6">'seed'</span><span class="s2">])</span>
        <span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">_benchmark</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">_benchmark</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s6">'double'</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">_benchmark</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s6">'int32'</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">MISSING_CFFI</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s6">'cffi not available'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_cffi</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">bit_generator </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data1</span><span class="s2">[</span><span class="s6">'seed'</span><span class="s2">])</span>
        <span class="s1">cffi_interface </span><span class="s2">= </span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">cffi</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">cffi_interface</span><span class="s2">, </span><span class="s1">interface</span><span class="s2">)</span>
        <span class="s1">other_cffi_interface </span><span class="s2">= </span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">cffi</span>
        <span class="s0">assert </span><span class="s1">other_cffi_interface </span><span class="s0">is </span><span class="s1">cffi_interface</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">MISSING_CTYPES</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s6">'ctypes not available'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_ctypes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">bit_generator </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data1</span><span class="s2">[</span><span class="s6">'seed'</span><span class="s2">])</span>
        <span class="s1">ctypes_interface </span><span class="s2">= </span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">ctypes</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">ctypes_interface</span><span class="s2">, </span><span class="s1">interface</span><span class="s2">)</span>
        <span class="s1">other_ctypes_interface </span><span class="s2">= </span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">ctypes</span>
        <span class="s0">assert </span><span class="s1">other_ctypes_interface </span><span class="s0">is </span><span class="s1">ctypes_interface</span>

    <span class="s0">def </span><span class="s1">test_getstate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">bit_generator </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data1</span><span class="s2">[</span><span class="s6">'seed'</span><span class="s2">])</span>
        <span class="s1">state </span><span class="s2">= </span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">state</span>
        <span class="s1">alt_state </span><span class="s2">= </span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">__getstate__</span><span class="s2">()</span>
        <span class="s1">assert_state_equal</span><span class="s2">(</span><span class="s1">state</span><span class="s2">, </span><span class="s1">alt_state</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestPhilox</span><span class="s2">(</span><span class="s1">Base</span><span class="s2">):</span>
    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">setup_class</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">):</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">bit_generator </span><span class="s2">= </span><span class="s1">Philox</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">bits </span><span class="s2">= </span><span class="s4">64</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">data1 </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_read_csv</span><span class="s2">(</span>
            <span class="s1">join</span><span class="s2">(</span><span class="s1">pwd</span><span class="s2">, </span><span class="s6">'./data/philox-testset-1.csv'</span><span class="s2">))</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">data2 </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_read_csv</span><span class="s2">(</span>
            <span class="s1">join</span><span class="s2">(</span><span class="s1">pwd</span><span class="s2">, </span><span class="s6">'./data/philox-testset-2.csv'</span><span class="s2">))</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">seed_error_type </span><span class="s2">= </span><span class="s1">TypeError</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">invalid_init_types </span><span class="s2">= []</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">invalid_init_values </span><span class="s2">= [(</span><span class="s4">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (-</span><span class="s4">1</span><span class="s2">,), (</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s4">2 </span><span class="s2">** </span><span class="s4">257 </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">)]</span>

    <span class="s0">def </span><span class="s1">test_set_key</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">bit_generator </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data1</span><span class="s2">[</span><span class="s6">'seed'</span><span class="s2">])</span>
        <span class="s1">state </span><span class="s2">= </span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">state</span>
        <span class="s1">keyed </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">(</span><span class="s1">counter</span><span class="s2">=</span><span class="s1">state</span><span class="s2">[</span><span class="s6">'state'</span><span class="s2">][</span><span class="s6">'counter'</span><span class="s2">],</span>
                                   <span class="s1">key</span><span class="s2">=</span><span class="s1">state</span><span class="s2">[</span><span class="s6">'state'</span><span class="s2">][</span><span class="s6">'key'</span><span class="s2">])</span>
        <span class="s1">assert_state_equal</span><span class="s2">(</span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">state</span><span class="s2">, </span><span class="s1">keyed</span><span class="s2">.</span><span class="s1">state</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestPCG64</span><span class="s2">(</span><span class="s1">Base</span><span class="s2">):</span>
    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">setup_class</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">):</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">bit_generator </span><span class="s2">= </span><span class="s1">PCG64</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">bits </span><span class="s2">= </span><span class="s4">64</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">data1 </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_read_csv</span><span class="s2">(</span><span class="s1">join</span><span class="s2">(</span><span class="s1">pwd</span><span class="s2">, </span><span class="s6">'./data/pcg64-testset-1.csv'</span><span class="s2">))</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">data2 </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_read_csv</span><span class="s2">(</span><span class="s1">join</span><span class="s2">(</span><span class="s1">pwd</span><span class="s2">, </span><span class="s6">'./data/pcg64-testset-2.csv'</span><span class="s2">))</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">seed_error_type </span><span class="s2">= (</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">TypeError</span><span class="s2">)</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">invalid_init_types </span><span class="s2">= [(</span><span class="s4">3.2</span><span class="s2">,), ([</span><span class="s0">None</span><span class="s2">],), (</span><span class="s4">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)]</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">invalid_init_values </span><span class="s2">= [(-</span><span class="s4">1</span><span class="s2">,)]</span>

    <span class="s0">def </span><span class="s1">test_advance_symmetry</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rs </span><span class="s2">= </span><span class="s1">Generator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data1</span><span class="s2">[</span><span class="s6">'seed'</span><span class="s2">]))</span>
        <span class="s1">state </span><span class="s2">= </span><span class="s1">rs</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">state</span>
        <span class="s1">step </span><span class="s2">= -</span><span class="s4">0x9e3779b97f4a7c150000000000000000</span>
        <span class="s1">rs</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">advance</span><span class="s2">(</span><span class="s1">step</span><span class="s2">)</span>
        <span class="s1">val_neg </span><span class="s2">= </span><span class="s1">rs</span><span class="s2">.</span><span class="s1">integers</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">rs</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s1">state</span>
        <span class="s1">rs</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">advance</span><span class="s2">(</span><span class="s4">2</span><span class="s2">**</span><span class="s4">128 </span><span class="s2">+ </span><span class="s1">step</span><span class="s2">)</span>
        <span class="s1">val_pos </span><span class="s2">= </span><span class="s1">rs</span><span class="s2">.</span><span class="s1">integers</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">rs</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s1">state</span>
        <span class="s1">rs</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">advance</span><span class="s2">(</span><span class="s4">10 </span><span class="s2">* </span><span class="s4">2</span><span class="s2">**</span><span class="s4">128 </span><span class="s2">+ </span><span class="s1">step</span><span class="s2">)</span>
        <span class="s1">val_big </span><span class="s2">= </span><span class="s1">rs</span><span class="s2">.</span><span class="s1">integers</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">val_neg </span><span class="s2">== </span><span class="s1">val_pos</span>
        <span class="s0">assert </span><span class="s1">val_big </span><span class="s2">== </span><span class="s1">val_pos</span>

    <span class="s0">def </span><span class="s1">test_advange_large</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rs </span><span class="s2">= </span><span class="s1">Generator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">(</span><span class="s4">38219308213743</span><span class="s2">))</span>
        <span class="s1">pcg </span><span class="s2">= </span><span class="s1">rs</span><span class="s2">.</span><span class="s1">bit_generator</span>
        <span class="s1">state </span><span class="s2">= </span><span class="s1">pcg</span><span class="s2">.</span><span class="s1">state</span><span class="s2">[</span><span class="s6">&quot;state&quot;</span><span class="s2">]</span>
        <span class="s1">initial_state </span><span class="s2">= </span><span class="s4">287608843259529770491897792873167516365</span>
        <span class="s0">assert </span><span class="s1">state</span><span class="s2">[</span><span class="s6">&quot;state&quot;</span><span class="s2">] == </span><span class="s1">initial_state</span>
        <span class="s1">pcg</span><span class="s2">.</span><span class="s1">advance</span><span class="s2">(</span><span class="s1">sum</span><span class="s2">(</span><span class="s4">2</span><span class="s2">**</span><span class="s1">i </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s2">(</span><span class="s4">96</span><span class="s2">, </span><span class="s4">64</span><span class="s2">, </span><span class="s4">32</span><span class="s2">, </span><span class="s4">16</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)))</span>
        <span class="s1">state </span><span class="s2">= </span><span class="s1">pcg</span><span class="s2">.</span><span class="s1">state</span><span class="s2">[</span><span class="s6">&quot;state&quot;</span><span class="s2">]</span>
        <span class="s1">advanced_state </span><span class="s2">= </span><span class="s4">135275564607035429730177404003164635391</span>
        <span class="s0">assert </span><span class="s1">state</span><span class="s2">[</span><span class="s6">&quot;state&quot;</span><span class="s2">] == </span><span class="s1">advanced_state</span>


<span class="s0">class </span><span class="s1">TestPCG64DXSM</span><span class="s2">(</span><span class="s1">Base</span><span class="s2">):</span>
    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">setup_class</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">):</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">bit_generator </span><span class="s2">= </span><span class="s1">PCG64DXSM</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">bits </span><span class="s2">= </span><span class="s4">64</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">data1 </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_read_csv</span><span class="s2">(</span><span class="s1">join</span><span class="s2">(</span><span class="s1">pwd</span><span class="s2">, </span><span class="s6">'./data/pcg64dxsm-testset-1.csv'</span><span class="s2">))</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">data2 </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_read_csv</span><span class="s2">(</span><span class="s1">join</span><span class="s2">(</span><span class="s1">pwd</span><span class="s2">, </span><span class="s6">'./data/pcg64dxsm-testset-2.csv'</span><span class="s2">))</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">seed_error_type </span><span class="s2">= (</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">TypeError</span><span class="s2">)</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">invalid_init_types </span><span class="s2">= [(</span><span class="s4">3.2</span><span class="s2">,), ([</span><span class="s0">None</span><span class="s2">],), (</span><span class="s4">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)]</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">invalid_init_values </span><span class="s2">= [(-</span><span class="s4">1</span><span class="s2">,)]</span>

    <span class="s0">def </span><span class="s1">test_advance_symmetry</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rs </span><span class="s2">= </span><span class="s1">Generator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data1</span><span class="s2">[</span><span class="s6">'seed'</span><span class="s2">]))</span>
        <span class="s1">state </span><span class="s2">= </span><span class="s1">rs</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">state</span>
        <span class="s1">step </span><span class="s2">= -</span><span class="s4">0x9e3779b97f4a7c150000000000000000</span>
        <span class="s1">rs</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">advance</span><span class="s2">(</span><span class="s1">step</span><span class="s2">)</span>
        <span class="s1">val_neg </span><span class="s2">= </span><span class="s1">rs</span><span class="s2">.</span><span class="s1">integers</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">rs</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s1">state</span>
        <span class="s1">rs</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">advance</span><span class="s2">(</span><span class="s4">2</span><span class="s2">**</span><span class="s4">128 </span><span class="s2">+ </span><span class="s1">step</span><span class="s2">)</span>
        <span class="s1">val_pos </span><span class="s2">= </span><span class="s1">rs</span><span class="s2">.</span><span class="s1">integers</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">rs</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s1">state</span>
        <span class="s1">rs</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">advance</span><span class="s2">(</span><span class="s4">10 </span><span class="s2">* </span><span class="s4">2</span><span class="s2">**</span><span class="s4">128 </span><span class="s2">+ </span><span class="s1">step</span><span class="s2">)</span>
        <span class="s1">val_big </span><span class="s2">= </span><span class="s1">rs</span><span class="s2">.</span><span class="s1">integers</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">val_neg </span><span class="s2">== </span><span class="s1">val_pos</span>
        <span class="s0">assert </span><span class="s1">val_big </span><span class="s2">== </span><span class="s1">val_pos</span>

    <span class="s0">def </span><span class="s1">test_advange_large</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rs </span><span class="s2">= </span><span class="s1">Generator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">(</span><span class="s4">38219308213743</span><span class="s2">))</span>
        <span class="s1">pcg </span><span class="s2">= </span><span class="s1">rs</span><span class="s2">.</span><span class="s1">bit_generator</span>
        <span class="s1">state </span><span class="s2">= </span><span class="s1">pcg</span><span class="s2">.</span><span class="s1">state</span>
        <span class="s1">initial_state </span><span class="s2">= </span><span class="s4">287608843259529770491897792873167516365</span>
        <span class="s0">assert </span><span class="s1">state</span><span class="s2">[</span><span class="s6">&quot;state&quot;</span><span class="s2">][</span><span class="s6">&quot;state&quot;</span><span class="s2">] == </span><span class="s1">initial_state</span>
        <span class="s1">pcg</span><span class="s2">.</span><span class="s1">advance</span><span class="s2">(</span><span class="s1">sum</span><span class="s2">(</span><span class="s4">2</span><span class="s2">**</span><span class="s1">i </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s2">(</span><span class="s4">96</span><span class="s2">, </span><span class="s4">64</span><span class="s2">, </span><span class="s4">32</span><span class="s2">, </span><span class="s4">16</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)))</span>
        <span class="s1">state </span><span class="s2">= </span><span class="s1">pcg</span><span class="s2">.</span><span class="s1">state</span><span class="s2">[</span><span class="s6">&quot;state&quot;</span><span class="s2">]</span>
        <span class="s1">advanced_state </span><span class="s2">= </span><span class="s4">277778083536782149546677086420637664879</span>
        <span class="s0">assert </span><span class="s1">state</span><span class="s2">[</span><span class="s6">&quot;state&quot;</span><span class="s2">] == </span><span class="s1">advanced_state</span>


<span class="s0">class </span><span class="s1">TestMT19937</span><span class="s2">(</span><span class="s1">Base</span><span class="s2">):</span>
    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">setup_class</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">):</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">bit_generator </span><span class="s2">= </span><span class="s1">MT19937</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">bits </span><span class="s2">= </span><span class="s4">32</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint32</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">data1 </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_read_csv</span><span class="s2">(</span><span class="s1">join</span><span class="s2">(</span><span class="s1">pwd</span><span class="s2">, </span><span class="s6">'./data/mt19937-testset-1.csv'</span><span class="s2">))</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">data2 </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_read_csv</span><span class="s2">(</span><span class="s1">join</span><span class="s2">(</span><span class="s1">pwd</span><span class="s2">, </span><span class="s6">'./data/mt19937-testset-2.csv'</span><span class="s2">))</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">seed_error_type </span><span class="s2">= </span><span class="s1">ValueError</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">invalid_init_types </span><span class="s2">= []</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">invalid_init_values </span><span class="s2">= [(-</span><span class="s4">1</span><span class="s2">,)]</span>

    <span class="s0">def </span><span class="s1">test_seed_float_array</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">]))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">]))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">]))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">]))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">])</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_state_tuple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rs </span><span class="s2">= </span><span class="s1">Generator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data1</span><span class="s2">[</span><span class="s6">'seed'</span><span class="s2">]))</span>
        <span class="s1">bit_generator </span><span class="s2">= </span><span class="s1">rs</span><span class="s2">.</span><span class="s1">bit_generator</span>
        <span class="s1">state </span><span class="s2">= </span><span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">state</span>
        <span class="s1">desired </span><span class="s2">= </span><span class="s1">rs</span><span class="s2">.</span><span class="s1">integers</span><span class="s2">(</span><span class="s4">2 </span><span class="s2">** </span><span class="s4">16</span><span class="s2">)</span>
        <span class="s1">tup </span><span class="s2">= (</span><span class="s1">state</span><span class="s2">[</span><span class="s6">'bit_generator'</span><span class="s2">], </span><span class="s1">state</span><span class="s2">[</span><span class="s6">'state'</span><span class="s2">][</span><span class="s6">'key'</span><span class="s2">],</span>
               <span class="s1">state</span><span class="s2">[</span><span class="s6">'state'</span><span class="s2">][</span><span class="s6">'pos'</span><span class="s2">])</span>
        <span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s1">tup</span>
        <span class="s1">actual </span><span class="s2">= </span><span class="s1">rs</span><span class="s2">.</span><span class="s1">integers</span><span class="s2">(</span><span class="s4">2 </span><span class="s2">** </span><span class="s4">16</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">actual</span><span class="s2">, </span><span class="s1">desired</span><span class="s2">)</span>
        <span class="s1">tup </span><span class="s2">= </span><span class="s1">tup </span><span class="s2">+ (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">)</span>
        <span class="s1">bit_generator</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s1">tup</span>
        <span class="s1">actual </span><span class="s2">= </span><span class="s1">rs</span><span class="s2">.</span><span class="s1">integers</span><span class="s2">(</span><span class="s4">2 </span><span class="s2">** </span><span class="s4">16</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">actual</span><span class="s2">, </span><span class="s1">desired</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestSFC64</span><span class="s2">(</span><span class="s1">Base</span><span class="s2">):</span>
    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">setup_class</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">):</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">bit_generator </span><span class="s2">= </span><span class="s1">SFC64</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">bits </span><span class="s2">= </span><span class="s4">64</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">data1 </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_read_csv</span><span class="s2">(</span>
            <span class="s1">join</span><span class="s2">(</span><span class="s1">pwd</span><span class="s2">, </span><span class="s6">'./data/sfc64-testset-1.csv'</span><span class="s2">))</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">data2 </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_read_csv</span><span class="s2">(</span>
            <span class="s1">join</span><span class="s2">(</span><span class="s1">pwd</span><span class="s2">, </span><span class="s6">'./data/sfc64-testset-2.csv'</span><span class="s2">))</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">seed_error_type </span><span class="s2">= (</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">TypeError</span><span class="s2">)</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">invalid_init_types </span><span class="s2">= [(</span><span class="s4">3.2</span><span class="s2">,), ([</span><span class="s0">None</span><span class="s2">],), (</span><span class="s4">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)]</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">invalid_init_values </span><span class="s2">= [(-</span><span class="s4">1</span><span class="s2">,)]</span>


<span class="s0">class </span><span class="s1">TestDefaultRNG</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_seed</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">args </span><span class="s0">in </span><span class="s2">[(), (</span><span class="s0">None</span><span class="s2">,), (</span><span class="s4">1234</span><span class="s2">,), ([</span><span class="s4">1234</span><span class="s2">, </span><span class="s4">5678</span><span class="s2">],)]:</span>
            <span class="s1">rg </span><span class="s2">= </span><span class="s1">default_rng</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">rg</span><span class="s2">.</span><span class="s1">bit_generator</span><span class="s2">, </span><span class="s1">PCG64</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_passthrough</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">bg </span><span class="s2">= </span><span class="s1">Philox</span><span class="s2">()</span>
        <span class="s1">rg </span><span class="s2">= </span><span class="s1">default_rng</span><span class="s2">(</span><span class="s1">bg</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">rg</span><span class="s2">.</span><span class="s1">bit_generator </span><span class="s0">is </span><span class="s1">bg</span>
        <span class="s1">rg2 </span><span class="s2">= </span><span class="s1">default_rng</span><span class="s2">(</span><span class="s1">rg</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">rg2 </span><span class="s0">is </span><span class="s1">rg</span>
        <span class="s0">assert </span><span class="s1">rg2</span><span class="s2">.</span><span class="s1">bit_generator </span><span class="s0">is </span><span class="s1">bg</span>
</pre>
</body>
</html>