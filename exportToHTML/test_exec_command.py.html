<html>
<head>
<title>test_exec_command.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_exec_command.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">from </span><span class="s1">tempfile </span><span class="s0">import </span><span class="s1">TemporaryFile</span>

<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">distutils </span><span class="s0">import </span><span class="s1">exec_command</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">distutils</span><span class="s2">.</span><span class="s1">exec_command </span><span class="s0">import </span><span class="s1">get_pythonexe</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">tempdir</span><span class="s2">, </span><span class="s1">assert_</span><span class="s2">, </span><span class="s1">assert_warns</span><span class="s2">, </span><span class="s1">IS_WASM</span>


<span class="s3"># In python 3 stdout, stderr are text (unicode compliant) devices, so to</span>
<span class="s3"># emulate them import StringIO from the io module.</span>
<span class="s0">from </span><span class="s1">io </span><span class="s0">import </span><span class="s1">StringIO</span>

<span class="s0">class </span><span class="s1">redirect_stdout</span><span class="s2">:</span>
    <span class="s4">&quot;&quot;&quot;Context manager to redirect stdout for exec_command test.&quot;&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">stdout</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_stdout </span><span class="s2">= </span><span class="s1">stdout </span><span class="s0">or </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">stdout</span>

    <span class="s0">def </span><span class="s1">__enter__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">old_stdout </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">stdout</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">stdout </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_stdout</span>

    <span class="s0">def </span><span class="s1">__exit__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">exc_type</span><span class="s2">, </span><span class="s1">exc_value</span><span class="s2">, </span><span class="s1">traceback</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_stdout</span><span class="s2">.</span><span class="s1">flush</span><span class="s2">()</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">stdout </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">old_stdout</span>
        <span class="s3"># note: closing sys.stdout won't close it.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_stdout</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

<span class="s0">class </span><span class="s1">redirect_stderr</span><span class="s2">:</span>
    <span class="s4">&quot;&quot;&quot;Context manager to redirect stderr for exec_command test.&quot;&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">stderr</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_stderr </span><span class="s2">= </span><span class="s1">stderr </span><span class="s0">or </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">stderr</span>

    <span class="s0">def </span><span class="s1">__enter__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">old_stderr </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">stderr</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">stderr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_stderr</span>

    <span class="s0">def </span><span class="s1">__exit__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">exc_type</span><span class="s2">, </span><span class="s1">exc_value</span><span class="s2">, </span><span class="s1">traceback</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_stderr</span><span class="s2">.</span><span class="s1">flush</span><span class="s2">()</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">stderr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">old_stderr</span>
        <span class="s3"># note: closing sys.stderr won't close it.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_stderr</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

<span class="s0">class </span><span class="s1">emulate_nonposix</span><span class="s2">:</span>
    <span class="s4">&quot;&quot;&quot;Context manager to emulate os.name != 'posix' &quot;&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">osname</span><span class="s2">=</span><span class="s5">'non-posix'</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_new_name </span><span class="s2">= </span><span class="s1">osname</span>

    <span class="s0">def </span><span class="s1">__enter__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_old_name </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">name</span>
        <span class="s1">os</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_new_name</span>

    <span class="s0">def </span><span class="s1">__exit__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">exc_type</span><span class="s2">, </span><span class="s1">exc_value</span><span class="s2">, </span><span class="s1">traceback</span><span class="s2">):</span>
        <span class="s1">os</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_old_name</span>


<span class="s0">def </span><span class="s1">test_exec_command_stdout</span><span class="s2">():</span>
    <span class="s3"># Regression test for gh-2999 and gh-2915.</span>
    <span class="s3"># There are several packages (nose, scipy.weave.inline, Sage inline</span>
    <span class="s3"># Fortran) that replace stdout, in which case it doesn't have a fileno</span>
    <span class="s3"># method.  This is tested here, with a do-nothing command that fails if the</span>
    <span class="s3"># presence of fileno() is assumed in exec_command.</span>

    <span class="s3"># The code has a special case for posix systems, so if we are on posix test</span>
    <span class="s3"># both that the special case works and that the generic code works.</span>

    <span class="s3"># Test posix version:</span>
    <span class="s0">with </span><span class="s1">redirect_stdout</span><span class="s2">(</span><span class="s1">StringIO</span><span class="s2">()):</span>
        <span class="s0">with </span><span class="s1">redirect_stderr</span><span class="s2">(</span><span class="s1">TemporaryFile</span><span class="s2">()):</span>
            <span class="s0">with </span><span class="s1">assert_warns</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">):</span>
                <span class="s1">exec_command</span><span class="s2">.</span><span class="s1">exec_command</span><span class="s2">(</span><span class="s5">&quot;cd '.'&quot;</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s5">'posix'</span><span class="s2">:</span>
        <span class="s3"># Test general (non-posix) version:</span>
        <span class="s0">with </span><span class="s1">emulate_nonposix</span><span class="s2">():</span>
            <span class="s0">with </span><span class="s1">redirect_stdout</span><span class="s2">(</span><span class="s1">StringIO</span><span class="s2">()):</span>
                <span class="s0">with </span><span class="s1">redirect_stderr</span><span class="s2">(</span><span class="s1">TemporaryFile</span><span class="s2">()):</span>
                    <span class="s0">with </span><span class="s1">assert_warns</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">):</span>
                        <span class="s1">exec_command</span><span class="s2">.</span><span class="s1">exec_command</span><span class="s2">(</span><span class="s5">&quot;cd '.'&quot;</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">test_exec_command_stderr</span><span class="s2">():</span>
    <span class="s3"># Test posix version:</span>
    <span class="s0">with </span><span class="s1">redirect_stdout</span><span class="s2">(</span><span class="s1">TemporaryFile</span><span class="s2">(</span><span class="s1">mode</span><span class="s2">=</span><span class="s5">'w+'</span><span class="s2">)):</span>
        <span class="s0">with </span><span class="s1">redirect_stderr</span><span class="s2">(</span><span class="s1">StringIO</span><span class="s2">()):</span>
            <span class="s0">with </span><span class="s1">assert_warns</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">):</span>
                <span class="s1">exec_command</span><span class="s2">.</span><span class="s1">exec_command</span><span class="s2">(</span><span class="s5">&quot;cd '.'&quot;</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s5">'posix'</span><span class="s2">:</span>
        <span class="s3"># Test general (non-posix) version:</span>
        <span class="s0">with </span><span class="s1">emulate_nonposix</span><span class="s2">():</span>
            <span class="s0">with </span><span class="s1">redirect_stdout</span><span class="s2">(</span><span class="s1">TemporaryFile</span><span class="s2">()):</span>
                <span class="s0">with </span><span class="s1">redirect_stderr</span><span class="s2">(</span><span class="s1">StringIO</span><span class="s2">()):</span>
                    <span class="s0">with </span><span class="s1">assert_warns</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">):</span>
                        <span class="s1">exec_command</span><span class="s2">.</span><span class="s1">exec_command</span><span class="s2">(</span><span class="s5">&quot;cd '.'&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s5">&quot;Cannot start subprocess&quot;</span><span class="s2">)</span>
<span class="s0">class </span><span class="s1">TestExecCommand</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">setup_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pyexe </span><span class="s2">= </span><span class="s1">get_pythonexe</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">check_nt</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kws</span><span class="s2">):</span>
        <span class="s1">s</span><span class="s2">, </span><span class="s1">o </span><span class="s2">= </span><span class="s1">exec_command</span><span class="s2">.</span><span class="s1">exec_command</span><span class="s2">(</span><span class="s5">'cmd /C echo path=%path%'</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">s </span><span class="s2">== </span><span class="s6">0</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">o </span><span class="s2">!= </span><span class="s5">''</span><span class="s2">)</span>

        <span class="s1">s</span><span class="s2">, </span><span class="s1">o </span><span class="s2">= </span><span class="s1">exec_command</span><span class="s2">.</span><span class="s1">exec_command</span><span class="s2">(</span>
         <span class="s5">'&quot;%s&quot; -c &quot;import sys;sys.stderr.write(sys.platform)&quot;' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyexe</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">s </span><span class="s2">== </span><span class="s6">0</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">o </span><span class="s2">== </span><span class="s5">'win32'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">check_posix</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kws</span><span class="s2">):</span>
        <span class="s1">s</span><span class="s2">, </span><span class="s1">o </span><span class="s2">= </span><span class="s1">exec_command</span><span class="s2">.</span><span class="s1">exec_command</span><span class="s2">(</span><span class="s5">&quot;echo Hello&quot;</span><span class="s2">, **</span><span class="s1">kws</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">s </span><span class="s2">== </span><span class="s6">0</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">o </span><span class="s2">== </span><span class="s5">'Hello'</span><span class="s2">)</span>

        <span class="s1">s</span><span class="s2">, </span><span class="s1">o </span><span class="s2">= </span><span class="s1">exec_command</span><span class="s2">.</span><span class="s1">exec_command</span><span class="s2">(</span><span class="s5">'echo $AAA'</span><span class="s2">, **</span><span class="s1">kws</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">s </span><span class="s2">== </span><span class="s6">0</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">o </span><span class="s2">== </span><span class="s5">''</span><span class="s2">)</span>

        <span class="s1">s</span><span class="s2">, </span><span class="s1">o </span><span class="s2">= </span><span class="s1">exec_command</span><span class="s2">.</span><span class="s1">exec_command</span><span class="s2">(</span><span class="s5">'echo &quot;$AAA&quot;'</span><span class="s2">, </span><span class="s1">AAA</span><span class="s2">=</span><span class="s5">'Tere'</span><span class="s2">, **</span><span class="s1">kws</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">s </span><span class="s2">== </span><span class="s6">0</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">o </span><span class="s2">== </span><span class="s5">'Tere'</span><span class="s2">)</span>

        <span class="s1">s</span><span class="s2">, </span><span class="s1">o </span><span class="s2">= </span><span class="s1">exec_command</span><span class="s2">.</span><span class="s1">exec_command</span><span class="s2">(</span><span class="s5">'echo &quot;$AAA&quot;'</span><span class="s2">, **</span><span class="s1">kws</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">s </span><span class="s2">== </span><span class="s6">0</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">o </span><span class="s2">== </span><span class="s5">''</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s5">'BBB' </span><span class="s0">not in </span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">:</span>
            <span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">[</span><span class="s5">'BBB'</span><span class="s2">] = </span><span class="s5">'Hi'</span>
            <span class="s1">s</span><span class="s2">, </span><span class="s1">o </span><span class="s2">= </span><span class="s1">exec_command</span><span class="s2">.</span><span class="s1">exec_command</span><span class="s2">(</span><span class="s5">'echo &quot;$BBB&quot;'</span><span class="s2">, **</span><span class="s1">kws</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">s </span><span class="s2">== </span><span class="s6">0</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">o </span><span class="s2">== </span><span class="s5">'Hi'</span><span class="s2">)</span>

            <span class="s1">s</span><span class="s2">, </span><span class="s1">o </span><span class="s2">= </span><span class="s1">exec_command</span><span class="s2">.</span><span class="s1">exec_command</span><span class="s2">(</span><span class="s5">'echo &quot;$BBB&quot;'</span><span class="s2">, </span><span class="s1">BBB</span><span class="s2">=</span><span class="s5">'Hey'</span><span class="s2">, **</span><span class="s1">kws</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">s </span><span class="s2">== </span><span class="s6">0</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">o </span><span class="s2">== </span><span class="s5">'Hey'</span><span class="s2">)</span>

            <span class="s1">s</span><span class="s2">, </span><span class="s1">o </span><span class="s2">= </span><span class="s1">exec_command</span><span class="s2">.</span><span class="s1">exec_command</span><span class="s2">(</span><span class="s5">'echo &quot;$BBB&quot;'</span><span class="s2">, **</span><span class="s1">kws</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">s </span><span class="s2">== </span><span class="s6">0</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">o </span><span class="s2">== </span><span class="s5">'Hi'</span><span class="s2">)</span>

            <span class="s0">del </span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">[</span><span class="s5">'BBB'</span><span class="s2">]</span>

            <span class="s1">s</span><span class="s2">, </span><span class="s1">o </span><span class="s2">= </span><span class="s1">exec_command</span><span class="s2">.</span><span class="s1">exec_command</span><span class="s2">(</span><span class="s5">'echo &quot;$BBB&quot;'</span><span class="s2">, **</span><span class="s1">kws</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">s </span><span class="s2">== </span><span class="s6">0</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">o </span><span class="s2">== </span><span class="s5">''</span><span class="s2">)</span>


        <span class="s1">s</span><span class="s2">, </span><span class="s1">o </span><span class="s2">= </span><span class="s1">exec_command</span><span class="s2">.</span><span class="s1">exec_command</span><span class="s2">(</span><span class="s5">'this_is_not_a_command'</span><span class="s2">, **</span><span class="s1">kws</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">s </span><span class="s2">!= </span><span class="s6">0</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">o </span><span class="s2">!= </span><span class="s5">''</span><span class="s2">)</span>

        <span class="s1">s</span><span class="s2">, </span><span class="s1">o </span><span class="s2">= </span><span class="s1">exec_command</span><span class="s2">.</span><span class="s1">exec_command</span><span class="s2">(</span><span class="s5">'echo path=$PATH'</span><span class="s2">, **</span><span class="s1">kws</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">s </span><span class="s2">== </span><span class="s6">0</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">o </span><span class="s2">!= </span><span class="s5">''</span><span class="s2">)</span>

        <span class="s1">s</span><span class="s2">, </span><span class="s1">o </span><span class="s2">= </span><span class="s1">exec_command</span><span class="s2">.</span><span class="s1">exec_command</span><span class="s2">(</span>
             <span class="s5">'&quot;%s&quot; -c &quot;import sys,os;sys.stderr.write(os.name)&quot;' </span><span class="s2">%</span>
             <span class="s1">self</span><span class="s2">.</span><span class="s1">pyexe</span><span class="s2">, **</span><span class="s1">kws</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">s </span><span class="s2">== </span><span class="s6">0</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">o </span><span class="s2">== </span><span class="s5">'posix'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">check_basic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">kws</span><span class="s2">):</span>
        <span class="s1">s</span><span class="s2">, </span><span class="s1">o </span><span class="s2">= </span><span class="s1">exec_command</span><span class="s2">.</span><span class="s1">exec_command</span><span class="s2">(</span>
                     <span class="s5">'&quot;%s&quot; -c &quot;raise </span><span class="s0">\'</span><span class="s5">Ignore me.</span><span class="s0">\'</span><span class="s5">&quot;' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyexe</span><span class="s2">, **</span><span class="s1">kws</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">s </span><span class="s2">!= </span><span class="s6">0</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">o </span><span class="s2">!= </span><span class="s5">''</span><span class="s2">)</span>

        <span class="s1">s</span><span class="s2">, </span><span class="s1">o </span><span class="s2">= </span><span class="s1">exec_command</span><span class="s2">.</span><span class="s1">exec_command</span><span class="s2">(</span>
             <span class="s5">'&quot;%s&quot; -c &quot;import sys;sys.stderr.write(</span><span class="s0">\'</span><span class="s5">0</span><span class="s0">\'</span><span class="s5">);'</span>
             <span class="s5">'sys.stderr.write(</span><span class="s0">\'</span><span class="s5">1</span><span class="s0">\'</span><span class="s5">);sys.stderr.write(</span><span class="s0">\'</span><span class="s5">2</span><span class="s0">\'</span><span class="s5">)&quot;' </span><span class="s2">%</span>
             <span class="s1">self</span><span class="s2">.</span><span class="s1">pyexe</span><span class="s2">, **</span><span class="s1">kws</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">s </span><span class="s2">== </span><span class="s6">0</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">o </span><span class="s2">== </span><span class="s5">'012'</span><span class="s2">)</span>

        <span class="s1">s</span><span class="s2">, </span><span class="s1">o </span><span class="s2">= </span><span class="s1">exec_command</span><span class="s2">.</span><span class="s1">exec_command</span><span class="s2">(</span>
                 <span class="s5">'&quot;%s&quot; -c &quot;import sys;sys.exit(15)&quot;' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyexe</span><span class="s2">, **</span><span class="s1">kws</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">s </span><span class="s2">== </span><span class="s6">15</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">o </span><span class="s2">== </span><span class="s5">''</span><span class="s2">)</span>

        <span class="s1">s</span><span class="s2">, </span><span class="s1">o </span><span class="s2">= </span><span class="s1">exec_command</span><span class="s2">.</span><span class="s1">exec_command</span><span class="s2">(</span>
                     <span class="s5">'&quot;%s&quot; -c &quot;print(</span><span class="s0">\'</span><span class="s5">Heipa</span><span class="s0">\'</span><span class="s5">&quot;)' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyexe</span><span class="s2">, **</span><span class="s1">kws</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">s </span><span class="s2">== </span><span class="s6">0</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">o </span><span class="s2">== </span><span class="s5">'Heipa'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">check_execute_in</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kws</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">tempdir</span><span class="s2">() </span><span class="s0">as </span><span class="s1">tmpdir</span><span class="s2">:</span>
            <span class="s1">fn </span><span class="s2">= </span><span class="s5">&quot;file&quot;</span>
            <span class="s1">tmpfile </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">tmpfile</span><span class="s2">, </span><span class="s5">'w'</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
                <span class="s1">f</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s5">'Hello'</span><span class="s2">)</span>

            <span class="s1">s</span><span class="s2">, </span><span class="s1">o </span><span class="s2">= </span><span class="s1">exec_command</span><span class="s2">.</span><span class="s1">exec_command</span><span class="s2">(</span>
                 <span class="s5">'&quot;%s&quot; -c &quot;f = open(</span><span class="s0">\'</span><span class="s5">%s</span><span class="s0">\'</span><span class="s5">, </span><span class="s0">\'</span><span class="s5">r</span><span class="s0">\'</span><span class="s5">); f.close()&quot;' </span><span class="s2">%</span>
                 <span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyexe</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">), **</span><span class="s1">kws</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">s </span><span class="s2">!= </span><span class="s6">0</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">o </span><span class="s2">!= </span><span class="s5">''</span><span class="s2">)</span>
            <span class="s1">s</span><span class="s2">, </span><span class="s1">o </span><span class="s2">= </span><span class="s1">exec_command</span><span class="s2">.</span><span class="s1">exec_command</span><span class="s2">(</span>
                     <span class="s5">'&quot;%s&quot; -c &quot;f = open(</span><span class="s0">\'</span><span class="s5">%s</span><span class="s0">\'</span><span class="s5">, </span><span class="s0">\'</span><span class="s5">r</span><span class="s0">\'</span><span class="s5">); print(f.read()); '</span>
                     <span class="s5">'f.close()&quot;' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyexe</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">), </span><span class="s1">execute_in</span><span class="s2">=</span><span class="s1">tmpdir</span><span class="s2">, **</span><span class="s1">kws</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">s </span><span class="s2">== </span><span class="s6">0</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">o </span><span class="s2">== </span><span class="s5">'Hello'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_basic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">redirect_stdout</span><span class="s2">(</span><span class="s1">StringIO</span><span class="s2">()):</span>
            <span class="s0">with </span><span class="s1">redirect_stderr</span><span class="s2">(</span><span class="s1">StringIO</span><span class="s2">()):</span>
                <span class="s0">with </span><span class="s1">assert_warns</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">):</span>
                    <span class="s0">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s5">&quot;posix&quot;</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_posix</span><span class="s2">(</span><span class="s1">use_tee</span><span class="s2">=</span><span class="s6">0</span><span class="s2">)</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_posix</span><span class="s2">(</span><span class="s1">use_tee</span><span class="s2">=</span><span class="s6">1</span><span class="s2">)</span>
                    <span class="s0">elif </span><span class="s1">os</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s5">&quot;nt&quot;</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_nt</span><span class="s2">(</span><span class="s1">use_tee</span><span class="s2">=</span><span class="s6">0</span><span class="s2">)</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_nt</span><span class="s2">(</span><span class="s1">use_tee</span><span class="s2">=</span><span class="s6">1</span><span class="s2">)</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">check_execute_in</span><span class="s2">(</span><span class="s1">use_tee</span><span class="s2">=</span><span class="s6">0</span><span class="s2">)</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">check_execute_in</span><span class="s2">(</span><span class="s1">use_tee</span><span class="s2">=</span><span class="s6">1</span><span class="s2">)</span>
</pre>
</body>
</html>