<html>
<head>
<title>test_sql.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_sql.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;SQL io tests 
 
The SQL tests are broken down in different classes: 
 
- `PandasSQLTest`: base class with common methods for all test classes 
- Tests for the public API (only tests with sqlite3) 
    - `_TestSQLApi` base class 
    - `TestSQLApi`: test the public API with sqlalchemy engine 
    - `TestSQLiteFallbackApi`: test the public API with a sqlite DBAPI 
      connection 
- Tests for the different SQL flavors (flavor specific type conversions) 
    - Tests for the sqlalchemy mode: `_TestSQLAlchemy` is the base class with 
      common methods. The different tested flavors (sqlite3, MySQL, 
      PostgreSQL) derive from the base class 
    - Tests for the fallback mode (`TestSQLiteFallback`) 
 
&quot;&quot;&quot;</span>
<span class="s2">from </span><span class="s1">__future__ </span><span class="s2">import </span><span class="s1">annotations</span>

<span class="s2">import </span><span class="s1">contextlib</span>
<span class="s2">from </span><span class="s1">contextlib </span><span class="s2">import </span><span class="s1">closing</span>
<span class="s2">import </span><span class="s1">csv</span>
<span class="s2">from </span><span class="s1">datetime </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">date</span><span class="s3">,</span>
    <span class="s1">datetime</span><span class="s3">,</span>
    <span class="s1">time</span><span class="s3">,</span>
    <span class="s1">timedelta</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">io </span><span class="s2">import </span><span class="s1">StringIO</span>
<span class="s2">from </span><span class="s1">pathlib </span><span class="s2">import </span><span class="s1">Path</span>
<span class="s2">import </span><span class="s1">sqlite3</span>
<span class="s2">import </span><span class="s1">uuid</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">import </span><span class="s1">pytest</span>

<span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">_libs </span><span class="s2">import </span><span class="s1">lib</span>
<span class="s2">import </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">util</span><span class="s3">.</span><span class="s1">_test_decorators </span><span class="s2">as </span><span class="s1">td</span>

<span class="s2">import </span><span class="s1">pandas </span><span class="s2">as </span><span class="s1">pd</span>
<span class="s2">from </span><span class="s1">pandas </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">DataFrame</span><span class="s3">,</span>
    <span class="s1">DatetimeTZDtype</span><span class="s3">,</span>
    <span class="s1">Index</span><span class="s3">,</span>
    <span class="s1">MultiIndex</span><span class="s3">,</span>
    <span class="s1">Series</span><span class="s3">,</span>
    <span class="s1">Timestamp</span><span class="s3">,</span>
    <span class="s1">concat</span><span class="s3">,</span>
    <span class="s1">date_range</span><span class="s3">,</span>
    <span class="s1">isna</span><span class="s3">,</span>
    <span class="s1">to_datetime</span><span class="s3">,</span>
    <span class="s1">to_timedelta</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">import </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">_testing </span><span class="s2">as </span><span class="s1">tm</span>
<span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">arrays </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">ArrowStringArray</span><span class="s3">,</span>
    <span class="s1">StringArray</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">util</span><span class="s3">.</span><span class="s1">version </span><span class="s2">import </span><span class="s1">Version</span>

<span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">io </span><span class="s2">import </span><span class="s1">sql</span>
<span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">io</span><span class="s3">.</span><span class="s1">sql </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">SQLAlchemyEngine</span><span class="s3">,</span>
    <span class="s1">SQLDatabase</span><span class="s3">,</span>
    <span class="s1">SQLiteDatabase</span><span class="s3">,</span>
    <span class="s1">get_engine</span><span class="s3">,</span>
    <span class="s1">pandasSQL_builder</span><span class="s3">,</span>
    <span class="s1">read_sql_query</span><span class="s3">,</span>
    <span class="s1">read_sql_table</span><span class="s3">,</span>
<span class="s3">)</span>

<span class="s2">try</span><span class="s3">:</span>
    <span class="s2">import </span><span class="s1">sqlalchemy</span>

    <span class="s1">SQLALCHEMY_INSTALLED </span><span class="s3">= </span><span class="s2">True</span>
<span class="s2">except </span><span class="s1">ImportError</span><span class="s3">:</span>
    <span class="s1">SQLALCHEMY_INSTALLED </span><span class="s3">= </span><span class="s2">False</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span>
<span class="s2">def </span><span class="s1">sql_strings</span><span class="s3">():</span>
    <span class="s2">return </span><span class="s3">{</span>
        <span class="s4">&quot;read_parameters&quot;</span><span class="s3">: {</span>
            <span class="s4">&quot;sqlite&quot;</span><span class="s3">: </span><span class="s4">&quot;SELECT * FROM iris WHERE Name=? AND SepalLength=?&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;mysql&quot;</span><span class="s3">: </span><span class="s4">&quot;SELECT * FROM iris WHERE `Name`=%s AND `SepalLength`=%s&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;postgresql&quot;</span><span class="s3">: </span><span class="s4">'SELECT * FROM iris WHERE &quot;Name&quot;=%s AND &quot;SepalLength&quot;=%s'</span><span class="s3">,</span>
        <span class="s3">},</span>
        <span class="s4">&quot;read_named_parameters&quot;</span><span class="s3">: {</span>
            <span class="s4">&quot;sqlite&quot;</span><span class="s3">: </span><span class="s4">&quot;&quot;&quot; 
                SELECT * FROM iris WHERE Name=:name AND SepalLength=:length 
                &quot;&quot;&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;mysql&quot;</span><span class="s3">: </span><span class="s4">&quot;&quot;&quot; 
                SELECT * FROM iris WHERE 
                `Name`=%(name)s AND `SepalLength`=%(length)s 
                &quot;&quot;&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;postgresql&quot;</span><span class="s3">: </span><span class="s4">&quot;&quot;&quot; 
                SELECT * FROM iris WHERE 
                &quot;Name&quot;=%(name)s AND &quot;SepalLength&quot;=%(length)s 
                &quot;&quot;&quot;</span><span class="s3">,</span>
        <span class="s3">},</span>
        <span class="s4">&quot;read_no_parameters_with_percent&quot;</span><span class="s3">: {</span>
            <span class="s4">&quot;sqlite&quot;</span><span class="s3">: </span><span class="s4">&quot;SELECT * FROM iris WHERE Name LIKE '%'&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;mysql&quot;</span><span class="s3">: </span><span class="s4">&quot;SELECT * FROM iris WHERE `Name` LIKE '%'&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;postgresql&quot;</span><span class="s3">: </span><span class="s4">&quot;SELECT * FROM iris WHERE </span><span class="s2">\&quot;</span><span class="s4">Name</span><span class="s2">\&quot; </span><span class="s4">LIKE '%'&quot;</span><span class="s3">,</span>
        <span class="s3">},</span>
    <span class="s3">}</span>


<span class="s2">def </span><span class="s1">iris_table_metadata</span><span class="s3">(</span><span class="s1">dialect</span><span class="s3">: </span><span class="s1">str</span><span class="s3">):</span>
    <span class="s2">from </span><span class="s1">sqlalchemy </span><span class="s2">import </span><span class="s3">(</span>
        <span class="s1">REAL</span><span class="s3">,</span>
        <span class="s1">Column</span><span class="s3">,</span>
        <span class="s1">Float</span><span class="s3">,</span>
        <span class="s1">MetaData</span><span class="s3">,</span>
        <span class="s1">String</span><span class="s3">,</span>
        <span class="s1">Table</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s1">dtype </span><span class="s3">= </span><span class="s1">Float </span><span class="s2">if </span><span class="s1">dialect </span><span class="s3">== </span><span class="s4">&quot;postgresql&quot; </span><span class="s2">else </span><span class="s1">REAL</span>
    <span class="s1">metadata </span><span class="s3">= </span><span class="s1">MetaData</span><span class="s3">()</span>
    <span class="s1">iris </span><span class="s3">= </span><span class="s1">Table</span><span class="s3">(</span>
        <span class="s4">&quot;iris&quot;</span><span class="s3">,</span>
        <span class="s1">metadata</span><span class="s3">,</span>
        <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;SepalLength&quot;</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">),</span>
        <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;SepalWidth&quot;</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">),</span>
        <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;PetalLength&quot;</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">),</span>
        <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;PetalWidth&quot;</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">),</span>
        <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;Name&quot;</span><span class="s3">, </span><span class="s1">String</span><span class="s3">(</span><span class="s5">200</span><span class="s3">)),</span>
    <span class="s3">)</span>
    <span class="s2">return </span><span class="s1">iris</span>


<span class="s2">def </span><span class="s1">create_and_load_iris_sqlite3</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">: </span><span class="s1">sqlite3</span><span class="s3">.</span><span class="s1">Connection</span><span class="s3">, </span><span class="s1">iris_file</span><span class="s3">: </span><span class="s1">Path</span><span class="s3">):</span>
    <span class="s1">cur </span><span class="s3">= </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">cursor</span><span class="s3">()</span>
    <span class="s1">stmt </span><span class="s3">= </span><span class="s4">&quot;&quot;&quot;CREATE TABLE iris ( 
            &quot;SepalLength&quot; REAL, 
            &quot;SepalWidth&quot; REAL, 
            &quot;PetalLength&quot; REAL, 
            &quot;PetalWidth&quot; REAL, 
            &quot;Name&quot; TEXT 
        )&quot;&quot;&quot;</span>
    <span class="s1">cur</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">stmt</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">iris_file</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s1">newline</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">csvfile</span><span class="s3">:</span>
        <span class="s1">reader </span><span class="s3">= </span><span class="s1">csv</span><span class="s3">.</span><span class="s1">reader</span><span class="s3">(</span><span class="s1">csvfile</span><span class="s3">)</span>
        <span class="s1">next</span><span class="s3">(</span><span class="s1">reader</span><span class="s3">)</span>
        <span class="s1">stmt </span><span class="s3">= </span><span class="s4">&quot;INSERT INTO iris VALUES(?, ?, ?, ?, ?)&quot;</span>
        <span class="s1">cur</span><span class="s3">.</span><span class="s1">executemany</span><span class="s3">(</span><span class="s1">stmt</span><span class="s3">, </span><span class="s1">reader</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">create_and_load_iris</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">iris_file</span><span class="s3">: </span><span class="s1">Path</span><span class="s3">, </span><span class="s1">dialect</span><span class="s3">: </span><span class="s1">str</span><span class="s3">):</span>
    <span class="s2">from </span><span class="s1">sqlalchemy </span><span class="s2">import </span><span class="s1">insert</span>
    <span class="s2">from </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">engine </span><span class="s2">import </span><span class="s1">Engine</span>

    <span class="s1">iris </span><span class="s3">= </span><span class="s1">iris_table_metadata</span><span class="s3">(</span><span class="s1">dialect</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">iris_file</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s1">newline</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">csvfile</span><span class="s3">:</span>
        <span class="s1">reader </span><span class="s3">= </span><span class="s1">csv</span><span class="s3">.</span><span class="s1">reader</span><span class="s3">(</span><span class="s1">csvfile</span><span class="s3">)</span>
        <span class="s1">header </span><span class="s3">= </span><span class="s1">next</span><span class="s3">(</span><span class="s1">reader</span><span class="s3">)</span>
        <span class="s1">params </span><span class="s3">= [</span><span class="s1">dict</span><span class="s3">(</span><span class="s1">zip</span><span class="s3">(</span><span class="s1">header</span><span class="s3">, </span><span class="s1">row</span><span class="s3">)) </span><span class="s2">for </span><span class="s1">row </span><span class="s2">in </span><span class="s1">reader</span><span class="s3">]</span>
        <span class="s1">stmt </span><span class="s3">= </span><span class="s1">insert</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">).</span><span class="s1">values</span><span class="s3">(</span><span class="s1">params</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">Engine</span><span class="s3">):</span>
            <span class="s2">with </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">() </span><span class="s2">as </span><span class="s1">conn</span><span class="s3">:</span>
                <span class="s2">with </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">():</span>
                    <span class="s1">iris</span><span class="s3">.</span><span class="s1">drop</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">checkfirst</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
                    <span class="s1">iris</span><span class="s3">.</span><span class="s1">create</span><span class="s3">(</span><span class="s1">bind</span><span class="s3">=</span><span class="s1">conn</span><span class="s3">)</span>
                    <span class="s1">conn</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">stmt</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">():</span>
                <span class="s1">iris</span><span class="s3">.</span><span class="s1">drop</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">checkfirst</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
                <span class="s1">iris</span><span class="s3">.</span><span class="s1">create</span><span class="s3">(</span><span class="s1">bind</span><span class="s3">=</span><span class="s1">conn</span><span class="s3">)</span>
                <span class="s1">conn</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">stmt</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">create_and_load_iris_view</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">):</span>
    <span class="s1">stmt </span><span class="s3">= </span><span class="s4">&quot;CREATE VIEW iris_view AS SELECT * FROM iris&quot;</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">sqlite3</span><span class="s3">.</span><span class="s1">Connection</span><span class="s3">):</span>
        <span class="s1">cur </span><span class="s3">= </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">cursor</span><span class="s3">()</span>
        <span class="s1">cur</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">stmt</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">from </span><span class="s1">sqlalchemy </span><span class="s2">import </span><span class="s1">text</span>
        <span class="s2">from </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">engine </span><span class="s2">import </span><span class="s1">Engine</span>

        <span class="s1">stmt </span><span class="s3">= </span><span class="s1">text</span><span class="s3">(</span><span class="s1">stmt</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">Engine</span><span class="s3">):</span>
            <span class="s2">with </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">() </span><span class="s2">as </span><span class="s1">conn</span><span class="s3">:</span>
                <span class="s2">with </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">():</span>
                    <span class="s1">conn</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">stmt</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">():</span>
                <span class="s1">conn</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">stmt</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">types_table_metadata</span><span class="s3">(</span><span class="s1">dialect</span><span class="s3">: </span><span class="s1">str</span><span class="s3">):</span>
    <span class="s2">from </span><span class="s1">sqlalchemy </span><span class="s2">import </span><span class="s3">(</span>
        <span class="s1">TEXT</span><span class="s3">,</span>
        <span class="s1">Boolean</span><span class="s3">,</span>
        <span class="s1">Column</span><span class="s3">,</span>
        <span class="s1">DateTime</span><span class="s3">,</span>
        <span class="s1">Float</span><span class="s3">,</span>
        <span class="s1">Integer</span><span class="s3">,</span>
        <span class="s1">MetaData</span><span class="s3">,</span>
        <span class="s1">Table</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s1">date_type </span><span class="s3">= </span><span class="s1">TEXT </span><span class="s2">if </span><span class="s1">dialect </span><span class="s3">== </span><span class="s4">&quot;sqlite&quot; </span><span class="s2">else </span><span class="s1">DateTime</span>
    <span class="s1">bool_type </span><span class="s3">= </span><span class="s1">Integer </span><span class="s2">if </span><span class="s1">dialect </span><span class="s3">== </span><span class="s4">&quot;sqlite&quot; </span><span class="s2">else </span><span class="s1">Boolean</span>
    <span class="s1">metadata </span><span class="s3">= </span><span class="s1">MetaData</span><span class="s3">()</span>
    <span class="s1">types </span><span class="s3">= </span><span class="s1">Table</span><span class="s3">(</span>
        <span class="s4">&quot;types&quot;</span><span class="s3">,</span>
        <span class="s1">metadata</span><span class="s3">,</span>
        <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;TextCol&quot;</span><span class="s3">, </span><span class="s1">TEXT</span><span class="s3">),</span>
        <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;DateCol&quot;</span><span class="s3">, </span><span class="s1">date_type</span><span class="s3">),</span>
        <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;IntDateCol&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">),</span>
        <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;IntDateOnlyCol&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">),</span>
        <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;FloatCol&quot;</span><span class="s3">, </span><span class="s1">Float</span><span class="s3">),</span>
        <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;IntCol&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">),</span>
        <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;BoolCol&quot;</span><span class="s3">, </span><span class="s1">bool_type</span><span class="s3">),</span>
        <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;IntColWithNull&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">),</span>
        <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;BoolColWithNull&quot;</span><span class="s3">, </span><span class="s1">bool_type</span><span class="s3">),</span>
    <span class="s3">)</span>
    <span class="s2">if </span><span class="s1">dialect </span><span class="s3">== </span><span class="s4">&quot;postgresql&quot;</span><span class="s3">:</span>
        <span class="s1">types</span><span class="s3">.</span><span class="s1">append_column</span><span class="s3">(</span><span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;DateColWithTz&quot;</span><span class="s3">, </span><span class="s1">DateTime</span><span class="s3">(</span><span class="s1">timezone</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)))</span>
    <span class="s2">return </span><span class="s1">types</span>


<span class="s2">def </span><span class="s1">create_and_load_types_sqlite3</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">: </span><span class="s1">sqlite3</span><span class="s3">.</span><span class="s1">Connection</span><span class="s3">, </span><span class="s1">types_data</span><span class="s3">: </span><span class="s1">list</span><span class="s3">[</span><span class="s1">dict</span><span class="s3">]):</span>
    <span class="s1">cur </span><span class="s3">= </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">cursor</span><span class="s3">()</span>
    <span class="s1">stmt </span><span class="s3">= </span><span class="s4">&quot;&quot;&quot;CREATE TABLE types ( 
                    &quot;TextCol&quot; TEXT, 
                    &quot;DateCol&quot; TEXT, 
                    &quot;IntDateCol&quot; INTEGER, 
                    &quot;IntDateOnlyCol&quot; INTEGER, 
                    &quot;FloatCol&quot; REAL, 
                    &quot;IntCol&quot; INTEGER, 
                    &quot;BoolCol&quot; INTEGER, 
                    &quot;IntColWithNull&quot; INTEGER, 
                    &quot;BoolColWithNull&quot; INTEGER 
                )&quot;&quot;&quot;</span>
    <span class="s1">cur</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">stmt</span><span class="s3">)</span>

    <span class="s1">stmt </span><span class="s3">= </span><span class="s4">&quot;&quot;&quot; 
            INSERT INTO types 
            VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?) 
            &quot;&quot;&quot;</span>
    <span class="s1">cur</span><span class="s3">.</span><span class="s1">executemany</span><span class="s3">(</span><span class="s1">stmt</span><span class="s3">, </span><span class="s1">types_data</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">create_and_load_types</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">types_data</span><span class="s3">: </span><span class="s1">list</span><span class="s3">[</span><span class="s1">dict</span><span class="s3">], </span><span class="s1">dialect</span><span class="s3">: </span><span class="s1">str</span><span class="s3">):</span>
    <span class="s2">from </span><span class="s1">sqlalchemy </span><span class="s2">import </span><span class="s1">insert</span>
    <span class="s2">from </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">engine </span><span class="s2">import </span><span class="s1">Engine</span>

    <span class="s1">types </span><span class="s3">= </span><span class="s1">types_table_metadata</span><span class="s3">(</span><span class="s1">dialect</span><span class="s3">)</span>

    <span class="s1">stmt </span><span class="s3">= </span><span class="s1">insert</span><span class="s3">(</span><span class="s1">types</span><span class="s3">).</span><span class="s1">values</span><span class="s3">(</span><span class="s1">types_data</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">Engine</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">() </span><span class="s2">as </span><span class="s1">conn</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">():</span>
                <span class="s1">types</span><span class="s3">.</span><span class="s1">drop</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">checkfirst</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
                <span class="s1">types</span><span class="s3">.</span><span class="s1">create</span><span class="s3">(</span><span class="s1">bind</span><span class="s3">=</span><span class="s1">conn</span><span class="s3">)</span>
                <span class="s1">conn</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">stmt</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">with </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">():</span>
            <span class="s1">types</span><span class="s3">.</span><span class="s1">drop</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">checkfirst</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
            <span class="s1">types</span><span class="s3">.</span><span class="s1">create</span><span class="s3">(</span><span class="s1">bind</span><span class="s3">=</span><span class="s1">conn</span><span class="s3">)</span>
            <span class="s1">conn</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">stmt</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">check_iris_frame</span><span class="s3">(</span><span class="s1">frame</span><span class="s3">: </span><span class="s1">DataFrame</span><span class="s3">):</span>
    <span class="s1">pytype </span><span class="s3">= </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">dtypes</span><span class="s3">.</span><span class="s1">iloc</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">type</span>
    <span class="s1">row </span><span class="s3">= </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">iloc</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s2">assert </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">pytype</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">floating</span><span class="s3">)</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">equalContents</span><span class="s3">(</span><span class="s1">row</span><span class="s3">.</span><span class="s1">values</span><span class="s3">, [</span><span class="s5">5.1</span><span class="s3">, </span><span class="s5">3.5</span><span class="s3">, </span><span class="s5">1.4</span><span class="s3">, </span><span class="s5">0.2</span><span class="s3">, </span><span class="s4">&quot;Iris-setosa&quot;</span><span class="s3">])</span>
    <span class="s2">assert </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">shape </span><span class="s2">in </span><span class="s3">((</span><span class="s5">150</span><span class="s3">, </span><span class="s5">5</span><span class="s3">), (</span><span class="s5">8</span><span class="s3">, </span><span class="s5">5</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">count_rows</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">table_name</span><span class="s3">: </span><span class="s1">str</span><span class="s3">):</span>
    <span class="s1">stmt </span><span class="s3">= </span><span class="s4">f&quot;SELECT count(*) AS count_1 FROM </span><span class="s2">{</span><span class="s1">table_name</span><span class="s2">}</span><span class="s4">&quot;</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">sqlite3</span><span class="s3">.</span><span class="s1">Connection</span><span class="s3">):</span>
        <span class="s1">cur </span><span class="s3">= </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">cursor</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">cur</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">stmt</span><span class="s3">).</span><span class="s1">fetchone</span><span class="s3">()[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">from </span><span class="s1">sqlalchemy </span><span class="s2">import </span><span class="s1">create_engine</span>
        <span class="s2">from </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">engine </span><span class="s2">import </span><span class="s1">Engine</span>

        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">engine </span><span class="s3">= </span><span class="s1">create_engine</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">)</span>
                <span class="s2">with </span><span class="s1">engine</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">() </span><span class="s2">as </span><span class="s1">conn</span><span class="s3">:</span>
                    <span class="s2">return </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">exec_driver_sql</span><span class="s3">(</span><span class="s1">stmt</span><span class="s3">).</span><span class="s1">scalar_one</span><span class="s3">()</span>
            <span class="s2">finally</span><span class="s3">:</span>
                <span class="s1">engine</span><span class="s3">.</span><span class="s1">dispose</span><span class="s3">()</span>
        <span class="s2">elif </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">Engine</span><span class="s3">):</span>
            <span class="s2">with </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">() </span><span class="s2">as </span><span class="s1">conn</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">exec_driver_sql</span><span class="s3">(</span><span class="s1">stmt</span><span class="s3">).</span><span class="s1">scalar_one</span><span class="s3">()</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">exec_driver_sql</span><span class="s3">(</span><span class="s1">stmt</span><span class="s3">).</span><span class="s1">scalar_one</span><span class="s3">()</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span>
<span class="s2">def </span><span class="s1">iris_path</span><span class="s3">(</span><span class="s1">datapath</span><span class="s3">):</span>
    <span class="s1">iris_path </span><span class="s3">= </span><span class="s1">datapath</span><span class="s3">(</span><span class="s4">&quot;io&quot;</span><span class="s3">, </span><span class="s4">&quot;data&quot;</span><span class="s3">, </span><span class="s4">&quot;csv&quot;</span><span class="s3">, </span><span class="s4">&quot;iris.csv&quot;</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">Path</span><span class="s3">(</span><span class="s1">iris_path</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span>
<span class="s2">def </span><span class="s1">types_data</span><span class="s3">():</span>
    <span class="s2">return </span><span class="s3">[</span>
        <span class="s3">{</span>
            <span class="s4">&quot;TextCol&quot;</span><span class="s3">: </span><span class="s4">&quot;first&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;DateCol&quot;</span><span class="s3">: </span><span class="s4">&quot;2000-01-03 00:00:00&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;IntDateCol&quot;</span><span class="s3">: </span><span class="s5">535852800</span><span class="s3">,</span>
            <span class="s4">&quot;IntDateOnlyCol&quot;</span><span class="s3">: </span><span class="s5">20101010</span><span class="s3">,</span>
            <span class="s4">&quot;FloatCol&quot;</span><span class="s3">: </span><span class="s5">10.10</span><span class="s3">,</span>
            <span class="s4">&quot;IntCol&quot;</span><span class="s3">: </span><span class="s5">1</span><span class="s3">,</span>
            <span class="s4">&quot;BoolCol&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">,</span>
            <span class="s4">&quot;IntColWithNull&quot;</span><span class="s3">: </span><span class="s5">1</span><span class="s3">,</span>
            <span class="s4">&quot;BoolColWithNull&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">,</span>
            <span class="s4">&quot;DateColWithTz&quot;</span><span class="s3">: </span><span class="s4">&quot;2000-01-01 00:00:00-08:00&quot;</span><span class="s3">,</span>
        <span class="s3">},</span>
        <span class="s3">{</span>
            <span class="s4">&quot;TextCol&quot;</span><span class="s3">: </span><span class="s4">&quot;first&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;DateCol&quot;</span><span class="s3">: </span><span class="s4">&quot;2000-01-04 00:00:00&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;IntDateCol&quot;</span><span class="s3">: </span><span class="s5">1356998400</span><span class="s3">,</span>
            <span class="s4">&quot;IntDateOnlyCol&quot;</span><span class="s3">: </span><span class="s5">20101212</span><span class="s3">,</span>
            <span class="s4">&quot;FloatCol&quot;</span><span class="s3">: </span><span class="s5">10.10</span><span class="s3">,</span>
            <span class="s4">&quot;IntCol&quot;</span><span class="s3">: </span><span class="s5">1</span><span class="s3">,</span>
            <span class="s4">&quot;BoolCol&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">,</span>
            <span class="s4">&quot;IntColWithNull&quot;</span><span class="s3">: </span><span class="s2">None</span><span class="s3">,</span>
            <span class="s4">&quot;BoolColWithNull&quot;</span><span class="s3">: </span><span class="s2">None</span><span class="s3">,</span>
            <span class="s4">&quot;DateColWithTz&quot;</span><span class="s3">: </span><span class="s4">&quot;2000-06-01 00:00:00-07:00&quot;</span><span class="s3">,</span>
        <span class="s3">},</span>
    <span class="s3">]</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span>
<span class="s2">def </span><span class="s1">types_data_frame</span><span class="s3">(</span><span class="s1">types_data</span><span class="s3">):</span>
    <span class="s1">dtypes </span><span class="s3">= {</span>
        <span class="s4">&quot;TextCol&quot;</span><span class="s3">: </span><span class="s4">&quot;str&quot;</span><span class="s3">,</span>
        <span class="s4">&quot;DateCol&quot;</span><span class="s3">: </span><span class="s4">&quot;str&quot;</span><span class="s3">,</span>
        <span class="s4">&quot;IntDateCol&quot;</span><span class="s3">: </span><span class="s4">&quot;int64&quot;</span><span class="s3">,</span>
        <span class="s4">&quot;IntDateOnlyCol&quot;</span><span class="s3">: </span><span class="s4">&quot;int64&quot;</span><span class="s3">,</span>
        <span class="s4">&quot;FloatCol&quot;</span><span class="s3">: </span><span class="s4">&quot;float&quot;</span><span class="s3">,</span>
        <span class="s4">&quot;IntCol&quot;</span><span class="s3">: </span><span class="s4">&quot;int64&quot;</span><span class="s3">,</span>
        <span class="s4">&quot;BoolCol&quot;</span><span class="s3">: </span><span class="s4">&quot;int64&quot;</span><span class="s3">,</span>
        <span class="s4">&quot;IntColWithNull&quot;</span><span class="s3">: </span><span class="s4">&quot;float&quot;</span><span class="s3">,</span>
        <span class="s4">&quot;BoolColWithNull&quot;</span><span class="s3">: </span><span class="s4">&quot;float&quot;</span><span class="s3">,</span>
    <span class="s3">}</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">types_data</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">df</span><span class="s3">[</span><span class="s1">dtypes</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">()].</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">dtypes</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span>
<span class="s2">def </span><span class="s1">test_frame1</span><span class="s3">():</span>
    <span class="s1">columns </span><span class="s3">= [</span><span class="s4">&quot;index&quot;</span><span class="s3">, </span><span class="s4">&quot;A&quot;</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">, </span><span class="s4">&quot;C&quot;</span><span class="s3">, </span><span class="s4">&quot;D&quot;</span><span class="s3">]</span>
    <span class="s1">data </span><span class="s3">= [</span>
        <span class="s3">(</span>
            <span class="s4">&quot;2000-01-03 00:00:00&quot;</span><span class="s3">,</span>
            <span class="s5">0.980268513777</span><span class="s3">,</span>
            <span class="s5">3.68573087906</span><span class="s3">,</span>
            <span class="s3">-</span><span class="s5">0.364216805298</span><span class="s3">,</span>
            <span class="s3">-</span><span class="s5">1.15973806169</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s4">&quot;2000-01-04 00:00:00&quot;</span><span class="s3">,</span>
            <span class="s5">1.04791624281</span><span class="s3">,</span>
            <span class="s3">-</span><span class="s5">0.0412318367011</span><span class="s3">,</span>
            <span class="s3">-</span><span class="s5">0.16181208307</span><span class="s3">,</span>
            <span class="s5">0.212549316967</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s4">&quot;2000-01-05 00:00:00&quot;</span><span class="s3">,</span>
            <span class="s5">0.498580885705</span><span class="s3">,</span>
            <span class="s5">0.731167677815</span><span class="s3">,</span>
            <span class="s3">-</span><span class="s5">0.537677223318</span><span class="s3">,</span>
            <span class="s5">1.34627041952</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s4">&quot;2000-01-06 00:00:00&quot;</span><span class="s3">,</span>
            <span class="s5">1.12020151869</span><span class="s3">,</span>
            <span class="s5">1.56762092543</span><span class="s3">,</span>
            <span class="s5">0.00364077397681</span><span class="s3">,</span>
            <span class="s5">0.67525259227</span><span class="s3">,</span>
        <span class="s3">),</span>
    <span class="s3">]</span>
    <span class="s2">return </span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">columns</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span>
<span class="s2">def </span><span class="s1">test_frame3</span><span class="s3">():</span>
    <span class="s1">columns </span><span class="s3">= [</span><span class="s4">&quot;index&quot;</span><span class="s3">, </span><span class="s4">&quot;A&quot;</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">]</span>
    <span class="s1">data </span><span class="s3">= [</span>
        <span class="s3">(</span><span class="s4">&quot;2000-01-03 00:00:00&quot;</span><span class="s3">, </span><span class="s5">2</span><span class="s3">**</span><span class="s5">31 </span><span class="s3">- </span><span class="s5">1</span><span class="s3">, -</span><span class="s5">1.987670</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s4">&quot;2000-01-04 00:00:00&quot;</span><span class="s3">, -</span><span class="s5">29</span><span class="s3">, -</span><span class="s5">0.0412318367011</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s4">&quot;2000-01-05 00:00:00&quot;</span><span class="s3">, </span><span class="s5">20000</span><span class="s3">, </span><span class="s5">0.731167677815</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s4">&quot;2000-01-06 00:00:00&quot;</span><span class="s3">, -</span><span class="s5">290867</span><span class="s3">, </span><span class="s5">1.56762092543</span><span class="s3">),</span>
    <span class="s3">]</span>
    <span class="s2">return </span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">columns</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span>
<span class="s2">def </span><span class="s1">mysql_pymysql_engine</span><span class="s3">(</span><span class="s1">iris_path</span><span class="s3">, </span><span class="s1">types_data</span><span class="s3">):</span>
    <span class="s1">sqlalchemy </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;sqlalchemy&quot;</span><span class="s3">)</span>
    <span class="s1">pymysql </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pymysql&quot;</span><span class="s3">)</span>
    <span class="s1">engine </span><span class="s3">= </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">create_engine</span><span class="s3">(</span>
        <span class="s4">&quot;mysql+pymysql://root@localhost:3306/pandas&quot;</span><span class="s3">,</span>
        <span class="s1">connect_args</span><span class="s3">={</span><span class="s4">&quot;client_flag&quot;</span><span class="s3">: </span><span class="s1">pymysql</span><span class="s3">.</span><span class="s1">constants</span><span class="s3">.</span><span class="s1">CLIENT</span><span class="s3">.</span><span class="s1">MULTI_STATEMENTS</span><span class="s3">},</span>
        <span class="s1">poolclass</span><span class="s3">=</span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">pool</span><span class="s3">.</span><span class="s1">NullPool</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">insp </span><span class="s3">= </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">engine</span><span class="s3">)</span>
    <span class="s2">if not </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span><span class="s4">&quot;iris&quot;</span><span class="s3">):</span>
        <span class="s1">create_and_load_iris</span><span class="s3">(</span><span class="s1">engine</span><span class="s3">, </span><span class="s1">iris_path</span><span class="s3">, </span><span class="s4">&quot;mysql&quot;</span><span class="s3">)</span>
    <span class="s2">if not </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span><span class="s4">&quot;types&quot;</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">entry </span><span class="s2">in </span><span class="s1">types_data</span><span class="s3">:</span>
            <span class="s1">entry</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s4">&quot;DateColWithTz&quot;</span><span class="s3">)</span>
        <span class="s1">create_and_load_types</span><span class="s3">(</span><span class="s1">engine</span><span class="s3">, </span><span class="s1">types_data</span><span class="s3">, </span><span class="s4">&quot;mysql&quot;</span><span class="s3">)</span>
    <span class="s2">yield </span><span class="s1">engine</span>
    <span class="s2">with </span><span class="s1">engine</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">() </span><span class="s2">as </span><span class="s1">conn</span><span class="s3">:</span>
        <span class="s2">with </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">():</span>
            <span class="s1">stmt </span><span class="s3">= </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">text</span><span class="s3">(</span><span class="s4">&quot;DROP TABLE IF EXISTS test_frame;&quot;</span><span class="s3">)</span>
            <span class="s1">conn</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">stmt</span><span class="s3">)</span>
    <span class="s1">engine</span><span class="s3">.</span><span class="s1">dispose</span><span class="s3">()</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span>
<span class="s2">def </span><span class="s1">mysql_pymysql_conn</span><span class="s3">(</span><span class="s1">mysql_pymysql_engine</span><span class="s3">):</span>
    <span class="s2">with </span><span class="s1">mysql_pymysql_engine</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">() </span><span class="s2">as </span><span class="s1">conn</span><span class="s3">:</span>
        <span class="s2">yield </span><span class="s1">conn</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span>
<span class="s2">def </span><span class="s1">postgresql_psycopg2_engine</span><span class="s3">(</span><span class="s1">iris_path</span><span class="s3">, </span><span class="s1">types_data</span><span class="s3">):</span>
    <span class="s1">sqlalchemy </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;sqlalchemy&quot;</span><span class="s3">)</span>
    <span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;psycopg2&quot;</span><span class="s3">)</span>
    <span class="s1">engine </span><span class="s3">= </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">create_engine</span><span class="s3">(</span>
        <span class="s4">&quot;postgresql+psycopg2://postgres:postgres@localhost:5432/pandas&quot;</span><span class="s3">,</span>
        <span class="s1">poolclass</span><span class="s3">=</span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">pool</span><span class="s3">.</span><span class="s1">NullPool</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">insp </span><span class="s3">= </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">engine</span><span class="s3">)</span>
    <span class="s2">if not </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span><span class="s4">&quot;iris&quot;</span><span class="s3">):</span>
        <span class="s1">create_and_load_iris</span><span class="s3">(</span><span class="s1">engine</span><span class="s3">, </span><span class="s1">iris_path</span><span class="s3">, </span><span class="s4">&quot;postgresql&quot;</span><span class="s3">)</span>
    <span class="s2">if not </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span><span class="s4">&quot;types&quot;</span><span class="s3">):</span>
        <span class="s1">create_and_load_types</span><span class="s3">(</span><span class="s1">engine</span><span class="s3">, </span><span class="s1">types_data</span><span class="s3">, </span><span class="s4">&quot;postgresql&quot;</span><span class="s3">)</span>
    <span class="s2">yield </span><span class="s1">engine</span>
    <span class="s2">with </span><span class="s1">engine</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">() </span><span class="s2">as </span><span class="s1">conn</span><span class="s3">:</span>
        <span class="s2">with </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">():</span>
            <span class="s1">stmt </span><span class="s3">= </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">text</span><span class="s3">(</span><span class="s4">&quot;DROP TABLE IF EXISTS test_frame;&quot;</span><span class="s3">)</span>
            <span class="s1">conn</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">stmt</span><span class="s3">)</span>
    <span class="s1">engine</span><span class="s3">.</span><span class="s1">dispose</span><span class="s3">()</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span>
<span class="s2">def </span><span class="s1">postgresql_psycopg2_conn</span><span class="s3">(</span><span class="s1">postgresql_psycopg2_engine</span><span class="s3">):</span>
    <span class="s2">with </span><span class="s1">postgresql_psycopg2_engine</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">() </span><span class="s2">as </span><span class="s1">conn</span><span class="s3">:</span>
        <span class="s2">yield </span><span class="s1">conn</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span>
<span class="s2">def </span><span class="s1">sqlite_str</span><span class="s3">():</span>
    <span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;sqlalchemy&quot;</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">() </span><span class="s2">as </span><span class="s1">name</span><span class="s3">:</span>
        <span class="s2">yield </span><span class="s4">&quot;sqlite:///&quot; </span><span class="s3">+ </span><span class="s1">name</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span>
<span class="s2">def </span><span class="s1">sqlite_engine</span><span class="s3">(</span><span class="s1">sqlite_str</span><span class="s3">):</span>
    <span class="s1">sqlalchemy </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;sqlalchemy&quot;</span><span class="s3">)</span>
    <span class="s1">engine </span><span class="s3">= </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">create_engine</span><span class="s3">(</span><span class="s1">sqlite_str</span><span class="s3">, </span><span class="s1">poolclass</span><span class="s3">=</span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">pool</span><span class="s3">.</span><span class="s1">NullPool</span><span class="s3">)</span>
    <span class="s2">yield </span><span class="s1">engine</span>
    <span class="s1">engine</span><span class="s3">.</span><span class="s1">dispose</span><span class="s3">()</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span>
<span class="s2">def </span><span class="s1">sqlite_conn</span><span class="s3">(</span><span class="s1">sqlite_engine</span><span class="s3">):</span>
    <span class="s2">with </span><span class="s1">sqlite_engine</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">() </span><span class="s2">as </span><span class="s1">conn</span><span class="s3">:</span>
        <span class="s2">yield </span><span class="s1">conn</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span>
<span class="s2">def </span><span class="s1">sqlite_iris_str</span><span class="s3">(</span><span class="s1">sqlite_str</span><span class="s3">, </span><span class="s1">iris_path</span><span class="s3">):</span>
    <span class="s1">sqlalchemy </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;sqlalchemy&quot;</span><span class="s3">)</span>
    <span class="s1">engine </span><span class="s3">= </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">create_engine</span><span class="s3">(</span><span class="s1">sqlite_str</span><span class="s3">)</span>
    <span class="s1">create_and_load_iris</span><span class="s3">(</span><span class="s1">engine</span><span class="s3">, </span><span class="s1">iris_path</span><span class="s3">, </span><span class="s4">&quot;sqlite&quot;</span><span class="s3">)</span>
    <span class="s1">engine</span><span class="s3">.</span><span class="s1">dispose</span><span class="s3">()</span>
    <span class="s2">return </span><span class="s1">sqlite_str</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span>
<span class="s2">def </span><span class="s1">sqlite_iris_engine</span><span class="s3">(</span><span class="s1">sqlite_engine</span><span class="s3">, </span><span class="s1">iris_path</span><span class="s3">):</span>
    <span class="s1">create_and_load_iris</span><span class="s3">(</span><span class="s1">sqlite_engine</span><span class="s3">, </span><span class="s1">iris_path</span><span class="s3">, </span><span class="s4">&quot;sqlite&quot;</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">sqlite_engine</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span>
<span class="s2">def </span><span class="s1">sqlite_iris_conn</span><span class="s3">(</span><span class="s1">sqlite_iris_engine</span><span class="s3">):</span>
    <span class="s2">with </span><span class="s1">sqlite_iris_engine</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">() </span><span class="s2">as </span><span class="s1">conn</span><span class="s3">:</span>
        <span class="s2">yield </span><span class="s1">conn</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span>
<span class="s2">def </span><span class="s1">sqlite_buildin</span><span class="s3">():</span>
    <span class="s2">with </span><span class="s1">contextlib</span><span class="s3">.</span><span class="s1">closing</span><span class="s3">(</span><span class="s1">sqlite3</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">(</span><span class="s4">&quot;:memory:&quot;</span><span class="s3">)) </span><span class="s2">as </span><span class="s1">closing_conn</span><span class="s3">:</span>
        <span class="s2">with </span><span class="s1">closing_conn </span><span class="s2">as </span><span class="s1">conn</span><span class="s3">:</span>
            <span class="s2">yield </span><span class="s1">conn</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span>
<span class="s2">def </span><span class="s1">sqlite_buildin_iris</span><span class="s3">(</span><span class="s1">sqlite_buildin</span><span class="s3">, </span><span class="s1">iris_path</span><span class="s3">):</span>
    <span class="s1">create_and_load_iris_sqlite3</span><span class="s3">(</span><span class="s1">sqlite_buildin</span><span class="s3">, </span><span class="s1">iris_path</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">sqlite_buildin</span>


<span class="s1">mysql_connectable </span><span class="s3">= [</span>
    <span class="s4">&quot;mysql_pymysql_engine&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;mysql_pymysql_conn&quot;</span><span class="s3">,</span>
<span class="s3">]</span>


<span class="s1">postgresql_connectable </span><span class="s3">= [</span>
    <span class="s4">&quot;postgresql_psycopg2_engine&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;postgresql_psycopg2_conn&quot;</span><span class="s3">,</span>
<span class="s3">]</span>

<span class="s1">sqlite_connectable </span><span class="s3">= [</span>
    <span class="s4">&quot;sqlite_engine&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;sqlite_conn&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;sqlite_str&quot;</span><span class="s3">,</span>
<span class="s3">]</span>

<span class="s1">sqlite_iris_connectable </span><span class="s3">= [</span>
    <span class="s4">&quot;sqlite_iris_engine&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;sqlite_iris_conn&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;sqlite_iris_str&quot;</span><span class="s3">,</span>
<span class="s3">]</span>

<span class="s1">sqlalchemy_connectable </span><span class="s3">= </span><span class="s1">mysql_connectable </span><span class="s3">+ </span><span class="s1">postgresql_connectable </span><span class="s3">+ </span><span class="s1">sqlite_connectable</span>

<span class="s1">sqlalchemy_connectable_iris </span><span class="s3">= (</span>
    <span class="s1">mysql_connectable </span><span class="s3">+ </span><span class="s1">postgresql_connectable </span><span class="s3">+ </span><span class="s1">sqlite_iris_connectable</span>
<span class="s3">)</span>

<span class="s1">all_connectable </span><span class="s3">= </span><span class="s1">sqlalchemy_connectable </span><span class="s3">+ [</span><span class="s4">&quot;sqlite_buildin&quot;</span><span class="s3">]</span>

<span class="s1">all_connectable_iris </span><span class="s3">= </span><span class="s1">sqlalchemy_connectable_iris </span><span class="s3">+ [</span><span class="s4">&quot;sqlite_buildin_iris&quot;</span><span class="s3">]</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">db</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;conn&quot;</span><span class="s3">, </span><span class="s1">all_connectable</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_dataframe_to_sql</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">, </span><span class="s1">request</span><span class="s3">):</span>
    <span class="s6"># GH 51086 if conn is sqlite_engine</span>
    <span class="s1">conn </span><span class="s3">= </span><span class="s1">request</span><span class="s3">.</span><span class="s1">getfixturevalue</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">)</span>
    <span class="s1">test_frame1</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;append&quot;</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">db</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;conn&quot;</span><span class="s3">, </span><span class="s1">all_connectable</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_dataframe_to_sql_arrow_dtypes</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">request</span><span class="s3">):</span>
    <span class="s6"># GH 52046</span>
    <span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pyarrow&quot;</span><span class="s3">)</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
        <span class="s3">{</span>
            <span class="s4">&quot;int&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;int8[pyarrow]&quot;</span><span class="s3">),</span>
            <span class="s4">&quot;datetime&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span>
                <span class="s3">[</span><span class="s1">datetime</span><span class="s3">(</span><span class="s5">2023</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;timestamp[ns][pyarrow]&quot;</span>
            <span class="s3">),</span>
            <span class="s4">&quot;date&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s1">date</span><span class="s3">(</span><span class="s5">2023</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;date32[day][pyarrow]&quot;</span><span class="s3">),</span>
            <span class="s4">&quot;timedelta&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s1">timedelta</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;duration[ns][pyarrow]&quot;</span><span class="s3">),</span>
            <span class="s4">&quot;string&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">&quot;a&quot;</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;string[pyarrow]&quot;</span><span class="s3">),</span>
        <span class="s3">}</span>
    <span class="s3">)</span>
    <span class="s1">conn </span><span class="s3">= </span><span class="s1">request</span><span class="s3">.</span><span class="s1">getfixturevalue</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;the 'timedelta'&quot;</span><span class="s3">):</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_arrow&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;replace&quot;</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">db</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;conn&quot;</span><span class="s3">, </span><span class="s1">all_connectable</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_dataframe_to_sql_arrow_dtypes_missing</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">request</span><span class="s3">, </span><span class="s1">nulls_fixture</span><span class="s3">):</span>
    <span class="s6"># GH 52046</span>
    <span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pyarrow&quot;</span><span class="s3">)</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
        <span class="s3">{</span>
            <span class="s4">&quot;datetime&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span>
                <span class="s3">[</span><span class="s1">datetime</span><span class="s3">(</span><span class="s5">2023</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">), </span><span class="s1">nulls_fixture</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;timestamp[ns][pyarrow]&quot;</span>
            <span class="s3">),</span>
        <span class="s3">}</span>
    <span class="s3">)</span>
    <span class="s1">conn </span><span class="s3">= </span><span class="s1">request</span><span class="s3">.</span><span class="s1">getfixturevalue</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">)</span>
    <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_arrow&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;replace&quot;</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">db</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;conn&quot;</span><span class="s3">, </span><span class="s1">all_connectable</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;method&quot;</span><span class="s3">, [</span><span class="s2">None</span><span class="s3">, </span><span class="s4">&quot;multi&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_to_sql</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">method</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">, </span><span class="s1">request</span><span class="s3">):</span>
    <span class="s1">conn </span><span class="s3">= </span><span class="s1">request</span><span class="s3">.</span><span class="s1">getfixturevalue</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pandasSQL_builder</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">need_transaction</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) </span><span class="s2">as </span><span class="s1">pandasSQL</span><span class="s3">:</span>
        <span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">, </span><span class="s4">&quot;test_frame&quot;</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span><span class="s4">&quot;test_frame&quot;</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">count_rows</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s4">&quot;test_frame&quot;</span><span class="s3">) == </span><span class="s1">len</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">db</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;conn&quot;</span><span class="s3">, </span><span class="s1">all_connectable</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;mode, num_row_coef&quot;</span><span class="s3">, [(</span><span class="s4">&quot;replace&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">), (</span><span class="s4">&quot;append&quot;</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)])</span>
<span class="s2">def </span><span class="s1">test_to_sql_exist</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">, </span><span class="s1">num_row_coef</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">, </span><span class="s1">request</span><span class="s3">):</span>
    <span class="s1">conn </span><span class="s3">= </span><span class="s1">request</span><span class="s3">.</span><span class="s1">getfixturevalue</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pandasSQL_builder</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">need_transaction</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) </span><span class="s2">as </span><span class="s1">pandasSQL</span><span class="s3">:</span>
        <span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">, </span><span class="s4">&quot;test_frame&quot;</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;fail&quot;</span><span class="s3">)</span>
        <span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">, </span><span class="s4">&quot;test_frame&quot;</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s1">mode</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span><span class="s4">&quot;test_frame&quot;</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">count_rows</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s4">&quot;test_frame&quot;</span><span class="s3">) == </span><span class="s1">num_row_coef </span><span class="s3">* </span><span class="s1">len</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">db</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;conn&quot;</span><span class="s3">, </span><span class="s1">all_connectable</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_to_sql_exist_fail</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">, </span><span class="s1">request</span><span class="s3">):</span>
    <span class="s1">conn </span><span class="s3">= </span><span class="s1">request</span><span class="s3">.</span><span class="s1">getfixturevalue</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pandasSQL_builder</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">need_transaction</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) </span><span class="s2">as </span><span class="s1">pandasSQL</span><span class="s3">:</span>
        <span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">, </span><span class="s4">&quot;test_frame&quot;</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;fail&quot;</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span><span class="s4">&quot;test_frame&quot;</span><span class="s3">)</span>

        <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;Table 'test_frame' already exists&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">, </span><span class="s4">&quot;test_frame&quot;</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;fail&quot;</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">db</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;conn&quot;</span><span class="s3">, </span><span class="s1">all_connectable_iris</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_read_iris_query</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">request</span><span class="s3">):</span>
    <span class="s1">conn </span><span class="s3">= </span><span class="s1">request</span><span class="s3">.</span><span class="s1">getfixturevalue</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">)</span>
    <span class="s1">iris_frame </span><span class="s3">= </span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM iris&quot;</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">)</span>
    <span class="s1">check_iris_frame</span><span class="s3">(</span><span class="s1">iris_frame</span><span class="s3">)</span>
    <span class="s1">iris_frame </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">read_sql</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM iris&quot;</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">)</span>
    <span class="s1">check_iris_frame</span><span class="s3">(</span><span class="s1">iris_frame</span><span class="s3">)</span>
    <span class="s1">iris_frame </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">read_sql</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM iris where 0=1&quot;</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">iris_frame</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s5">0</span><span class="s3">, </span><span class="s5">5</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s4">&quot;SepalWidth&quot; </span><span class="s2">in </span><span class="s1">iris_frame</span><span class="s3">.</span><span class="s1">columns</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">db</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;conn&quot;</span><span class="s3">, </span><span class="s1">all_connectable_iris</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_read_iris_query_chunksize</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">request</span><span class="s3">):</span>
    <span class="s1">conn </span><span class="s3">= </span><span class="s1">request</span><span class="s3">.</span><span class="s1">getfixturevalue</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">)</span>
    <span class="s1">iris_frame </span><span class="s3">= </span><span class="s1">concat</span><span class="s3">(</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM iris&quot;</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">, </span><span class="s1">chunksize</span><span class="s3">=</span><span class="s5">7</span><span class="s3">))</span>
    <span class="s1">check_iris_frame</span><span class="s3">(</span><span class="s1">iris_frame</span><span class="s3">)</span>
    <span class="s1">iris_frame </span><span class="s3">= </span><span class="s1">concat</span><span class="s3">(</span><span class="s1">pd</span><span class="s3">.</span><span class="s1">read_sql</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM iris&quot;</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">, </span><span class="s1">chunksize</span><span class="s3">=</span><span class="s5">7</span><span class="s3">))</span>
    <span class="s1">check_iris_frame</span><span class="s3">(</span><span class="s1">iris_frame</span><span class="s3">)</span>
    <span class="s1">iris_frame </span><span class="s3">= </span><span class="s1">concat</span><span class="s3">(</span><span class="s1">pd</span><span class="s3">.</span><span class="s1">read_sql</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM iris where 0=1&quot;</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">, </span><span class="s1">chunksize</span><span class="s3">=</span><span class="s5">7</span><span class="s3">))</span>
    <span class="s2">assert </span><span class="s1">iris_frame</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s5">0</span><span class="s3">, </span><span class="s5">5</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s4">&quot;SepalWidth&quot; </span><span class="s2">in </span><span class="s1">iris_frame</span><span class="s3">.</span><span class="s1">columns</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">db</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;conn&quot;</span><span class="s3">, </span><span class="s1">sqlalchemy_connectable_iris</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_read_iris_query_expression_with_parameter</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">request</span><span class="s3">):</span>
    <span class="s1">conn </span><span class="s3">= </span><span class="s1">request</span><span class="s3">.</span><span class="s1">getfixturevalue</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">)</span>
    <span class="s2">from </span><span class="s1">sqlalchemy </span><span class="s2">import </span><span class="s3">(</span>
        <span class="s1">MetaData</span><span class="s3">,</span>
        <span class="s1">Table</span><span class="s3">,</span>
        <span class="s1">create_engine</span><span class="s3">,</span>
        <span class="s1">select</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s1">metadata </span><span class="s3">= </span><span class="s1">MetaData</span><span class="s3">()</span>
    <span class="s1">autoload_con </span><span class="s3">= </span><span class="s1">create_engine</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">) </span><span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">str</span><span class="s3">) </span><span class="s2">else </span><span class="s1">conn</span>
    <span class="s1">iris </span><span class="s3">= </span><span class="s1">Table</span><span class="s3">(</span><span class="s4">&quot;iris&quot;</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">, </span><span class="s1">autoload_with</span><span class="s3">=</span><span class="s1">autoload_con</span><span class="s3">)</span>
    <span class="s1">iris_frame </span><span class="s3">= </span><span class="s1">read_sql_query</span><span class="s3">(</span>
        <span class="s1">select</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">), </span><span class="s1">conn</span><span class="s3">, </span><span class="s1">params</span><span class="s3">={</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;Iris-setosa&quot;</span><span class="s3">, </span><span class="s4">&quot;length&quot;</span><span class="s3">: </span><span class="s5">5.1</span><span class="s3">}</span>
    <span class="s3">)</span>
    <span class="s1">check_iris_frame</span><span class="s3">(</span><span class="s1">iris_frame</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
        <span class="s1">autoload_con</span><span class="s3">.</span><span class="s1">dispose</span><span class="s3">()</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">db</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;conn&quot;</span><span class="s3">, </span><span class="s1">all_connectable_iris</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_read_iris_query_string_with_parameter</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">request</span><span class="s3">, </span><span class="s1">sql_strings</span><span class="s3">):</span>
    <span class="s2">for </span><span class="s1">db</span><span class="s3">, </span><span class="s1">query </span><span class="s2">in </span><span class="s1">sql_strings</span><span class="s3">[</span><span class="s4">&quot;read_parameters&quot;</span><span class="s3">].</span><span class="s1">items</span><span class="s3">():</span>
        <span class="s2">if </span><span class="s1">db </span><span class="s2">in </span><span class="s1">conn</span><span class="s3">:</span>
            <span class="s2">break</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">KeyError</span><span class="s3">(</span><span class="s4">f&quot;No part of </span><span class="s2">{</span><span class="s1">conn</span><span class="s2">} </span><span class="s4">found in sql_strings['read_parameters']&quot;</span><span class="s3">)</span>
    <span class="s1">conn </span><span class="s3">= </span><span class="s1">request</span><span class="s3">.</span><span class="s1">getfixturevalue</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">)</span>
    <span class="s1">iris_frame </span><span class="s3">= </span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s1">query</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">, </span><span class="s1">params</span><span class="s3">=(</span><span class="s4">&quot;Iris-setosa&quot;</span><span class="s3">, </span><span class="s5">5.1</span><span class="s3">))</span>
    <span class="s1">check_iris_frame</span><span class="s3">(</span><span class="s1">iris_frame</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">db</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;conn&quot;</span><span class="s3">, </span><span class="s1">sqlalchemy_connectable_iris</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_read_iris_table</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">request</span><span class="s3">):</span>
    <span class="s6"># GH 51015 if conn = sqlite_iris_str</span>
    <span class="s1">conn </span><span class="s3">= </span><span class="s1">request</span><span class="s3">.</span><span class="s1">getfixturevalue</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">)</span>
    <span class="s1">iris_frame </span><span class="s3">= </span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;iris&quot;</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">)</span>
    <span class="s1">check_iris_frame</span><span class="s3">(</span><span class="s1">iris_frame</span><span class="s3">)</span>
    <span class="s1">iris_frame </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">read_sql</span><span class="s3">(</span><span class="s4">&quot;iris&quot;</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">)</span>
    <span class="s1">check_iris_frame</span><span class="s3">(</span><span class="s1">iris_frame</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">db</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;conn&quot;</span><span class="s3">, </span><span class="s1">sqlalchemy_connectable_iris</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_read_iris_table_chunksize</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">request</span><span class="s3">):</span>
    <span class="s1">conn </span><span class="s3">= </span><span class="s1">request</span><span class="s3">.</span><span class="s1">getfixturevalue</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">)</span>
    <span class="s1">iris_frame </span><span class="s3">= </span><span class="s1">concat</span><span class="s3">(</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;iris&quot;</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">, </span><span class="s1">chunksize</span><span class="s3">=</span><span class="s5">7</span><span class="s3">))</span>
    <span class="s1">check_iris_frame</span><span class="s3">(</span><span class="s1">iris_frame</span><span class="s3">)</span>
    <span class="s1">iris_frame </span><span class="s3">= </span><span class="s1">concat</span><span class="s3">(</span><span class="s1">pd</span><span class="s3">.</span><span class="s1">read_sql</span><span class="s3">(</span><span class="s4">&quot;iris&quot;</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">, </span><span class="s1">chunksize</span><span class="s3">=</span><span class="s5">7</span><span class="s3">))</span>
    <span class="s1">check_iris_frame</span><span class="s3">(</span><span class="s1">iris_frame</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">db</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;conn&quot;</span><span class="s3">, </span><span class="s1">sqlalchemy_connectable</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_to_sql_callable</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">, </span><span class="s1">request</span><span class="s3">):</span>
    <span class="s1">conn </span><span class="s3">= </span><span class="s1">request</span><span class="s3">.</span><span class="s1">getfixturevalue</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">)</span>

    <span class="s1">check </span><span class="s3">= []  </span><span class="s6"># used to double check function below is really being used</span>

    <span class="s2">def </span><span class="s1">sample</span><span class="s3">(</span><span class="s1">pd_table</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">, </span><span class="s1">keys</span><span class="s3">, </span><span class="s1">data_iter</span><span class="s3">):</span>
        <span class="s1">check</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">data </span><span class="s3">= [</span><span class="s1">dict</span><span class="s3">(</span><span class="s1">zip</span><span class="s3">(</span><span class="s1">keys</span><span class="s3">, </span><span class="s1">row</span><span class="s3">)) </span><span class="s2">for </span><span class="s1">row </span><span class="s2">in </span><span class="s1">data_iter</span><span class="s3">]</span>
        <span class="s1">conn</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">pd_table</span><span class="s3">.</span><span class="s1">table</span><span class="s3">.</span><span class="s1">insert</span><span class="s3">(), </span><span class="s1">data</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pandasSQL_builder</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">need_transaction</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) </span><span class="s2">as </span><span class="s1">pandasSQL</span><span class="s3">:</span>
        <span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">, </span><span class="s4">&quot;test_frame&quot;</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">sample</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span><span class="s4">&quot;test_frame&quot;</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">check </span><span class="s3">== [</span><span class="s5">1</span><span class="s3">]</span>
    <span class="s2">assert </span><span class="s1">count_rows</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s4">&quot;test_frame&quot;</span><span class="s3">) == </span><span class="s1">len</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">db</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;conn&quot;</span><span class="s3">, </span><span class="s1">mysql_connectable</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_default_type_conversion</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">request</span><span class="s3">):</span>
    <span class="s1">conn </span><span class="s3">= </span><span class="s1">request</span><span class="s3">.</span><span class="s1">getfixturevalue</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">)</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;types&quot;</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">)</span>

    <span class="s2">assert </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">FloatCol</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">floating</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">IntCol</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">integer</span><span class="s3">)</span>

    <span class="s6"># MySQL has no real BOOL type (it's an alias for TINYINT)</span>
    <span class="s2">assert </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">BoolCol</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">integer</span><span class="s3">)</span>

    <span class="s6"># Int column with NA values stays as float</span>
    <span class="s2">assert </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">IntColWithNull</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">floating</span><span class="s3">)</span>

    <span class="s6"># Bool column with NA = int column with NA values =&gt; becomes float</span>
    <span class="s2">assert </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">BoolColWithNull</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">floating</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">db</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;conn&quot;</span><span class="s3">, </span><span class="s1">mysql_connectable</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_read_procedure</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">request</span><span class="s3">):</span>
    <span class="s1">conn </span><span class="s3">= </span><span class="s1">request</span><span class="s3">.</span><span class="s1">getfixturevalue</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">)</span>

    <span class="s6"># GH 7324</span>
    <span class="s6"># Although it is more an api test, it is added to the</span>
    <span class="s6"># mysql tests as sqlite does not have stored procedures</span>
    <span class="s2">from </span><span class="s1">sqlalchemy </span><span class="s2">import </span><span class="s1">text</span>
    <span class="s2">from </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">engine </span><span class="s2">import </span><span class="s1">Engine</span>

    <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;a&quot;</span><span class="s3">: [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], </span><span class="s4">&quot;b&quot;</span><span class="s3">: [</span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">0.2</span><span class="s3">, </span><span class="s5">0.3</span><span class="s3">]})</span>
    <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_frame&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s1">proc </span><span class="s3">= </span><span class="s4">&quot;&quot;&quot;DROP PROCEDURE IF EXISTS get_testdb; 
 
    CREATE PROCEDURE get_testdb () 
 
    BEGIN 
        SELECT * FROM test_frame; 
    END&quot;&quot;&quot;</span>
    <span class="s1">proc </span><span class="s3">= </span><span class="s1">text</span><span class="s3">(</span><span class="s1">proc</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">Engine</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">() </span><span class="s2">as </span><span class="s1">engine_conn</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">engine_conn</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">():</span>
                <span class="s1">engine_conn</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">proc</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">with </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">():</span>
            <span class="s1">conn</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">proc</span><span class="s3">)</span>

    <span class="s1">res1 </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;CALL get_testdb();&quot;</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">)</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">res1</span><span class="s3">)</span>

    <span class="s6"># test delegation to read_sql_query</span>
    <span class="s1">res2 </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql</span><span class="s3">(</span><span class="s4">&quot;CALL get_testdb();&quot;</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">)</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">res2</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">db</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;conn&quot;</span><span class="s3">, </span><span class="s1">postgresql_connectable</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;expected_count&quot;</span><span class="s3">, [</span><span class="s5">2</span><span class="s3">, </span><span class="s4">&quot;Success!&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_copy_from_callable_insertion_method</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">expected_count</span><span class="s3">, </span><span class="s1">request</span><span class="s3">):</span>
    <span class="s6"># GH 8953</span>
    <span class="s6"># Example in io.rst found under _io.sql.method</span>
    <span class="s6"># not available in sqlite, mysql</span>
    <span class="s2">def </span><span class="s1">psql_insert_copy</span><span class="s3">(</span><span class="s1">table</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">, </span><span class="s1">keys</span><span class="s3">, </span><span class="s1">data_iter</span><span class="s3">):</span>
        <span class="s6"># gets a DBAPI connection that can provide a cursor</span>
        <span class="s1">dbapi_conn </span><span class="s3">= </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">connection</span>
        <span class="s2">with </span><span class="s1">dbapi_conn</span><span class="s3">.</span><span class="s1">cursor</span><span class="s3">() </span><span class="s2">as </span><span class="s1">cur</span><span class="s3">:</span>
            <span class="s1">s_buf </span><span class="s3">= </span><span class="s1">StringIO</span><span class="s3">()</span>
            <span class="s1">writer </span><span class="s3">= </span><span class="s1">csv</span><span class="s3">.</span><span class="s1">writer</span><span class="s3">(</span><span class="s1">s_buf</span><span class="s3">)</span>
            <span class="s1">writer</span><span class="s3">.</span><span class="s1">writerows</span><span class="s3">(</span><span class="s1">data_iter</span><span class="s3">)</span>
            <span class="s1">s_buf</span><span class="s3">.</span><span class="s1">seek</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>

            <span class="s1">columns </span><span class="s3">= </span><span class="s4">&quot;, &quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">([</span><span class="s4">f'&quot;</span><span class="s2">{</span><span class="s1">k</span><span class="s2">}</span><span class="s4">&quot;' </span><span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">keys</span><span class="s3">])</span>
            <span class="s2">if </span><span class="s1">table</span><span class="s3">.</span><span class="s1">schema</span><span class="s3">:</span>
                <span class="s1">table_name </span><span class="s3">= </span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">table</span><span class="s3">.</span><span class="s1">schema</span><span class="s2">}</span><span class="s4">.</span><span class="s2">{</span><span class="s1">table</span><span class="s3">.</span><span class="s1">name</span><span class="s2">}</span><span class="s4">&quot;</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">table_name </span><span class="s3">= </span><span class="s1">table</span><span class="s3">.</span><span class="s1">name</span>

            <span class="s1">sql_query </span><span class="s3">= </span><span class="s4">f&quot;COPY </span><span class="s2">{</span><span class="s1">table_name</span><span class="s2">} </span><span class="s4">(</span><span class="s2">{</span><span class="s1">columns</span><span class="s2">}</span><span class="s4">) FROM STDIN WITH CSV&quot;</span>
            <span class="s1">cur</span><span class="s3">.</span><span class="s1">copy_expert</span><span class="s3">(</span><span class="s1">sql</span><span class="s3">=</span><span class="s1">sql_query</span><span class="s3">, </span><span class="s1">file</span><span class="s3">=</span><span class="s1">s_buf</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">expected_count</span>

    <span class="s1">conn </span><span class="s3">= </span><span class="s1">request</span><span class="s3">.</span><span class="s1">getfixturevalue</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">)</span>
    <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;col1&quot;</span><span class="s3">: [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], </span><span class="s4">&quot;col2&quot;</span><span class="s3">: [</span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">0.2</span><span class="s3">], </span><span class="s4">&quot;col3&quot;</span><span class="s3">: [</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s4">&quot;n&quot;</span><span class="s3">]})</span>
    <span class="s1">result_count </span><span class="s3">= </span><span class="s1">expected</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span>
        <span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_frame&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">psql_insert_copy</span>
    <span class="s3">)</span>
    <span class="s6"># GH 46891</span>
    <span class="s2">if </span><span class="s1">expected_count </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">result_count </span><span class="s2">is None</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">result_count </span><span class="s3">== </span><span class="s1">expected_count</span>
    <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;test_frame&quot;</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">)</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">db</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;conn&quot;</span><span class="s3">, </span><span class="s1">postgresql_connectable</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_insertion_method_on_conflict_do_nothing</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">request</span><span class="s3">):</span>
    <span class="s6"># GH 15988: Example in to_sql docstring</span>
    <span class="s1">conn </span><span class="s3">= </span><span class="s1">request</span><span class="s3">.</span><span class="s1">getfixturevalue</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">)</span>

    <span class="s2">from </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">dialects</span><span class="s3">.</span><span class="s1">postgresql </span><span class="s2">import </span><span class="s1">insert</span>
    <span class="s2">from </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">engine </span><span class="s2">import </span><span class="s1">Engine</span>
    <span class="s2">from </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">sql </span><span class="s2">import </span><span class="s1">text</span>

    <span class="s2">def </span><span class="s1">insert_on_conflict</span><span class="s3">(</span><span class="s1">table</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">, </span><span class="s1">keys</span><span class="s3">, </span><span class="s1">data_iter</span><span class="s3">):</span>
        <span class="s1">data </span><span class="s3">= [</span><span class="s1">dict</span><span class="s3">(</span><span class="s1">zip</span><span class="s3">(</span><span class="s1">keys</span><span class="s3">, </span><span class="s1">row</span><span class="s3">)) </span><span class="s2">for </span><span class="s1">row </span><span class="s2">in </span><span class="s1">data_iter</span><span class="s3">]</span>
        <span class="s1">stmt </span><span class="s3">= (</span>
            <span class="s1">insert</span><span class="s3">(</span><span class="s1">table</span><span class="s3">.</span><span class="s1">table</span><span class="s3">)</span>
            <span class="s3">.</span><span class="s1">values</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>
            <span class="s3">.</span><span class="s1">on_conflict_do_nothing</span><span class="s3">(</span><span class="s1">index_elements</span><span class="s3">=[</span><span class="s4">&quot;a&quot;</span><span class="s3">])</span>
        <span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">stmt</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">result</span><span class="s3">.</span><span class="s1">rowcount</span>

    <span class="s1">create_sql </span><span class="s3">= </span><span class="s1">text</span><span class="s3">(</span>
        <span class="s4">&quot;&quot;&quot; 
    CREATE TABLE test_insert_conflict ( 
        a  integer PRIMARY KEY, 
        b  numeric, 
        c  text 
    ); 
    &quot;&quot;&quot;</span>
    <span class="s3">)</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">Engine</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">() </span><span class="s2">as </span><span class="s1">con</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">con</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">():</span>
                <span class="s1">con</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">create_sql</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">with </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">():</span>
            <span class="s1">conn</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">create_sql</span><span class="s3">)</span>

    <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2.1</span><span class="s3">, </span><span class="s4">&quot;a&quot;</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">list</span><span class="s3">(</span><span class="s4">&quot;abc&quot;</span><span class="s3">))</span>
    <span class="s1">expected</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span>
        <span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_insert_conflict&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;append&quot;</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span>
    <span class="s3">)</span>

    <span class="s1">df_insert </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3.2</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">list</span><span class="s3">(</span><span class="s4">&quot;abc&quot;</span><span class="s3">))</span>
    <span class="s1">inserted </span><span class="s3">= </span><span class="s1">df_insert</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span>
        <span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_insert_conflict&quot;</span><span class="s3">,</span>
        <span class="s1">con</span><span class="s3">=</span><span class="s1">conn</span><span class="s3">,</span>
        <span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;append&quot;</span><span class="s3">,</span>
        <span class="s1">method</span><span class="s3">=</span><span class="s1">insert_on_conflict</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;test_insert_conflict&quot;</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">)</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">inserted </span><span class="s3">== </span><span class="s5">0</span>

    <span class="s6"># Cleanup</span>
    <span class="s2">with </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">SQLDatabase</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">need_transaction</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) </span><span class="s2">as </span><span class="s1">pandasSQL</span><span class="s3">:</span>
        <span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">drop_table</span><span class="s3">(</span><span class="s4">&quot;test_insert_conflict&quot;</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">db</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;conn&quot;</span><span class="s3">, </span><span class="s1">mysql_connectable</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_insertion_method_on_conflict_update</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">request</span><span class="s3">):</span>
    <span class="s6"># GH 14553: Example in to_sql docstring</span>
    <span class="s1">conn </span><span class="s3">= </span><span class="s1">request</span><span class="s3">.</span><span class="s1">getfixturevalue</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">)</span>

    <span class="s2">from </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">dialects</span><span class="s3">.</span><span class="s1">mysql </span><span class="s2">import </span><span class="s1">insert</span>
    <span class="s2">from </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">engine </span><span class="s2">import </span><span class="s1">Engine</span>
    <span class="s2">from </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">sql </span><span class="s2">import </span><span class="s1">text</span>

    <span class="s2">def </span><span class="s1">insert_on_conflict</span><span class="s3">(</span><span class="s1">table</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">, </span><span class="s1">keys</span><span class="s3">, </span><span class="s1">data_iter</span><span class="s3">):</span>
        <span class="s1">data </span><span class="s3">= [</span><span class="s1">dict</span><span class="s3">(</span><span class="s1">zip</span><span class="s3">(</span><span class="s1">keys</span><span class="s3">, </span><span class="s1">row</span><span class="s3">)) </span><span class="s2">for </span><span class="s1">row </span><span class="s2">in </span><span class="s1">data_iter</span><span class="s3">]</span>
        <span class="s1">stmt </span><span class="s3">= </span><span class="s1">insert</span><span class="s3">(</span><span class="s1">table</span><span class="s3">.</span><span class="s1">table</span><span class="s3">).</span><span class="s1">values</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>
        <span class="s1">stmt </span><span class="s3">= </span><span class="s1">stmt</span><span class="s3">.</span><span class="s1">on_duplicate_key_update</span><span class="s3">(</span><span class="s1">b</span><span class="s3">=</span><span class="s1">stmt</span><span class="s3">.</span><span class="s1">inserted</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">c</span><span class="s3">=</span><span class="s1">stmt</span><span class="s3">.</span><span class="s1">inserted</span><span class="s3">.</span><span class="s1">c</span><span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">stmt</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">result</span><span class="s3">.</span><span class="s1">rowcount</span>

    <span class="s1">create_sql </span><span class="s3">= </span><span class="s1">text</span><span class="s3">(</span>
        <span class="s4">&quot;&quot;&quot; 
    CREATE TABLE test_insert_conflict ( 
        a INT PRIMARY KEY, 
        b FLOAT, 
        c VARCHAR(10) 
    ); 
    &quot;&quot;&quot;</span>
    <span class="s3">)</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">Engine</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">() </span><span class="s2">as </span><span class="s1">con</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">con</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">():</span>
                <span class="s1">con</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">create_sql</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">with </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">():</span>
            <span class="s1">conn</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">create_sql</span><span class="s3">)</span>

    <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2.1</span><span class="s3">, </span><span class="s4">&quot;a&quot;</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">list</span><span class="s3">(</span><span class="s4">&quot;abc&quot;</span><span class="s3">))</span>
    <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_insert_conflict&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;append&quot;</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3.2</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">list</span><span class="s3">(</span><span class="s4">&quot;abc&quot;</span><span class="s3">))</span>
    <span class="s1">inserted </span><span class="s3">= </span><span class="s1">expected</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span>
        <span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_insert_conflict&quot;</span><span class="s3">,</span>
        <span class="s1">con</span><span class="s3">=</span><span class="s1">conn</span><span class="s3">,</span>
        <span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;append&quot;</span><span class="s3">,</span>
        <span class="s1">method</span><span class="s3">=</span><span class="s1">insert_on_conflict</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;test_insert_conflict&quot;</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">)</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">inserted </span><span class="s3">== </span><span class="s5">2</span>

    <span class="s6"># Cleanup</span>
    <span class="s2">with </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">SQLDatabase</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">need_transaction</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) </span><span class="s2">as </span><span class="s1">pandasSQL</span><span class="s3">:</span>
        <span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">drop_table</span><span class="s3">(</span><span class="s4">&quot;test_insert_conflict&quot;</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">db</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;conn&quot;</span><span class="s3">, </span><span class="s1">postgresql_connectable</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_read_view_postgres</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">request</span><span class="s3">):</span>
    <span class="s6"># GH 52969</span>
    <span class="s1">conn </span><span class="s3">= </span><span class="s1">request</span><span class="s3">.</span><span class="s1">getfixturevalue</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">)</span>

    <span class="s2">from </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">engine </span><span class="s2">import </span><span class="s1">Engine</span>
    <span class="s2">from </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">sql </span><span class="s2">import </span><span class="s1">text</span>

    <span class="s1">table_name </span><span class="s3">= </span><span class="s4">f&quot;group_</span><span class="s2">{</span><span class="s1">uuid</span><span class="s3">.</span><span class="s1">uuid4</span><span class="s3">().</span><span class="s1">hex</span><span class="s2">}</span><span class="s4">&quot;</span>
    <span class="s1">view_name </span><span class="s3">= </span><span class="s4">f&quot;group_view_</span><span class="s2">{</span><span class="s1">uuid</span><span class="s3">.</span><span class="s1">uuid4</span><span class="s3">().</span><span class="s1">hex</span><span class="s2">}</span><span class="s4">&quot;</span>

    <span class="s1">sql_stmt </span><span class="s3">= </span><span class="s1">text</span><span class="s3">(</span>
        <span class="s4">f&quot;&quot;&quot;</span>
    <span class="s4">CREATE TABLE </span><span class="s2">{</span><span class="s1">table_name</span><span class="s2">} </span><span class="s4">(</span>
        <span class="s4">group_id INTEGER,</span>
        <span class="s4">name TEXT</span>
    <span class="s4">);</span>
    <span class="s4">INSERT INTO </span><span class="s2">{</span><span class="s1">table_name</span><span class="s2">} </span><span class="s4">VALUES</span>
        <span class="s4">(1, 'name');</span>
    <span class="s4">CREATE VIEW </span><span class="s2">{</span><span class="s1">view_name</span><span class="s2">}</span>
    <span class="s4">AS</span>
    <span class="s4">SELECT * FROM </span><span class="s2">{</span><span class="s1">table_name</span><span class="s2">}</span><span class="s4">;</span>
    <span class="s4">&quot;&quot;&quot;</span>
    <span class="s3">)</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">Engine</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">() </span><span class="s2">as </span><span class="s1">con</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">con</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">():</span>
                <span class="s1">con</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">sql_stmt</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">with </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">():</span>
            <span class="s1">conn</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">sql_stmt</span><span class="s3">)</span>
    <span class="s1">result </span><span class="s3">= </span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s1">view_name</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">)</span>
    <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;group_id&quot;</span><span class="s3">: [</span><span class="s5">1</span><span class="s3">], </span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;name&quot;</span><span class="s3">})</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_read_view_sqlite</span><span class="s3">(</span><span class="s1">sqlite_buildin</span><span class="s3">):</span>
    <span class="s6"># GH 52969</span>
    <span class="s1">create_table </span><span class="s3">= </span><span class="s4">&quot;&quot;&quot; 
CREATE TABLE groups ( 
   group_id INTEGER, 
   name TEXT 
); 
&quot;&quot;&quot;</span>
    <span class="s1">insert_into </span><span class="s3">= </span><span class="s4">&quot;&quot;&quot; 
INSERT INTO groups VALUES 
    (1, 'name'); 
&quot;&quot;&quot;</span>
    <span class="s1">create_view </span><span class="s3">= </span><span class="s4">&quot;&quot;&quot; 
CREATE VIEW group_view 
AS 
SELECT * FROM groups; 
&quot;&quot;&quot;</span>
    <span class="s1">sqlite_buildin</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">create_table</span><span class="s3">)</span>
    <span class="s1">sqlite_buildin</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">insert_into</span><span class="s3">)</span>
    <span class="s1">sqlite_buildin</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">create_view</span><span class="s3">)</span>
    <span class="s1">result </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">read_sql</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM group_view&quot;</span><span class="s3">, </span><span class="s1">sqlite_buildin</span><span class="s3">)</span>
    <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;group_id&quot;</span><span class="s3">: [</span><span class="s5">1</span><span class="s3">], </span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;name&quot;</span><span class="s3">})</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_execute_typeerror</span><span class="s3">(</span><span class="s1">sqlite_iris_engine</span><span class="s3">):</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;pandas.io.sql.execute requires a connection&quot;</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span>
            <span class="s1">FutureWarning</span><span class="s3">,</span>
            <span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;`pandas.io.sql.execute` is deprecated and &quot;</span>
            <span class="s4">&quot;will be removed in the future version.&quot;</span><span class="s3">,</span>
        <span class="s3">):</span>
            <span class="s1">sql</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s4">&quot;select * from iris&quot;</span><span class="s3">, </span><span class="s1">sqlite_iris_engine</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_execute_deprecated</span><span class="s3">(</span><span class="s1">sqlite_buildin_iris</span><span class="s3">):</span>
    <span class="s6"># GH50185</span>
    <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span>
        <span class="s1">FutureWarning</span><span class="s3">,</span>
        <span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;`pandas.io.sql.execute` is deprecated and &quot;</span>
        <span class="s4">&quot;will be removed in the future version.&quot;</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s1">sql</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s4">&quot;select * from iris&quot;</span><span class="s3">, </span><span class="s1">sqlite_buildin_iris</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">MixInBase</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">teardown_method</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># if setup fails, there may not be a connection to close.</span>
        <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s4">&quot;conn&quot;</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
        <span class="s6"># use a fresh connection to ensure we can drop all tables.</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">conn </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">()</span>
        <span class="s2">except </span><span class="s3">(</span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">exc</span><span class="s3">.</span><span class="s1">OperationalError</span><span class="s3">, </span><span class="s1">sqlite3</span><span class="s3">.</span><span class="s1">OperationalError</span><span class="s3">):</span>
            <span class="s2">pass</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">conn</span><span class="s3">:</span>
                <span class="s2">for </span><span class="s1">view </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_all_views</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">):</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">drop_view</span><span class="s3">(</span><span class="s1">view</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">)</span>
                <span class="s2">for </span><span class="s1">tbl </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_all_tables</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">):</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">drop_table</span><span class="s3">(</span><span class="s1">tbl</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">SQLiteMixIn</span><span class="s3">(</span><span class="s1">MixInBase</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">connect</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">sqlite3</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">(</span><span class="s4">&quot;:memory:&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">drop_table</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">table_name</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">):</span>
        <span class="s1">conn</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s4">f&quot;DROP TABLE IF EXISTS </span><span class="s2">{</span><span class="s1">sql</span><span class="s3">.</span><span class="s1">_get_valid_sqlite_name</span><span class="s3">(</span><span class="s1">table_name</span><span class="s3">)</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s1">conn</span><span class="s3">.</span><span class="s1">commit</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">_get_all_tables</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">):</span>
        <span class="s1">c </span><span class="s3">= </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s4">&quot;SELECT name FROM sqlite_master WHERE type='table'&quot;</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s3">[</span><span class="s1">table</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] </span><span class="s2">for </span><span class="s1">table </span><span class="s2">in </span><span class="s1">c</span><span class="s3">.</span><span class="s1">fetchall</span><span class="s3">()]</span>

    <span class="s2">def </span><span class="s1">drop_view</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">view_name</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">):</span>
        <span class="s1">conn</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s4">f&quot;DROP VIEW IF EXISTS </span><span class="s2">{</span><span class="s1">sql</span><span class="s3">.</span><span class="s1">_get_valid_sqlite_name</span><span class="s3">(</span><span class="s1">view_name</span><span class="s3">)</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s1">conn</span><span class="s3">.</span><span class="s1">commit</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">_get_all_views</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">):</span>
        <span class="s1">c </span><span class="s3">= </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s4">&quot;SELECT name FROM sqlite_master WHERE type='view'&quot;</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s3">[</span><span class="s1">view</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] </span><span class="s2">for </span><span class="s1">view </span><span class="s2">in </span><span class="s1">c</span><span class="s3">.</span><span class="s1">fetchall</span><span class="s3">()]</span>


<span class="s2">class </span><span class="s1">SQLAlchemyMixIn</span><span class="s3">(</span><span class="s1">MixInBase</span><span class="s3">):</span>
    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">teardown_class</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">):</span>
        <span class="s1">cls</span><span class="s3">.</span><span class="s1">engine</span><span class="s3">.</span><span class="s1">dispose</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">connect</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">engine</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">drop_table</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">table_name</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">in_transaction</span><span class="s3">():</span>
            <span class="s1">conn</span><span class="s3">.</span><span class="s1">get_transaction</span><span class="s3">().</span><span class="s1">rollback</span><span class="s3">()</span>
        <span class="s2">with </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">():</span>
            <span class="s1">sql</span><span class="s3">.</span><span class="s1">SQLDatabase</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">).</span><span class="s1">drop_table</span><span class="s3">(</span><span class="s1">table_name</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_get_all_tables</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">):</span>
        <span class="s2">from </span><span class="s1">sqlalchemy </span><span class="s2">import </span><span class="s1">inspect</span>

        <span class="s2">return </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">).</span><span class="s1">get_table_names</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">drop_view</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">view_name</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">):</span>
        <span class="s1">quoted_view </span><span class="s3">= </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">engine</span><span class="s3">.</span><span class="s1">dialect</span><span class="s3">.</span><span class="s1">identifier_preparer</span><span class="s3">.</span><span class="s1">quote_identifier</span><span class="s3">(</span>
            <span class="s1">view_name</span>
        <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">in_transaction</span><span class="s3">():</span>
            <span class="s1">conn</span><span class="s3">.</span><span class="s1">get_transaction</span><span class="s3">().</span><span class="s1">rollback</span><span class="s3">()</span>
        <span class="s2">with </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">():</span>
            <span class="s1">conn</span><span class="s3">.</span><span class="s1">exec_driver_sql</span><span class="s3">(</span><span class="s4">f&quot;DROP VIEW IF EXISTS </span><span class="s2">{</span><span class="s1">quoted_view</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_get_all_views</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">):</span>
        <span class="s2">from </span><span class="s1">sqlalchemy </span><span class="s2">import </span><span class="s1">inspect</span>

        <span class="s2">return </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">).</span><span class="s1">get_view_names</span><span class="s3">()</span>


<span class="s2">class </span><span class="s1">PandasSQLTest</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot; 
    Base class with common private methods for SQLAlchemy and fallback cases. 
 
    &quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">load_iris_data</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">iris_path</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">drop_table</span><span class="s3">(</span><span class="s4">&quot;iris&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">sqlite3</span><span class="s3">.</span><span class="s1">Connection</span><span class="s3">):</span>
            <span class="s1">create_and_load_iris_sqlite3</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">iris_path</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">create_and_load_iris</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">iris_path</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">flavor</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">load_types_data</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">types_data</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">flavor </span><span class="s3">!= </span><span class="s4">&quot;postgresql&quot;</span><span class="s3">:</span>
            <span class="s2">for </span><span class="s1">entry </span><span class="s2">in </span><span class="s1">types_data</span><span class="s3">:</span>
                <span class="s1">entry</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s4">&quot;DateColWithTz&quot;</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">sqlite3</span><span class="s3">.</span><span class="s1">Connection</span><span class="s3">):</span>
            <span class="s1">types_data </span><span class="s3">= [</span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">entry</span><span class="s3">.</span><span class="s1">values</span><span class="s3">()) </span><span class="s2">for </span><span class="s1">entry </span><span class="s2">in </span><span class="s1">types_data</span><span class="s3">]</span>
            <span class="s1">create_and_load_types_sqlite3</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">types_data</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">create_and_load_types</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">types_data</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">flavor</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_read_sql_iris_parameter</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">sql_strings</span><span class="s3">):</span>
        <span class="s1">query </span><span class="s3">= </span><span class="s1">sql_strings</span><span class="s3">[</span><span class="s4">&quot;read_parameters&quot;</span><span class="s3">][</span><span class="s1">self</span><span class="s3">.</span><span class="s1">flavor</span><span class="s3">]</span>
        <span class="s1">params </span><span class="s3">= (</span><span class="s4">&quot;Iris-setosa&quot;</span><span class="s3">, </span><span class="s5">5.1</span><span class="s3">)</span>
        <span class="s1">iris_frame </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">read_query</span><span class="s3">(</span><span class="s1">query</span><span class="s3">, </span><span class="s1">params</span><span class="s3">=</span><span class="s1">params</span><span class="s3">)</span>
        <span class="s1">check_iris_frame</span><span class="s3">(</span><span class="s1">iris_frame</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_read_sql_iris_named_parameter</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">sql_strings</span><span class="s3">):</span>
        <span class="s1">query </span><span class="s3">= </span><span class="s1">sql_strings</span><span class="s3">[</span><span class="s4">&quot;read_named_parameters&quot;</span><span class="s3">][</span><span class="s1">self</span><span class="s3">.</span><span class="s1">flavor</span><span class="s3">]</span>
        <span class="s1">params </span><span class="s3">= {</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;Iris-setosa&quot;</span><span class="s3">, </span><span class="s4">&quot;length&quot;</span><span class="s3">: </span><span class="s5">5.1</span><span class="s3">}</span>
        <span class="s1">iris_frame </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">read_query</span><span class="s3">(</span><span class="s1">query</span><span class="s3">, </span><span class="s1">params</span><span class="s3">=</span><span class="s1">params</span><span class="s3">)</span>
        <span class="s1">check_iris_frame</span><span class="s3">(</span><span class="s1">iris_frame</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_read_sql_iris_no_parameter_with_percent</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">sql_strings</span><span class="s3">):</span>
        <span class="s1">query </span><span class="s3">= </span><span class="s1">sql_strings</span><span class="s3">[</span><span class="s4">&quot;read_no_parameters_with_percent&quot;</span><span class="s3">][</span><span class="s1">self</span><span class="s3">.</span><span class="s1">flavor</span><span class="s3">]</span>
        <span class="s1">iris_frame </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">read_query</span><span class="s3">(</span><span class="s1">query</span><span class="s3">, </span><span class="s1">params</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">check_iris_frame</span><span class="s3">(</span><span class="s1">iris_frame</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_to_sql_empty</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">drop_table</span><span class="s3">(</span><span class="s4">&quot;test_frame1&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">.</span><span class="s1">iloc</span><span class="s3">[:</span><span class="s5">0</span><span class="s3">], </span><span class="s4">&quot;test_frame1&quot;</span><span class="s3">) == </span><span class="s5">0</span>

    <span class="s2">def </span><span class="s1">_to_sql_with_sql_engine</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">=</span><span class="s4">&quot;auto&quot;</span><span class="s3">, **</span><span class="s1">engine_kwargs</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;`to_sql` with the `engine` param&quot;&quot;&quot;</span>
        <span class="s6"># mostly copied from this class's `_to_sql()` method</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">drop_table</span><span class="s3">(</span><span class="s4">&quot;test_frame1&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

        <span class="s2">assert </span><span class="s3">(</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span>
                <span class="s1">test_frame1</span><span class="s3">, </span><span class="s4">&quot;test_frame1&quot;</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">=</span><span class="s1">engine</span><span class="s3">, **</span><span class="s1">engine_kwargs</span>
            <span class="s3">)</span>
            <span class="s3">== </span><span class="s5">4</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span><span class="s4">&quot;test_frame1&quot;</span><span class="s3">)</span>

        <span class="s1">num_entries </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">)</span>
        <span class="s1">num_rows </span><span class="s3">= </span><span class="s1">count_rows</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s4">&quot;test_frame1&quot;</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">num_rows </span><span class="s3">== </span><span class="s1">num_entries</span>

        <span class="s6"># Nuke table</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">drop_table</span><span class="s3">(</span><span class="s4">&quot;test_frame1&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_roundtrip</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">drop_table</span><span class="s3">(</span><span class="s4">&quot;test_frame_roundtrip&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">, </span><span class="s4">&quot;test_frame_roundtrip&quot;</span><span class="s3">) == </span><span class="s5">4</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">read_query</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM test_frame_roundtrip&quot;</span><span class="s3">)</span>

        <span class="s1">result</span><span class="s3">.</span><span class="s1">set_index</span><span class="s3">(</span><span class="s4">&quot;level_0&quot;</span><span class="s3">, </span><span class="s1">inplace</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s6"># result.index.astype(int)</span>

        <span class="s1">result</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">name </span><span class="s3">= </span><span class="s2">None</span>

        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_execute_sql</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># drop_sql = &quot;DROP TABLE IF EXISTS test&quot;  # should already be done</span>
        <span class="s1">iris_results </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM iris&quot;</span><span class="s3">)</span>
        <span class="s1">row </span><span class="s3">= </span><span class="s1">iris_results</span><span class="s3">.</span><span class="s1">fetchone</span><span class="s3">()</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">equalContents</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, [</span><span class="s5">5.1</span><span class="s3">, </span><span class="s5">3.5</span><span class="s3">, </span><span class="s5">1.4</span><span class="s3">, </span><span class="s5">0.2</span><span class="s3">, </span><span class="s4">&quot;Iris-setosa&quot;</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">_to_sql_save_index</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">.</span><span class="s1">from_records</span><span class="s3">(</span>
            <span class="s3">[(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2.1</span><span class="s3">, </span><span class="s4">&quot;line1&quot;</span><span class="s3">), (</span><span class="s5">2</span><span class="s3">, </span><span class="s5">1.5</span><span class="s3">, </span><span class="s4">&quot;line2&quot;</span><span class="s3">)], </span><span class="s1">columns</span><span class="s3">=[</span><span class="s4">&quot;A&quot;</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">, </span><span class="s4">&quot;C&quot;</span><span class="s3">], </span><span class="s1">index</span><span class="s3">=[</span><span class="s4">&quot;A&quot;</span><span class="s3">]</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s4">&quot;test_to_sql_saves_index&quot;</span><span class="s3">) == </span><span class="s5">2</span>
        <span class="s1">ix_cols </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_index_columns</span><span class="s3">(</span><span class="s4">&quot;test_to_sql_saves_index&quot;</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">ix_cols </span><span class="s3">== [[</span><span class="s4">&quot;A&quot;</span><span class="s3">]]</span>

    <span class="s2">def </span><span class="s1">_transaction_test</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">run_transaction</span><span class="s3">() </span><span class="s2">as </span><span class="s1">trans</span><span class="s3">:</span>
            <span class="s1">stmt </span><span class="s3">= </span><span class="s4">&quot;CREATE TABLE test_trans (A INT, B TEXT)&quot;</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">pandasSQL</span><span class="s3">, </span><span class="s1">SQLiteDatabase</span><span class="s3">):</span>
                <span class="s1">trans</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">stmt</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">from </span><span class="s1">sqlalchemy </span><span class="s2">import </span><span class="s1">text</span>

                <span class="s1">stmt </span><span class="s3">= </span><span class="s1">text</span><span class="s3">(</span><span class="s1">stmt</span><span class="s3">)</span>
                <span class="s1">trans</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">stmt</span><span class="s3">)</span>

        <span class="s2">class </span><span class="s1">DummyException</span><span class="s3">(</span><span class="s1">Exception</span><span class="s3">):</span>
            <span class="s2">pass</span>

        <span class="s6"># Make sure when transaction is rolled back, no rows get inserted</span>
        <span class="s1">ins_sql </span><span class="s3">= </span><span class="s4">&quot;INSERT INTO test_trans (A,B) VALUES (1, 'blah')&quot;</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">pandasSQL</span><span class="s3">, </span><span class="s1">SQLDatabase</span><span class="s3">):</span>
            <span class="s2">from </span><span class="s1">sqlalchemy </span><span class="s2">import </span><span class="s1">text</span>

            <span class="s1">ins_sql </span><span class="s3">= </span><span class="s1">text</span><span class="s3">(</span><span class="s1">ins_sql</span><span class="s3">)</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">run_transaction</span><span class="s3">() </span><span class="s2">as </span><span class="s1">trans</span><span class="s3">:</span>
                <span class="s1">trans</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">ins_sql</span><span class="s3">)</span>
                <span class="s2">raise </span><span class="s1">DummyException</span><span class="s3">(</span><span class="s4">&quot;error&quot;</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">DummyException</span><span class="s3">:</span>
            <span class="s6"># ignore raised exception</span>
            <span class="s2">pass</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">read_query</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM test_trans&quot;</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">res</span><span class="s3">) == </span><span class="s5">0</span>

        <span class="s6"># Make sure when transaction is committed, rows do get inserted</span>
        <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">run_transaction</span><span class="s3">() </span><span class="s2">as </span><span class="s1">trans</span><span class="s3">:</span>
            <span class="s1">trans</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">ins_sql</span><span class="s3">)</span>
        <span class="s1">res2 </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">read_query</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM test_trans&quot;</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">res2</span><span class="s3">) == </span><span class="s5">1</span>


<span class="s6"># -----------------------------------------------------------------------------</span>
<span class="s6"># -- Testing the public API</span>


<span class="s2">class </span><span class="s1">_TestSQLApi</span><span class="s3">(</span><span class="s1">PandasSQLTest</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Base class to test the public API. 
 
    From this two classes are derived to run these tests for both the 
    sqlalchemy mode (`TestSQLApi`) and the fallback mode 
    (`TestSQLiteFallbackApi`).  These tests are run with sqlite3. Specific 
    tests for the different sql flavours are included in `_TestSQLAlchemy`. 
 
    Notes: 
    flavor can always be passed even in SQLAlchemy mode, 
    should be correctly ignored. 
 
    we don't use drop_table because that isn't part of the public api 
 
    &quot;&quot;&quot;</span>

    <span class="s1">flavor </span><span class="s3">= </span><span class="s4">&quot;sqlite&quot;</span>
    <span class="s1">mode</span><span class="s3">: </span><span class="s1">str</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span><span class="s3">(</span><span class="s1">autouse</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">setup_method</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">iris_path</span><span class="s3">, </span><span class="s1">types_data</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">conn </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">load_iris_data</span><span class="s3">(</span><span class="s1">iris_path</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">load_types_data</span><span class="s3">(</span><span class="s1">types_data</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">load_test_data_and_sql</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">load_test_data_and_sql</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">create_and_load_iris_view</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_read_sql_view</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">iris_frame </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM iris_view&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">check_iris_frame</span><span class="s3">(</span><span class="s1">iris_frame</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_read_sql_with_chunksize_no_result</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">query </span><span class="s3">= </span><span class="s4">&quot;SELECT * FROM iris_view WHERE SepalLength &lt; 0.0&quot;</span>
        <span class="s1">with_batch </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s1">query</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">chunksize</span><span class="s3">=</span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">without_batch </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s1">query</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">concat</span><span class="s3">(</span><span class="s1">with_batch</span><span class="s3">), </span><span class="s1">without_batch</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_to_sql</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">):</span>
        <span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">, </span><span class="s4">&quot;test_frame1&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span><span class="s4">&quot;test_frame1&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_to_sql_fail</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">):</span>
        <span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">, </span><span class="s4">&quot;test_frame2&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;fail&quot;</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span><span class="s4">&quot;test_frame2&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

        <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;Table 'test_frame2' already exists&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">, </span><span class="s4">&quot;test_frame2&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;fail&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_to_sql_replace</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">):</span>
        <span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">, </span><span class="s4">&quot;test_frame3&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;fail&quot;</span><span class="s3">)</span>
        <span class="s6"># Add to table again</span>
        <span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">, </span><span class="s4">&quot;test_frame3&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;replace&quot;</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span><span class="s4">&quot;test_frame3&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

        <span class="s1">num_entries </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">)</span>
        <span class="s1">num_rows </span><span class="s3">= </span><span class="s1">count_rows</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s4">&quot;test_frame3&quot;</span><span class="s3">)</span>

        <span class="s2">assert </span><span class="s1">num_rows </span><span class="s3">== </span><span class="s1">num_entries</span>

    <span class="s2">def </span><span class="s1">test_to_sql_append</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">, </span><span class="s4">&quot;test_frame4&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;fail&quot;</span><span class="s3">) == </span><span class="s5">4</span>

        <span class="s6"># Add to table again</span>
        <span class="s2">assert </span><span class="s3">(</span>
            <span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">, </span><span class="s4">&quot;test_frame4&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;append&quot;</span><span class="s3">) == </span><span class="s5">4</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span><span class="s4">&quot;test_frame4&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

        <span class="s1">num_entries </span><span class="s3">= </span><span class="s5">2 </span><span class="s3">* </span><span class="s1">len</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">)</span>
        <span class="s1">num_rows </span><span class="s3">= </span><span class="s1">count_rows</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s4">&quot;test_frame4&quot;</span><span class="s3">)</span>

        <span class="s2">assert </span><span class="s1">num_rows </span><span class="s3">== </span><span class="s1">num_entries</span>

    <span class="s2">def </span><span class="s1">test_to_sql_type_mapping</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_frame3</span><span class="s3">):</span>
        <span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">test_frame3</span><span class="s3">, </span><span class="s4">&quot;test_frame5&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM test_frame5&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">test_frame3</span><span class="s3">, </span><span class="s1">result</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_to_sql_series</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">Series</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">5</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;int64&quot;</span><span class="s3">), </span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;series&quot;</span><span class="s3">)</span>
        <span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s4">&quot;test_series&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
        <span class="s1">s2 </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM test_series&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">s</span><span class="s3">.</span><span class="s1">to_frame</span><span class="s3">(), </span><span class="s1">s2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_roundtrip</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">):</span>
        <span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">, </span><span class="s4">&quot;test_frame_roundtrip&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM test_frame_roundtrip&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

        <span class="s6"># HACK!</span>
        <span class="s1">result</span><span class="s3">.</span><span class="s1">index </span><span class="s3">= </span><span class="s1">test_frame1</span><span class="s3">.</span><span class="s1">index</span>
        <span class="s1">result</span><span class="s3">.</span><span class="s1">set_index</span><span class="s3">(</span><span class="s4">&quot;level_0&quot;</span><span class="s3">, </span><span class="s1">inplace</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">result</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">int</span><span class="s3">)</span>
        <span class="s1">result</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">name </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_roundtrip_chunksize</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">):</span>
        <span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span>
            <span class="s1">test_frame1</span><span class="s3">,</span>
            <span class="s4">&quot;test_frame_roundtrip&quot;</span><span class="s3">,</span>
            <span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">,</span>
            <span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s1">chunksize</span><span class="s3">=</span><span class="s5">2</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM test_frame_roundtrip&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_execute_sql</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># drop_sql = &quot;DROP TABLE IF EXISTS test&quot;  # should already be done</span>
        <span class="s2">with </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">pandasSQL_builder</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">) </span><span class="s2">as </span><span class="s1">pandas_sql</span><span class="s3">:</span>
            <span class="s1">iris_results </span><span class="s3">= </span><span class="s1">pandas_sql</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM iris&quot;</span><span class="s3">)</span>
        <span class="s1">row </span><span class="s3">= </span><span class="s1">iris_results</span><span class="s3">.</span><span class="s1">fetchone</span><span class="s3">()</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">equalContents</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, [</span><span class="s5">5.1</span><span class="s3">, </span><span class="s5">3.5</span><span class="s3">, </span><span class="s5">1.4</span><span class="s3">, </span><span class="s5">0.2</span><span class="s3">, </span><span class="s4">&quot;Iris-setosa&quot;</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_date_parsing</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Test date parsing in read_sql</span>
        <span class="s6"># No Parsing</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM types&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s2">assert not </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">DateCol</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">datetime64</span><span class="s3">)</span>

        <span class="s1">df </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span>
            <span class="s4">&quot;SELECT * FROM types&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">parse_dates</span><span class="s3">=[</span><span class="s4">&quot;DateCol&quot;</span><span class="s3">]</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">DateCol</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">datetime64</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">DateCol</span><span class="s3">.</span><span class="s1">tolist</span><span class="s3">() == [</span>
            <span class="s1">Timestamp</span><span class="s3">(</span><span class="s5">2000</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">),</span>
            <span class="s1">Timestamp</span><span class="s3">(</span><span class="s5">2000</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">),</span>
        <span class="s3">]</span>

        <span class="s1">df </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span>
            <span class="s4">&quot;SELECT * FROM types&quot;</span><span class="s3">,</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">,</span>
            <span class="s1">parse_dates</span><span class="s3">={</span><span class="s4">&quot;DateCol&quot;</span><span class="s3">: </span><span class="s4">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span class="s3">},</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">DateCol</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">datetime64</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">DateCol</span><span class="s3">.</span><span class="s1">tolist</span><span class="s3">() == [</span>
            <span class="s1">Timestamp</span><span class="s3">(</span><span class="s5">2000</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">),</span>
            <span class="s1">Timestamp</span><span class="s3">(</span><span class="s5">2000</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">),</span>
        <span class="s3">]</span>

        <span class="s1">df </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span>
            <span class="s4">&quot;SELECT * FROM types&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">parse_dates</span><span class="s3">=[</span><span class="s4">&quot;IntDateCol&quot;</span><span class="s3">]</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">IntDateCol</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">datetime64</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">IntDateCol</span><span class="s3">.</span><span class="s1">tolist</span><span class="s3">() == [</span>
            <span class="s1">Timestamp</span><span class="s3">(</span><span class="s5">1986</span><span class="s3">, </span><span class="s5">12</span><span class="s3">, </span><span class="s5">25</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">),</span>
            <span class="s1">Timestamp</span><span class="s3">(</span><span class="s5">2013</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">),</span>
        <span class="s3">]</span>

        <span class="s1">df </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span>
            <span class="s4">&quot;SELECT * FROM types&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">parse_dates</span><span class="s3">={</span><span class="s4">&quot;IntDateCol&quot;</span><span class="s3">: </span><span class="s4">&quot;s&quot;</span><span class="s3">}</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">IntDateCol</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">datetime64</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">IntDateCol</span><span class="s3">.</span><span class="s1">tolist</span><span class="s3">() == [</span>
            <span class="s1">Timestamp</span><span class="s3">(</span><span class="s5">1986</span><span class="s3">, </span><span class="s5">12</span><span class="s3">, </span><span class="s5">25</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">),</span>
            <span class="s1">Timestamp</span><span class="s3">(</span><span class="s5">2013</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">),</span>
        <span class="s3">]</span>

        <span class="s1">df </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span>
            <span class="s4">&quot;SELECT * FROM types&quot;</span><span class="s3">,</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">,</span>
            <span class="s1">parse_dates</span><span class="s3">={</span><span class="s4">&quot;IntDateOnlyCol&quot;</span><span class="s3">: </span><span class="s4">&quot;%Y%m%d&quot;</span><span class="s3">},</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">IntDateOnlyCol</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">datetime64</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">IntDateOnlyCol</span><span class="s3">.</span><span class="s1">tolist</span><span class="s3">() == [</span>
            <span class="s1">Timestamp</span><span class="s3">(</span><span class="s4">&quot;2010-10-10&quot;</span><span class="s3">),</span>
            <span class="s1">Timestamp</span><span class="s3">(</span><span class="s4">&quot;2010-12-12&quot;</span><span class="s3">),</span>
        <span class="s3">]</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;error&quot;</span><span class="s3">, [</span><span class="s4">&quot;ignore&quot;</span><span class="s3">, </span><span class="s4">&quot;raise&quot;</span><span class="s3">, </span><span class="s4">&quot;coerce&quot;</span><span class="s3">])</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
        <span class="s4">&quot;read_sql, text, mode&quot;</span><span class="s3">,</span>
        <span class="s3">[</span>
            <span class="s3">(</span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql</span><span class="s3">, </span><span class="s4">&quot;SELECT * FROM types&quot;</span><span class="s3">, (</span><span class="s4">&quot;sqlalchemy&quot;</span><span class="s3">, </span><span class="s4">&quot;fallback&quot;</span><span class="s3">)),</span>
            <span class="s3">(</span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql</span><span class="s3">, </span><span class="s4">&quot;types&quot;</span><span class="s3">, (</span><span class="s4">&quot;sqlalchemy&quot;</span><span class="s3">)),</span>
            <span class="s3">(</span>
                <span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">,</span>
                <span class="s4">&quot;SELECT * FROM types&quot;</span><span class="s3">,</span>
                <span class="s3">(</span><span class="s4">&quot;sqlalchemy&quot;</span><span class="s3">, </span><span class="s4">&quot;fallback&quot;</span><span class="s3">),</span>
            <span class="s3">),</span>
            <span class="s3">(</span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">, </span><span class="s4">&quot;types&quot;</span><span class="s3">, (</span><span class="s4">&quot;sqlalchemy&quot;</span><span class="s3">)),</span>
        <span class="s3">],</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_custom_dateparsing_error</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">read_sql</span><span class="s3">, </span><span class="s1">text</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">, </span><span class="s1">error</span><span class="s3">, </span><span class="s1">types_data_frame</span>
    <span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">mode </span><span class="s2">in </span><span class="s1">mode</span><span class="s3">:</span>
            <span class="s1">expected </span><span class="s3">= </span><span class="s1">types_data_frame</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">({</span><span class="s4">&quot;DateCol&quot;</span><span class="s3">: </span><span class="s4">&quot;datetime64[ns]&quot;</span><span class="s3">})</span>

            <span class="s1">result </span><span class="s3">= </span><span class="s1">read_sql</span><span class="s3">(</span>
                <span class="s1">text</span><span class="s3">,</span>
                <span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">,</span>
                <span class="s1">parse_dates</span><span class="s3">={</span>
                    <span class="s4">&quot;DateCol&quot;</span><span class="s3">: {</span><span class="s4">&quot;errors&quot;</span><span class="s3">: </span><span class="s1">error</span><span class="s3">},</span>
                <span class="s3">},</span>
            <span class="s3">)</span>

            <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_date_and_index</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Test case where same column appears in parse_date and index_col</span>

        <span class="s1">df </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span>
            <span class="s4">&quot;SELECT * FROM types&quot;</span><span class="s3">,</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">,</span>
            <span class="s1">index_col</span><span class="s3">=</span><span class="s4">&quot;DateCol&quot;</span><span class="s3">,</span>
            <span class="s1">parse_dates</span><span class="s3">=[</span><span class="s4">&quot;DateCol&quot;</span><span class="s3">, </span><span class="s4">&quot;IntDateCol&quot;</span><span class="s3">],</span>
        <span class="s3">)</span>

        <span class="s2">assert </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">datetime64</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">IntDateCol</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">datetime64</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_timedelta</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># see #6921</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">to_timedelta</span><span class="s3">(</span><span class="s1">Series</span><span class="s3">([</span><span class="s4">&quot;00:00:01&quot;</span><span class="s3">, </span><span class="s4">&quot;00:00:03&quot;</span><span class="s3">], </span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;foo&quot;</span><span class="s3">)).</span><span class="s1">to_frame</span><span class="s3">()</span>
        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">):</span>
            <span class="s1">result_count </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_timedelta&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">result_count </span><span class="s3">== </span><span class="s5">2</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM test_timedelta&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_series_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">[</span><span class="s4">&quot;foo&quot;</span><span class="s3">], </span><span class="s1">df</span><span class="s3">[</span><span class="s4">&quot;foo&quot;</span><span class="s3">].</span><span class="s1">view</span><span class="s3">(</span><span class="s4">&quot;int64&quot;</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_complex_raises</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;a&quot;</span><span class="s3">: [</span><span class="s5">1 </span><span class="s3">+ </span><span class="s5">1j</span><span class="s3">, </span><span class="s5">2j</span><span class="s3">]})</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;Complex datatypes not supported&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s4">&quot;test_complex&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">) </span><span class="s2">is None</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
        <span class="s4">&quot;index_name,index_label,expected&quot;</span><span class="s3">,</span>
        <span class="s3">[</span>
            <span class="s6"># no index name, defaults to 'index'</span>
            <span class="s3">(</span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s4">&quot;index&quot;</span><span class="s3">),</span>
            <span class="s6"># specifying index_label</span>
            <span class="s3">(</span><span class="s2">None</span><span class="s3">, </span><span class="s4">&quot;other_label&quot;</span><span class="s3">, </span><span class="s4">&quot;other_label&quot;</span><span class="s3">),</span>
            <span class="s6"># using the index name</span>
            <span class="s3">(</span><span class="s4">&quot;index_name&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s4">&quot;index_name&quot;</span><span class="s3">),</span>
            <span class="s6"># has index name, but specifying index_label</span>
            <span class="s3">(</span><span class="s4">&quot;index_name&quot;</span><span class="s3">, </span><span class="s4">&quot;other_label&quot;</span><span class="s3">, </span><span class="s4">&quot;other_label&quot;</span><span class="s3">),</span>
            <span class="s6"># index name is integer</span>
            <span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s4">&quot;0&quot;</span><span class="s3">),</span>
            <span class="s6"># index name is None but index label is integer</span>
            <span class="s3">(</span><span class="s2">None</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s4">&quot;0&quot;</span><span class="s3">),</span>
        <span class="s3">],</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_to_sql_index_label</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">index_name</span><span class="s3">, </span><span class="s1">index_label</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">):</span>
        <span class="s1">temp_frame </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;col1&quot;</span><span class="s3">: </span><span class="s1">range</span><span class="s3">(</span><span class="s5">4</span><span class="s3">)})</span>
        <span class="s1">temp_frame</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">name </span><span class="s3">= </span><span class="s1">index_name</span>
        <span class="s1">query </span><span class="s3">= </span><span class="s4">&quot;SELECT * FROM test_index_label&quot;</span>
        <span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">temp_frame</span><span class="s3">, </span><span class="s4">&quot;test_index_label&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index_label</span><span class="s3">=</span><span class="s1">index_label</span><span class="s3">)</span>
        <span class="s1">frame </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s1">query</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] == </span><span class="s1">expected</span>

    <span class="s2">def </span><span class="s1">test_to_sql_index_label_multiindex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">expected_row_count </span><span class="s3">= </span><span class="s5">4</span>
        <span class="s1">temp_frame </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span><span class="s4">&quot;col1&quot;</span><span class="s3">: </span><span class="s1">range</span><span class="s3">(</span><span class="s5">4</span><span class="s3">)},</span>
            <span class="s1">index</span><span class="s3">=</span><span class="s1">MultiIndex</span><span class="s3">.</span><span class="s1">from_product</span><span class="s3">([(</span><span class="s4">&quot;A0&quot;</span><span class="s3">, </span><span class="s4">&quot;A1&quot;</span><span class="s3">), (</span><span class="s4">&quot;B0&quot;</span><span class="s3">, </span><span class="s4">&quot;B1&quot;</span><span class="s3">)]),</span>
        <span class="s3">)</span>

        <span class="s6"># no index name, defaults to 'level_0' and 'level_1'</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">temp_frame</span><span class="s3">, </span><span class="s4">&quot;test_index_label&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">result </span><span class="s3">== </span><span class="s1">expected_row_count</span>
        <span class="s1">frame </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM test_index_label&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] == </span><span class="s4">&quot;level_0&quot;</span>
        <span class="s2">assert </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] == </span><span class="s4">&quot;level_1&quot;</span>

        <span class="s6"># specifying index_label</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span>
            <span class="s1">temp_frame</span><span class="s3">,</span>
            <span class="s4">&quot;test_index_label&quot;</span><span class="s3">,</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">,</span>
            <span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;replace&quot;</span><span class="s3">,</span>
            <span class="s1">index_label</span><span class="s3">=[</span><span class="s4">&quot;A&quot;</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">],</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">result </span><span class="s3">== </span><span class="s1">expected_row_count</span>
        <span class="s1">frame </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM test_index_label&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">[:</span><span class="s5">2</span><span class="s3">].</span><span class="s1">tolist</span><span class="s3">() == [</span><span class="s4">&quot;A&quot;</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">]</span>

        <span class="s6"># using the index name</span>
        <span class="s1">temp_frame</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">names </span><span class="s3">= [</span><span class="s4">&quot;A&quot;</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">]</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span>
            <span class="s1">temp_frame</span><span class="s3">, </span><span class="s4">&quot;test_index_label&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;replace&quot;</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">result </span><span class="s3">== </span><span class="s1">expected_row_count</span>
        <span class="s1">frame </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM test_index_label&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">[:</span><span class="s5">2</span><span class="s3">].</span><span class="s1">tolist</span><span class="s3">() == [</span><span class="s4">&quot;A&quot;</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">]</span>

        <span class="s6"># has index name, but specifying index_label</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span>
            <span class="s1">temp_frame</span><span class="s3">,</span>
            <span class="s4">&quot;test_index_label&quot;</span><span class="s3">,</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">,</span>
            <span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;replace&quot;</span><span class="s3">,</span>
            <span class="s1">index_label</span><span class="s3">=[</span><span class="s4">&quot;C&quot;</span><span class="s3">, </span><span class="s4">&quot;D&quot;</span><span class="s3">],</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">result </span><span class="s3">== </span><span class="s1">expected_row_count</span>
        <span class="s1">frame </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM test_index_label&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">[:</span><span class="s5">2</span><span class="s3">].</span><span class="s1">tolist</span><span class="s3">() == [</span><span class="s4">&quot;C&quot;</span><span class="s3">, </span><span class="s4">&quot;D&quot;</span><span class="s3">]</span>

        <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;Length of 'index_label' should match number of levels, which is 2&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span>
                <span class="s1">temp_frame</span><span class="s3">,</span>
                <span class="s4">&quot;test_index_label&quot;</span><span class="s3">,</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">,</span>
                <span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;replace&quot;</span><span class="s3">,</span>
                <span class="s1">index_label</span><span class="s3">=</span><span class="s4">&quot;C&quot;</span><span class="s3">,</span>
            <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_multiindex_roundtrip</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">.</span><span class="s1">from_records</span><span class="s3">(</span>
            <span class="s3">[(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2.1</span><span class="s3">, </span><span class="s4">&quot;line1&quot;</span><span class="s3">), (</span><span class="s5">2</span><span class="s3">, </span><span class="s5">1.5</span><span class="s3">, </span><span class="s4">&quot;line2&quot;</span><span class="s3">)],</span>
            <span class="s1">columns</span><span class="s3">=[</span><span class="s4">&quot;A&quot;</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">, </span><span class="s4">&quot;C&quot;</span><span class="s3">],</span>
            <span class="s1">index</span><span class="s3">=[</span><span class="s4">&quot;A&quot;</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">],</span>
        <span class="s3">)</span>

        <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_multiindex_roundtrip&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span>
            <span class="s4">&quot;SELECT * FROM test_multiindex_roundtrip&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index_col</span><span class="s3">=[</span><span class="s4">&quot;A&quot;</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">]</span>
        <span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">result</span><span class="s3">, </span><span class="s1">check_index_type</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
        <span class="s4">&quot;dtype&quot;</span><span class="s3">,</span>
        <span class="s3">[</span>
            <span class="s2">None</span><span class="s3">,</span>
            <span class="s1">int</span><span class="s3">,</span>
            <span class="s1">float</span><span class="s3">,</span>
            <span class="s3">{</span><span class="s4">&quot;A&quot;</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">: </span><span class="s1">float</span><span class="s3">},</span>
        <span class="s3">],</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_dtype_argument</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">):</span>
        <span class="s6"># GH10285 Add dtype argument to read_sql_query</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s5">1.2</span><span class="s3">, </span><span class="s5">3.4</span><span class="s3">], [</span><span class="s5">5.6</span><span class="s3">, </span><span class="s5">7.8</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=[</span><span class="s4">&quot;A&quot;</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_dtype_argument&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">) == </span><span class="s5">2</span>

        <span class="s1">expected </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">dtype</span><span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span>
            <span class="s4">&quot;SELECT A, B FROM test_dtype_argument&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span>
        <span class="s3">)</span>

        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_integer_col_names</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">])</span>
        <span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s4">&quot;test_frame_integer_col_names&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;replace&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_get_schema</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">):</span>
        <span class="s1">create_sql </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">get_schema</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">, </span><span class="s4">&quot;test&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s4">&quot;CREATE&quot; </span><span class="s2">in </span><span class="s1">create_sql</span>

    <span class="s2">def </span><span class="s1">test_get_schema_with_schema</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">):</span>
        <span class="s6"># GH28486</span>
        <span class="s1">create_sql </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">get_schema</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">, </span><span class="s4">&quot;test&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s4">&quot;pypi&quot;</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s4">&quot;CREATE TABLE pypi.&quot; </span><span class="s2">in </span><span class="s1">create_sql</span>

    <span class="s2">def </span><span class="s1">test_get_schema_dtypes</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">== </span><span class="s4">&quot;sqlalchemy&quot;</span><span class="s3">:</span>
            <span class="s2">from </span><span class="s1">sqlalchemy </span><span class="s2">import </span><span class="s1">Integer</span>

            <span class="s1">dtype </span><span class="s3">= </span><span class="s1">Integer</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">dtype </span><span class="s3">= </span><span class="s4">&quot;INTEGER&quot;</span>

        <span class="s1">float_frame </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;a&quot;</span><span class="s3">: [</span><span class="s5">1.1</span><span class="s3">, </span><span class="s5">1.2</span><span class="s3">], </span><span class="s4">&quot;b&quot;</span><span class="s3">: [</span><span class="s5">2.1</span><span class="s3">, </span><span class="s5">2.2</span><span class="s3">]})</span>
        <span class="s1">create_sql </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">get_schema</span><span class="s3">(</span>
            <span class="s1">float_frame</span><span class="s3">, </span><span class="s4">&quot;test&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">={</span><span class="s4">&quot;b&quot;</span><span class="s3">: </span><span class="s1">dtype</span><span class="s3">}</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s4">&quot;CREATE&quot; </span><span class="s2">in </span><span class="s1">create_sql</span>
        <span class="s2">assert </span><span class="s4">&quot;INTEGER&quot; </span><span class="s2">in </span><span class="s1">create_sql</span>

    <span class="s2">def </span><span class="s1">test_get_schema_keys</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">):</span>
        <span class="s1">frame </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;Col1&quot;</span><span class="s3">: [</span><span class="s5">1.1</span><span class="s3">, </span><span class="s5">1.2</span><span class="s3">], </span><span class="s4">&quot;Col2&quot;</span><span class="s3">: [</span><span class="s5">2.1</span><span class="s3">, </span><span class="s5">2.2</span><span class="s3">]})</span>
        <span class="s1">create_sql </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">get_schema</span><span class="s3">(</span><span class="s1">frame</span><span class="s3">, </span><span class="s4">&quot;test&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">keys</span><span class="s3">=</span><span class="s4">&quot;Col1&quot;</span><span class="s3">)</span>
        <span class="s1">constraint_sentence </span><span class="s3">= </span><span class="s4">'CONSTRAINT test_pk PRIMARY KEY (&quot;Col1&quot;)'</span>
        <span class="s2">assert </span><span class="s1">constraint_sentence </span><span class="s2">in </span><span class="s1">create_sql</span>

        <span class="s6"># multiple columns as key (GH10385)</span>
        <span class="s1">create_sql </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">get_schema</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">, </span><span class="s4">&quot;test&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">keys</span><span class="s3">=[</span><span class="s4">&quot;A&quot;</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">])</span>
        <span class="s1">constraint_sentence </span><span class="s3">= </span><span class="s4">'CONSTRAINT test_pk PRIMARY KEY (&quot;A&quot;, &quot;B&quot;)'</span>
        <span class="s2">assert </span><span class="s1">constraint_sentence </span><span class="s2">in </span><span class="s1">create_sql</span>

    <span class="s2">def </span><span class="s1">test_chunksize_read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">2</span><span class="s3">).</span><span class="s1">standard_normal</span><span class="s3">((</span><span class="s5">22</span><span class="s3">, </span><span class="s5">5</span><span class="s3">)), </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">list</span><span class="s3">(</span><span class="s4">&quot;abcde&quot;</span><span class="s3">)</span>
        <span class="s3">)</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_chunksize&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

        <span class="s6"># reading the query in one time</span>
        <span class="s1">res1 </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;select * from test_chunksize&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

        <span class="s6"># reading the query in chunks with read_sql_query</span>
        <span class="s1">res2 </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">()</span>
        <span class="s1">i </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s1">sizes </span><span class="s3">= [</span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]</span>

        <span class="s2">for </span><span class="s1">chunk </span><span class="s2">in </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span>
            <span class="s4">&quot;select * from test_chunksize&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">chunksize</span><span class="s3">=</span><span class="s5">5</span>
        <span class="s3">):</span>
            <span class="s1">res2 </span><span class="s3">= </span><span class="s1">concat</span><span class="s3">([</span><span class="s1">res2</span><span class="s3">, </span><span class="s1">chunk</span><span class="s3">], </span><span class="s1">ignore_index</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">chunk</span><span class="s3">) == </span><span class="s1">sizes</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]</span>
            <span class="s1">i </span><span class="s3">+= </span><span class="s5">1</span>

        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">res1</span><span class="s3">, </span><span class="s1">res2</span><span class="s3">)</span>

        <span class="s6"># reading the query in chunks with read_sql_query</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">== </span><span class="s4">&quot;sqlalchemy&quot;</span><span class="s3">:</span>
            <span class="s1">res3 </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">()</span>
            <span class="s1">i </span><span class="s3">= </span><span class="s5">0</span>
            <span class="s1">sizes </span><span class="s3">= [</span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]</span>

            <span class="s2">for </span><span class="s1">chunk </span><span class="s2">in </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;test_chunksize&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">chunksize</span><span class="s3">=</span><span class="s5">5</span><span class="s3">):</span>
                <span class="s1">res3 </span><span class="s3">= </span><span class="s1">concat</span><span class="s3">([</span><span class="s1">res3</span><span class="s3">, </span><span class="s1">chunk</span><span class="s3">], </span><span class="s1">ignore_index</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
                <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">chunk</span><span class="s3">) == </span><span class="s1">sizes</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]</span>
                <span class="s1">i </span><span class="s3">+= </span><span class="s5">1</span>

            <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">res1</span><span class="s3">, </span><span class="s1">res3</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_categorical</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># GH8624</span>
        <span class="s6"># test that categorical gets written correctly as dense column</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span>
                <span class="s4">&quot;person_id&quot;</span><span class="s3">: [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">],</span>
                <span class="s4">&quot;person_name&quot;</span><span class="s3">: [</span><span class="s4">&quot;John P. Doe&quot;</span><span class="s3">, </span><span class="s4">&quot;Jane Dove&quot;</span><span class="s3">, </span><span class="s4">&quot;John P. Doe&quot;</span><span class="s3">],</span>
            <span class="s3">}</span>
        <span class="s3">)</span>
        <span class="s1">df2 </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s1">df2</span><span class="s3">[</span><span class="s4">&quot;person_name&quot;</span><span class="s3">] = </span><span class="s1">df2</span><span class="s3">[</span><span class="s4">&quot;person_name&quot;</span><span class="s3">].</span><span class="s1">astype</span><span class="s3">(</span><span class="s4">&quot;category&quot;</span><span class="s3">)</span>

        <span class="s1">df2</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_categorical&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM test_categorical&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">df</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_unicode_column_name</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># GH 11431</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=[</span><span class="s4">&quot;</span><span class="s2">\xe9</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span><span class="s3">])</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_unicode&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_escaped_table_name</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># GH 13206</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;A&quot;</span><span class="s3">: [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], </span><span class="s4">&quot;B&quot;</span><span class="s3">: [</span><span class="s5">0.2</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">5.6</span><span class="s3">]})</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;d1187b08-4943-4c8d-a7f6&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM `d1187b08-4943-4c8d-a7f6`&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">df</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_read_sql_duplicate_columns</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># GH#53117</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;a&quot;</span><span class="s3">: [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], </span><span class="s4">&quot;b&quot;</span><span class="s3">: [</span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">0.2</span><span class="s3">, </span><span class="s5">0.3</span><span class="s3">], </span><span class="s4">&quot;c&quot;</span><span class="s3">: </span><span class="s5">1</span><span class="s3">})</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_table&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

        <span class="s1">result </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">read_sql</span><span class="s3">(</span><span class="s4">&quot;SELECT a, b, a +1 as a, c FROM test_table;&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">[[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">0.2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">0.3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]],</span>
            <span class="s1">columns</span><span class="s3">=[</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span><span class="s3">, </span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s4">&quot;c&quot;</span><span class="s3">],</span>
        <span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span><span class="s2">not </span><span class="s1">SQLALCHEMY_INSTALLED</span><span class="s3">, </span><span class="s1">reason</span><span class="s3">=</span><span class="s4">&quot;SQLAlchemy not installed&quot;</span><span class="s3">)</span>
<span class="s2">class </span><span class="s1">TestSQLApi</span><span class="s3">(</span><span class="s1">SQLAlchemyMixIn</span><span class="s3">, </span><span class="s1">_TestSQLApi</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Test the public API as it would be used directly 
 
    Tests for `read_sql_table` are included here, as this is specific for the 
    sqlalchemy mode. 
 
    &quot;&quot;&quot;</span>

    <span class="s1">flavor </span><span class="s3">= </span><span class="s4">&quot;sqlite&quot;</span>
    <span class="s1">mode </span><span class="s3">= </span><span class="s4">&quot;sqlalchemy&quot;</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">setup_class</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">):</span>
        <span class="s1">cls</span><span class="s3">.</span><span class="s1">engine </span><span class="s3">= </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">create_engine</span><span class="s3">(</span><span class="s4">&quot;sqlite:///:memory:&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_read_table_columns</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">):</span>
        <span class="s6"># test columns argument in read_table</span>
        <span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">, </span><span class="s4">&quot;test_frame&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

        <span class="s1">cols </span><span class="s3">= [</span><span class="s4">&quot;A&quot;</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">]</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;test_frame&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">cols</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">result</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">.</span><span class="s1">tolist</span><span class="s3">() == </span><span class="s1">cols</span>

    <span class="s2">def </span><span class="s1">test_read_table_index_col</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">):</span>
        <span class="s6"># test columns argument in read_table</span>
        <span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">, </span><span class="s4">&quot;test_frame&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;test_frame&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index_col</span><span class="s3">=</span><span class="s4">&quot;index&quot;</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">result</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">names </span><span class="s3">== [</span><span class="s4">&quot;index&quot;</span><span class="s3">]</span>

        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;test_frame&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index_col</span><span class="s3">=[</span><span class="s4">&quot;A&quot;</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">result</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">names </span><span class="s3">== [</span><span class="s4">&quot;A&quot;</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">]</span>

        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span>
            <span class="s4">&quot;test_frame&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index_col</span><span class="s3">=[</span><span class="s4">&quot;A&quot;</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">], </span><span class="s1">columns</span><span class="s3">=[</span><span class="s4">&quot;C&quot;</span><span class="s3">, </span><span class="s4">&quot;D&quot;</span><span class="s3">]</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">result</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">names </span><span class="s3">== [</span><span class="s4">&quot;A&quot;</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">]</span>
        <span class="s2">assert </span><span class="s1">result</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">.</span><span class="s1">tolist</span><span class="s3">() == [</span><span class="s4">&quot;C&quot;</span><span class="s3">, </span><span class="s4">&quot;D&quot;</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">test_read_sql_delegate</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">iris_frame1 </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM iris&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">iris_frame2 </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM iris&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">iris_frame1</span><span class="s3">, </span><span class="s1">iris_frame2</span><span class="s3">)</span>

        <span class="s1">iris_frame1 </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;iris&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">iris_frame2 </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql</span><span class="s3">(</span><span class="s4">&quot;iris&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">iris_frame1</span><span class="s3">, </span><span class="s1">iris_frame2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_not_reflect_all_tables</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">from </span><span class="s1">sqlalchemy </span><span class="s2">import </span><span class="s1">text</span>
        <span class="s2">from </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">engine </span><span class="s2">import </span><span class="s1">Engine</span>

        <span class="s6"># create invalid table</span>
        <span class="s1">query_list </span><span class="s3">= [</span>
            <span class="s1">text</span><span class="s3">(</span><span class="s4">&quot;CREATE TABLE invalid (x INTEGER, y UNKNOWN);&quot;</span><span class="s3">),</span>
            <span class="s1">text</span><span class="s3">(</span><span class="s4">&quot;CREATE TABLE other_table (x INTEGER, y INTEGER);&quot;</span><span class="s3">),</span>
        <span class="s3">]</span>
        <span class="s2">for </span><span class="s1">query </span><span class="s2">in </span><span class="s1">query_list</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">Engine</span><span class="s3">):</span>
                <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">() </span><span class="s2">as </span><span class="s1">conn</span><span class="s3">:</span>
                    <span class="s2">with </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">():</span>
                        <span class="s1">conn</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">query</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">():</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">query</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span><span class="s2">None</span><span class="s3">):</span>
            <span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;other_table&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
            <span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM other_table&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_warning_case_insensitive_table_name</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">):</span>
        <span class="s6"># see gh-7815</span>
        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span>
            <span class="s1">UserWarning</span><span class="s3">,</span>
            <span class="s1">match</span><span class="s3">=(</span>
                <span class="s4">r&quot;The provided table name 'TABLE1' is not found exactly as such in &quot;</span>
                <span class="s4">r&quot;the database after writing the table, possibly due to case &quot;</span>
                <span class="s4">r&quot;sensitivity issues. Consider using lower case table names.&quot;</span>
            <span class="s3">),</span>
        <span class="s3">):</span>
            <span class="s1">sql</span><span class="s3">.</span><span class="s1">SQLDatabase</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">).</span><span class="s1">check_case_sensitive</span><span class="s3">(</span><span class="s4">&quot;TABLE1&quot;</span><span class="s3">, </span><span class="s4">&quot;&quot;</span><span class="s3">)</span>

        <span class="s6"># Test that the warning is certainly NOT triggered in a normal case.</span>
        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span><span class="s2">None</span><span class="s3">):</span>
            <span class="s1">test_frame1</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;CaseSensitive&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_get_index_columns</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">tbl_name</span><span class="s3">):</span>
        <span class="s2">from </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">engine </span><span class="s2">import </span><span class="s1">reflection</span>

        <span class="s1">insp </span><span class="s3">= </span><span class="s1">reflection</span><span class="s3">.</span><span class="s1">Inspector</span><span class="s3">.</span><span class="s1">from_engine</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">ixs </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_indexes</span><span class="s3">(</span><span class="s4">&quot;test_index_saved&quot;</span><span class="s3">)</span>
        <span class="s1">ixs </span><span class="s3">= [</span><span class="s1">i</span><span class="s3">[</span><span class="s4">&quot;column_names&quot;</span><span class="s3">] </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">ixs</span><span class="s3">]</span>
        <span class="s2">return </span><span class="s1">ixs</span>

    <span class="s2">def </span><span class="s1">test_sqlalchemy_type_mapping</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">from </span><span class="s1">sqlalchemy </span><span class="s2">import </span><span class="s1">TIMESTAMP</span>

        <span class="s6"># Test Timestamp objects (no datetime64 because of timezone) (GH9085)</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span><span class="s4">&quot;time&quot;</span><span class="s3">: </span><span class="s1">to_datetime</span><span class="s3">([</span><span class="s4">&quot;2014-12-12 01:54&quot;</span><span class="s3">, </span><span class="s4">&quot;2014-12-11 02:54&quot;</span><span class="s3">], </span><span class="s1">utc</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)}</span>
        <span class="s3">)</span>
        <span class="s1">db </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">SQLDatabase</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">table </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">SQLTable</span><span class="s3">(</span><span class="s4">&quot;test_type&quot;</span><span class="s3">, </span><span class="s1">db</span><span class="s3">, </span><span class="s1">frame</span><span class="s3">=</span><span class="s1">df</span><span class="s3">)</span>
        <span class="s6"># GH 9086: TIMESTAMP is the suggested type for datetimes with timezones</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">table</span><span class="s3">.</span><span class="s1">table</span><span class="s3">.</span><span class="s1">c</span><span class="s3">[</span><span class="s4">&quot;time&quot;</span><span class="s3">].</span><span class="s1">type</span><span class="s3">, </span><span class="s1">TIMESTAMP</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
        <span class="s4">&quot;integer, expected&quot;</span><span class="s3">,</span>
        <span class="s3">[</span>
            <span class="s3">(</span><span class="s4">&quot;int8&quot;</span><span class="s3">, </span><span class="s4">&quot;SMALLINT&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s4">&quot;Int8&quot;</span><span class="s3">, </span><span class="s4">&quot;SMALLINT&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s4">&quot;uint8&quot;</span><span class="s3">, </span><span class="s4">&quot;SMALLINT&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s4">&quot;UInt8&quot;</span><span class="s3">, </span><span class="s4">&quot;SMALLINT&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s4">&quot;int16&quot;</span><span class="s3">, </span><span class="s4">&quot;SMALLINT&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s4">&quot;Int16&quot;</span><span class="s3">, </span><span class="s4">&quot;SMALLINT&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s4">&quot;uint16&quot;</span><span class="s3">, </span><span class="s4">&quot;INTEGER&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s4">&quot;UInt16&quot;</span><span class="s3">, </span><span class="s4">&quot;INTEGER&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s4">&quot;int32&quot;</span><span class="s3">, </span><span class="s4">&quot;INTEGER&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s4">&quot;Int32&quot;</span><span class="s3">, </span><span class="s4">&quot;INTEGER&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s4">&quot;uint32&quot;</span><span class="s3">, </span><span class="s4">&quot;BIGINT&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s4">&quot;UInt32&quot;</span><span class="s3">, </span><span class="s4">&quot;BIGINT&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s4">&quot;int64&quot;</span><span class="s3">, </span><span class="s4">&quot;BIGINT&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s4">&quot;Int64&quot;</span><span class="s3">, </span><span class="s4">&quot;BIGINT&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s1">int</span><span class="s3">, </span><span class="s4">&quot;BIGINT&quot; </span><span class="s2">if </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">(</span><span class="s1">int</span><span class="s3">).</span><span class="s1">name </span><span class="s3">== </span><span class="s4">&quot;int64&quot; </span><span class="s2">else </span><span class="s4">&quot;INTEGER&quot;</span><span class="s3">),</span>
        <span class="s3">],</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_sqlalchemy_integer_mapping</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">integer</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">):</span>
        <span class="s6"># GH35076 Map pandas integer to optimal SQLAlchemy integer type</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], </span><span class="s1">columns</span><span class="s3">=[</span><span class="s4">&quot;a&quot;</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">integer</span><span class="s3">)</span>
        <span class="s1">db </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">SQLDatabase</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">table </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">SQLTable</span><span class="s3">(</span><span class="s4">&quot;test_type&quot;</span><span class="s3">, </span><span class="s1">db</span><span class="s3">, </span><span class="s1">frame</span><span class="s3">=</span><span class="s1">df</span><span class="s3">)</span>

        <span class="s1">result </span><span class="s3">= </span><span class="s1">str</span><span class="s3">(</span><span class="s1">table</span><span class="s3">.</span><span class="s1">table</span><span class="s3">.</span><span class="s1">c</span><span class="s3">.</span><span class="s1">a</span><span class="s3">.</span><span class="s1">type</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">result </span><span class="s3">== </span><span class="s1">expected</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;integer&quot;</span><span class="s3">, [</span><span class="s4">&quot;uint64&quot;</span><span class="s3">, </span><span class="s4">&quot;UInt64&quot;</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_sqlalchemy_integer_overload_mapping</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">integer</span><span class="s3">):</span>
        <span class="s6"># GH35076 Map pandas integer to optimal SQLAlchemy integer type</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], </span><span class="s1">columns</span><span class="s3">=[</span><span class="s4">&quot;a&quot;</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">integer</span><span class="s3">)</span>
        <span class="s1">db </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">SQLDatabase</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span>
            <span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;Unsigned 64 bit integer datatype is not supported&quot;</span>
        <span class="s3">):</span>
            <span class="s1">sql</span><span class="s3">.</span><span class="s1">SQLTable</span><span class="s3">(</span><span class="s4">&quot;test_type&quot;</span><span class="s3">, </span><span class="s1">db</span><span class="s3">, </span><span class="s1">frame</span><span class="s3">=</span><span class="s1">df</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_database_uri_string</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">):</span>
        <span class="s6"># Test read_sql and .to_sql method with a database URI (GH10654)</span>
        <span class="s6"># db_uri = 'sqlite:///:memory:' # raises</span>
        <span class="s6"># sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) near</span>
        <span class="s6"># &quot;iris&quot;: syntax error [SQL: 'iris']</span>
        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">() </span><span class="s2">as </span><span class="s1">name</span><span class="s3">:</span>
            <span class="s1">db_uri </span><span class="s3">= </span><span class="s4">&quot;sqlite:///&quot; </span><span class="s3">+ </span><span class="s1">name</span>
            <span class="s1">table </span><span class="s3">= </span><span class="s4">&quot;iris&quot;</span>
            <span class="s1">test_frame1</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s1">table</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">db_uri</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;replace&quot;</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
            <span class="s1">test_frame2 </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql</span><span class="s3">(</span><span class="s1">table</span><span class="s3">, </span><span class="s1">db_uri</span><span class="s3">)</span>
            <span class="s1">test_frame3 </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s1">table</span><span class="s3">, </span><span class="s1">db_uri</span><span class="s3">)</span>
            <span class="s1">query </span><span class="s3">= </span><span class="s4">&quot;SELECT * FROM iris&quot;</span>
            <span class="s1">test_frame4 </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s1">query</span><span class="s3">, </span><span class="s1">db_uri</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">, </span><span class="s1">test_frame2</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">, </span><span class="s1">test_frame3</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">, </span><span class="s1">test_frame4</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">td</span><span class="s3">.</span><span class="s1">skip_if_installed</span><span class="s3">(</span><span class="s4">&quot;pg8000&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_pg8000_sqlalchemy_passthrough_error</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># using driver that will not be installed on CI to trigger error</span>
        <span class="s6"># in sqlalchemy.create_engine -&gt; test passing of this error to user</span>
        <span class="s1">db_uri </span><span class="s3">= </span><span class="s4">&quot;postgresql+pg8000://user:pass@host/dbname&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ImportError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;pg8000&quot;</span><span class="s3">):</span>
            <span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql</span><span class="s3">(</span><span class="s4">&quot;select * from table&quot;</span><span class="s3">, </span><span class="s1">db_uri</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_query_by_text_obj</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># WIP : GH10846</span>
        <span class="s2">from </span><span class="s1">sqlalchemy </span><span class="s2">import </span><span class="s1">text</span>

        <span class="s1">name_text </span><span class="s3">= </span><span class="s1">text</span><span class="s3">(</span><span class="s4">&quot;select * from iris where name=:name&quot;</span><span class="s3">)</span>
        <span class="s1">iris_df </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql</span><span class="s3">(</span><span class="s1">name_text</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">params</span><span class="s3">={</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;Iris-versicolor&quot;</span><span class="s3">})</span>
        <span class="s1">all_names </span><span class="s3">= </span><span class="s1">set</span><span class="s3">(</span><span class="s1">iris_df</span><span class="s3">[</span><span class="s4">&quot;Name&quot;</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">all_names </span><span class="s3">== {</span><span class="s4">&quot;Iris-versicolor&quot;</span><span class="s3">}</span>

    <span class="s2">def </span><span class="s1">test_query_by_select_obj</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># WIP : GH10846</span>
        <span class="s2">from </span><span class="s1">sqlalchemy </span><span class="s2">import </span><span class="s3">(</span>
            <span class="s1">bindparam</span><span class="s3">,</span>
            <span class="s1">select</span><span class="s3">,</span>
        <span class="s3">)</span>

        <span class="s1">iris </span><span class="s3">= </span><span class="s1">iris_table_metadata</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">flavor</span><span class="s3">)</span>
        <span class="s1">name_select </span><span class="s3">= </span><span class="s1">select</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">).</span><span class="s1">where</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">c</span><span class="s3">.</span><span class="s1">Name </span><span class="s3">== </span><span class="s1">bindparam</span><span class="s3">(</span><span class="s4">&quot;name&quot;</span><span class="s3">))</span>
        <span class="s1">iris_df </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql</span><span class="s3">(</span><span class="s1">name_select</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">params</span><span class="s3">={</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;Iris-setosa&quot;</span><span class="s3">})</span>
        <span class="s1">all_names </span><span class="s3">= </span><span class="s1">set</span><span class="s3">(</span><span class="s1">iris_df</span><span class="s3">[</span><span class="s4">&quot;Name&quot;</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">all_names </span><span class="s3">== {</span><span class="s4">&quot;Iris-setosa&quot;</span><span class="s3">}</span>

    <span class="s2">def </span><span class="s1">test_column_with_percentage</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># GH 37157</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;A&quot;</span><span class="s3">: [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], </span><span class="s4">&quot;%_variation&quot;</span><span class="s3">: [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">]})</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_column_percentage&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;test_column_percentage&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">df</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestSQLiteFallbackApi</span><span class="s3">(</span><span class="s1">SQLiteMixIn</span><span class="s3">, </span><span class="s1">_TestSQLApi</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Test the public sqlite connection fallback API 
 
    &quot;&quot;&quot;</span>

    <span class="s1">flavor </span><span class="s3">= </span><span class="s4">&quot;sqlite&quot;</span>
    <span class="s1">mode </span><span class="s3">= </span><span class="s4">&quot;fallback&quot;</span>

    <span class="s2">def </span><span class="s1">connect</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">database</span><span class="s3">=</span><span class="s4">&quot;:memory:&quot;</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">sqlite3</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">(</span><span class="s1">database</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_sql_open_close</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_frame3</span><span class="s3">):</span>
        <span class="s6"># Test if the IO in the database still work if the connection closed</span>
        <span class="s6"># between the writing and reading (as in many real situations).</span>

        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">() </span><span class="s2">as </span><span class="s1">name</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">closing</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)) </span><span class="s2">as </span><span class="s1">conn</span><span class="s3">:</span>
                <span class="s2">assert </span><span class="s3">(</span>
                    <span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">test_frame3</span><span class="s3">, </span><span class="s4">&quot;test_frame3_legacy&quot;</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
                    <span class="s3">== </span><span class="s5">4</span>
                <span class="s3">)</span>

            <span class="s2">with </span><span class="s1">closing</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)) </span><span class="s2">as </span><span class="s1">conn</span><span class="s3">:</span>
                <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM test_frame3_legacy;&quot;</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">)</span>

        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">test_frame3</span><span class="s3">, </span><span class="s1">result</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span><span class="s1">SQLALCHEMY_INSTALLED</span><span class="s3">, </span><span class="s1">reason</span><span class="s3">=</span><span class="s4">&quot;SQLAlchemy is installed&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_con_string_import_error</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">conn </span><span class="s3">= </span><span class="s4">&quot;mysql://root@localhost/pandas&quot;</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;Using URI string without sqlalchemy installed&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ImportError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM iris&quot;</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span><span class="s1">SQLALCHEMY_INSTALLED</span><span class="s3">, </span><span class="s1">reason</span><span class="s3">=</span><span class="s4">&quot;SQLAlchemy is installed&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_con_unknown_dbapi2_class_does_not_error_without_sql_alchemy_installed</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s2">class </span><span class="s1">MockSqliteConnection</span><span class="s3">:</span>
            <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">conn </span><span class="s3">= </span><span class="s1">sqlite3</span><span class="s3">.</span><span class="s1">Connection</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>

            <span class="s2">def </span><span class="s1">__getattr__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">):</span>
                <span class="s2">return </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">name</span><span class="s3">)</span>

            <span class="s2">def </span><span class="s1">close</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

        <span class="s2">with </span><span class="s1">contextlib</span><span class="s3">.</span><span class="s1">closing</span><span class="s3">(</span><span class="s1">MockSqliteConnection</span><span class="s3">(</span><span class="s4">&quot;:memory:&quot;</span><span class="s3">)) </span><span class="s2">as </span><span class="s1">conn</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">):</span>
                <span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql</span><span class="s3">(</span><span class="s4">&quot;SELECT 1&quot;</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_read_sql_delegate</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">iris_frame1 </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM iris&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">iris_frame2 </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM iris&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">iris_frame1</span><span class="s3">, </span><span class="s1">iris_frame2</span><span class="s3">)</span>

        <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;Execution failed on sql 'iris': near </span><span class="s2">\&quot;</span><span class="s4">iris</span><span class="s2">\&quot;</span><span class="s4">: syntax error&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">sql</span><span class="s3">.</span><span class="s1">DatabaseError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql</span><span class="s3">(</span><span class="s4">&quot;iris&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_get_schema2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">):</span>
        <span class="s6"># without providing a connection object (available for backwards comp)</span>
        <span class="s1">create_sql </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">get_schema</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">, </span><span class="s4">&quot;test&quot;</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s4">&quot;CREATE&quot; </span><span class="s2">in </span><span class="s1">create_sql</span>

    <span class="s2">def </span><span class="s1">_get_sqlite_column_type</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">, </span><span class="s1">column</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">schema</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">&quot;</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">col</span><span class="s3">.</span><span class="s1">split</span><span class="s3">()[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">strip</span><span class="s3">(</span><span class="s4">'&quot;'</span><span class="s3">) == </span><span class="s1">column</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">col</span><span class="s3">.</span><span class="s1">split</span><span class="s3">()[</span><span class="s5">1</span><span class="s3">]</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">f&quot;Column </span><span class="s2">{</span><span class="s1">column</span><span class="s2">} </span><span class="s4">not found&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_sqlite_type_mapping</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Test Timestamp objects (no datetime64 because of timezone) (GH9085)</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span><span class="s4">&quot;time&quot;</span><span class="s3">: </span><span class="s1">to_datetime</span><span class="s3">([</span><span class="s4">&quot;2014-12-12 01:54&quot;</span><span class="s3">, </span><span class="s4">&quot;2014-12-11 02:54&quot;</span><span class="s3">], </span><span class="s1">utc</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)}</span>
        <span class="s3">)</span>
        <span class="s1">db </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">SQLiteDatabase</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">table </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">SQLiteTable</span><span class="s3">(</span><span class="s4">&quot;test_type&quot;</span><span class="s3">, </span><span class="s1">db</span><span class="s3">, </span><span class="s1">frame</span><span class="s3">=</span><span class="s1">df</span><span class="s3">)</span>
        <span class="s1">schema </span><span class="s3">= </span><span class="s1">table</span><span class="s3">.</span><span class="s1">sql_schema</span><span class="s3">()</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_sqlite_column_type</span><span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;time&quot;</span><span class="s3">) == </span><span class="s4">&quot;TIMESTAMP&quot;</span>


<span class="s6"># -----------------------------------------------------------------------------</span>
<span class="s6"># -- Database flavor specific tests</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span><span class="s2">not </span><span class="s1">SQLALCHEMY_INSTALLED</span><span class="s3">, </span><span class="s1">reason</span><span class="s3">=</span><span class="s4">&quot;SQLAlchemy not installed&quot;</span><span class="s3">)</span>
<span class="s2">class </span><span class="s1">_TestSQLAlchemy</span><span class="s3">(</span><span class="s1">SQLAlchemyMixIn</span><span class="s3">, </span><span class="s1">PandasSQLTest</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Base class for testing the sqlalchemy backend. 
 
    Subclasses for specific database types are created below. Tests that 
    deviate for each flavor are overwritten there. 
 
    &quot;&quot;&quot;</span>

    <span class="s1">flavor</span><span class="s3">: </span><span class="s1">str</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">setup_class</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">):</span>
        <span class="s1">cls</span><span class="s3">.</span><span class="s1">setup_driver</span><span class="s3">()</span>
        <span class="s1">cls</span><span class="s3">.</span><span class="s1">setup_engine</span><span class="s3">()</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span><span class="s3">(</span><span class="s1">autouse</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">setup_method</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">iris_path</span><span class="s3">, </span><span class="s1">types_data</span><span class="s3">):</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">conn </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">engine</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">pandasSQL </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">SQLDatabase</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">exc</span><span class="s3">.</span><span class="s1">OperationalError</span><span class="s3">:</span>
            <span class="s1">pytest</span><span class="s3">.</span><span class="s1">skip</span><span class="s3">(</span><span class="s4">f&quot;Can't connect to </span><span class="s2">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">flavor</span><span class="s2">} </span><span class="s4">server&quot;</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">load_iris_data</span><span class="s3">(</span><span class="s1">iris_path</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">load_types_data</span><span class="s3">(</span><span class="s1">types_data</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">setup_driver</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">):</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError</span><span class="s3">()</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">setup_engine</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">):</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">test_read_sql_parameter</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">sql_strings</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_read_sql_iris_parameter</span><span class="s3">(</span><span class="s1">sql_strings</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_read_sql_named_parameter</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">sql_strings</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_read_sql_iris_named_parameter</span><span class="s3">(</span><span class="s1">sql_strings</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_to_sql_empty</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_to_sql_empty</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_create_table</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">from </span><span class="s1">sqlalchemy </span><span class="s2">import </span><span class="s1">inspect</span>

        <span class="s1">temp_conn </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">()</span>
        <span class="s1">temp_frame </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span><span class="s4">&quot;one&quot;</span><span class="s3">: [</span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">4.0</span><span class="s3">], </span><span class="s4">&quot;two&quot;</span><span class="s3">: [</span><span class="s5">4.0</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">]}</span>
        <span class="s3">)</span>
        <span class="s2">with </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">SQLDatabase</span><span class="s3">(</span><span class="s1">temp_conn</span><span class="s3">, </span><span class="s1">need_transaction</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) </span><span class="s2">as </span><span class="s1">pandasSQL</span><span class="s3">:</span>
            <span class="s2">assert </span><span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">temp_frame</span><span class="s3">, </span><span class="s4">&quot;temp_frame&quot;</span><span class="s3">) == </span><span class="s5">4</span>

        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">temp_conn</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span><span class="s4">&quot;temp_frame&quot;</span><span class="s3">)</span>

        <span class="s6"># Cleanup</span>
        <span class="s2">with </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">SQLDatabase</span><span class="s3">(</span><span class="s1">temp_conn</span><span class="s3">, </span><span class="s1">need_transaction</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) </span><span class="s2">as </span><span class="s1">pandasSQL</span><span class="s3">:</span>
            <span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">drop_table</span><span class="s3">(</span><span class="s4">&quot;temp_frame&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_drop_table</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">from </span><span class="s1">sqlalchemy </span><span class="s2">import </span><span class="s1">inspect</span>

        <span class="s1">temp_conn </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">()</span>
        <span class="s1">temp_frame </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span><span class="s4">&quot;one&quot;</span><span class="s3">: [</span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">4.0</span><span class="s3">], </span><span class="s4">&quot;two&quot;</span><span class="s3">: [</span><span class="s5">4.0</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">]}</span>
        <span class="s3">)</span>
        <span class="s1">pandasSQL </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">SQLDatabase</span><span class="s3">(</span><span class="s1">temp_conn</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">temp_frame</span><span class="s3">, </span><span class="s4">&quot;temp_frame&quot;</span><span class="s3">) == </span><span class="s5">4</span>

        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">temp_conn</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span><span class="s4">&quot;temp_frame&quot;</span><span class="s3">)</span>

        <span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">drop_table</span><span class="s3">(</span><span class="s4">&quot;temp_frame&quot;</span><span class="s3">)</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">insp</span><span class="s3">.</span><span class="s1">clear_cache</span><span class="s3">()  </span><span class="s6"># needed with SQLAlchemy 2.0, unavailable prior</span>
        <span class="s2">except </span><span class="s1">AttributeError</span><span class="s3">:</span>
            <span class="s2">pass</span>
        <span class="s2">assert not </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span><span class="s4">&quot;temp_frame&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_roundtrip</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_roundtrip</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_execute_sql</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_execute_sql</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">test_read_table</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">iris_frame </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;iris&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">check_iris_frame</span><span class="s3">(</span><span class="s1">iris_frame</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_read_table_columns</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">iris_frame </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span>
            <span class="s4">&quot;iris&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">=[</span><span class="s4">&quot;SepalLength&quot;</span><span class="s3">, </span><span class="s4">&quot;SepalLength&quot;</span><span class="s3">]</span>
        <span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">equalContents</span><span class="s3">(</span><span class="s1">iris_frame</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">.</span><span class="s1">values</span><span class="s3">, [</span><span class="s4">&quot;SepalLength&quot;</span><span class="s3">, </span><span class="s4">&quot;SepalLength&quot;</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_read_table_absent_raises</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;Table this_doesnt_exist not found&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;this_doesnt_exist&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_default_type_conversion</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;types&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

        <span class="s2">assert </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">FloatCol</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">floating</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">IntCol</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">integer</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">BoolCol</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">bool_</span><span class="s3">)</span>

        <span class="s6"># Int column with NA values stays as float</span>
        <span class="s2">assert </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">IntColWithNull</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">floating</span><span class="s3">)</span>
        <span class="s6"># Bool column with NA values becomes object</span>
        <span class="s2">assert </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">BoolColWithNull</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">object</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_bigint</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># int64 should be converted to BigInteger, GH7433</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">data</span><span class="s3">={</span><span class="s4">&quot;i64&quot;</span><span class="s3">: [</span><span class="s5">2</span><span class="s3">**</span><span class="s5">62</span><span class="s3">]})</span>
        <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_bigint&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) == </span><span class="s5">1</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;test_bigint&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">result</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_default_date_load</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;types&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

        <span class="s6"># IMPORTANT - sqlite has no native date type, so shouldn't parse, but</span>
        <span class="s6"># MySQL SHOULD be converted.</span>
        <span class="s2">assert </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">DateCol</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">datetime64</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_datetime_with_timezone</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">request</span><span class="s3">):</span>
        <span class="s6"># edge case that converts postgresql datetime with time zone types</span>
        <span class="s6"># to datetime64[ns,psycopg2.tz.FixedOffsetTimezone..], which is ok</span>
        <span class="s6"># but should be more natural, so coerce to datetime64[ns] for now</span>

        <span class="s2">def </span><span class="s1">check</span><span class="s3">(</span><span class="s1">col</span><span class="s3">):</span>
            <span class="s6"># check that a column is either datetime64[ns]</span>
            <span class="s6"># or datetime64[ns, UTC]</span>
            <span class="s2">if </span><span class="s1">lib</span><span class="s3">.</span><span class="s1">is_np_dtype</span><span class="s3">(</span><span class="s1">col</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s4">&quot;M&quot;</span><span class="s3">):</span>
                <span class="s6"># &quot;2000-01-01 00:00:00-08:00&quot; should convert to</span>
                <span class="s6"># &quot;2000-01-01 08:00:00&quot;</span>
                <span class="s2">assert </span><span class="s1">col</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] == </span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s4">&quot;2000-01-01 08:00:00&quot;</span><span class="s3">)</span>

                <span class="s6"># &quot;2000-06-01 00:00:00-07:00&quot; should convert to</span>
                <span class="s6"># &quot;2000-06-01 07:00:00&quot;</span>
                <span class="s2">assert </span><span class="s1">col</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] == </span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s4">&quot;2000-06-01 07:00:00&quot;</span><span class="s3">)</span>

            <span class="s2">elif </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">col</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">DatetimeTZDtype</span><span class="s3">):</span>
                <span class="s2">assert </span><span class="s1">str</span><span class="s3">(</span><span class="s1">col</span><span class="s3">.</span><span class="s1">dt</span><span class="s3">.</span><span class="s1">tz</span><span class="s3">) == </span><span class="s4">&quot;UTC&quot;</span>

                <span class="s6"># &quot;2000-01-01 00:00:00-08:00&quot; should convert to</span>
                <span class="s6"># &quot;2000-01-01 08:00:00&quot;</span>
                <span class="s6"># &quot;2000-06-01 00:00:00-07:00&quot; should convert to</span>
                <span class="s6"># &quot;2000-06-01 07:00:00&quot;</span>
                <span class="s6"># GH 6415</span>
                <span class="s1">expected_data </span><span class="s3">= [</span>
                    <span class="s1">Timestamp</span><span class="s3">(</span><span class="s4">&quot;2000-01-01 08:00:00&quot;</span><span class="s3">, </span><span class="s1">tz</span><span class="s3">=</span><span class="s4">&quot;UTC&quot;</span><span class="s3">),</span>
                    <span class="s1">Timestamp</span><span class="s3">(</span><span class="s4">&quot;2000-06-01 07:00:00&quot;</span><span class="s3">, </span><span class="s1">tz</span><span class="s3">=</span><span class="s4">&quot;UTC&quot;</span><span class="s3">),</span>
                <span class="s3">]</span>
                <span class="s1">expected </span><span class="s3">= </span><span class="s1">Series</span><span class="s3">(</span><span class="s1">expected_data</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s1">col</span><span class="s3">.</span><span class="s1">name</span><span class="s3">)</span>
                <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_series_equal</span><span class="s3">(</span><span class="s1">col</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">AssertionError</span><span class="s3">(</span>
                    <span class="s4">f&quot;DateCol loaded with incorrect type -&gt; </span><span class="s2">{</span><span class="s1">col</span><span class="s3">.</span><span class="s1">dtype</span><span class="s2">}</span><span class="s4">&quot;</span>
                <span class="s3">)</span>

        <span class="s6"># GH11216</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;select * from types&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s4">&quot;DateColWithTz&quot;</span><span class="s3">):</span>
            <span class="s1">request</span><span class="s3">.</span><span class="s1">node</span><span class="s3">.</span><span class="s1">add_marker</span><span class="s3">(</span>
                <span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span><span class="s1">reason</span><span class="s3">=</span><span class="s4">&quot;no column with datetime with time zone&quot;</span><span class="s3">)</span>
            <span class="s3">)</span>

        <span class="s6"># this is parsed on Travis (linux), but not on macosx for some reason</span>
        <span class="s6"># even with the same versions of psycopg2 &amp; sqlalchemy, possibly a</span>
        <span class="s6"># Postgresql server version difference</span>
        <span class="s1">col </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">DateColWithTz</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">col</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">DatetimeTZDtype</span><span class="s3">)</span>

        <span class="s1">df </span><span class="s3">= </span><span class="s1">read_sql_query</span><span class="s3">(</span>
            <span class="s4">&quot;select * from types&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">parse_dates</span><span class="s3">=[</span><span class="s4">&quot;DateColWithTz&quot;</span><span class="s3">]</span>
        <span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s4">&quot;DateColWithTz&quot;</span><span class="s3">):</span>
            <span class="s1">request</span><span class="s3">.</span><span class="s1">node</span><span class="s3">.</span><span class="s1">add_marker</span><span class="s3">(</span>
                <span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span><span class="s1">reason</span><span class="s3">=</span><span class="s4">&quot;no column with datetime with time zone&quot;</span><span class="s3">)</span>
            <span class="s3">)</span>
        <span class="s1">col </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">DateColWithTz</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">col</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">DatetimeTZDtype</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">str</span><span class="s3">(</span><span class="s1">col</span><span class="s3">.</span><span class="s1">dt</span><span class="s3">.</span><span class="s1">tz</span><span class="s3">) == </span><span class="s4">&quot;UTC&quot;</span>
        <span class="s1">check</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">DateColWithTz</span><span class="s3">)</span>

        <span class="s1">df </span><span class="s3">= </span><span class="s1">concat</span><span class="s3">(</span>
            <span class="s1">list</span><span class="s3">(</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;select * from types&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">chunksize</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)),</span>
            <span class="s1">ignore_index</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">col </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">DateColWithTz</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">col</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">DatetimeTZDtype</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">str</span><span class="s3">(</span><span class="s1">col</span><span class="s3">.</span><span class="s1">dt</span><span class="s3">.</span><span class="s1">tz</span><span class="s3">) == </span><span class="s4">&quot;UTC&quot;</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;types&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">col </span><span class="s3">= </span><span class="s1">expected</span><span class="s3">.</span><span class="s1">DateColWithTz</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">col</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">DatetimeTZDtype</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_series_equal</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">DateColWithTz</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">.</span><span class="s1">DateColWithTz</span><span class="s3">)</span>

        <span class="s6"># xref #7139</span>
        <span class="s6"># this might or might not be converted depending on the postgres driver</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;types&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">check</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">DateColWithTz</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_datetime_with_timezone_roundtrip</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># GH 9086</span>
        <span class="s6"># Write datetimetz data to a db and read it back</span>
        <span class="s6"># For dbs that support timestamps with timezones, should get back UTC</span>
        <span class="s6"># otherwise naive data should be returned</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span><span class="s4">&quot;A&quot;</span><span class="s3">: </span><span class="s1">date_range</span><span class="s3">(</span><span class="s4">&quot;2013-01-01 09:00:00&quot;</span><span class="s3">, </span><span class="s1">periods</span><span class="s3">=</span><span class="s5">3</span><span class="s3">, </span><span class="s1">tz</span><span class="s3">=</span><span class="s4">&quot;US/Pacific&quot;</span><span class="s3">)}</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">expected</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_datetime_tz&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) == </span><span class="s5">3</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">flavor </span><span class="s3">== </span><span class="s4">&quot;postgresql&quot;</span><span class="s3">:</span>
            <span class="s6"># SQLAlchemy &quot;timezones&quot; (i.e. offsets) are coerced to UTC</span>
            <span class="s1">expected</span><span class="s3">[</span><span class="s4">&quot;A&quot;</span><span class="s3">] = </span><span class="s1">expected</span><span class="s3">[</span><span class="s4">&quot;A&quot;</span><span class="s3">].</span><span class="s1">dt</span><span class="s3">.</span><span class="s1">tz_convert</span><span class="s3">(</span><span class="s4">&quot;UTC&quot;</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s6"># Otherwise, timestamps are returned as local, naive</span>
            <span class="s1">expected</span><span class="s3">[</span><span class="s4">&quot;A&quot;</span><span class="s3">] = </span><span class="s1">expected</span><span class="s3">[</span><span class="s4">&quot;A&quot;</span><span class="s3">].</span><span class="s1">dt</span><span class="s3">.</span><span class="s1">tz_localize</span><span class="s3">(</span><span class="s2">None</span><span class="s3">)</span>

        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;test_datetime_tz&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM test_datetime_tz&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">flavor </span><span class="s3">== </span><span class="s4">&quot;sqlite&quot;</span><span class="s3">:</span>
            <span class="s6"># read_sql_query does not return datetime type like read_sql_table</span>
            <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">result</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s4">&quot;A&quot;</span><span class="s3">], </span><span class="s1">str</span><span class="s3">)</span>
            <span class="s1">result</span><span class="s3">[</span><span class="s4">&quot;A&quot;</span><span class="s3">] = </span><span class="s1">to_datetime</span><span class="s3">(</span><span class="s1">result</span><span class="s3">[</span><span class="s4">&quot;A&quot;</span><span class="s3">])</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_out_of_bounds_datetime</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># GH 26761</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;date&quot;</span><span class="s3">: </span><span class="s1">datetime</span><span class="s3">(</span><span class="s5">9999</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)}, </span><span class="s1">index</span><span class="s3">=[</span><span class="s5">0</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">data</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_datetime_obb&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) == </span><span class="s5">1</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;test_datetime_obb&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([</span><span class="s1">pd</span><span class="s3">.</span><span class="s1">NaT</span><span class="s3">], </span><span class="s1">columns</span><span class="s3">=[</span><span class="s4">&quot;date&quot;</span><span class="s3">])</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_naive_datetimeindex_roundtrip</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># GH 23510</span>
        <span class="s6"># Ensure that a naive DatetimeIndex isn't converted to UTC</span>
        <span class="s1">dates </span><span class="s3">= </span><span class="s1">date_range</span><span class="s3">(</span><span class="s4">&quot;2018-01-01&quot;</span><span class="s3">, </span><span class="s1">periods</span><span class="s3">=</span><span class="s5">5</span><span class="s3">, </span><span class="s1">freq</span><span class="s3">=</span><span class="s4">&quot;6H&quot;</span><span class="s3">).</span><span class="s1">_with_freq</span><span class="s3">(</span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;nums&quot;</span><span class="s3">: </span><span class="s1">range</span><span class="s3">(</span><span class="s5">5</span><span class="s3">)}, </span><span class="s1">index</span><span class="s3">=</span><span class="s1">dates</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s3">(</span>
            <span class="s1">expected</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;foo_table&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index_label</span><span class="s3">=</span><span class="s4">&quot;info_date&quot;</span><span class="s3">)</span>
            <span class="s3">== </span><span class="s5">5</span>
        <span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;foo_table&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index_col</span><span class="s3">=</span><span class="s4">&quot;info_date&quot;</span><span class="s3">)</span>
        <span class="s6"># result index with gain a name from a set_index operation; expected</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">, </span><span class="s1">check_names</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_date_parsing</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># No Parsing</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;types&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">expected_type </span><span class="s3">= </span><span class="s1">object </span><span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">flavor </span><span class="s3">== </span><span class="s4">&quot;sqlite&quot; </span><span class="s2">else </span><span class="s1">np</span><span class="s3">.</span><span class="s1">datetime64</span>
        <span class="s2">assert </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">DateCol</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">expected_type</span><span class="s3">)</span>

        <span class="s1">df </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;types&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">parse_dates</span><span class="s3">=[</span><span class="s4">&quot;DateCol&quot;</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">DateCol</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">datetime64</span><span class="s3">)</span>

        <span class="s1">df </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span>
            <span class="s4">&quot;types&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">parse_dates</span><span class="s3">={</span><span class="s4">&quot;DateCol&quot;</span><span class="s3">: </span><span class="s4">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span class="s3">}</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">DateCol</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">datetime64</span><span class="s3">)</span>

        <span class="s1">df </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span>
            <span class="s4">&quot;types&quot;</span><span class="s3">,</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">,</span>
            <span class="s1">parse_dates</span><span class="s3">={</span><span class="s4">&quot;DateCol&quot;</span><span class="s3">: {</span><span class="s4">&quot;format&quot;</span><span class="s3">: </span><span class="s4">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span class="s3">}},</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">DateCol</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">datetime64</span><span class="s3">)</span>

        <span class="s1">df </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;types&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">parse_dates</span><span class="s3">=[</span><span class="s4">&quot;IntDateCol&quot;</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">IntDateCol</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">datetime64</span><span class="s3">)</span>

        <span class="s1">df </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;types&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">parse_dates</span><span class="s3">={</span><span class="s4">&quot;IntDateCol&quot;</span><span class="s3">: </span><span class="s4">&quot;s&quot;</span><span class="s3">})</span>
        <span class="s2">assert </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">IntDateCol</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">datetime64</span><span class="s3">)</span>

        <span class="s1">df </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span>
            <span class="s4">&quot;types&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">parse_dates</span><span class="s3">={</span><span class="s4">&quot;IntDateCol&quot;</span><span class="s3">: {</span><span class="s4">&quot;unit&quot;</span><span class="s3">: </span><span class="s4">&quot;s&quot;</span><span class="s3">}}</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">IntDateCol</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">datetime64</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_datetime</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span><span class="s4">&quot;A&quot;</span><span class="s3">: </span><span class="s1">date_range</span><span class="s3">(</span><span class="s4">&quot;2013-01-01 09:00:00&quot;</span><span class="s3">, </span><span class="s1">periods</span><span class="s3">=</span><span class="s5">3</span><span class="s3">), </span><span class="s4">&quot;B&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">3.0</span><span class="s3">)}</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_datetime&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">) == </span><span class="s5">3</span>

        <span class="s6"># with read_table -&gt; type information from schema used</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;test_datetime&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">result</span><span class="s3">.</span><span class="s1">drop</span><span class="s3">(</span><span class="s4">&quot;index&quot;</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">df</span><span class="s3">)</span>

        <span class="s6"># with read_sql -&gt; no type information -&gt; sqlite has no native</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM test_datetime&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">result</span><span class="s3">.</span><span class="s1">drop</span><span class="s3">(</span><span class="s4">&quot;index&quot;</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">flavor </span><span class="s3">== </span><span class="s4">&quot;sqlite&quot;</span><span class="s3">:</span>
            <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">result</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s4">&quot;A&quot;</span><span class="s3">], </span><span class="s1">str</span><span class="s3">)</span>
            <span class="s1">result</span><span class="s3">[</span><span class="s4">&quot;A&quot;</span><span class="s3">] = </span><span class="s1">to_datetime</span><span class="s3">(</span><span class="s1">result</span><span class="s3">[</span><span class="s4">&quot;A&quot;</span><span class="s3">])</span>
            <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">df</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">df</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_datetime_NaT</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span><span class="s4">&quot;A&quot;</span><span class="s3">: </span><span class="s1">date_range</span><span class="s3">(</span><span class="s4">&quot;2013-01-01 09:00:00&quot;</span><span class="s3">, </span><span class="s1">periods</span><span class="s3">=</span><span class="s5">3</span><span class="s3">), </span><span class="s4">&quot;B&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">3.0</span><span class="s3">)}</span>
        <span class="s3">)</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">[</span><span class="s5">1</span><span class="s3">, </span><span class="s4">&quot;A&quot;</span><span class="s3">] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>
        <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_datetime&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) == </span><span class="s5">3</span>

        <span class="s6"># with read_table -&gt; type information from schema used</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;test_datetime&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">df</span><span class="s3">)</span>

        <span class="s6"># with read_sql -&gt; no type information -&gt; sqlite has no native</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM test_datetime&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">flavor </span><span class="s3">== </span><span class="s4">&quot;sqlite&quot;</span><span class="s3">:</span>
            <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">result</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s4">&quot;A&quot;</span><span class="s3">], </span><span class="s1">str</span><span class="s3">)</span>
            <span class="s1">result</span><span class="s3">[</span><span class="s4">&quot;A&quot;</span><span class="s3">] = </span><span class="s1">to_datetime</span><span class="s3">(</span><span class="s1">result</span><span class="s3">[</span><span class="s4">&quot;A&quot;</span><span class="s3">], </span><span class="s1">errors</span><span class="s3">=</span><span class="s4">&quot;coerce&quot;</span><span class="s3">)</span>
            <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">df</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">df</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_datetime_date</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># test support for datetime.date</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([</span><span class="s1">date</span><span class="s3">(</span><span class="s5">2014</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">), </span><span class="s1">date</span><span class="s3">(</span><span class="s5">2014</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)], </span><span class="s1">columns</span><span class="s3">=[</span><span class="s4">&quot;a&quot;</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_date&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) == </span><span class="s5">2</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;test_date&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">res</span><span class="s3">[</span><span class="s4">&quot;a&quot;</span><span class="s3">]</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">to_datetime</span><span class="s3">(</span><span class="s1">df</span><span class="s3">[</span><span class="s4">&quot;a&quot;</span><span class="s3">])</span>
        <span class="s6"># comes back as datetime64</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_series_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_datetime_time</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">sqlite_buildin</span><span class="s3">):</span>
        <span class="s6"># test support for datetime.time</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([</span><span class="s1">time</span><span class="s3">(</span><span class="s5">9</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">), </span><span class="s1">time</span><span class="s3">(</span><span class="s5">9</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">30</span><span class="s3">)], </span><span class="s1">columns</span><span class="s3">=[</span><span class="s4">&quot;a&quot;</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_time&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) == </span><span class="s5">2</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;test_time&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">df</span><span class="s3">)</span>

        <span class="s6"># GH8341</span>
        <span class="s6"># first, use the fallback to have the sqlite adapter put in place</span>
        <span class="s1">sqlite_conn </span><span class="s3">= </span><span class="s1">sqlite_buildin</span>
        <span class="s2">assert </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s4">&quot;test_time2&quot;</span><span class="s3">, </span><span class="s1">sqlite_conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) == </span><span class="s5">2</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM test_time2&quot;</span><span class="s3">, </span><span class="s1">sqlite_conn</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">map</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">_</span><span class="s3">: </span><span class="s1">_</span><span class="s3">.</span><span class="s1">strftime</span><span class="s3">(</span><span class="s4">&quot;%H:%M:%S.%f&quot;</span><span class="s3">))</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">ref</span><span class="s3">, </span><span class="s1">res</span><span class="s3">)  </span><span class="s6"># check if adapter is in place</span>
        <span class="s6"># then test if sqlalchemy is unaffected by the sqlite adapter</span>
        <span class="s2">assert </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s4">&quot;test_time3&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) == </span><span class="s5">2</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">flavor </span><span class="s3">== </span><span class="s4">&quot;sqlite&quot;</span><span class="s3">:</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM test_time3&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
            <span class="s1">ref </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">map</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">_</span><span class="s3">: </span><span class="s1">_</span><span class="s3">.</span><span class="s1">strftime</span><span class="s3">(</span><span class="s4">&quot;%H:%M:%S.%f&quot;</span><span class="s3">))</span>
            <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">ref</span><span class="s3">, </span><span class="s1">res</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;test_time3&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">res</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_mixed_dtype_insert</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># see GH6509</span>
        <span class="s1">s1 </span><span class="s3">= </span><span class="s1">Series</span><span class="s3">(</span><span class="s5">2</span><span class="s3">**</span><span class="s5">25 </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">int32</span><span class="s3">)</span>
        <span class="s1">s2 </span><span class="s3">= </span><span class="s1">Series</span><span class="s3">(</span><span class="s5">0.0</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;s1&quot;</span><span class="s3">: </span><span class="s1">s1</span><span class="s3">, </span><span class="s4">&quot;s2&quot;</span><span class="s3">: </span><span class="s1">s2</span><span class="s3">})</span>

        <span class="s6"># write and read again</span>
        <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_read_write&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) == </span><span class="s5">1</span>
        <span class="s1">df2 </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;test_read_write&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">df2</span><span class="s3">, </span><span class="s1">check_dtype</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">check_exact</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_nan_numeric</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># NaNs in numeric float column</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;A&quot;</span><span class="s3">: [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], </span><span class="s4">&quot;B&quot;</span><span class="s3">: [</span><span class="s5">0.2</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">5.6</span><span class="s3">]})</span>
        <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_nan&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) == </span><span class="s5">3</span>

        <span class="s6"># with read_table</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;test_nan&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">df</span><span class="s3">)</span>

        <span class="s6"># with read_sql</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM test_nan&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">df</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_nan_fullcolumn</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># full NaN column (numeric float column)</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;A&quot;</span><span class="s3">: [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], </span><span class="s4">&quot;B&quot;</span><span class="s3">: [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">]})</span>
        <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_nan&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) == </span><span class="s5">3</span>

        <span class="s6"># with read_table</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;test_nan&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">df</span><span class="s3">)</span>

        <span class="s6"># with read_sql -&gt; not type info from table -&gt; stays None</span>
        <span class="s1">df</span><span class="s3">[</span><span class="s4">&quot;B&quot;</span><span class="s3">] = </span><span class="s1">df</span><span class="s3">[</span><span class="s4">&quot;B&quot;</span><span class="s3">].</span><span class="s1">astype</span><span class="s3">(</span><span class="s4">&quot;object&quot;</span><span class="s3">)</span>
        <span class="s1">df</span><span class="s3">[</span><span class="s4">&quot;B&quot;</span><span class="s3">] = </span><span class="s2">None</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM test_nan&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">df</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_nan_string</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># NaNs in string column</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;A&quot;</span><span class="s3">: [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], </span><span class="s4">&quot;B&quot;</span><span class="s3">: [</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">]})</span>
        <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_nan&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) == </span><span class="s5">3</span>

        <span class="s6"># NaNs are coming back as None</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">[</span><span class="s5">2</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">] = </span><span class="s2">None</span>

        <span class="s6"># with read_table</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;test_nan&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">df</span><span class="s3">)</span>

        <span class="s6"># with read_sql</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM test_nan&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">df</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_get_index_columns</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">tbl_name</span><span class="s3">):</span>
        <span class="s2">from </span><span class="s1">sqlalchemy </span><span class="s2">import </span><span class="s1">inspect</span>

        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

        <span class="s1">ixs </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_indexes</span><span class="s3">(</span><span class="s1">tbl_name</span><span class="s3">)</span>
        <span class="s1">ixs </span><span class="s3">= [</span><span class="s1">i</span><span class="s3">[</span><span class="s4">&quot;column_names&quot;</span><span class="s3">] </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">ixs</span><span class="s3">]</span>
        <span class="s2">return </span><span class="s1">ixs</span>

    <span class="s2">def </span><span class="s1">test_to_sql_save_index</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_to_sql_save_index</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">test_transactions</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_transaction_test</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">test_get_schema_create_table</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_frame3</span><span class="s3">):</span>
        <span class="s6"># Use a dataframe without a bool column, since MySQL converts bool to</span>
        <span class="s6"># TINYINT (which read_sql_table returns as an int and causes a dtype</span>
        <span class="s6"># mismatch)</span>
        <span class="s2">from </span><span class="s1">sqlalchemy </span><span class="s2">import </span><span class="s1">text</span>
        <span class="s2">from </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">engine </span><span class="s2">import </span><span class="s1">Engine</span>

        <span class="s1">tbl </span><span class="s3">= </span><span class="s4">&quot;test_get_schema_create_table&quot;</span>
        <span class="s1">create_sql </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">get_schema</span><span class="s3">(</span><span class="s1">test_frame3</span><span class="s3">, </span><span class="s1">tbl</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">blank_test_df </span><span class="s3">= </span><span class="s1">test_frame3</span><span class="s3">.</span><span class="s1">iloc</span><span class="s3">[:</span><span class="s5">0</span><span class="s3">]</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">drop_table</span><span class="s3">(</span><span class="s1">tbl</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">create_sql </span><span class="s3">= </span><span class="s1">text</span><span class="s3">(</span><span class="s1">create_sql</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">Engine</span><span class="s3">):</span>
            <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">() </span><span class="s2">as </span><span class="s1">conn</span><span class="s3">:</span>
                <span class="s2">with </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">():</span>
                    <span class="s1">conn</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">create_sql</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">():</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">create_sql</span><span class="s3">)</span>
        <span class="s1">returned_df </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s1">tbl</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">returned_df</span><span class="s3">, </span><span class="s1">blank_test_df</span><span class="s3">, </span><span class="s1">check_index_type</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">drop_table</span><span class="s3">(</span><span class="s1">tbl</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_dtype</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">from </span><span class="s1">sqlalchemy </span><span class="s2">import </span><span class="s3">(</span>
            <span class="s1">TEXT</span><span class="s3">,</span>
            <span class="s1">String</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s2">from </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">schema </span><span class="s2">import </span><span class="s1">MetaData</span>

        <span class="s1">cols </span><span class="s3">= [</span><span class="s4">&quot;A&quot;</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">]</span>
        <span class="s1">data </span><span class="s3">= [(</span><span class="s5">0.8</span><span class="s3">, </span><span class="s2">True</span><span class="s3">), (</span><span class="s5">0.9</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)]</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">cols</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;dtype_test&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">) == </span><span class="s5">2</span>
        <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;dtype_test2&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">={</span><span class="s4">&quot;B&quot;</span><span class="s3">: </span><span class="s1">TEXT</span><span class="s3">}) == </span><span class="s5">2</span>
        <span class="s1">meta </span><span class="s3">= </span><span class="s1">MetaData</span><span class="s3">()</span>
        <span class="s1">meta</span><span class="s3">.</span><span class="s1">reflect</span><span class="s3">(</span><span class="s1">bind</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">sqltype </span><span class="s3">= </span><span class="s1">meta</span><span class="s3">.</span><span class="s1">tables</span><span class="s3">[</span><span class="s4">&quot;dtype_test2&quot;</span><span class="s3">].</span><span class="s1">columns</span><span class="s3">[</span><span class="s4">&quot;B&quot;</span><span class="s3">].</span><span class="s1">type</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">sqltype</span><span class="s3">, </span><span class="s1">TEXT</span><span class="s3">)</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;The type of B is not a SQLAlchemy type&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;error&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">={</span><span class="s4">&quot;B&quot;</span><span class="s3">: </span><span class="s1">str</span><span class="s3">})</span>

        <span class="s6"># GH9083</span>
        <span class="s2">assert </span><span class="s3">(</span>
            <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;dtype_test3&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">={</span><span class="s4">&quot;B&quot;</span><span class="s3">: </span><span class="s1">String</span><span class="s3">(</span><span class="s5">10</span><span class="s3">)}) == </span><span class="s5">2</span>
        <span class="s3">)</span>
        <span class="s1">meta</span><span class="s3">.</span><span class="s1">reflect</span><span class="s3">(</span><span class="s1">bind</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">sqltype </span><span class="s3">= </span><span class="s1">meta</span><span class="s3">.</span><span class="s1">tables</span><span class="s3">[</span><span class="s4">&quot;dtype_test3&quot;</span><span class="s3">].</span><span class="s1">columns</span><span class="s3">[</span><span class="s4">&quot;B&quot;</span><span class="s3">].</span><span class="s1">type</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">sqltype</span><span class="s3">, </span><span class="s1">String</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">sqltype</span><span class="s3">.</span><span class="s1">length </span><span class="s3">== </span><span class="s5">10</span>

        <span class="s6"># single dtype</span>
        <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;single_dtype_test&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">TEXT</span><span class="s3">) == </span><span class="s5">2</span>
        <span class="s1">meta</span><span class="s3">.</span><span class="s1">reflect</span><span class="s3">(</span><span class="s1">bind</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">sqltypea </span><span class="s3">= </span><span class="s1">meta</span><span class="s3">.</span><span class="s1">tables</span><span class="s3">[</span><span class="s4">&quot;single_dtype_test&quot;</span><span class="s3">].</span><span class="s1">columns</span><span class="s3">[</span><span class="s4">&quot;A&quot;</span><span class="s3">].</span><span class="s1">type</span>
        <span class="s1">sqltypeb </span><span class="s3">= </span><span class="s1">meta</span><span class="s3">.</span><span class="s1">tables</span><span class="s3">[</span><span class="s4">&quot;single_dtype_test&quot;</span><span class="s3">].</span><span class="s1">columns</span><span class="s3">[</span><span class="s4">&quot;B&quot;</span><span class="s3">].</span><span class="s1">type</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">sqltypea</span><span class="s3">, </span><span class="s1">TEXT</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">sqltypeb</span><span class="s3">, </span><span class="s1">TEXT</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_notna_dtype</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">from </span><span class="s1">sqlalchemy </span><span class="s2">import </span><span class="s3">(</span>
            <span class="s1">Boolean</span><span class="s3">,</span>
            <span class="s1">DateTime</span><span class="s3">,</span>
            <span class="s1">Float</span><span class="s3">,</span>
            <span class="s1">Integer</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s2">from </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">schema </span><span class="s2">import </span><span class="s1">MetaData</span>

        <span class="s1">cols </span><span class="s3">= {</span>
            <span class="s4">&quot;Bool&quot;</span><span class="s3">: </span><span class="s1">Series</span><span class="s3">([</span><span class="s2">True</span><span class="s3">, </span><span class="s2">None</span><span class="s3">]),</span>
            <span class="s4">&quot;Date&quot;</span><span class="s3">: </span><span class="s1">Series</span><span class="s3">([</span><span class="s1">datetime</span><span class="s3">(</span><span class="s5">2012</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">1</span><span class="s3">), </span><span class="s2">None</span><span class="s3">]),</span>
            <span class="s4">&quot;Int&quot;</span><span class="s3">: </span><span class="s1">Series</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s2">None</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;object&quot;</span><span class="s3">),</span>
            <span class="s4">&quot;Float&quot;</span><span class="s3">: </span><span class="s1">Series</span><span class="s3">([</span><span class="s5">1.1</span><span class="s3">, </span><span class="s2">None</span><span class="s3">]),</span>
        <span class="s3">}</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">cols</span><span class="s3">)</span>

        <span class="s1">tbl </span><span class="s3">= </span><span class="s4">&quot;notna_dtype_test&quot;</span>
        <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s1">tbl</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">) == </span><span class="s5">2</span>
        <span class="s1">_ </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s1">tbl</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">meta </span><span class="s3">= </span><span class="s1">MetaData</span><span class="s3">()</span>
        <span class="s1">meta</span><span class="s3">.</span><span class="s1">reflect</span><span class="s3">(</span><span class="s1">bind</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">my_type </span><span class="s3">= </span><span class="s1">Integer </span><span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">flavor </span><span class="s3">== </span><span class="s4">&quot;mysql&quot; </span><span class="s2">else </span><span class="s1">Boolean</span>
        <span class="s1">col_dict </span><span class="s3">= </span><span class="s1">meta</span><span class="s3">.</span><span class="s1">tables</span><span class="s3">[</span><span class="s1">tbl</span><span class="s3">].</span><span class="s1">columns</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">col_dict</span><span class="s3">[</span><span class="s4">&quot;Bool&quot;</span><span class="s3">].</span><span class="s1">type</span><span class="s3">, </span><span class="s1">my_type</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">col_dict</span><span class="s3">[</span><span class="s4">&quot;Date&quot;</span><span class="s3">].</span><span class="s1">type</span><span class="s3">, </span><span class="s1">DateTime</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">col_dict</span><span class="s3">[</span><span class="s4">&quot;Int&quot;</span><span class="s3">].</span><span class="s1">type</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">col_dict</span><span class="s3">[</span><span class="s4">&quot;Float&quot;</span><span class="s3">].</span><span class="s1">type</span><span class="s3">, </span><span class="s1">Float</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_double_precision</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">from </span><span class="s1">sqlalchemy </span><span class="s2">import </span><span class="s3">(</span>
            <span class="s1">BigInteger</span><span class="s3">,</span>
            <span class="s1">Float</span><span class="s3">,</span>
            <span class="s1">Integer</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s2">from </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">schema </span><span class="s2">import </span><span class="s1">MetaData</span>

        <span class="s1">V </span><span class="s3">= </span><span class="s5">1.23456789101112131415</span>

        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span>
                <span class="s4">&quot;f32&quot;</span><span class="s3">: </span><span class="s1">Series</span><span class="s3">([</span><span class="s1">V</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;float32&quot;</span><span class="s3">),</span>
                <span class="s4">&quot;f64&quot;</span><span class="s3">: </span><span class="s1">Series</span><span class="s3">([</span><span class="s1">V</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;float64&quot;</span><span class="s3">),</span>
                <span class="s4">&quot;f64_as_f32&quot;</span><span class="s3">: </span><span class="s1">Series</span><span class="s3">([</span><span class="s1">V</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;float64&quot;</span><span class="s3">),</span>
                <span class="s4">&quot;i32&quot;</span><span class="s3">: </span><span class="s1">Series</span><span class="s3">([</span><span class="s5">5</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;int32&quot;</span><span class="s3">),</span>
                <span class="s4">&quot;i64&quot;</span><span class="s3">: </span><span class="s1">Series</span><span class="s3">([</span><span class="s5">5</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;int64&quot;</span><span class="s3">),</span>
            <span class="s3">}</span>
        <span class="s3">)</span>

        <span class="s2">assert </span><span class="s3">(</span>
            <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span>
                <span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_dtypes&quot;</span><span class="s3">,</span>
                <span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">,</span>
                <span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
                <span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;replace&quot;</span><span class="s3">,</span>
                <span class="s1">dtype</span><span class="s3">={</span><span class="s4">&quot;f64_as_f32&quot;</span><span class="s3">: </span><span class="s1">Float</span><span class="s3">(</span><span class="s1">precision</span><span class="s3">=</span><span class="s5">23</span><span class="s3">)},</span>
            <span class="s3">)</span>
            <span class="s3">== </span><span class="s5">1</span>
        <span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;test_dtypes&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

        <span class="s6"># check precision of float64</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">round</span><span class="s3">(</span><span class="s1">df</span><span class="s3">[</span><span class="s4">&quot;f64&quot;</span><span class="s3">].</span><span class="s1">iloc</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s5">14</span><span class="s3">) == </span><span class="s1">np</span><span class="s3">.</span><span class="s1">round</span><span class="s3">(</span><span class="s1">res</span><span class="s3">[</span><span class="s4">&quot;f64&quot;</span><span class="s3">].</span><span class="s1">iloc</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s5">14</span><span class="s3">)</span>

        <span class="s6"># check sql types</span>
        <span class="s1">meta </span><span class="s3">= </span><span class="s1">MetaData</span><span class="s3">()</span>
        <span class="s1">meta</span><span class="s3">.</span><span class="s1">reflect</span><span class="s3">(</span><span class="s1">bind</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">col_dict </span><span class="s3">= </span><span class="s1">meta</span><span class="s3">.</span><span class="s1">tables</span><span class="s3">[</span><span class="s4">&quot;test_dtypes&quot;</span><span class="s3">].</span><span class="s1">columns</span>
        <span class="s2">assert </span><span class="s1">str</span><span class="s3">(</span><span class="s1">col_dict</span><span class="s3">[</span><span class="s4">&quot;f32&quot;</span><span class="s3">].</span><span class="s1">type</span><span class="s3">) == </span><span class="s1">str</span><span class="s3">(</span><span class="s1">col_dict</span><span class="s3">[</span><span class="s4">&quot;f64_as_f32&quot;</span><span class="s3">].</span><span class="s1">type</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">col_dict</span><span class="s3">[</span><span class="s4">&quot;f32&quot;</span><span class="s3">].</span><span class="s1">type</span><span class="s3">, </span><span class="s1">Float</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">col_dict</span><span class="s3">[</span><span class="s4">&quot;f64&quot;</span><span class="s3">].</span><span class="s1">type</span><span class="s3">, </span><span class="s1">Float</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">col_dict</span><span class="s3">[</span><span class="s4">&quot;i32&quot;</span><span class="s3">].</span><span class="s1">type</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">col_dict</span><span class="s3">[</span><span class="s4">&quot;i64&quot;</span><span class="s3">].</span><span class="s1">type</span><span class="s3">, </span><span class="s1">BigInteger</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_connectable_issue_example</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># This tests the example raised in issue</span>
        <span class="s6"># https://github.com/pandas-dev/pandas/issues/10104</span>
        <span class="s2">from </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">engine </span><span class="s2">import </span><span class="s1">Engine</span>

        <span class="s2">def </span><span class="s1">test_select</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">):</span>
            <span class="s1">query </span><span class="s3">= </span><span class="s4">&quot;SELECT test_foo_data FROM test_foo_data&quot;</span>
            <span class="s2">return </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s1">query</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">connection</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">test_append</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">, </span><span class="s1">data</span><span class="s3">):</span>
            <span class="s1">data</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_foo_data&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">connection</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;append&quot;</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">test_connectable</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">):</span>
            <span class="s6"># https://github.com/sqlalchemy/sqlalchemy/commit/</span>
            <span class="s6"># 00b5c10846e800304caa86549ab9da373b42fa5d#r48323973</span>
            <span class="s1">foo_data </span><span class="s3">= </span><span class="s1">test_select</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">)</span>
            <span class="s1">test_append</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">foo_data</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">main</span><span class="s3">(</span><span class="s1">connectable</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">connectable</span><span class="s3">, </span><span class="s1">Engine</span><span class="s3">):</span>
                <span class="s2">with </span><span class="s1">connectable</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">() </span><span class="s2">as </span><span class="s1">conn</span><span class="s3">:</span>
                    <span class="s2">with </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">():</span>
                        <span class="s1">test_connectable</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">test_connectable</span><span class="s3">(</span><span class="s1">connectable</span><span class="s3">)</span>

        <span class="s2">assert </span><span class="s3">(</span>
            <span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;test_foo_data&quot;</span><span class="s3">: [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]}).</span><span class="s1">to_sql</span><span class="s3">(</span>
                <span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_foo_data&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span>
            <span class="s3">)</span>
            <span class="s3">== </span><span class="s5">3</span>
        <span class="s3">)</span>
        <span class="s1">main</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
        <span class="s4">&quot;input&quot;</span><span class="s3">,</span>
        <span class="s3">[{</span><span class="s4">&quot;foo&quot;</span><span class="s3">: [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">]}, {</span><span class="s4">&quot;foo&quot;</span><span class="s3">: [-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">]}, {</span><span class="s4">&quot;foo&quot;</span><span class="s3">: [-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">], </span><span class="s4">&quot;infe0&quot;</span><span class="s3">: [</span><span class="s4">&quot;bar&quot;</span><span class="s3">]}],</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_to_sql_with_negative_npinf</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">input</span><span class="s3">, </span><span class="s1">request</span><span class="s3">):</span>
        <span class="s6"># GH 34431</span>

        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">input</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">flavor </span><span class="s3">== </span><span class="s4">&quot;mysql&quot;</span><span class="s3">:</span>
            <span class="s6"># GH 36465</span>
            <span class="s6"># The input {&quot;foo&quot;: [-np.inf], &quot;infe0&quot;: [&quot;bar&quot;]} does not raise any error</span>
            <span class="s6"># for pymysql version &gt;= 0.10</span>
            <span class="s6"># TODO(GH#36465): remove this version check after GH 36465 is fixed</span>
            <span class="s1">pymysql </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pymysql&quot;</span><span class="s3">)</span>

            <span class="s2">if </span><span class="s3">(</span>
                <span class="s1">Version</span><span class="s3">(</span><span class="s1">pymysql</span><span class="s3">.</span><span class="s1">__version__</span><span class="s3">) &lt; </span><span class="s1">Version</span><span class="s3">(</span><span class="s4">&quot;1.0.3&quot;</span><span class="s3">)</span>
                <span class="s2">and </span><span class="s4">&quot;infe0&quot; </span><span class="s2">in </span><span class="s1">df</span><span class="s3">.</span><span class="s1">columns</span>
            <span class="s3">):</span>
                <span class="s1">mark </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span><span class="s1">reason</span><span class="s3">=</span><span class="s4">&quot;GH 36465&quot;</span><span class="s3">)</span>
                <span class="s1">request</span><span class="s3">.</span><span class="s1">node</span><span class="s3">.</span><span class="s1">add_marker</span><span class="s3">(</span><span class="s1">mark</span><span class="s3">)</span>

            <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;inf cannot be used with MySQL&quot;</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
                <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;foobar&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;foobar&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) == </span><span class="s5">1</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;foobar&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
            <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">res</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_temporary_table</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">from </span><span class="s1">sqlalchemy </span><span class="s2">import </span><span class="s3">(</span>
            <span class="s1">Column</span><span class="s3">,</span>
            <span class="s1">Integer</span><span class="s3">,</span>
            <span class="s1">Unicode</span><span class="s3">,</span>
            <span class="s1">select</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s2">from </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">orm </span><span class="s2">import </span><span class="s3">(</span>
            <span class="s1">Session</span><span class="s3">,</span>
            <span class="s1">declarative_base</span><span class="s3">,</span>
        <span class="s3">)</span>

        <span class="s1">test_data </span><span class="s3">= </span><span class="s4">&quot;Hello, World!&quot;</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;spam&quot;</span><span class="s3">: [</span><span class="s1">test_data</span><span class="s3">]})</span>
        <span class="s1">Base </span><span class="s3">= </span><span class="s1">declarative_base</span><span class="s3">()</span>

        <span class="s2">class </span><span class="s1">Temporary</span><span class="s3">(</span><span class="s1">Base</span><span class="s3">):</span>
            <span class="s1">__tablename__ </span><span class="s3">= </span><span class="s4">&quot;temp_test&quot;</span>
            <span class="s1">__table_args__ </span><span class="s3">= {</span><span class="s4">&quot;prefixes&quot;</span><span class="s3">: [</span><span class="s4">&quot;TEMPORARY&quot;</span><span class="s3">]}</span>
            <span class="s1">id </span><span class="s3">= </span><span class="s1">Column</span><span class="s3">(</span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">primary_key</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
            <span class="s1">spam </span><span class="s3">= </span><span class="s1">Column</span><span class="s3">(</span><span class="s1">Unicode</span><span class="s3">(</span><span class="s5">30</span><span class="s3">), </span><span class="s1">nullable</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">Session</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">) </span><span class="s2">as </span><span class="s1">session</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">session</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">():</span>
                <span class="s1">conn </span><span class="s3">= </span><span class="s1">session</span><span class="s3">.</span><span class="s1">connection</span><span class="s3">()</span>
                <span class="s1">Temporary</span><span class="s3">.</span><span class="s1">__table__</span><span class="s3">.</span><span class="s1">create</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">)</span>
                <span class="s1">session</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">Temporary</span><span class="s3">(</span><span class="s1">spam</span><span class="s3">=</span><span class="s1">test_data</span><span class="s3">))</span>
                <span class="s1">session</span><span class="s3">.</span><span class="s1">flush</span><span class="s3">()</span>
                <span class="s1">df </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s1">sql</span><span class="s3">=</span><span class="s1">select</span><span class="s3">(</span><span class="s1">Temporary</span><span class="s3">.</span><span class="s1">spam</span><span class="s3">), </span><span class="s1">con</span><span class="s3">=</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s6"># -- SQL Engine tests (in the base class for now)</span>
    <span class="s2">def </span><span class="s1">test_invalid_engine</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">):</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;engine must be one of 'auto', 'sqlalchemy'&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_to_sql_with_sql_engine</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">, </span><span class="s4">&quot;bad_engine&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_options_sqlalchemy</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">):</span>
        <span class="s6"># use the set option</span>
        <span class="s2">with </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">option_context</span><span class="s3">(</span><span class="s4">&quot;io.sql.engine&quot;</span><span class="s3">, </span><span class="s4">&quot;sqlalchemy&quot;</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_to_sql_with_sql_engine</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_options_auto</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">):</span>
        <span class="s6"># use the set option</span>
        <span class="s2">with </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">option_context</span><span class="s3">(</span><span class="s4">&quot;io.sql.engine&quot;</span><span class="s3">, </span><span class="s4">&quot;auto&quot;</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_to_sql_with_sql_engine</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_options_get_engine</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">get_engine</span><span class="s3">(</span><span class="s4">&quot;sqlalchemy&quot;</span><span class="s3">), </span><span class="s1">SQLAlchemyEngine</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">option_context</span><span class="s3">(</span><span class="s4">&quot;io.sql.engine&quot;</span><span class="s3">, </span><span class="s4">&quot;sqlalchemy&quot;</span><span class="s3">):</span>
            <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">get_engine</span><span class="s3">(</span><span class="s4">&quot;auto&quot;</span><span class="s3">), </span><span class="s1">SQLAlchemyEngine</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">get_engine</span><span class="s3">(</span><span class="s4">&quot;sqlalchemy&quot;</span><span class="s3">), </span><span class="s1">SQLAlchemyEngine</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">option_context</span><span class="s3">(</span><span class="s4">&quot;io.sql.engine&quot;</span><span class="s3">, </span><span class="s4">&quot;auto&quot;</span><span class="s3">):</span>
            <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">get_engine</span><span class="s3">(</span><span class="s4">&quot;auto&quot;</span><span class="s3">), </span><span class="s1">SQLAlchemyEngine</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">get_engine</span><span class="s3">(</span><span class="s4">&quot;sqlalchemy&quot;</span><span class="s3">), </span><span class="s1">SQLAlchemyEngine</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_get_engine_auto_error_message</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Expect different error messages from get_engine(engine=&quot;auto&quot;)</span>
        <span class="s6"># if engines aren't installed vs. are installed but bad version</span>
        <span class="s2">pass</span>
        <span class="s6"># TODO(GH#36893) fill this in when we add more engines</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;func&quot;</span><span class="s3">, [</span><span class="s4">&quot;read_sql&quot;</span><span class="s3">, </span><span class="s4">&quot;read_sql_query&quot;</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_read_sql_dtype_backend</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">string_storage</span><span class="s3">, </span><span class="s1">func</span><span class="s3">, </span><span class="s1">dtype_backend</span><span class="s3">):</span>
        <span class="s6"># GH#50048</span>
        <span class="s1">table </span><span class="s3">= </span><span class="s4">&quot;test&quot;</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dtype_backend_data</span><span class="s3">()</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s1">table</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;replace&quot;</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">option_context</span><span class="s3">(</span><span class="s4">&quot;mode.string_storage&quot;</span><span class="s3">, </span><span class="s1">string_storage</span><span class="s3">):</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">pd</span><span class="s3">, </span><span class="s1">func</span><span class="s3">)(</span>
                <span class="s4">f&quot;Select * from </span><span class="s2">{</span><span class="s1">table</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">dtype_backend</span><span class="s3">=</span><span class="s1">dtype_backend</span>
            <span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dtype_backend_expected</span><span class="s3">(</span><span class="s1">string_storage</span><span class="s3">, </span><span class="s1">dtype_backend</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">option_context</span><span class="s3">(</span><span class="s4">&quot;mode.string_storage&quot;</span><span class="s3">, </span><span class="s1">string_storage</span><span class="s3">):</span>
            <span class="s1">iterator </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">pd</span><span class="s3">, </span><span class="s1">func</span><span class="s3">)(</span>
                <span class="s4">f&quot;Select * from </span><span class="s2">{</span><span class="s1">table</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
                <span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">,</span>
                <span class="s1">dtype_backend</span><span class="s3">=</span><span class="s1">dtype_backend</span><span class="s3">,</span>
                <span class="s1">chunksize</span><span class="s3">=</span><span class="s5">3</span><span class="s3">,</span>
            <span class="s3">)</span>
            <span class="s1">expected </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dtype_backend_expected</span><span class="s3">(</span><span class="s1">string_storage</span><span class="s3">, </span><span class="s1">dtype_backend</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">result </span><span class="s2">in </span><span class="s1">iterator</span><span class="s3">:</span>
                <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;func&quot;</span><span class="s3">, [</span><span class="s4">&quot;read_sql&quot;</span><span class="s3">, </span><span class="s4">&quot;read_sql_table&quot;</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_read_sql_dtype_backend_table</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">string_storage</span><span class="s3">, </span><span class="s1">func</span><span class="s3">, </span><span class="s1">dtype_backend</span><span class="s3">):</span>
        <span class="s6"># GH#50048</span>
        <span class="s1">table </span><span class="s3">= </span><span class="s4">&quot;test&quot;</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dtype_backend_data</span><span class="s3">()</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s1">table</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;replace&quot;</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">option_context</span><span class="s3">(</span><span class="s4">&quot;mode.string_storage&quot;</span><span class="s3">, </span><span class="s1">string_storage</span><span class="s3">):</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">pd</span><span class="s3">, </span><span class="s1">func</span><span class="s3">)(</span><span class="s1">table</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">dtype_backend</span><span class="s3">=</span><span class="s1">dtype_backend</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dtype_backend_expected</span><span class="s3">(</span><span class="s1">string_storage</span><span class="s3">, </span><span class="s1">dtype_backend</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">option_context</span><span class="s3">(</span><span class="s4">&quot;mode.string_storage&quot;</span><span class="s3">, </span><span class="s1">string_storage</span><span class="s3">):</span>
            <span class="s1">iterator </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">pd</span><span class="s3">, </span><span class="s1">func</span><span class="s3">)(</span>
                <span class="s1">table</span><span class="s3">,</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">,</span>
                <span class="s1">dtype_backend</span><span class="s3">=</span><span class="s1">dtype_backend</span><span class="s3">,</span>
                <span class="s1">chunksize</span><span class="s3">=</span><span class="s5">3</span><span class="s3">,</span>
            <span class="s3">)</span>
            <span class="s1">expected </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dtype_backend_expected</span><span class="s3">(</span><span class="s1">string_storage</span><span class="s3">, </span><span class="s1">dtype_backend</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">result </span><span class="s2">in </span><span class="s1">iterator</span><span class="s3">:</span>
                <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;func&quot;</span><span class="s3">, [</span><span class="s4">&quot;read_sql&quot;</span><span class="s3">, </span><span class="s4">&quot;read_sql_table&quot;</span><span class="s3">, </span><span class="s4">&quot;read_sql_query&quot;</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_read_sql_invalid_dtype_backend_table</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">func</span><span class="s3">):</span>
        <span class="s1">table </span><span class="s3">= </span><span class="s4">&quot;test&quot;</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dtype_backend_data</span><span class="s3">()</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s1">table</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;replace&quot;</span><span class="s3">)</span>

        <span class="s1">msg </span><span class="s3">= (</span>
            <span class="s4">&quot;dtype_backend numpy is invalid, only 'numpy_nullable' and &quot;</span>
            <span class="s4">&quot;'pyarrow' are allowed.&quot;</span>
        <span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">getattr</span><span class="s3">(</span><span class="s1">pd</span><span class="s3">, </span><span class="s1">func</span><span class="s3">)(</span><span class="s1">table</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">dtype_backend</span><span class="s3">=</span><span class="s4">&quot;numpy&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">dtype_backend_data</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; DataFrame</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span>
                <span class="s4">&quot;a&quot;</span><span class="s3">: </span><span class="s1">Series</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;Int64&quot;</span><span class="s3">),</span>
                <span class="s4">&quot;b&quot;</span><span class="s3">: </span><span class="s1">Series</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;Int64&quot;</span><span class="s3">),</span>
                <span class="s4">&quot;c&quot;</span><span class="s3">: </span><span class="s1">Series</span><span class="s3">([</span><span class="s5">1.5</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">2.5</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;Float64&quot;</span><span class="s3">),</span>
                <span class="s4">&quot;d&quot;</span><span class="s3">: </span><span class="s1">Series</span><span class="s3">([</span><span class="s5">1.5</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">, </span><span class="s5">2.5</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;Float64&quot;</span><span class="s3">),</span>
                <span class="s4">&quot;e&quot;</span><span class="s3">: [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">None</span><span class="s3">],</span>
                <span class="s4">&quot;f&quot;</span><span class="s3">: [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">],</span>
                <span class="s4">&quot;g&quot;</span><span class="s3">: [</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span><span class="s3">, </span><span class="s4">&quot;c&quot;</span><span class="s3">],</span>
                <span class="s4">&quot;h&quot;</span><span class="s3">: [</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">],</span>
            <span class="s3">}</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">dtype_backend_expected</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">storage</span><span class="s3">, </span><span class="s1">dtype_backend</span><span class="s3">) </span><span class="s1">-&gt; DataFrame</span><span class="s3">:</span>
        <span class="s1">string_array</span><span class="s3">: </span><span class="s1">StringArray </span><span class="s3">| </span><span class="s1">ArrowStringArray</span>
        <span class="s1">string_array_na</span><span class="s3">: </span><span class="s1">StringArray </span><span class="s3">| </span><span class="s1">ArrowStringArray</span>
        <span class="s2">if </span><span class="s1">storage </span><span class="s3">== </span><span class="s4">&quot;python&quot;</span><span class="s3">:</span>
            <span class="s1">string_array </span><span class="s3">= </span><span class="s1">StringArray</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span><span class="s3">, </span><span class="s4">&quot;c&quot;</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">object_</span><span class="s3">))</span>
            <span class="s1">string_array_na </span><span class="s3">= </span><span class="s1">StringArray</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span><span class="s3">, </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">NA</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">object_</span><span class="s3">))</span>

        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">pa </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pyarrow&quot;</span><span class="s3">)</span>
            <span class="s1">string_array </span><span class="s3">= </span><span class="s1">ArrowStringArray</span><span class="s3">(</span><span class="s1">pa</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span><span class="s3">, </span><span class="s4">&quot;c&quot;</span><span class="s3">]))</span>
            <span class="s1">string_array_na </span><span class="s3">= </span><span class="s1">ArrowStringArray</span><span class="s3">(</span><span class="s1">pa</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">]))</span>

        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span>
                <span class="s4">&quot;a&quot;</span><span class="s3">: </span><span class="s1">Series</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;Int64&quot;</span><span class="s3">),</span>
                <span class="s4">&quot;b&quot;</span><span class="s3">: </span><span class="s1">Series</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;Int64&quot;</span><span class="s3">),</span>
                <span class="s4">&quot;c&quot;</span><span class="s3">: </span><span class="s1">Series</span><span class="s3">([</span><span class="s5">1.5</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">2.5</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;Float64&quot;</span><span class="s3">),</span>
                <span class="s4">&quot;d&quot;</span><span class="s3">: </span><span class="s1">Series</span><span class="s3">([</span><span class="s5">1.5</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">, </span><span class="s5">2.5</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;Float64&quot;</span><span class="s3">),</span>
                <span class="s4">&quot;e&quot;</span><span class="s3">: </span><span class="s1">Series</span><span class="s3">([</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">NA</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;boolean&quot;</span><span class="s3">),</span>
                <span class="s4">&quot;f&quot;</span><span class="s3">: </span><span class="s1">Series</span><span class="s3">([</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;boolean&quot;</span><span class="s3">),</span>
                <span class="s4">&quot;g&quot;</span><span class="s3">: </span><span class="s1">string_array</span><span class="s3">,</span>
                <span class="s4">&quot;h&quot;</span><span class="s3">: </span><span class="s1">string_array_na</span><span class="s3">,</span>
            <span class="s3">}</span>
        <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">dtype_backend </span><span class="s3">== </span><span class="s4">&quot;pyarrow&quot;</span><span class="s3">:</span>
            <span class="s1">pa </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pyarrow&quot;</span><span class="s3">)</span>

            <span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">arrays </span><span class="s2">import </span><span class="s1">ArrowExtensionArray</span>

            <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
                <span class="s3">{</span>
                    <span class="s1">col</span><span class="s3">: </span><span class="s1">ArrowExtensionArray</span><span class="s3">(</span><span class="s1">pa</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">df</span><span class="s3">[</span><span class="s1">col</span><span class="s3">], </span><span class="s1">from_pandas</span><span class="s3">=</span><span class="s2">True</span><span class="s3">))</span>
                    <span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">df</span><span class="s3">.</span><span class="s1">columns</span>
                <span class="s3">}</span>
            <span class="s3">)</span>
        <span class="s2">return </span><span class="s1">df</span>

    <span class="s2">def </span><span class="s1">test_chunksize_empty_dtypes</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># GH#50245</span>
        <span class="s1">dtypes </span><span class="s3">= {</span><span class="s4">&quot;a&quot;</span><span class="s3">: </span><span class="s4">&quot;int64&quot;</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span><span class="s3">: </span><span class="s4">&quot;object&quot;</span><span class="s3">}</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">columns</span><span class="s3">=[</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span><span class="s3">]).</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">dtypes</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;replace&quot;</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">result </span><span class="s2">in </span><span class="s1">read_sql_query</span><span class="s3">(</span>
            <span class="s4">&quot;SELECT * FROM test&quot;</span><span class="s3">,</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">,</span>
            <span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtypes</span><span class="s3">,</span>
            <span class="s1">chunksize</span><span class="s3">=</span><span class="s5">1</span><span class="s3">,</span>
        <span class="s3">):</span>
            <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;dtype_backend&quot;</span><span class="s3">, [</span><span class="s1">lib</span><span class="s3">.</span><span class="s1">no_default</span><span class="s3">, </span><span class="s4">&quot;numpy_nullable&quot;</span><span class="s3">])</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;func&quot;</span><span class="s3">, [</span><span class="s4">&quot;read_sql&quot;</span><span class="s3">, </span><span class="s4">&quot;read_sql_query&quot;</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_read_sql_dtype</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">func</span><span class="s3">, </span><span class="s1">dtype_backend</span><span class="s3">):</span>
        <span class="s6"># GH#50797</span>
        <span class="s1">table </span><span class="s3">= </span><span class="s4">&quot;test&quot;</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;a&quot;</span><span class="s3">: [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], </span><span class="s4">&quot;b&quot;</span><span class="s3">: </span><span class="s5">5</span><span class="s3">})</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s1">table</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;replace&quot;</span><span class="s3">)</span>

        <span class="s1">result </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">pd</span><span class="s3">, </span><span class="s1">func</span><span class="s3">)(</span>
            <span class="s4">f&quot;Select * from </span><span class="s2">{</span><span class="s1">table</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">,</span>
            <span class="s1">dtype</span><span class="s3">={</span><span class="s4">&quot;a&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">},</span>
            <span class="s1">dtype_backend</span><span class="s3">=</span><span class="s1">dtype_backend</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span>
                <span class="s4">&quot;a&quot;</span><span class="s3">: </span><span class="s1">Series</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">),</span>
                <span class="s4">&quot;b&quot;</span><span class="s3">: </span><span class="s1">Series</span><span class="s3">(</span>
                    <span class="s3">[</span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s3">],</span>
                    <span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;int64&quot; </span><span class="s2">if not </span><span class="s1">dtype_backend </span><span class="s3">== </span><span class="s4">&quot;numpy_nullable&quot; </span><span class="s2">else </span><span class="s4">&quot;Int64&quot;</span><span class="s3">,</span>
                <span class="s3">),</span>
            <span class="s3">}</span>
        <span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestSQLiteAlchemy</span><span class="s3">(</span><span class="s1">_TestSQLAlchemy</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Test the sqlalchemy backend against an in-memory sqlite database. 
 
    &quot;&quot;&quot;</span>

    <span class="s1">flavor </span><span class="s3">= </span><span class="s4">&quot;sqlite&quot;</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">setup_engine</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">):</span>
        <span class="s1">cls</span><span class="s3">.</span><span class="s1">engine </span><span class="s3">= </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">create_engine</span><span class="s3">(</span><span class="s4">&quot;sqlite:///:memory:&quot;</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">setup_driver</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">):</span>
        <span class="s6"># sqlite3 is built-in</span>
        <span class="s1">cls</span><span class="s3">.</span><span class="s1">driver </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s2">def </span><span class="s1">test_keyword_deprecation</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># GH 54397</span>
        <span class="s1">msg </span><span class="s3">= (</span>
            <span class="s4">&quot;Starting with pandas version 3.0 all arguments of to_sql except for the &quot;</span>
            <span class="s4">&quot;arguments 'name' and 'con' will be keyword-only.&quot;</span>
        <span class="s3">)</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([{</span><span class="s4">&quot;A&quot;</span><span class="s3">: </span><span class="s5">1</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">: </span><span class="s5">2</span><span class="s3">, </span><span class="s4">&quot;C&quot;</span><span class="s3">: </span><span class="s5">3</span><span class="s3">}, {</span><span class="s4">&quot;A&quot;</span><span class="s3">: </span><span class="s5">1</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">: </span><span class="s5">2</span><span class="s3">, </span><span class="s4">&quot;C&quot;</span><span class="s3">: </span><span class="s5">3</span><span class="s3">}])</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s4">&quot;example&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s4">&quot;example&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;replace&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_default_type_conversion</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;types&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

        <span class="s2">assert </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">FloatCol</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">floating</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">IntCol</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">integer</span><span class="s3">)</span>

        <span class="s6"># sqlite has no boolean type, so integer type is returned</span>
        <span class="s2">assert </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">BoolCol</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">integer</span><span class="s3">)</span>

        <span class="s6"># Int column with NA values stays as float</span>
        <span class="s2">assert </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">IntColWithNull</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">floating</span><span class="s3">)</span>

        <span class="s6"># Non-native Bool column with NA values stays as float</span>
        <span class="s2">assert </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">BoolColWithNull</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">floating</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_default_date_load</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;types&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

        <span class="s6"># IMPORTANT - sqlite has no native date type, so shouldn't parse, but</span>
        <span class="s2">assert not </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">DateCol</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">datetime64</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_bigint_warning</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># test no warning for BIGINT (to support int64) is raised (GH7433)</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;a&quot;</span><span class="s3">: [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]}, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;int64&quot;</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_bigintwarning&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) == </span><span class="s5">2</span>

        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span><span class="s2">None</span><span class="s3">):</span>
            <span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;test_bigintwarning&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_valueerror_exception</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;col1&quot;</span><span class="s3">: [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], </span><span class="s4">&quot;col2&quot;</span><span class="s3">: [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]})</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;Empty table name specified&quot;</span><span class="s3">):</span>
            <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;replace&quot;</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_row_object_is_named_tuple</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># GH 40682</span>
        <span class="s6"># Test for the is_named_tuple() function</span>
        <span class="s6"># Placed here due to its usage of sqlalchemy</span>

        <span class="s2">from </span><span class="s1">sqlalchemy </span><span class="s2">import </span><span class="s3">(</span>
            <span class="s1">Column</span><span class="s3">,</span>
            <span class="s1">Integer</span><span class="s3">,</span>
            <span class="s1">String</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s2">from </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">orm </span><span class="s2">import </span><span class="s3">(</span>
            <span class="s1">declarative_base</span><span class="s3">,</span>
            <span class="s1">sessionmaker</span><span class="s3">,</span>
        <span class="s3">)</span>

        <span class="s1">BaseModel </span><span class="s3">= </span><span class="s1">declarative_base</span><span class="s3">()</span>

        <span class="s2">class </span><span class="s1">Test</span><span class="s3">(</span><span class="s1">BaseModel</span><span class="s3">):</span>
            <span class="s1">__tablename__ </span><span class="s3">= </span><span class="s4">&quot;test_frame&quot;</span>
            <span class="s1">id </span><span class="s3">= </span><span class="s1">Column</span><span class="s3">(</span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">primary_key</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
            <span class="s1">string_column </span><span class="s3">= </span><span class="s1">Column</span><span class="s3">(</span><span class="s1">String</span><span class="s3">(</span><span class="s5">50</span><span class="s3">))</span>

        <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">():</span>
            <span class="s1">BaseModel</span><span class="s3">.</span><span class="s1">metadata</span><span class="s3">.</span><span class="s1">create_all</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">Session </span><span class="s3">= </span><span class="s1">sessionmaker</span><span class="s3">(</span><span class="s1">bind</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">Session</span><span class="s3">() </span><span class="s2">as </span><span class="s1">session</span><span class="s3">:</span>
            <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;id&quot;</span><span class="s3">: [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], </span><span class="s4">&quot;string_column&quot;</span><span class="s3">: [</span><span class="s4">&quot;hello&quot;</span><span class="s3">, </span><span class="s4">&quot;world&quot;</span><span class="s3">]})</span>
            <span class="s2">assert </span><span class="s3">(</span>
                <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span>
                    <span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_frame&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;replace&quot;</span>
                <span class="s3">)</span>
                <span class="s3">== </span><span class="s5">2</span>
            <span class="s3">)</span>
            <span class="s1">session</span><span class="s3">.</span><span class="s1">commit</span><span class="s3">()</span>
            <span class="s1">test_query </span><span class="s3">= </span><span class="s1">session</span><span class="s3">.</span><span class="s1">query</span><span class="s3">(</span><span class="s1">Test</span><span class="s3">.</span><span class="s1">id</span><span class="s3">, </span><span class="s1">Test</span><span class="s3">.</span><span class="s1">string_column</span><span class="s3">)</span>
            <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">test_query</span><span class="s3">)</span>

        <span class="s2">assert </span><span class="s1">list</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">) == [</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s4">&quot;string_column&quot;</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">dtype_backend_expected</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">storage</span><span class="s3">, </span><span class="s1">dtype_backend</span><span class="s3">) </span><span class="s1">-&gt; DataFrame</span><span class="s3">:</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">super</span><span class="s3">().</span><span class="s1">dtype_backend_expected</span><span class="s3">(</span><span class="s1">storage</span><span class="s3">, </span><span class="s1">dtype_backend</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">dtype_backend </span><span class="s3">== </span><span class="s4">&quot;numpy_nullable&quot;</span><span class="s3">:</span>
            <span class="s1">df </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">({</span><span class="s4">&quot;e&quot;</span><span class="s3">: </span><span class="s4">&quot;Int64&quot;</span><span class="s3">, </span><span class="s4">&quot;f&quot;</span><span class="s3">: </span><span class="s4">&quot;Int64&quot;</span><span class="s3">})</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">df </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">({</span><span class="s4">&quot;e&quot;</span><span class="s3">: </span><span class="s4">&quot;int64[pyarrow]&quot;</span><span class="s3">, </span><span class="s4">&quot;f&quot;</span><span class="s3">: </span><span class="s4">&quot;int64[pyarrow]&quot;</span><span class="s3">})</span>

        <span class="s2">return </span><span class="s1">df</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;func&quot;</span><span class="s3">, [</span><span class="s4">&quot;read_sql&quot;</span><span class="s3">, </span><span class="s4">&quot;read_sql_table&quot;</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_read_sql_dtype_backend_table</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">string_storage</span><span class="s3">, </span><span class="s1">func</span><span class="s3">):</span>
        <span class="s6"># GH#50048 Not supported for sqlite</span>
        <span class="s2">pass</span>

    <span class="s2">def </span><span class="s1">test_read_sql_string_inference</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># GH#54430</span>
        <span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pyarrow&quot;</span><span class="s3">)</span>
        <span class="s1">table </span><span class="s3">= </span><span class="s4">&quot;test&quot;</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;a&quot;</span><span class="s3">: [</span><span class="s4">&quot;x&quot;</span><span class="s3">, </span><span class="s4">&quot;y&quot;</span><span class="s3">]})</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">table</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;replace&quot;</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">option_context</span><span class="s3">(</span><span class="s4">&quot;future.infer_string&quot;</span><span class="s3">, </span><span class="s2">True</span><span class="s3">):</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s1">table</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

        <span class="s1">dtype </span><span class="s3">= </span><span class="s4">&quot;string[pyarrow_numpy]&quot;</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span><span class="s4">&quot;a&quot;</span><span class="s3">: [</span><span class="s4">&quot;x&quot;</span><span class="s3">, </span><span class="s4">&quot;y&quot;</span><span class="s3">]}, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">Index</span><span class="s3">([</span><span class="s4">&quot;a&quot;</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">)</span>
        <span class="s3">)</span>

        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_roundtripping_datetimes</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># GH#54877</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;t&quot;</span><span class="s3">: [</span><span class="s1">datetime</span><span class="s3">(</span><span class="s5">2020</span><span class="s3">, </span><span class="s5">12</span><span class="s3">, </span><span class="s5">31</span><span class="s3">, </span><span class="s5">12</span><span class="s3">)]}, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;datetime64[ns]&quot;</span><span class="s3">)</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s4">&quot;test&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;replace&quot;</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">read_sql</span><span class="s3">(</span><span class="s4">&quot;select * from test&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">).</span><span class="s1">iloc</span><span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]</span>
        <span class="s2">assert </span><span class="s1">result </span><span class="s3">== </span><span class="s4">&quot;2020-12-31 12:00:00.000000&quot;</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span>
<span class="s2">def </span><span class="s1">sqlite_builtin_detect_types</span><span class="s3">():</span>
    <span class="s2">with </span><span class="s1">contextlib</span><span class="s3">.</span><span class="s1">closing</span><span class="s3">(</span>
        <span class="s1">sqlite3</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">(</span><span class="s4">&quot;:memory:&quot;</span><span class="s3">, </span><span class="s1">detect_types</span><span class="s3">=</span><span class="s1">sqlite3</span><span class="s3">.</span><span class="s1">PARSE_DECLTYPES</span><span class="s3">)</span>
    <span class="s3">) </span><span class="s2">as </span><span class="s1">closing_conn</span><span class="s3">:</span>
        <span class="s2">with </span><span class="s1">closing_conn </span><span class="s2">as </span><span class="s1">conn</span><span class="s3">:</span>
            <span class="s2">yield </span><span class="s1">conn</span>


<span class="s2">def </span><span class="s1">test_roundtripping_datetimes_detect_types</span><span class="s3">(</span><span class="s1">sqlite_builtin_detect_types</span><span class="s3">):</span>
    <span class="s6"># https://github.com/pandas-dev/pandas/issues/55554</span>
    <span class="s1">conn </span><span class="s3">= </span><span class="s1">sqlite_builtin_detect_types</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;t&quot;</span><span class="s3">: [</span><span class="s1">datetime</span><span class="s3">(</span><span class="s5">2020</span><span class="s3">, </span><span class="s5">12</span><span class="s3">, </span><span class="s5">31</span><span class="s3">, </span><span class="s5">12</span><span class="s3">)]}, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;datetime64[ns]&quot;</span><span class="s3">)</span>
    <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s4">&quot;test&quot;</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;replace&quot;</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">result </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">read_sql</span><span class="s3">(</span><span class="s4">&quot;select * from test&quot;</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">).</span><span class="s1">iloc</span><span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]</span>
    <span class="s2">assert </span><span class="s1">result </span><span class="s3">== </span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s4">&quot;2020-12-31 12:00:00.000000&quot;</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">db</span>
<span class="s2">class </span><span class="s1">TestMySQLAlchemy</span><span class="s3">(</span><span class="s1">_TestSQLAlchemy</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Test the sqlalchemy backend against an MySQL database. 
 
    &quot;&quot;&quot;</span>

    <span class="s1">flavor </span><span class="s3">= </span><span class="s4">&quot;mysql&quot;</span>
    <span class="s1">port </span><span class="s3">= </span><span class="s5">3306</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">setup_engine</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">):</span>
        <span class="s1">cls</span><span class="s3">.</span><span class="s1">engine </span><span class="s3">= </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">create_engine</span><span class="s3">(</span>
            <span class="s4">f&quot;mysql+</span><span class="s2">{</span><span class="s1">cls</span><span class="s3">.</span><span class="s1">driver</span><span class="s2">}</span><span class="s4">://root@localhost:</span><span class="s2">{</span><span class="s1">cls</span><span class="s3">.</span><span class="s1">port</span><span class="s2">}</span><span class="s4">/pandas&quot;</span><span class="s3">,</span>
            <span class="s1">connect_args</span><span class="s3">=</span><span class="s1">cls</span><span class="s3">.</span><span class="s1">connect_args</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">setup_driver</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">):</span>
        <span class="s1">pymysql </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pymysql&quot;</span><span class="s3">)</span>
        <span class="s1">cls</span><span class="s3">.</span><span class="s1">driver </span><span class="s3">= </span><span class="s4">&quot;pymysql&quot;</span>
        <span class="s1">cls</span><span class="s3">.</span><span class="s1">connect_args </span><span class="s3">= {</span><span class="s4">&quot;client_flag&quot;</span><span class="s3">: </span><span class="s1">pymysql</span><span class="s3">.</span><span class="s1">constants</span><span class="s3">.</span><span class="s1">CLIENT</span><span class="s3">.</span><span class="s1">MULTI_STATEMENTS</span><span class="s3">}</span>

    <span class="s2">def </span><span class="s1">test_default_type_conversion</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">pass</span>

    <span class="s2">def </span><span class="s1">dtype_backend_expected</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">storage</span><span class="s3">, </span><span class="s1">dtype_backend</span><span class="s3">) </span><span class="s1">-&gt; DataFrame</span><span class="s3">:</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">super</span><span class="s3">().</span><span class="s1">dtype_backend_expected</span><span class="s3">(</span><span class="s1">storage</span><span class="s3">, </span><span class="s1">dtype_backend</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">dtype_backend </span><span class="s3">== </span><span class="s4">&quot;numpy_nullable&quot;</span><span class="s3">:</span>
            <span class="s1">df </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">({</span><span class="s4">&quot;e&quot;</span><span class="s3">: </span><span class="s4">&quot;Int64&quot;</span><span class="s3">, </span><span class="s4">&quot;f&quot;</span><span class="s3">: </span><span class="s4">&quot;Int64&quot;</span><span class="s3">})</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">df </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">({</span><span class="s4">&quot;e&quot;</span><span class="s3">: </span><span class="s4">&quot;int64[pyarrow]&quot;</span><span class="s3">, </span><span class="s4">&quot;f&quot;</span><span class="s3">: </span><span class="s4">&quot;int64[pyarrow]&quot;</span><span class="s3">})</span>

        <span class="s2">return </span><span class="s1">df</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">db</span>
<span class="s2">class </span><span class="s1">TestPostgreSQLAlchemy</span><span class="s3">(</span><span class="s1">_TestSQLAlchemy</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Test the sqlalchemy backend against an PostgreSQL database. 
 
    &quot;&quot;&quot;</span>

    <span class="s1">flavor </span><span class="s3">= </span><span class="s4">&quot;postgresql&quot;</span>
    <span class="s1">port </span><span class="s3">= </span><span class="s5">5432</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">setup_engine</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">):</span>
        <span class="s1">cls</span><span class="s3">.</span><span class="s1">engine </span><span class="s3">= </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">create_engine</span><span class="s3">(</span>
            <span class="s4">f&quot;postgresql+</span><span class="s2">{</span><span class="s1">cls</span><span class="s3">.</span><span class="s1">driver</span><span class="s2">}</span><span class="s4">://postgres:postgres@localhost:</span><span class="s2">{</span><span class="s1">cls</span><span class="s3">.</span><span class="s1">port</span><span class="s2">}</span><span class="s4">/pandas&quot;</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">setup_driver</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">):</span>
        <span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;psycopg2&quot;</span><span class="s3">)</span>
        <span class="s1">cls</span><span class="s3">.</span><span class="s1">driver </span><span class="s3">= </span><span class="s4">&quot;psycopg2&quot;</span>

    <span class="s2">def </span><span class="s1">test_schema_support</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">from </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">engine </span><span class="s2">import </span><span class="s1">Engine</span>

        <span class="s6"># only test this for postgresql (schema's not supported in</span>
        <span class="s6"># mysql/sqlite)</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;col1&quot;</span><span class="s3">: [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], </span><span class="s4">&quot;col2&quot;</span><span class="s3">: [</span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">0.2</span><span class="s3">], </span><span class="s4">&quot;col3&quot;</span><span class="s3">: [</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s4">&quot;n&quot;</span><span class="s3">]})</span>

        <span class="s6"># create a schema</span>
        <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">():</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">.</span><span class="s1">exec_driver_sql</span><span class="s3">(</span><span class="s4">&quot;DROP SCHEMA IF EXISTS other CASCADE;&quot;</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">.</span><span class="s1">exec_driver_sql</span><span class="s3">(</span><span class="s4">&quot;CREATE SCHEMA other;&quot;</span><span class="s3">)</span>

        <span class="s6"># write dataframe to different schema's</span>
        <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_schema_public&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) == </span><span class="s5">2</span>
        <span class="s2">assert </span><span class="s3">(</span>
            <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span>
                <span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_schema_public_explicit&quot;</span><span class="s3">,</span>
                <span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">,</span>
                <span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
                <span class="s1">schema</span><span class="s3">=</span><span class="s4">&quot;public&quot;</span><span class="s3">,</span>
            <span class="s3">)</span>
            <span class="s3">== </span><span class="s5">2</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s3">(</span>
            <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span>
                <span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_schema_other&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s4">&quot;other&quot;</span>
            <span class="s3">)</span>
            <span class="s3">== </span><span class="s5">2</span>
        <span class="s3">)</span>

        <span class="s6"># read dataframes back in</span>
        <span class="s1">res1 </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;test_schema_public&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">res1</span><span class="s3">)</span>
        <span class="s1">res2 </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;test_schema_public_explicit&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">res2</span><span class="s3">)</span>
        <span class="s1">res3 </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span>
            <span class="s4">&quot;test_schema_public_explicit&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s4">&quot;public&quot;</span>
        <span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">res3</span><span class="s3">)</span>
        <span class="s1">res4 </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;test_schema_other&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s4">&quot;other&quot;</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">res4</span><span class="s3">)</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;Table test_schema_other not found&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;test_schema_other&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s4">&quot;public&quot;</span><span class="s3">)</span>

        <span class="s6"># different if_exists options</span>

        <span class="s6"># create a schema</span>
        <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">():</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">.</span><span class="s1">exec_driver_sql</span><span class="s3">(</span><span class="s4">&quot;DROP SCHEMA IF EXISTS other CASCADE;&quot;</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">.</span><span class="s1">exec_driver_sql</span><span class="s3">(</span><span class="s4">&quot;CREATE SCHEMA other;&quot;</span><span class="s3">)</span>

        <span class="s6"># write dataframe with different if_exists options</span>
        <span class="s2">assert </span><span class="s3">(</span>
            <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span>
                <span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_schema_other&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s4">&quot;other&quot;</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span>
            <span class="s3">)</span>
            <span class="s3">== </span><span class="s5">2</span>
        <span class="s3">)</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span>
            <span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_schema_other&quot;</span><span class="s3">,</span>
            <span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">,</span>
            <span class="s1">schema</span><span class="s3">=</span><span class="s4">&quot;other&quot;</span><span class="s3">,</span>
            <span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;replace&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s3">(</span>
            <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span>
                <span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_schema_other&quot;</span><span class="s3">,</span>
                <span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">,</span>
                <span class="s1">schema</span><span class="s3">=</span><span class="s4">&quot;other&quot;</span><span class="s3">,</span>
                <span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
                <span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;append&quot;</span><span class="s3">,</span>
            <span class="s3">)</span>
            <span class="s3">== </span><span class="s5">2</span>
        <span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;test_schema_other&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s4">&quot;other&quot;</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">concat</span><span class="s3">([</span><span class="s1">df</span><span class="s3">, </span><span class="s1">df</span><span class="s3">], </span><span class="s1">ignore_index</span><span class="s3">=</span><span class="s2">True</span><span class="s3">), </span><span class="s1">res</span><span class="s3">)</span>

        <span class="s6"># specifying schema in user-provided meta</span>

        <span class="s6"># The schema won't be applied on another Connection</span>
        <span class="s6"># because of transactional schemas</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">Engine</span><span class="s3">):</span>
            <span class="s1">engine2 </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">()</span>
            <span class="s1">pdsql </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">SQLDatabase</span><span class="s3">(</span><span class="s1">engine2</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s4">&quot;other&quot;</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">pdsql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s4">&quot;test_schema_other2&quot;</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) == </span><span class="s5">2</span>
            <span class="s2">assert </span><span class="s3">(</span>
                <span class="s1">pdsql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s4">&quot;test_schema_other2&quot;</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;replace&quot;</span><span class="s3">)</span>
                <span class="s3">== </span><span class="s5">2</span>
            <span class="s3">)</span>
            <span class="s2">assert </span><span class="s3">(</span>
                <span class="s1">pdsql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s4">&quot;test_schema_other2&quot;</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;append&quot;</span><span class="s3">)</span>
                <span class="s3">== </span><span class="s5">2</span>
            <span class="s3">)</span>
            <span class="s1">res1 </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_table</span><span class="s3">(</span><span class="s4">&quot;test_schema_other2&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s4">&quot;other&quot;</span><span class="s3">)</span>
            <span class="s1">res2 </span><span class="s3">= </span><span class="s1">pdsql</span><span class="s3">.</span><span class="s1">read_table</span><span class="s3">(</span><span class="s4">&quot;test_schema_other2&quot;</span><span class="s3">)</span>
            <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">res1</span><span class="s3">, </span><span class="s1">res2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_self_join_date_columns</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># GH 44421</span>
        <span class="s2">from </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">engine </span><span class="s2">import </span><span class="s1">Engine</span>
        <span class="s2">from </span><span class="s1">sqlalchemy</span><span class="s3">.</span><span class="s1">sql </span><span class="s2">import </span><span class="s1">text</span>

        <span class="s1">create_table </span><span class="s3">= </span><span class="s1">text</span><span class="s3">(</span>
            <span class="s4">&quot;&quot;&quot; 
        CREATE TABLE person 
        ( 
            id serial constraint person_pkey primary key, 
            created_dt timestamp with time zone 
        ); 
 
        INSERT INTO person 
            VALUES (1, '2021-01-01T00:00:00Z'); 
        &quot;&quot;&quot;</span>
        <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">Engine</span><span class="s3">):</span>
            <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">() </span><span class="s2">as </span><span class="s1">con</span><span class="s3">:</span>
                <span class="s2">with </span><span class="s1">con</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">():</span>
                    <span class="s1">con</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">create_table</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">():</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">create_table</span><span class="s3">)</span>

        <span class="s1">sql_query </span><span class="s3">= (</span>
            <span class="s4">'SELECT * FROM &quot;person&quot; AS p1 INNER JOIN &quot;person&quot; AS p2 ON p1.id = p2.id;'</span>
        <span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">read_sql</span><span class="s3">(</span><span class="s1">sql_query</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">[[</span><span class="s5">1</span><span class="s3">, </span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s4">&quot;2021&quot;</span><span class="s3">, </span><span class="s1">tz</span><span class="s3">=</span><span class="s4">&quot;UTC&quot;</span><span class="s3">)] * </span><span class="s5">2</span><span class="s3">], </span><span class="s1">columns</span><span class="s3">=[</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s4">&quot;created_dt&quot;</span><span class="s3">] * </span><span class="s5">2</span>
        <span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s6"># Cleanup</span>
        <span class="s2">with </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">SQLDatabase</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">need_transaction</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) </span><span class="s2">as </span><span class="s1">pandasSQL</span><span class="s3">:</span>
            <span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">drop_table</span><span class="s3">(</span><span class="s4">&quot;person&quot;</span><span class="s3">)</span>


<span class="s6"># -----------------------------------------------------------------------------</span>
<span class="s6"># -- Test Sqlite / MySQL fallback</span>


<span class="s2">class </span><span class="s1">TestSQLiteFallback</span><span class="s3">(</span><span class="s1">SQLiteMixIn</span><span class="s3">, </span><span class="s1">PandasSQLTest</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Test the fallback mode against an in-memory sqlite database. 
 
    &quot;&quot;&quot;</span>

    <span class="s1">flavor </span><span class="s3">= </span><span class="s4">&quot;sqlite&quot;</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span><span class="s3">(</span><span class="s1">autouse</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">setup_method</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">iris_path</span><span class="s3">, </span><span class="s1">types_data</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">conn </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">load_iris_data</span><span class="s3">(</span><span class="s1">iris_path</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">load_types_data</span><span class="s3">(</span><span class="s1">types_data</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">pandasSQL </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">SQLiteDatabase</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_read_sql_parameter</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">sql_strings</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_read_sql_iris_parameter</span><span class="s3">(</span><span class="s1">sql_strings</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_read_sql_named_parameter</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">sql_strings</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_read_sql_iris_named_parameter</span><span class="s3">(</span><span class="s1">sql_strings</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_to_sql_empty</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_to_sql_empty</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_create_and_drop_table</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">temp_frame </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span><span class="s4">&quot;one&quot;</span><span class="s3">: [</span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">4.0</span><span class="s3">], </span><span class="s4">&quot;two&quot;</span><span class="s3">: [</span><span class="s5">4.0</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">]}</span>
        <span class="s3">)</span>

        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">temp_frame</span><span class="s3">, </span><span class="s4">&quot;drop_test_frame&quot;</span><span class="s3">) == </span><span class="s5">4</span>

        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span><span class="s4">&quot;drop_test_frame&quot;</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">drop_table</span><span class="s3">(</span><span class="s4">&quot;drop_test_frame&quot;</span><span class="s3">)</span>

        <span class="s2">assert not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pandasSQL</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span><span class="s4">&quot;drop_test_frame&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_roundtrip</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_frame1</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_roundtrip</span><span class="s3">(</span><span class="s1">test_frame1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_execute_sql</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_execute_sql</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">test_datetime_date</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># test support for datetime.date</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([</span><span class="s1">date</span><span class="s3">(</span><span class="s5">2014</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">), </span><span class="s1">date</span><span class="s3">(</span><span class="s5">2014</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)], </span><span class="s1">columns</span><span class="s3">=[</span><span class="s4">&quot;a&quot;</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_date&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) == </span><span class="s5">2</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM test_date&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">flavor </span><span class="s3">== </span><span class="s4">&quot;sqlite&quot;</span><span class="s3">:</span>
            <span class="s6"># comes back as strings</span>
            <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">df</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">str</span><span class="s3">))</span>
        <span class="s2">elif </span><span class="s1">self</span><span class="s3">.</span><span class="s1">flavor </span><span class="s3">== </span><span class="s4">&quot;mysql&quot;</span><span class="s3">:</span>
            <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">df</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;tz_aware&quot;</span><span class="s3">, [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_datetime_time</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">tz_aware</span><span class="s3">):</span>
        <span class="s6"># test support for datetime.time, GH #8341</span>
        <span class="s2">if not </span><span class="s1">tz_aware</span><span class="s3">:</span>
            <span class="s1">tz_times </span><span class="s3">= [</span><span class="s1">time</span><span class="s3">(</span><span class="s5">9</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">), </span><span class="s1">time</span><span class="s3">(</span><span class="s5">9</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">30</span><span class="s3">)]</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">tz_dt </span><span class="s3">= </span><span class="s1">date_range</span><span class="s3">(</span><span class="s4">&quot;2013-01-01 09:00:00&quot;</span><span class="s3">, </span><span class="s1">periods</span><span class="s3">=</span><span class="s5">2</span><span class="s3">, </span><span class="s1">tz</span><span class="s3">=</span><span class="s4">&quot;US/Pacific&quot;</span><span class="s3">)</span>
            <span class="s1">tz_times </span><span class="s3">= </span><span class="s1">Series</span><span class="s3">(</span><span class="s1">tz_dt</span><span class="s3">.</span><span class="s1">to_pydatetime</span><span class="s3">()).</span><span class="s1">map</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">dt</span><span class="s3">: </span><span class="s1">dt</span><span class="s3">.</span><span class="s1">timetz</span><span class="s3">())</span>

        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">tz_times</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">=[</span><span class="s4">&quot;a&quot;</span><span class="s3">])</span>

        <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_time&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) == </span><span class="s5">2</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">&quot;SELECT * FROM test_time&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">flavor </span><span class="s3">== </span><span class="s4">&quot;sqlite&quot;</span><span class="s3">:</span>
            <span class="s6"># comes back as strings</span>
            <span class="s1">expected </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">map</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">_</span><span class="s3">: </span><span class="s1">_</span><span class="s3">.</span><span class="s1">strftime</span><span class="s3">(</span><span class="s4">&quot;%H:%M:%S.%f&quot;</span><span class="s3">))</span>
            <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_get_index_columns</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">tbl_name</span><span class="s3">):</span>
        <span class="s1">ixs </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span>
            <span class="s4">&quot;SELECT * FROM sqlite_master WHERE type = 'index' &quot;</span>
            <span class="s4">f&quot;AND tbl_name = '</span><span class="s2">{</span><span class="s1">tbl_name</span><span class="s2">}</span><span class="s4">'&quot;</span><span class="s3">,</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">ix_cols </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">ix_name </span><span class="s2">in </span><span class="s1">ixs</span><span class="s3">.</span><span class="s1">name</span><span class="s3">:</span>
            <span class="s1">ix_info </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql_query</span><span class="s3">(</span><span class="s4">f&quot;PRAGMA index_info(</span><span class="s2">{</span><span class="s1">ix_name</span><span class="s2">}</span><span class="s4">)&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>
            <span class="s1">ix_cols</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">ix_info</span><span class="s3">.</span><span class="s1">name</span><span class="s3">.</span><span class="s1">tolist</span><span class="s3">())</span>
        <span class="s2">return </span><span class="s1">ix_cols</span>

    <span class="s2">def </span><span class="s1">test_to_sql_save_index</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_to_sql_save_index</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">test_transactions</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_transaction_test</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">_get_sqlite_column_type</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">table</span><span class="s3">, </span><span class="s1">column</span><span class="s3">):</span>
        <span class="s1">recs </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s4">f&quot;PRAGMA table_info(</span><span class="s2">{</span><span class="s1">table</span><span class="s2">}</span><span class="s4">)&quot;</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">cid</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">ctype</span><span class="s3">, </span><span class="s1">not_null</span><span class="s3">, </span><span class="s1">default</span><span class="s3">, </span><span class="s1">pk </span><span class="s2">in </span><span class="s1">recs</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">name </span><span class="s3">== </span><span class="s1">column</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">ctype</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">f&quot;Table </span><span class="s2">{</span><span class="s1">table</span><span class="s2">}</span><span class="s4">, column </span><span class="s2">{</span><span class="s1">column</span><span class="s2">} </span><span class="s4">not found&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_dtype</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">flavor </span><span class="s3">== </span><span class="s4">&quot;mysql&quot;</span><span class="s3">:</span>
            <span class="s1">pytest</span><span class="s3">.</span><span class="s1">skip</span><span class="s3">(</span><span class="s4">&quot;Not applicable to MySQL legacy&quot;</span><span class="s3">)</span>
        <span class="s1">cols </span><span class="s3">= [</span><span class="s4">&quot;A&quot;</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">]</span>
        <span class="s1">data </span><span class="s3">= [(</span><span class="s5">0.8</span><span class="s3">, </span><span class="s2">True</span><span class="s3">), (</span><span class="s5">0.9</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)]</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">cols</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;dtype_test&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">) == </span><span class="s5">2</span>
        <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;dtype_test2&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">={</span><span class="s4">&quot;B&quot;</span><span class="s3">: </span><span class="s4">&quot;STRING&quot;</span><span class="s3">}) == </span><span class="s5">2</span>

        <span class="s6"># sqlite stores Boolean values as INTEGER</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_sqlite_column_type</span><span class="s3">(</span><span class="s4">&quot;dtype_test&quot;</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">) == </span><span class="s4">&quot;INTEGER&quot;</span>

        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_sqlite_column_type</span><span class="s3">(</span><span class="s4">&quot;dtype_test2&quot;</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">) == </span><span class="s4">&quot;STRING&quot;</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s4">r&quot;B \(&lt;class 'bool'&gt;\) not a string&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;error&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">={</span><span class="s4">&quot;B&quot;</span><span class="s3">: </span><span class="s1">bool</span><span class="s3">})</span>

        <span class="s6"># single dtype</span>
        <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;single_dtype_test&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;STRING&quot;</span><span class="s3">) == </span><span class="s5">2</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_sqlite_column_type</span><span class="s3">(</span><span class="s4">&quot;single_dtype_test&quot;</span><span class="s3">, </span><span class="s4">&quot;A&quot;</span><span class="s3">) == </span><span class="s4">&quot;STRING&quot;</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_sqlite_column_type</span><span class="s3">(</span><span class="s4">&quot;single_dtype_test&quot;</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">) == </span><span class="s4">&quot;STRING&quot;</span>

    <span class="s2">def </span><span class="s1">test_notna_dtype</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">flavor </span><span class="s3">== </span><span class="s4">&quot;mysql&quot;</span><span class="s3">:</span>
            <span class="s1">pytest</span><span class="s3">.</span><span class="s1">skip</span><span class="s3">(</span><span class="s4">&quot;Not applicable to MySQL legacy&quot;</span><span class="s3">)</span>

        <span class="s1">cols </span><span class="s3">= {</span>
            <span class="s4">&quot;Bool&quot;</span><span class="s3">: </span><span class="s1">Series</span><span class="s3">([</span><span class="s2">True</span><span class="s3">, </span><span class="s2">None</span><span class="s3">]),</span>
            <span class="s4">&quot;Date&quot;</span><span class="s3">: </span><span class="s1">Series</span><span class="s3">([</span><span class="s1">datetime</span><span class="s3">(</span><span class="s5">2012</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">1</span><span class="s3">), </span><span class="s2">None</span><span class="s3">]),</span>
            <span class="s4">&quot;Int&quot;</span><span class="s3">: </span><span class="s1">Series</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s2">None</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;object&quot;</span><span class="s3">),</span>
            <span class="s4">&quot;Float&quot;</span><span class="s3">: </span><span class="s1">Series</span><span class="s3">([</span><span class="s5">1.1</span><span class="s3">, </span><span class="s2">None</span><span class="s3">]),</span>
        <span class="s3">}</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">cols</span><span class="s3">)</span>

        <span class="s1">tbl </span><span class="s3">= </span><span class="s4">&quot;notna_dtype_test&quot;</span>
        <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s1">tbl</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">) == </span><span class="s5">2</span>

        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_sqlite_column_type</span><span class="s3">(</span><span class="s1">tbl</span><span class="s3">, </span><span class="s4">&quot;Bool&quot;</span><span class="s3">) == </span><span class="s4">&quot;INTEGER&quot;</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_sqlite_column_type</span><span class="s3">(</span><span class="s1">tbl</span><span class="s3">, </span><span class="s4">&quot;Date&quot;</span><span class="s3">) == </span><span class="s4">&quot;TIMESTAMP&quot;</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_sqlite_column_type</span><span class="s3">(</span><span class="s1">tbl</span><span class="s3">, </span><span class="s4">&quot;Int&quot;</span><span class="s3">) == </span><span class="s4">&quot;INTEGER&quot;</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_sqlite_column_type</span><span class="s3">(</span><span class="s1">tbl</span><span class="s3">, </span><span class="s4">&quot;Float&quot;</span><span class="s3">) == </span><span class="s4">&quot;REAL&quot;</span>

    <span class="s2">def </span><span class="s1">test_illegal_names</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># For sqlite, these should work fine</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=[</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span><span class="s3">])</span>

        <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;Empty table or column name specified&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">ndx</span><span class="s3">, </span><span class="s1">weird_name </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s4">&quot;test_weird_name]&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;test_weird_name[&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;test_weird_name`&quot;</span><span class="s3">,</span>
                <span class="s4">'test_weird_name&quot;'</span><span class="s3">,</span>
                <span class="s4">&quot;test_weird_name'&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;_b.test_weird_name_01-30&quot;</span><span class="s3">,</span>
                <span class="s4">'&quot;_b.test_weird_name_01-30&quot;'</span><span class="s3">,</span>
                <span class="s4">&quot;99beginswithnumber&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;12345&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;</span><span class="s2">\xe9</span><span class="s4">&quot;</span><span class="s3">,</span>
            <span class="s3">]</span>
        <span class="s3">):</span>
            <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s1">weird_name</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">) == </span><span class="s5">2</span>
            <span class="s1">sql</span><span class="s3">.</span><span class="s1">table_exists</span><span class="s3">(</span><span class="s1">weird_name</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>

            <span class="s1">df2 </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=[</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s1">weird_name</span><span class="s3">])</span>
            <span class="s1">c_tbl </span><span class="s3">= </span><span class="s4">f&quot;test_weird_col_name</span><span class="s2">{</span><span class="s1">ndx</span><span class="s2">:</span><span class="s4">d</span><span class="s2">}</span><span class="s4">&quot;</span>
            <span class="s2">assert </span><span class="s1">df2</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s1">c_tbl</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">) == </span><span class="s5">2</span>
            <span class="s1">sql</span><span class="s3">.</span><span class="s1">table_exists</span><span class="s3">(</span><span class="s1">c_tbl</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">conn</span><span class="s3">)</span>


<span class="s6"># -----------------------------------------------------------------------------</span>
<span class="s6"># -- Old tests from 0.13.1 (before refactor using sqlalchemy)</span>


<span class="s1">_formatters </span><span class="s3">= {</span>
    <span class="s1">datetime</span><span class="s3">: </span><span class="s4">&quot;'{}'&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">,</span>
    <span class="s1">str</span><span class="s3">: </span><span class="s4">&quot;'{}'&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">,</span>
    <span class="s1">np</span><span class="s3">.</span><span class="s1">str_</span><span class="s3">: </span><span class="s4">&quot;'{}'&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">,</span>
    <span class="s1">bytes</span><span class="s3">: </span><span class="s4">&quot;'{}'&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">,</span>
    <span class="s1">float</span><span class="s3">: </span><span class="s4">&quot;{:.8f}&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">,</span>
    <span class="s1">int</span><span class="s3">: </span><span class="s4">&quot;{:d}&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">,</span>
    <span class="s1">type</span><span class="s3">(</span><span class="s2">None</span><span class="s3">): </span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s4">&quot;NULL&quot;</span><span class="s3">,</span>
    <span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">: </span><span class="s4">&quot;{:.10f}&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">,</span>
    <span class="s1">bool</span><span class="s3">: </span><span class="s4">&quot;'{!s}'&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">,</span>
<span class="s3">}</span>


<span class="s2">def </span><span class="s1">format_query</span><span class="s3">(</span><span class="s1">sql</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">processed_args </span><span class="s3">= []</span>
    <span class="s2">for </span><span class="s1">arg </span><span class="s2">in </span><span class="s1">args</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">, </span><span class="s1">float</span><span class="s3">) </span><span class="s2">and </span><span class="s1">isna</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">):</span>
            <span class="s1">arg </span><span class="s3">= </span><span class="s2">None</span>

        <span class="s1">formatter </span><span class="s3">= </span><span class="s1">_formatters</span><span class="s3">[</span><span class="s1">type</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">)]</span>
        <span class="s1">processed_args</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">formatter</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">))</span>

    <span class="s2">return </span><span class="s1">sql </span><span class="s3">% </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">processed_args</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">tquery</span><span class="s3">(</span><span class="s1">query</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Replace removed sql.tquery function&quot;&quot;&quot;</span>
    <span class="s2">with </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">pandasSQL_builder</span><span class="s3">(</span><span class="s1">con</span><span class="s3">) </span><span class="s2">as </span><span class="s1">pandas_sql</span><span class="s3">:</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">pandas_sql</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">query</span><span class="s3">).</span><span class="s1">fetchall</span><span class="s3">()</span>
    <span class="s2">return None if </span><span class="s1">res </span><span class="s2">is None else </span><span class="s1">list</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestXSQLite</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">drop_table</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">table_name</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">):</span>
        <span class="s1">cur </span><span class="s3">= </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">cursor</span><span class="s3">()</span>
        <span class="s1">cur</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s4">f&quot;DROP TABLE IF EXISTS </span><span class="s2">{</span><span class="s1">sql</span><span class="s3">.</span><span class="s1">_get_valid_sqlite_name</span><span class="s3">(</span><span class="s1">table_name</span><span class="s3">)</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s1">conn</span><span class="s3">.</span><span class="s1">commit</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">test_basic</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">sqlite_buildin</span><span class="s3">):</span>
        <span class="s1">frame </span><span class="s3">= </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">makeTimeDataFrame</span><span class="s3">()</span>
        <span class="s2">assert </span><span class="s3">(</span>
            <span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">frame</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_table&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">sqlite_buildin</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) == </span><span class="s5">30</span>
        <span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql</span><span class="s3">(</span><span class="s4">&quot;select * from test_table&quot;</span><span class="s3">, </span><span class="s1">sqlite_buildin</span><span class="s3">)</span>

        <span class="s6"># HACK! Change this once indexes are handled properly.</span>
        <span class="s1">result</span><span class="s3">.</span><span class="s1">index </span><span class="s3">= </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">index</span>

        <span class="s1">expected </span><span class="s3">= </span><span class="s1">frame</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">frame</span><span class="s3">)</span>

        <span class="s1">frame</span><span class="s3">[</span><span class="s4">&quot;txt&quot;</span><span class="s3">] = [</span><span class="s4">&quot;a&quot;</span><span class="s3">] * </span><span class="s1">len</span><span class="s3">(</span><span class="s1">frame</span><span class="s3">)</span>
        <span class="s1">frame2 </span><span class="s3">= </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s1">new_idx </span><span class="s3">= </span><span class="s1">Index</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">frame2</span><span class="s3">)), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">int64</span><span class="s3">) + </span><span class="s5">10</span>
        <span class="s1">frame2</span><span class="s3">[</span><span class="s4">&quot;Idx&quot;</span><span class="s3">] = </span><span class="s1">new_idx</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s2">assert </span><span class="s3">(</span>
            <span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">frame2</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;test_table2&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">sqlite_buildin</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
            <span class="s3">== </span><span class="s5">30</span>
        <span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql</span><span class="s3">(</span>
            <span class="s4">&quot;select * from test_table2&quot;</span><span class="s3">, </span><span class="s1">sqlite_buildin</span><span class="s3">, </span><span class="s1">index_col</span><span class="s3">=</span><span class="s4">&quot;Idx&quot;</span>
        <span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s1">expected</span><span class="s3">.</span><span class="s1">index </span><span class="s3">= </span><span class="s1">new_idx</span>
        <span class="s1">expected</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">name </span><span class="s3">= </span><span class="s4">&quot;Idx&quot;</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">expected</span><span class="s3">, </span><span class="s1">result</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_write_row_by_row</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">sqlite_buildin</span><span class="s3">):</span>
        <span class="s1">frame </span><span class="s3">= </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">makeTimeDataFrame</span><span class="s3">()</span>
        <span class="s1">frame</span><span class="s3">.</span><span class="s1">iloc</span><span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>
        <span class="s1">create_sql </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">get_schema</span><span class="s3">(</span><span class="s1">frame</span><span class="s3">, </span><span class="s4">&quot;test&quot;</span><span class="s3">)</span>
        <span class="s1">cur </span><span class="s3">= </span><span class="s1">sqlite_buildin</span><span class="s3">.</span><span class="s1">cursor</span><span class="s3">()</span>
        <span class="s1">cur</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">create_sql</span><span class="s3">)</span>

        <span class="s1">ins </span><span class="s3">= </span><span class="s4">&quot;INSERT INTO test VALUES (%s, %s, %s, %s)&quot;</span>
        <span class="s2">for </span><span class="s1">_</span><span class="s3">, </span><span class="s1">row </span><span class="s2">in </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">iterrows</span><span class="s3">():</span>
            <span class="s1">fmt_sql </span><span class="s3">= </span><span class="s1">format_query</span><span class="s3">(</span><span class="s1">ins</span><span class="s3">, *</span><span class="s1">row</span><span class="s3">)</span>
            <span class="s1">tquery</span><span class="s3">(</span><span class="s1">fmt_sql</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">sqlite_buildin</span><span class="s3">)</span>

        <span class="s1">sqlite_buildin</span><span class="s3">.</span><span class="s1">commit</span><span class="s3">()</span>

        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql</span><span class="s3">(</span><span class="s4">&quot;select * from test&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">sqlite_buildin</span><span class="s3">)</span>
        <span class="s1">result</span><span class="s3">.</span><span class="s1">index </span><span class="s3">= </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">index</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">frame</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-3</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_execute</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">sqlite_buildin</span><span class="s3">):</span>
        <span class="s1">frame </span><span class="s3">= </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">makeTimeDataFrame</span><span class="s3">()</span>
        <span class="s1">create_sql </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">get_schema</span><span class="s3">(</span><span class="s1">frame</span><span class="s3">, </span><span class="s4">&quot;test&quot;</span><span class="s3">)</span>
        <span class="s1">cur </span><span class="s3">= </span><span class="s1">sqlite_buildin</span><span class="s3">.</span><span class="s1">cursor</span><span class="s3">()</span>
        <span class="s1">cur</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">create_sql</span><span class="s3">)</span>
        <span class="s1">ins </span><span class="s3">= </span><span class="s4">&quot;INSERT INTO test VALUES (?, ?, ?, ?)&quot;</span>

        <span class="s1">row </span><span class="s3">= </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">iloc</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s2">with </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">pandasSQL_builder</span><span class="s3">(</span><span class="s1">sqlite_buildin</span><span class="s3">) </span><span class="s2">as </span><span class="s1">pandas_sql</span><span class="s3">:</span>
            <span class="s1">pandas_sql</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">ins</span><span class="s3">, </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">row</span><span class="s3">))</span>
        <span class="s1">sqlite_buildin</span><span class="s3">.</span><span class="s1">commit</span><span class="s3">()</span>

        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql</span><span class="s3">(</span><span class="s4">&quot;select * from test&quot;</span><span class="s3">, </span><span class="s1">sqlite_buildin</span><span class="s3">)</span>
        <span class="s1">result</span><span class="s3">.</span><span class="s1">index </span><span class="s3">= </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">index</span><span class="s3">[:</span><span class="s5">1</span><span class="s3">]</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">frame</span><span class="s3">[:</span><span class="s5">1</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_schema</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">sqlite_buildin</span><span class="s3">):</span>
        <span class="s1">frame </span><span class="s3">= </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">makeTimeDataFrame</span><span class="s3">()</span>
        <span class="s1">create_sql </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">get_schema</span><span class="s3">(</span><span class="s1">frame</span><span class="s3">, </span><span class="s4">&quot;test&quot;</span><span class="s3">)</span>
        <span class="s1">lines </span><span class="s3">= </span><span class="s1">create_sql</span><span class="s3">.</span><span class="s1">splitlines</span><span class="s3">()</span>
        <span class="s2">for </span><span class="s1">line </span><span class="s2">in </span><span class="s1">lines</span><span class="s3">:</span>
            <span class="s1">tokens </span><span class="s3">= </span><span class="s1">line</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">&quot; &quot;</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">tokens</span><span class="s3">) == </span><span class="s5">2 </span><span class="s2">and </span><span class="s1">tokens</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] == </span><span class="s4">&quot;A&quot;</span><span class="s3">:</span>
                <span class="s2">assert </span><span class="s1">tokens</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] == </span><span class="s4">&quot;DATETIME&quot;</span>

        <span class="s1">create_sql </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">get_schema</span><span class="s3">(</span><span class="s1">frame</span><span class="s3">, </span><span class="s4">&quot;test&quot;</span><span class="s3">, </span><span class="s1">keys</span><span class="s3">=[</span><span class="s4">&quot;A&quot;</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">])</span>
        <span class="s1">lines </span><span class="s3">= </span><span class="s1">create_sql</span><span class="s3">.</span><span class="s1">splitlines</span><span class="s3">()</span>
        <span class="s2">assert </span><span class="s4">'PRIMARY KEY (&quot;A&quot;, &quot;B&quot;)' </span><span class="s2">in </span><span class="s1">create_sql</span>
        <span class="s1">cur </span><span class="s3">= </span><span class="s1">sqlite_buildin</span><span class="s3">.</span><span class="s1">cursor</span><span class="s3">()</span>
        <span class="s1">cur</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">create_sql</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_execute_fail</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">sqlite_buildin</span><span class="s3">):</span>
        <span class="s1">create_sql </span><span class="s3">= </span><span class="s4">&quot;&quot;&quot; 
        CREATE TABLE test 
        ( 
        a TEXT, 
        b TEXT, 
        c REAL, 
        PRIMARY KEY (a, b) 
        ); 
        &quot;&quot;&quot;</span>
        <span class="s1">cur </span><span class="s3">= </span><span class="s1">sqlite_buildin</span><span class="s3">.</span><span class="s1">cursor</span><span class="s3">()</span>
        <span class="s1">cur</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">create_sql</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">pandasSQL_builder</span><span class="s3">(</span><span class="s1">sqlite_buildin</span><span class="s3">) </span><span class="s2">as </span><span class="s1">pandas_sql</span><span class="s3">:</span>
            <span class="s1">pandas_sql</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s4">'INSERT INTO test VALUES(&quot;foo&quot;, &quot;bar&quot;, 1.234)'</span><span class="s3">)</span>
            <span class="s1">pandas_sql</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s4">'INSERT INTO test VALUES(&quot;foo&quot;, &quot;baz&quot;, 2.567)'</span><span class="s3">)</span>

            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">sql</span><span class="s3">.</span><span class="s1">DatabaseError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;Execution failed on sql&quot;</span><span class="s3">):</span>
                <span class="s1">pandas_sql</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s4">'INSERT INTO test VALUES(&quot;foo&quot;, &quot;bar&quot;, 7)'</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_execute_closed_connection</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">create_sql </span><span class="s3">= </span><span class="s4">&quot;&quot;&quot; 
        CREATE TABLE test 
        ( 
        a TEXT, 
        b TEXT, 
        c REAL, 
        PRIMARY KEY (a, b) 
        ); 
        &quot;&quot;&quot;</span>
        <span class="s2">with </span><span class="s1">contextlib</span><span class="s3">.</span><span class="s1">closing</span><span class="s3">(</span><span class="s1">sqlite3</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">(</span><span class="s4">&quot;:memory:&quot;</span><span class="s3">)) </span><span class="s2">as </span><span class="s1">conn</span><span class="s3">:</span>
            <span class="s1">cur </span><span class="s3">= </span><span class="s1">conn</span><span class="s3">.</span><span class="s1">cursor</span><span class="s3">()</span>
            <span class="s1">cur</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">create_sql</span><span class="s3">)</span>

            <span class="s2">with </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">pandasSQL_builder</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">) </span><span class="s2">as </span><span class="s1">pandas_sql</span><span class="s3">:</span>
                <span class="s1">pandas_sql</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s4">'INSERT INTO test VALUES(&quot;foo&quot;, &quot;bar&quot;, 1.234)'</span><span class="s3">)</span>

        <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;Cannot operate on a closed database.&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">sqlite3</span><span class="s3">.</span><span class="s1">ProgrammingError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">tquery</span><span class="s3">(</span><span class="s4">&quot;select * from test&quot;</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">conn</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_keyword_as_column_names</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">sqlite_buildin</span><span class="s3">):</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;From&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s5">5</span><span class="s3">)})</span>
        <span class="s2">assert </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">sqlite_buildin</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;testkeywords&quot;</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) == </span><span class="s5">5</span>

    <span class="s2">def </span><span class="s1">test_onecolumn_of_integer</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">sqlite_buildin</span><span class="s3">):</span>
        <span class="s6"># GH 3628</span>
        <span class="s6"># a column_of_integers dataframe should transfer well to sql</span>

        <span class="s1">mono_df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], </span><span class="s1">columns</span><span class="s3">=[</span><span class="s4">&quot;c0&quot;</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span><span class="s1">mono_df</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">sqlite_buildin</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;mono_df&quot;</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) == </span><span class="s5">2</span>
        <span class="s6"># computing the sum via sql</span>
        <span class="s1">con_x </span><span class="s3">= </span><span class="s1">sqlite_buildin</span>
        <span class="s1">the_sum </span><span class="s3">= </span><span class="s1">sum</span><span class="s3">(</span><span class="s1">my_c0</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] </span><span class="s2">for </span><span class="s1">my_c0 </span><span class="s2">in </span><span class="s1">con_x</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s4">&quot;select * from mono_df&quot;</span><span class="s3">))</span>
        <span class="s6"># it should not fail, and gives 3 ( Issue #3628 )</span>
        <span class="s2">assert </span><span class="s1">the_sum </span><span class="s3">== </span><span class="s5">3</span>

        <span class="s1">result </span><span class="s3">= </span><span class="s1">sql</span><span class="s3">.</span><span class="s1">read_sql</span><span class="s3">(</span><span class="s4">&quot;select * from mono_df&quot;</span><span class="s3">, </span><span class="s1">con_x</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">mono_df</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_if_exists</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">sqlite_buildin</span><span class="s3">):</span>
        <span class="s1">df_if_exists_1 </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;col1&quot;</span><span class="s3">: [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], </span><span class="s4">&quot;col2&quot;</span><span class="s3">: [</span><span class="s4">&quot;A&quot;</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">]})</span>
        <span class="s1">df_if_exists_2 </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;col1&quot;</span><span class="s3">: [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">], </span><span class="s4">&quot;col2&quot;</span><span class="s3">: [</span><span class="s4">&quot;C&quot;</span><span class="s3">, </span><span class="s4">&quot;D&quot;</span><span class="s3">, </span><span class="s4">&quot;E&quot;</span><span class="s3">]})</span>
        <span class="s1">table_name </span><span class="s3">= </span><span class="s4">&quot;table_if_exists&quot;</span>
        <span class="s1">sql_select </span><span class="s3">= </span><span class="s4">f&quot;SELECT * FROM </span><span class="s2">{</span><span class="s1">table_name</span><span class="s2">}</span><span class="s4">&quot;</span>

        <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;'notvalidvalue' is not valid for if_exists&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span>
                <span class="s1">frame</span><span class="s3">=</span><span class="s1">df_if_exists_1</span><span class="s3">,</span>
                <span class="s1">con</span><span class="s3">=</span><span class="s1">sqlite_buildin</span><span class="s3">,</span>
                <span class="s1">name</span><span class="s3">=</span><span class="s1">table_name</span><span class="s3">,</span>
                <span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;notvalidvalue&quot;</span><span class="s3">,</span>
            <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">drop_table</span><span class="s3">(</span><span class="s1">table_name</span><span class="s3">, </span><span class="s1">sqlite_buildin</span><span class="s3">)</span>

        <span class="s6"># test if_exists='fail'</span>
        <span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span>
            <span class="s1">frame</span><span class="s3">=</span><span class="s1">df_if_exists_1</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">sqlite_buildin</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s1">table_name</span><span class="s3">, </span><span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;fail&quot;</span>
        <span class="s3">)</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;Table 'table_if_exists' already exists&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span>
                <span class="s1">frame</span><span class="s3">=</span><span class="s1">df_if_exists_1</span><span class="s3">,</span>
                <span class="s1">con</span><span class="s3">=</span><span class="s1">sqlite_buildin</span><span class="s3">,</span>
                <span class="s1">name</span><span class="s3">=</span><span class="s1">table_name</span><span class="s3">,</span>
                <span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;fail&quot;</span><span class="s3">,</span>
            <span class="s3">)</span>
        <span class="s6"># test if_exists='replace'</span>
        <span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span>
            <span class="s1">frame</span><span class="s3">=</span><span class="s1">df_if_exists_1</span><span class="s3">,</span>
            <span class="s1">con</span><span class="s3">=</span><span class="s1">sqlite_buildin</span><span class="s3">,</span>
            <span class="s1">name</span><span class="s3">=</span><span class="s1">table_name</span><span class="s3">,</span>
            <span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;replace&quot;</span><span class="s3">,</span>
            <span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">tquery</span><span class="s3">(</span><span class="s1">sql_select</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">sqlite_buildin</span><span class="s3">) == [(</span><span class="s5">1</span><span class="s3">, </span><span class="s4">&quot;A&quot;</span><span class="s3">), (</span><span class="s5">2</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">)]</span>
        <span class="s2">assert </span><span class="s3">(</span>
            <span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span>
                <span class="s1">frame</span><span class="s3">=</span><span class="s1">df_if_exists_2</span><span class="s3">,</span>
                <span class="s1">con</span><span class="s3">=</span><span class="s1">sqlite_buildin</span><span class="s3">,</span>
                <span class="s1">name</span><span class="s3">=</span><span class="s1">table_name</span><span class="s3">,</span>
                <span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;replace&quot;</span><span class="s3">,</span>
                <span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s3">)</span>
            <span class="s3">== </span><span class="s5">3</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">tquery</span><span class="s3">(</span><span class="s1">sql_select</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">sqlite_buildin</span><span class="s3">) == [(</span><span class="s5">3</span><span class="s3">, </span><span class="s4">&quot;C&quot;</span><span class="s3">), (</span><span class="s5">4</span><span class="s3">, </span><span class="s4">&quot;D&quot;</span><span class="s3">), (</span><span class="s5">5</span><span class="s3">, </span><span class="s4">&quot;E&quot;</span><span class="s3">)]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">drop_table</span><span class="s3">(</span><span class="s1">table_name</span><span class="s3">, </span><span class="s1">sqlite_buildin</span><span class="s3">)</span>

        <span class="s6"># test if_exists='append'</span>
        <span class="s2">assert </span><span class="s3">(</span>
            <span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span>
                <span class="s1">frame</span><span class="s3">=</span><span class="s1">df_if_exists_1</span><span class="s3">,</span>
                <span class="s1">con</span><span class="s3">=</span><span class="s1">sqlite_buildin</span><span class="s3">,</span>
                <span class="s1">name</span><span class="s3">=</span><span class="s1">table_name</span><span class="s3">,</span>
                <span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;fail&quot;</span><span class="s3">,</span>
                <span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s3">)</span>
            <span class="s3">== </span><span class="s5">2</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">tquery</span><span class="s3">(</span><span class="s1">sql_select</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">sqlite_buildin</span><span class="s3">) == [(</span><span class="s5">1</span><span class="s3">, </span><span class="s4">&quot;A&quot;</span><span class="s3">), (</span><span class="s5">2</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">)]</span>
        <span class="s2">assert </span><span class="s3">(</span>
            <span class="s1">sql</span><span class="s3">.</span><span class="s1">to_sql</span><span class="s3">(</span>
                <span class="s1">frame</span><span class="s3">=</span><span class="s1">df_if_exists_2</span><span class="s3">,</span>
                <span class="s1">con</span><span class="s3">=</span><span class="s1">sqlite_buildin</span><span class="s3">,</span>
                <span class="s1">name</span><span class="s3">=</span><span class="s1">table_name</span><span class="s3">,</span>
                <span class="s1">if_exists</span><span class="s3">=</span><span class="s4">&quot;append&quot;</span><span class="s3">,</span>
                <span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s3">)</span>
            <span class="s3">== </span><span class="s5">3</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">tquery</span><span class="s3">(</span><span class="s1">sql_select</span><span class="s3">, </span><span class="s1">con</span><span class="s3">=</span><span class="s1">sqlite_buildin</span><span class="s3">) == [</span>
            <span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s4">&quot;A&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s5">3</span><span class="s3">, </span><span class="s4">&quot;C&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s5">4</span><span class="s3">, </span><span class="s4">&quot;D&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s5">5</span><span class="s3">, </span><span class="s4">&quot;E&quot;</span><span class="s3">),</span>
        <span class="s3">]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">drop_table</span><span class="s3">(</span><span class="s1">table_name</span><span class="s3">, </span><span class="s1">sqlite_buildin</span><span class="s3">)</span>
</pre>
</body>
</html>