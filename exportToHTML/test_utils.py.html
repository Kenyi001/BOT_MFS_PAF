<html>
<head>
<title>test_utils.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #5f826b; font-style: italic;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
.s6 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_utils.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">warnings</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">itertools</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">import </span><span class="s1">weakref</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">assert_equal</span><span class="s2">, </span><span class="s1">assert_array_equal</span><span class="s2">, </span><span class="s1">assert_almost_equal</span><span class="s2">,</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">, </span><span class="s1">assert_array_less</span><span class="s2">, </span><span class="s1">build_err_msg</span><span class="s2">,</span>
    <span class="s1">assert_raises</span><span class="s2">, </span><span class="s1">assert_warns</span><span class="s2">, </span><span class="s1">assert_no_warnings</span><span class="s2">, </span><span class="s1">assert_allclose</span><span class="s2">,</span>
    <span class="s1">assert_approx_equal</span><span class="s2">, </span><span class="s1">assert_array_almost_equal_nulp</span><span class="s2">, </span><span class="s1">assert_array_max_ulp</span><span class="s2">,</span>
    <span class="s1">clear_and_catch_warnings</span><span class="s2">, </span><span class="s1">suppress_warnings</span><span class="s2">, </span><span class="s1">assert_string_equal</span><span class="s2">, </span><span class="s1">assert_</span><span class="s2">,</span>
    <span class="s1">tempdir</span><span class="s2">, </span><span class="s1">temppath</span><span class="s2">, </span><span class="s1">assert_no_gc_cycles</span><span class="s2">, </span><span class="s1">HAS_REFCOUNT</span>
    <span class="s2">)</span>


<span class="s0">class </span><span class="s1">_GenericTest</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">_test_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_test_not_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_array_rank1_eq</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Test two equal array of rank 1 are found equal.&quot;&quot;&quot;</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_array_rank1_noteq</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Test two different array of rank 1 are found not equal.&quot;&quot;&quot;</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_array_rank2_eq</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Test two equal array of rank 2 are found equal.&quot;&quot;&quot;</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]])</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_array_diffshape</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Test two arrays with different shapes are found not equal.&quot;&quot;&quot;</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]])</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_objarray</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Test object arrays.&quot;&quot;&quot;</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_array_likes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_equal</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">TestArrayEqual</span><span class="s2">(</span><span class="s1">_GenericTest</span><span class="s2">):</span>

    <span class="s0">def </span><span class="s1">setup_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func </span><span class="s2">= </span><span class="s1">assert_array_equal</span>

    <span class="s0">def </span><span class="s1">test_generic_rank1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Test rank 1 array for all dtypes.&quot;&quot;&quot;</span>
        <span class="s0">def </span><span class="s1">foo</span><span class="s2">(</span><span class="s1">t</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">t</span><span class="s2">)</span>
            <span class="s1">a</span><span class="s2">.</span><span class="s1">fill</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
            <span class="s1">c </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
            <span class="s1">c</span><span class="s2">.</span><span class="s1">fill</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

        <span class="s5"># Test numeric types and object</span>
        <span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s6">'?bhilqpBHILQPfdgFDG'</span><span class="s2">:</span>
            <span class="s1">foo</span><span class="s2">(</span><span class="s1">t</span><span class="s2">)</span>

        <span class="s5"># Test strings</span>
        <span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s2">[</span><span class="s6">'S1'</span><span class="s2">, </span><span class="s6">'U1'</span><span class="s2">]:</span>
            <span class="s1">foo</span><span class="s2">(</span><span class="s1">t</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_0_ndim_array</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s4">473963742225900817127911193656584771</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s4">18535119325151578301457182298393896</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

        <span class="s1">y </span><span class="s2">= </span><span class="s1">x</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s4">43</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

        <span class="s1">y </span><span class="s2">= </span><span class="s1">x</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_generic_rank3</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Test rank 3 array for all dtypes.&quot;&quot;&quot;</span>
        <span class="s0">def </span><span class="s1">foo</span><span class="s2">(</span><span class="s1">t</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">4</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">), </span><span class="s1">t</span><span class="s2">)</span>
            <span class="s1">a</span><span class="s2">.</span><span class="s1">fill</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
            <span class="s1">c </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
            <span class="s1">c</span><span class="s2">.</span><span class="s1">fill</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

        <span class="s5"># Test numeric types and object</span>
        <span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s6">'?bhilqpBHILQPfdgFDG'</span><span class="s2">:</span>
            <span class="s1">foo</span><span class="s2">(</span><span class="s1">t</span><span class="s2">)</span>

        <span class="s5"># Test strings</span>
        <span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s2">[</span><span class="s6">'S1'</span><span class="s2">, </span><span class="s6">'U1'</span><span class="s2">]:</span>
            <span class="s1">foo</span><span class="s2">(</span><span class="s1">t</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_nan_array</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Test arrays with nan values in them.&quot;&quot;&quot;</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">])</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_string_arrays</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Test two arrays with different shapes are found not equal.&quot;&quot;&quot;</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s6">'floupi'</span><span class="s2">, </span><span class="s6">'floupa'</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s6">'floupi'</span><span class="s2">, </span><span class="s6">'floupa'</span><span class="s2">])</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s6">'floupipi'</span><span class="s2">, </span><span class="s6">'floupa'</span><span class="s2">])</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_recarrays</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Test record arrays.&quot;&quot;&quot;</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, [(</span><span class="s6">'floupi'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s6">'floupa'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)])</span>
        <span class="s1">a</span><span class="s2">[</span><span class="s6">'floupi'</span><span class="s2">] = [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]</span>
        <span class="s1">a</span><span class="s2">[</span><span class="s6">'floupa'</span><span class="s2">] = [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, [(</span><span class="s6">'floupipi'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">),</span>
                         <span class="s2">(</span><span class="s6">'floupi'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s6">'floupa'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)])</span>
        <span class="s1">c</span><span class="s2">[</span><span class="s6">'floupipi'</span><span class="s2">] = </span><span class="s1">a</span><span class="s2">[</span><span class="s6">'floupi'</span><span class="s2">].</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">c</span><span class="s2">[</span><span class="s6">'floupa'</span><span class="s2">] = </span><span class="s1">a</span><span class="s2">[</span><span class="s6">'floupa'</span><span class="s2">].</span><span class="s1">copy</span><span class="s2">()</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_masked_nan_inf</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Regression test for gh-11121</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">MaskedArray</span><span class="s2">([</span><span class="s4">3.</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">, </span><span class="s4">6.5</span><span class="s2">], </span><span class="s1">mask</span><span class="s2">=[</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">3.</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">6.5</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">MaskedArray</span><span class="s2">([</span><span class="s4">3.</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">, </span><span class="s4">6.5</span><span class="s2">], </span><span class="s1">mask</span><span class="s2">=[</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">, </span><span class="s4">6.5</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_subclass_that_overrides_eq</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># While we cannot guarantee testing functions will always work for</span>
        <span class="s5"># subclasses, the tests should ideally rely only on subclasses having</span>
        <span class="s5"># comparison operators, not on them being able to store booleans</span>
        <span class="s5"># (which, e.g., astropy Quantity cannot usefully do). See gh-8452.</span>
        <span class="s0">class </span><span class="s1">MyArray</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">):</span>
            <span class="s0">def </span><span class="s1">__eq__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">).</span><span class="s1">all</span><span class="s2">())</span>

            <span class="s0">def </span><span class="s1">__ne__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
                <span class="s0">return not </span><span class="s1">self </span><span class="s2">== </span><span class="s1">other</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">]).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">MyArray</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">2.</span><span class="s2">, </span><span class="s4">3.</span><span class="s2">]).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">MyArray</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">a </span><span class="s2">== </span><span class="s1">a</span><span class="s2">), </span><span class="s1">bool</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">a </span><span class="s2">== </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">a </span><span class="s2">!= </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_subclass_that_does_not_implement_npall</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">class </span><span class="s1">MyArray</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">):</span>
            <span class="s0">def </span><span class="s1">__array_function__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">NotImplemented</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">]).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">MyArray</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">2.</span><span class="s2">, </span><span class="s4">3.</span><span class="s2">]).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">MyArray</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_suppress_overflow_warnings</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Based on issue #18992</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">all</span><span class="s2">=</span><span class="s6">&quot;raise&quot;</span><span class="s2">):</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">),</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1e-40</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_array_vs_scalar_is_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Test comparing an array with a scalar when all values are equal.&quot;&quot;&quot;</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s4">1.</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_array_vs_scalar_not_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Test comparing an array with a scalar when not all values equal.&quot;&quot;&quot;</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">, </span><span class="s4">3.</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s4">1.</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_array_vs_scalar_strict</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Test comparing an array with a scalar with strict option.&quot;&quot;&quot;</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s4">1.</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">):</span>
            <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">strict</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_array_vs_array_strict</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Test comparing two arrays with strict option.&quot;&quot;&quot;</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">])</span>

        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">strict</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_array_vs_float_array_strict</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Test comparing two arrays with strict option.&quot;&quot;&quot;</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">])</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">):</span>
            <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">strict</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestBuildErrorMessage</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_build_err_msg_defaults</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.00001</span><span class="s2">, </span><span class="s4">2.00002</span><span class="s2">, </span><span class="s4">3.00003</span><span class="s2">])</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.00002</span><span class="s2">, </span><span class="s4">2.00003</span><span class="s2">, </span><span class="s4">3.00004</span><span class="s2">])</span>
        <span class="s1">err_msg </span><span class="s2">= </span><span class="s6">'There is a mismatch'</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">build_err_msg</span><span class="s2">([</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">], </span><span class="s1">err_msg</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= (</span><span class="s6">'</span><span class="s0">\n</span><span class="s6">Items are not equal: There is a mismatch</span><span class="s0">\n </span><span class="s6">ACTUAL: array(['</span>
             <span class="s6">'1.00001, 2.00002, 3.00003])</span><span class="s0">\n </span><span class="s6">DESIRED: array([1.00002, '</span>
             <span class="s6">'2.00003, 3.00004])'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_build_err_msg_no_verbose</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.00001</span><span class="s2">, </span><span class="s4">2.00002</span><span class="s2">, </span><span class="s4">3.00003</span><span class="s2">])</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.00002</span><span class="s2">, </span><span class="s4">2.00003</span><span class="s2">, </span><span class="s4">3.00004</span><span class="s2">])</span>
        <span class="s1">err_msg </span><span class="s2">= </span><span class="s6">'There is a mismatch'</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">build_err_msg</span><span class="s2">([</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">], </span><span class="s1">err_msg</span><span class="s2">, </span><span class="s1">verbose</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s6">'</span><span class="s0">\n</span><span class="s6">Items are not equal: There is a mismatch'</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_build_err_msg_custom_names</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.00001</span><span class="s2">, </span><span class="s4">2.00002</span><span class="s2">, </span><span class="s4">3.00003</span><span class="s2">])</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.00002</span><span class="s2">, </span><span class="s4">2.00003</span><span class="s2">, </span><span class="s4">3.00004</span><span class="s2">])</span>
        <span class="s1">err_msg </span><span class="s2">= </span><span class="s6">'There is a mismatch'</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">build_err_msg</span><span class="s2">([</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">], </span><span class="s1">err_msg</span><span class="s2">, </span><span class="s1">names</span><span class="s2">=(</span><span class="s6">'FOO'</span><span class="s2">, </span><span class="s6">'BAR'</span><span class="s2">))</span>
        <span class="s1">b </span><span class="s2">= (</span><span class="s6">'</span><span class="s0">\n</span><span class="s6">Items are not equal: There is a mismatch</span><span class="s0">\n </span><span class="s6">FOO: array(['</span>
             <span class="s6">'1.00001, 2.00002, 3.00003])</span><span class="s0">\n </span><span class="s6">BAR: array([1.00002, 2.00003, '</span>
             <span class="s6">'3.00004])'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_build_err_msg_custom_precision</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.000000001</span><span class="s2">, </span><span class="s4">2.00002</span><span class="s2">, </span><span class="s4">3.00003</span><span class="s2">])</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.000000002</span><span class="s2">, </span><span class="s4">2.00003</span><span class="s2">, </span><span class="s4">3.00004</span><span class="s2">])</span>
        <span class="s1">err_msg </span><span class="s2">= </span><span class="s6">'There is a mismatch'</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">build_err_msg</span><span class="s2">([</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">], </span><span class="s1">err_msg</span><span class="s2">, </span><span class="s1">precision</span><span class="s2">=</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= (</span><span class="s6">'</span><span class="s0">\n</span><span class="s6">Items are not equal: There is a mismatch</span><span class="s0">\n </span><span class="s6">ACTUAL: array(['</span>
             <span class="s6">'1.000000001, 2.00002    , 3.00003    ])</span><span class="s0">\n </span><span class="s6">DESIRED: array(['</span>
             <span class="s6">'1.000000002, 2.00003    , 3.00004    ])'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestEqual</span><span class="s2">(</span><span class="s1">TestArrayEqual</span><span class="s2">):</span>

    <span class="s0">def </span><span class="s1">setup_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func </span><span class="s2">= </span><span class="s1">assert_equal</span>

    <span class="s0">def </span><span class="s1">test_nan_items</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_inf_items</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">], [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_datetime</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_equal</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s6">&quot;2017-01-01&quot;</span><span class="s2">, </span><span class="s6">&quot;s&quot;</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s6">&quot;2017-01-01&quot;</span><span class="s2">, </span><span class="s6">&quot;s&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_equal</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s6">&quot;2017-01-01&quot;</span><span class="s2">, </span><span class="s6">&quot;s&quot;</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s6">&quot;2017-01-01&quot;</span><span class="s2">, </span><span class="s6">&quot;m&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>

        <span class="s5"># gh-10081</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s6">&quot;2017-01-01&quot;</span><span class="s2">, </span><span class="s6">&quot;s&quot;</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s6">&quot;2017-01-02&quot;</span><span class="s2">, </span><span class="s6">&quot;s&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s6">&quot;2017-01-01&quot;</span><span class="s2">, </span><span class="s6">&quot;s&quot;</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s6">&quot;2017-01-02&quot;</span><span class="s2">, </span><span class="s6">&quot;m&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_nat_items</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># not a datetime</span>
        <span class="s1">nadt_no_unit </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s6">&quot;NaT&quot;</span><span class="s2">)</span>
        <span class="s1">nadt_s </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s6">&quot;NaT&quot;</span><span class="s2">, </span><span class="s6">&quot;s&quot;</span><span class="s2">)</span>
        <span class="s1">nadt_d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s6">&quot;NaT&quot;</span><span class="s2">, </span><span class="s6">&quot;ns&quot;</span><span class="s2">)</span>
        <span class="s5"># not a timedelta</span>
        <span class="s1">natd_no_unit </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s6">&quot;NaT&quot;</span><span class="s2">)</span>
        <span class="s1">natd_s </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s6">&quot;NaT&quot;</span><span class="s2">, </span><span class="s6">&quot;s&quot;</span><span class="s2">)</span>
        <span class="s1">natd_d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s6">&quot;NaT&quot;</span><span class="s2">, </span><span class="s6">&quot;ns&quot;</span><span class="s2">)</span>

        <span class="s1">dts </span><span class="s2">= [</span><span class="s1">nadt_no_unit</span><span class="s2">, </span><span class="s1">nadt_s</span><span class="s2">, </span><span class="s1">nadt_d</span><span class="s2">]</span>
        <span class="s1">tds </span><span class="s2">= [</span><span class="s1">natd_no_unit</span><span class="s2">, </span><span class="s1">natd_s</span><span class="s2">, </span><span class="s1">natd_d</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span><span class="s1">dts</span><span class="s2">, </span><span class="s1">dts</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">([</span><span class="s1">a</span><span class="s2">], [</span><span class="s1">b</span><span class="s2">])</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">([</span><span class="s1">a</span><span class="s2">], </span><span class="s1">b</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span><span class="s1">tds</span><span class="s2">, </span><span class="s1">tds</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">([</span><span class="s1">a</span><span class="s2">], [</span><span class="s1">b</span><span class="s2">])</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">([</span><span class="s1">a</span><span class="s2">], </span><span class="s1">b</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span><span class="s1">tds</span><span class="s2">, </span><span class="s1">dts</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s1">b</span><span class="s2">])</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">([</span><span class="s1">a</span><span class="s2">], [</span><span class="s1">b</span><span class="s2">])</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">([</span><span class="s1">a</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s6">&quot;2017-01-01&quot;</span><span class="s2">, </span><span class="s6">&quot;s&quot;</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">([</span><span class="s1">b</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s6">&quot;2017-01-01&quot;</span><span class="s2">, </span><span class="s6">&quot;s&quot;</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">([</span><span class="s1">a</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s4">123</span><span class="s2">, </span><span class="s6">&quot;s&quot;</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">([</span><span class="s1">b</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s4">123</span><span class="s2">, </span><span class="s6">&quot;s&quot;</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_non_numeric</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s6">'ab'</span><span class="s2">, </span><span class="s6">'ab'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span><span class="s6">'ab'</span><span class="s2">, </span><span class="s6">'abb'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_complex_item</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">complex</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">complex</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span><span class="s1">complex</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span><span class="s1">complex</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span><span class="s1">complex</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_negative_zero</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">PZERO</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">NZERO</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">complex</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)])</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">complex</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_object</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">#gh-12942</span>
        <span class="s0">import </span><span class="s1">datetime</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2000</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                      <span class="s1">datetime</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2000</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">[::-</span><span class="s4">1</span><span class="s2">])</span>


<span class="s0">class </span><span class="s1">TestArrayAlmostEqual</span><span class="s2">(</span><span class="s1">_GenericTest</span><span class="s2">):</span>

    <span class="s0">def </span><span class="s1">setup_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func </span><span class="s2">= </span><span class="s1">assert_array_almost_equal</span>

    <span class="s0">def </span><span class="s1">test_closeness</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Note that in the course of time we ended up with</span>
        <span class="s5">#     `abs(x - y) &lt; 1.5 * 10**(-decimal)`</span>
        <span class="s5"># instead of the previously documented</span>
        <span class="s5">#     `abs(x - y) &lt; 0.5 * 10**(-decimal)`</span>
        <span class="s5"># so this check serves to preserve the wrongness.</span>

        <span class="s5"># test scalars</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s4">1.499999</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">,</span>
                          <span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s4">0</span><span class="s2">))</span>

        <span class="s5"># test arrays</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">([</span><span class="s4">1.499999</span><span class="s2">], [</span><span class="s4">0.0</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">,</span>
                          <span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">([</span><span class="s4">1.5</span><span class="s2">], [</span><span class="s4">0.0</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s4">0</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_simple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1234.2222</span><span class="s2">])</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1234.2223</span><span class="s2">])</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s4">4</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">,</span>
                <span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s4">5</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_nan</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">anan </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">])</span>
        <span class="s1">aone </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">ainf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">anan</span><span class="s2">, </span><span class="s1">anan</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">,</span>
                <span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">anan</span><span class="s2">, </span><span class="s1">aone</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">,</span>
                <span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">anan</span><span class="s2">, </span><span class="s1">ainf</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">,</span>
                <span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">ainf</span><span class="s2">, </span><span class="s1">anan</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_inf</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">], [</span><span class="s4">3.</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">]])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">a</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">,</span>
                <span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">))</span>
        <span class="s1">b</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">,</span>
                <span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_subclass</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">], [</span><span class="s4">3.</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">]])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">masked_array</span><span class="s2">([[</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">], [</span><span class="s4">0.</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">]],</span>
                               <span class="s2">[[</span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">], [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

        <span class="s5"># Test fully masked as well (see gh-11123).</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">MaskedArray</span><span class="s2">(</span><span class="s4">3.5</span><span class="s2">, </span><span class="s1">mask</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">3.</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">, </span><span class="s4">6.5</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">masked</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">3.</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">, </span><span class="s4">6.5</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">MaskedArray</span><span class="s2">([</span><span class="s4">3.</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">, </span><span class="s4">6.5</span><span class="s2">], </span><span class="s1">mask</span><span class="s2">=[</span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">, </span><span class="s4">3.</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">MaskedArray</span><span class="s2">([</span><span class="s4">3.</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">, </span><span class="s4">6.5</span><span class="s2">], </span><span class="s1">mask</span><span class="s2">=[</span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s4">1.</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_subclass_that_cannot_be_bool</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># While we cannot guarantee testing functions will always work for</span>
        <span class="s5"># subclasses, the tests should ideally rely only on subclasses having</span>
        <span class="s5"># comparison operators, not on them being able to store booleans</span>
        <span class="s5"># (which, e.g., astropy Quantity cannot usefully do). See gh-8452.</span>
        <span class="s0">class </span><span class="s1">MyArray</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">):</span>
            <span class="s0">def </span><span class="s1">__eq__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">super</span><span class="s2">().</span><span class="s1">__eq__</span><span class="s2">(</span><span class="s1">other</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>

            <span class="s0">def </span><span class="s1">__lt__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">super</span><span class="s2">().</span><span class="s1">__lt__</span><span class="s2">(</span><span class="s1">other</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>

            <span class="s0">def </span><span class="s1">all</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
                <span class="s0">raise </span><span class="s1">NotImplementedError</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">]).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">MyArray</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestAlmostEqual</span><span class="s2">(</span><span class="s1">_GenericTest</span><span class="s2">):</span>

    <span class="s0">def </span><span class="s1">setup_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func </span><span class="s2">= </span><span class="s1">assert_almost_equal</span>

    <span class="s0">def </span><span class="s1">test_closeness</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Note that in the course of time we ended up with</span>
        <span class="s5">#     `abs(x - y) &lt; 1.5 * 10**(-decimal)`</span>
        <span class="s5"># instead of the previously documented</span>
        <span class="s5">#     `abs(x - y) &lt; 0.5 * 10**(-decimal)`</span>
        <span class="s5"># so this check serves to preserve the wrongness.</span>

        <span class="s5"># test scalars</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s4">1.499999</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">,</span>
                      <span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s4">0</span><span class="s2">))</span>

        <span class="s5"># test arrays</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">([</span><span class="s4">1.499999</span><span class="s2">], [</span><span class="s4">0.0</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">,</span>
                      <span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">([</span><span class="s4">1.5</span><span class="s2">], [</span><span class="s4">0.0</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s4">0</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_nan_item</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">,</span>
                      <span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">,</span>
                      <span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">,</span>
                      <span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_inf_item</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">,</span>
                      <span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">,</span>
                      <span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_simple_item</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_complex_item</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">complex</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">complex</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">complex</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span><span class="s1">complex</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span><span class="s1">complex</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span><span class="s1">complex</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">complex</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)])</span>
        <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">complex</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)])</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">complex</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_not_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_error_message</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Check the message is formatted correctly for the decimal value. 
           Also check the message when input includes inf or nan (gh12200)&quot;&quot;&quot;</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.00000000001</span><span class="s2">, </span><span class="s4">2.00000000002</span><span class="s2">, </span><span class="s4">3.00003</span><span class="s2">])</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.00000000002</span><span class="s2">, </span><span class="s4">2.00000000003</span><span class="s2">, </span><span class="s4">3.00004</span><span class="s2">])</span>

        <span class="s5"># Test with a different amount of decimal digits</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">exc_info</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s4">12</span><span class="s2">)</span>
        <span class="s1">msgs </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">exc_info</span><span class="s2">.</span><span class="s1">value</span><span class="s2">).</span><span class="s1">split</span><span class="s2">(</span><span class="s6">'</span><span class="s0">\n</span><span class="s6">'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">msgs</span><span class="s2">[</span><span class="s4">3</span><span class="s2">], </span><span class="s6">'Mismatched elements: 3 / 3 (100%)'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">msgs</span><span class="s2">[</span><span class="s4">4</span><span class="s2">], </span><span class="s6">'Max absolute difference: 1.e-05'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">msgs</span><span class="s2">[</span><span class="s4">5</span><span class="s2">], </span><span class="s6">'Max relative difference: 3.33328889e-06'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span>
            <span class="s1">msgs</span><span class="s2">[</span><span class="s4">6</span><span class="s2">],</span>
            <span class="s6">' x: array([1.00000000001, 2.00000000002, 3.00003      ])'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span>
            <span class="s1">msgs</span><span class="s2">[</span><span class="s4">7</span><span class="s2">],</span>
            <span class="s6">' y: array([1.00000000002, 2.00000000003, 3.00004      ])'</span><span class="s2">)</span>

        <span class="s5"># With the default value of decimal digits, only the 3rd element</span>
        <span class="s5"># differs. Note that we only check for the formatting of the arrays</span>
        <span class="s5"># themselves.</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">exc_info</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">msgs </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">exc_info</span><span class="s2">.</span><span class="s1">value</span><span class="s2">).</span><span class="s1">split</span><span class="s2">(</span><span class="s6">'</span><span class="s0">\n</span><span class="s6">'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">msgs</span><span class="s2">[</span><span class="s4">3</span><span class="s2">], </span><span class="s6">'Mismatched elements: 1 / 3 (33.3%)'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">msgs</span><span class="s2">[</span><span class="s4">4</span><span class="s2">], </span><span class="s6">'Max absolute difference: 1.e-05'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">msgs</span><span class="s2">[</span><span class="s4">5</span><span class="s2">], </span><span class="s6">'Max relative difference: 3.33328889e-06'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">msgs</span><span class="s2">[</span><span class="s4">6</span><span class="s2">], </span><span class="s6">' x: array([1.     , 2.     , 3.00003])'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">msgs</span><span class="s2">[</span><span class="s4">7</span><span class="s2">], </span><span class="s6">' y: array([1.     , 2.     , 3.00004])'</span><span class="s2">)</span>

        <span class="s5"># Check the error message when input includes inf</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">exc_info</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">msgs </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">exc_info</span><span class="s2">.</span><span class="s1">value</span><span class="s2">).</span><span class="s1">split</span><span class="s2">(</span><span class="s6">'</span><span class="s0">\n</span><span class="s6">'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">msgs</span><span class="s2">[</span><span class="s4">3</span><span class="s2">], </span><span class="s6">'Mismatched elements: 1 / 2 (50%)'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">msgs</span><span class="s2">[</span><span class="s4">4</span><span class="s2">], </span><span class="s6">'Max absolute difference: 1.'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">msgs</span><span class="s2">[</span><span class="s4">5</span><span class="s2">], </span><span class="s6">'Max relative difference: 1.'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">msgs</span><span class="s2">[</span><span class="s4">6</span><span class="s2">], </span><span class="s6">' x: array([inf,  0.])'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">msgs</span><span class="s2">[</span><span class="s4">7</span><span class="s2">], </span><span class="s6">' y: array([inf,  1.])'</span><span class="s2">)</span>

        <span class="s5"># Check the error message when dividing by zero</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">exc_info</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">msgs </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">exc_info</span><span class="s2">.</span><span class="s1">value</span><span class="s2">).</span><span class="s1">split</span><span class="s2">(</span><span class="s6">'</span><span class="s0">\n</span><span class="s6">'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">msgs</span><span class="s2">[</span><span class="s4">3</span><span class="s2">], </span><span class="s6">'Mismatched elements: 2 / 2 (100%)'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">msgs</span><span class="s2">[</span><span class="s4">4</span><span class="s2">], </span><span class="s6">'Max absolute difference: 2'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">msgs</span><span class="s2">[</span><span class="s4">5</span><span class="s2">], </span><span class="s6">'Max relative difference: inf'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_error_message_2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Check the message is formatted correctly when either x or y is a scalar.&quot;&quot;&quot;</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s4">2</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s4">20</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">exc_info</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">msgs </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">exc_info</span><span class="s2">.</span><span class="s1">value</span><span class="s2">).</span><span class="s1">split</span><span class="s2">(</span><span class="s6">'</span><span class="s0">\n</span><span class="s6">'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">msgs</span><span class="s2">[</span><span class="s4">3</span><span class="s2">], </span><span class="s6">'Mismatched elements: 20 / 20 (100%)'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">msgs</span><span class="s2">[</span><span class="s4">4</span><span class="s2">], </span><span class="s6">'Max absolute difference: 1.'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">msgs</span><span class="s2">[</span><span class="s4">5</span><span class="s2">], </span><span class="s6">'Max relative difference: 1.'</span><span class="s2">)</span>

        <span class="s1">y </span><span class="s2">= </span><span class="s4">2</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s4">20</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">exc_info</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">msgs </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">exc_info</span><span class="s2">.</span><span class="s1">value</span><span class="s2">).</span><span class="s1">split</span><span class="s2">(</span><span class="s6">'</span><span class="s0">\n</span><span class="s6">'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">msgs</span><span class="s2">[</span><span class="s4">3</span><span class="s2">], </span><span class="s6">'Mismatched elements: 20 / 20 (100%)'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">msgs</span><span class="s2">[</span><span class="s4">4</span><span class="s2">], </span><span class="s6">'Max absolute difference: 1.'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">msgs</span><span class="s2">[</span><span class="s4">5</span><span class="s2">], </span><span class="s6">'Max relative difference: 0.5'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_subclass_that_cannot_be_bool</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># While we cannot guarantee testing functions will always work for</span>
        <span class="s5"># subclasses, the tests should ideally rely only on subclasses having</span>
        <span class="s5"># comparison operators, not on them being able to store booleans</span>
        <span class="s5"># (which, e.g., astropy Quantity cannot usefully do). See gh-8452.</span>
        <span class="s0">class </span><span class="s1">MyArray</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">):</span>
            <span class="s0">def </span><span class="s1">__eq__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">super</span><span class="s2">().</span><span class="s1">__eq__</span><span class="s2">(</span><span class="s1">other</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>

            <span class="s0">def </span><span class="s1">__lt__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">super</span><span class="s2">().</span><span class="s1">__lt__</span><span class="s2">(</span><span class="s1">other</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>

            <span class="s0">def </span><span class="s1">all</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
                <span class="s0">raise </span><span class="s1">NotImplementedError</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">]).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">MyArray</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestApproxEqual</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">setup_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func </span><span class="s2">= </span><span class="s1">assert_approx_equal</span>

    <span class="s0">def </span><span class="s1">test_simple_0d_arrays</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s4">1234.22</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s4">1234.23</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">significant</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">significant</span><span class="s2">=</span><span class="s4">6</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">,</span>
                      <span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">significant</span><span class="s2">=</span><span class="s4">7</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_simple_items</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s4">1234.22</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s4">1234.23</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">significant</span><span class="s2">=</span><span class="s4">4</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">significant</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">significant</span><span class="s2">=</span><span class="s4">6</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">,</span>
                      <span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">significant</span><span class="s2">=</span><span class="s4">7</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_nan_array</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">anan </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>
        <span class="s1">aone </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">ainf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">anan</span><span class="s2">, </span><span class="s1">anan</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">anan</span><span class="s2">, </span><span class="s1">aone</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">anan</span><span class="s2">, </span><span class="s1">ainf</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">ainf</span><span class="s2">, </span><span class="s1">anan</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_nan_items</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">anan </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>
        <span class="s1">aone </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">ainf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">anan</span><span class="s2">, </span><span class="s1">anan</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">anan</span><span class="s2">, </span><span class="s1">aone</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">anan</span><span class="s2">, </span><span class="s1">ainf</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">ainf</span><span class="s2">, </span><span class="s1">anan</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">TestArrayAssertLess</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">setup_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func </span><span class="s2">= </span><span class="s1">assert_array_less</span>

    <span class="s0">def </span><span class="s1">test_simple_arrays</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.1</span><span class="s2">, </span><span class="s4">2.2</span><span class="s2">])</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.2</span><span class="s2">, </span><span class="s4">2.3</span><span class="s2">])</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">))</span>

        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.3</span><span class="s2">])</span>

        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_rank2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1.1</span><span class="s2">, </span><span class="s4">2.2</span><span class="s2">], [</span><span class="s4">3.3</span><span class="s2">, </span><span class="s4">4.4</span><span class="s2">]])</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1.2</span><span class="s2">, </span><span class="s4">2.3</span><span class="s2">], [</span><span class="s4">3.4</span><span class="s2">, </span><span class="s4">4.5</span><span class="s2">]])</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">))</span>

        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.3</span><span class="s2">], [</span><span class="s4">3.4</span><span class="s2">, </span><span class="s4">4.5</span><span class="s2">]])</span>

        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_rank3</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))+</span><span class="s4">1</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">))</span>

        <span class="s1">y</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>

        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_simple_items</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s4">1.1</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s4">2.2</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">))</span>

        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">2.2</span><span class="s2">, </span><span class="s4">3.3</span><span class="s2">])</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">))</span>

        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">3.3</span><span class="s2">])</span>

        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_nan_noncompare</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">anan </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>
        <span class="s1">aone </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">ainf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">anan</span><span class="s2">, </span><span class="s1">anan</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">aone</span><span class="s2">, </span><span class="s1">anan</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">anan</span><span class="s2">, </span><span class="s1">aone</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">anan</span><span class="s2">, </span><span class="s1">ainf</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">ainf</span><span class="s2">, </span><span class="s1">anan</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_nan_noncompare_array</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.1</span><span class="s2">, </span><span class="s4">2.2</span><span class="s2">, </span><span class="s4">3.3</span><span class="s2">])</span>
        <span class="s1">anan </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>

        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">anan</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">anan</span><span class="s2">, </span><span class="s1">x</span><span class="s2">))</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.1</span><span class="s2">, </span><span class="s4">2.2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">])</span>

        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">anan</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">anan</span><span class="s2">, </span><span class="s1">x</span><span class="s2">))</span>

        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">])</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_inf_compare</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">aone </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">ainf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">aone</span><span class="s2">, </span><span class="s1">ainf</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(-</span><span class="s1">ainf</span><span class="s2">, </span><span class="s1">aone</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(-</span><span class="s1">ainf</span><span class="s2">, </span><span class="s1">ainf</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">ainf</span><span class="s2">, </span><span class="s1">aone</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">aone</span><span class="s2">, -</span><span class="s1">ainf</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">ainf</span><span class="s2">, </span><span class="s1">ainf</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">ainf</span><span class="s2">, -</span><span class="s1">ainf</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(-</span><span class="s1">ainf</span><span class="s2">, -</span><span class="s1">ainf</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_inf_compare_array</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.1</span><span class="s2">, </span><span class="s4">2.2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">])</span>
        <span class="s1">ainf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>

        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">ainf</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">ainf</span><span class="s2">, </span><span class="s1">x</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, -</span><span class="s1">ainf</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(-</span><span class="s1">x</span><span class="s2">, -</span><span class="s1">ainf</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(-</span><span class="s1">ainf</span><span class="s2">, -</span><span class="s1">x</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_func</span><span class="s2">(-</span><span class="s1">ainf</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestWarns</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_warn</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">f</span><span class="s2">():</span>
            <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">&quot;yo&quot;</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s4">3</span>

        <span class="s1">before_filters </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">[</span><span class="s6">'warnings'</span><span class="s2">].</span><span class="s1">filters</span><span class="s2">[:]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">assert_warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">f</span><span class="s2">), </span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">after_filters </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">[</span><span class="s6">'warnings'</span><span class="s2">].</span><span class="s1">filters</span>

        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">assert_no_warnings</span><span class="s2">, </span><span class="s1">f</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">assert_no_warnings</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), </span><span class="s4">1</span><span class="s2">)</span>

        <span class="s5"># Check that the warnings state is unchanged</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">before_filters</span><span class="s2">, </span><span class="s1">after_filters</span><span class="s2">,</span>
                     <span class="s6">&quot;assert_warns does not preserver warnings state&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_context_manager</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s1">before_filters </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">[</span><span class="s6">'warnings'</span><span class="s2">].</span><span class="s1">filters</span><span class="s2">[:]</span>
        <span class="s0">with </span><span class="s1">assert_warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">):</span>
            <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">&quot;yo&quot;</span><span class="s2">)</span>
        <span class="s1">after_filters </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">[</span><span class="s6">'warnings'</span><span class="s2">].</span><span class="s1">filters</span>

        <span class="s0">def </span><span class="s1">no_warnings</span><span class="s2">():</span>
            <span class="s0">with </span><span class="s1">assert_no_warnings</span><span class="s2">():</span>
                <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">&quot;yo&quot;</span><span class="s2">)</span>

        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">no_warnings</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">before_filters</span><span class="s2">, </span><span class="s1">after_filters</span><span class="s2">,</span>
                     <span class="s6">&quot;assert_warns does not preserver warnings state&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_warn_wrong_warning</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">f</span><span class="s2">():</span>
            <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">&quot;yo&quot;</span><span class="s2">, </span><span class="s1">DeprecationWarning</span><span class="s2">)</span>

        <span class="s1">failed </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s0">with </span><span class="s1">warnings</span><span class="s2">.</span><span class="s1">catch_warnings</span><span class="s2">():</span>
            <span class="s1">warnings</span><span class="s2">.</span><span class="s1">simplefilter</span><span class="s2">(</span><span class="s6">&quot;error&quot;</span><span class="s2">, </span><span class="s1">DeprecationWarning</span><span class="s2">)</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s5"># Should raise a DeprecationWarning</span>
                <span class="s1">assert_warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">f</span><span class="s2">)</span>
                <span class="s1">failed </span><span class="s2">= </span><span class="s0">True</span>
            <span class="s0">except </span><span class="s1">DeprecationWarning</span><span class="s2">:</span>
                <span class="s0">pass</span>

        <span class="s0">if </span><span class="s1">failed</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span><span class="s6">&quot;wrong warning caught by assert_warn&quot;</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestAssertAllclose</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_simple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s4">1e-3</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s4">1e-9</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">assert_allclose</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">])</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">assert_allclose</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

        <span class="s1">b</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] = </span><span class="s1">y </span><span class="s2">* (</span><span class="s4">1 </span><span class="s2">+ </span><span class="s4">1e-8</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">assert_allclose</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-9</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s4">6</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">0.5</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">assert_allclose</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">0.5</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_min_int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int_</span><span class="s2">).</span><span class="s1">min</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int_</span><span class="s2">)</span>
        <span class="s5"># Should not raise:</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_report_fail_percentage</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">exc_info</span><span class="s2">:</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">exc_info</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s6">'Mismatched elements: 1 / 4 (25%)</span><span class="s0">\n</span><span class="s6">'</span>
                <span class="s6">'Max absolute difference: 1</span><span class="s0">\n</span><span class="s6">'</span>
                <span class="s6">'Max relative difference: 0.5' </span><span class="s0">in </span><span class="s1">msg</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_equal_nan</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">])</span>
        <span class="s5"># Should not raise:</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">equal_nan</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_not_equal_nan</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">])</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">assert_allclose</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">equal_nan</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_equal_nan_default</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Make sure equal_nan default behavior remains unchanged. (All</span>
        <span class="s5"># of these functions use assert_array_compare under the hood.)</span>
        <span class="s5"># None of these should raise.</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">])</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_array_less</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_report_max_relative_error</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">exc_info</span><span class="s2">:</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">exc_info</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s6">'Max relative difference: 0.5' </span><span class="s0">in </span><span class="s1">msg</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_timedelta</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># see gh-18286</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s6">&quot;NaT&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s6">&quot;m8[ns]&quot;</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_error_message_unsigned</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Check the the message is formatted correctly when overflow can occur 
           (gh21768)&quot;&quot;&quot;</span>
        <span class="s5"># Ensure to test for potential overflow in the case of:</span>
        <span class="s5">#        x - y</span>
        <span class="s5"># and</span>
        <span class="s5">#        y - x</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">8</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s6">'uint8'</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s6">'uint8'</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">exc_info</span><span class="s2">:</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">msgs </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">exc_info</span><span class="s2">.</span><span class="s1">value</span><span class="s2">).</span><span class="s1">split</span><span class="s2">(</span><span class="s6">'</span><span class="s0">\n</span><span class="s6">'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">msgs</span><span class="s2">[</span><span class="s4">4</span><span class="s2">], </span><span class="s6">'Max absolute difference: 4'</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestArrayAlmostEqualNulp</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_float64_pass</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># The number of units of least precision</span>
        <span class="s5"># In this case, use a few places above the lowest level (ie nulp=1)</span>
        <span class="s1">nulp </span><span class="s2">= </span><span class="s4">5</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s4">20</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">50</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s4">10</span><span class="s2">**</span><span class="s1">x</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[-</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">]</span>

        <span class="s5"># Addition</span>
        <span class="s1">eps </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">eps</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">x</span><span class="s2">*</span><span class="s1">eps</span><span class="s2">*</span><span class="s1">nulp</span><span class="s2">/</span><span class="s4">2.</span>
        <span class="s1">assert_array_almost_equal_nulp</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>

        <span class="s5"># Subtraction</span>
        <span class="s1">epsneg </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">epsneg</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x </span><span class="s2">- </span><span class="s1">x</span><span class="s2">*</span><span class="s1">epsneg</span><span class="s2">*</span><span class="s1">nulp</span><span class="s2">/</span><span class="s4">2.</span>
        <span class="s1">assert_array_almost_equal_nulp</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_float64_fail</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">nulp </span><span class="s2">= </span><span class="s4">5</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s4">20</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">50</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s4">10</span><span class="s2">**</span><span class="s1">x</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[-</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">]</span>

        <span class="s1">eps </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">eps</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">x</span><span class="s2">*</span><span class="s1">eps</span><span class="s2">*</span><span class="s1">nulp</span><span class="s2">*</span><span class="s4">2.</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">assert_array_almost_equal_nulp</span><span class="s2">,</span>
                      <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>

        <span class="s1">epsneg </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">epsneg</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x </span><span class="s2">- </span><span class="s1">x</span><span class="s2">*</span><span class="s1">epsneg</span><span class="s2">*</span><span class="s1">nulp</span><span class="s2">*</span><span class="s4">2.</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">assert_array_almost_equal_nulp</span><span class="s2">,</span>
                      <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_float64_ignore_nan</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Ignore ULP differences between various NAN's</span>
        <span class="s5"># Note that MIPS may reverse quiet and signaling nans</span>
        <span class="s5"># so we use the builtin version as a base.</span>
        <span class="s1">offset </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">(</span><span class="s4">0xffffffff</span><span class="s2">)</span>
        <span class="s1">nan1_i64 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">)</span>
        <span class="s1">nan2_i64 </span><span class="s2">= </span><span class="s1">nan1_i64 </span><span class="s2">^ </span><span class="s1">offset  </span><span class="s5"># nan payload on MIPS is all ones.</span>
        <span class="s1">nan1_f64 </span><span class="s2">= </span><span class="s1">nan1_i64</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">nan2_f64 </span><span class="s2">= </span><span class="s1">nan2_i64</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">assert_array_max_ulp</span><span class="s2">(</span><span class="s1">nan1_f64</span><span class="s2">, </span><span class="s1">nan2_f64</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_float32_pass</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">nulp </span><span class="s2">= </span><span class="s4">5</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s4">20</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">50</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s4">10</span><span class="s2">**</span><span class="s1">x</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[-</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">]</span>

        <span class="s1">eps </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">eps</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">x</span><span class="s2">*</span><span class="s1">eps</span><span class="s2">*</span><span class="s1">nulp</span><span class="s2">/</span><span class="s4">2.</span>
        <span class="s1">assert_array_almost_equal_nulp</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>

        <span class="s1">epsneg </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">epsneg</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x </span><span class="s2">- </span><span class="s1">x</span><span class="s2">*</span><span class="s1">epsneg</span><span class="s2">*</span><span class="s1">nulp</span><span class="s2">/</span><span class="s4">2.</span>
        <span class="s1">assert_array_almost_equal_nulp</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_float32_fail</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">nulp </span><span class="s2">= </span><span class="s4">5</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s4">20</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">50</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s4">10</span><span class="s2">**</span><span class="s1">x</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[-</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">]</span>

        <span class="s1">eps </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">eps</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">x</span><span class="s2">*</span><span class="s1">eps</span><span class="s2">*</span><span class="s1">nulp</span><span class="s2">*</span><span class="s4">2.</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">assert_array_almost_equal_nulp</span><span class="s2">,</span>
                      <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>

        <span class="s1">epsneg </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">epsneg</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x </span><span class="s2">- </span><span class="s1">x</span><span class="s2">*</span><span class="s1">epsneg</span><span class="s2">*</span><span class="s1">nulp</span><span class="s2">*</span><span class="s4">2.</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">assert_array_almost_equal_nulp</span><span class="s2">,</span>
                      <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_float32_ignore_nan</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Ignore ULP differences between various NAN's</span>
        <span class="s5"># Note that MIPS may reverse quiet and signaling nans</span>
        <span class="s5"># so we use the builtin version as a base.</span>
        <span class="s1">offset </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">(</span><span class="s4">0xffff</span><span class="s2">)</span>
        <span class="s1">nan1_i32 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">)</span>
        <span class="s1">nan2_i32 </span><span class="s2">= </span><span class="s1">nan1_i32 </span><span class="s2">^ </span><span class="s1">offset  </span><span class="s5"># nan payload on MIPS is all ones.</span>
        <span class="s1">nan1_f32 </span><span class="s2">= </span><span class="s1">nan1_i32</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">nan2_f32 </span><span class="s2">= </span><span class="s1">nan2_i32</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">assert_array_max_ulp</span><span class="s2">(</span><span class="s1">nan1_f32</span><span class="s2">, </span><span class="s1">nan2_f32</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_float16_pass</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">nulp </span><span class="s2">= </span><span class="s4">5</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s4">10</span><span class="s2">**</span><span class="s1">x</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[-</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">]</span>

        <span class="s1">eps </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">eps</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">x</span><span class="s2">*</span><span class="s1">eps</span><span class="s2">*</span><span class="s1">nulp</span><span class="s2">/</span><span class="s4">2.</span>
        <span class="s1">assert_array_almost_equal_nulp</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>

        <span class="s1">epsneg </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">epsneg</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x </span><span class="s2">- </span><span class="s1">x</span><span class="s2">*</span><span class="s1">epsneg</span><span class="s2">*</span><span class="s1">nulp</span><span class="s2">/</span><span class="s4">2.</span>
        <span class="s1">assert_array_almost_equal_nulp</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_float16_fail</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">nulp </span><span class="s2">= </span><span class="s4">5</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s4">10</span><span class="s2">**</span><span class="s1">x</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[-</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">]</span>

        <span class="s1">eps </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">eps</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">x</span><span class="s2">*</span><span class="s1">eps</span><span class="s2">*</span><span class="s1">nulp</span><span class="s2">*</span><span class="s4">2.</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">assert_array_almost_equal_nulp</span><span class="s2">,</span>
                      <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>

        <span class="s1">epsneg </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">epsneg</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x </span><span class="s2">- </span><span class="s1">x</span><span class="s2">*</span><span class="s1">epsneg</span><span class="s2">*</span><span class="s1">nulp</span><span class="s2">*</span><span class="s4">2.</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">assert_array_almost_equal_nulp</span><span class="s2">,</span>
                      <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_float16_ignore_nan</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Ignore ULP differences between various NAN's</span>
        <span class="s5"># Note that MIPS may reverse quiet and signaling nans</span>
        <span class="s5"># so we use the builtin version as a base.</span>
        <span class="s1">offset </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint16</span><span class="s2">(</span><span class="s4">0xff</span><span class="s2">)</span>
        <span class="s1">nan1_i16 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint16</span><span class="s2">)</span>
        <span class="s1">nan2_i16 </span><span class="s2">= </span><span class="s1">nan1_i16 </span><span class="s2">^ </span><span class="s1">offset  </span><span class="s5"># nan payload on MIPS is all ones.</span>
        <span class="s1">nan1_f16 </span><span class="s2">= </span><span class="s1">nan1_i16</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">nan2_f16 </span><span class="s2">= </span><span class="s1">nan2_i16</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">assert_array_max_ulp</span><span class="s2">(</span><span class="s1">nan1_f16</span><span class="s2">, </span><span class="s1">nan2_f16</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_complex128_pass</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">nulp </span><span class="s2">= </span><span class="s4">5</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s4">20</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">50</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s4">10</span><span class="s2">**</span><span class="s1">x</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[-</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">]</span>
        <span class="s1">xi </span><span class="s2">= </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">x</span><span class="s2">*</span><span class="s4">1j</span>

        <span class="s1">eps </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">eps</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">x</span><span class="s2">*</span><span class="s1">eps</span><span class="s2">*</span><span class="s1">nulp</span><span class="s2">/</span><span class="s4">2.</span>
        <span class="s1">assert_array_almost_equal_nulp</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">, </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">y</span><span class="s2">*</span><span class="s4">1j</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal_nulp</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">, </span><span class="s1">y </span><span class="s2">+ </span><span class="s1">x</span><span class="s2">*</span><span class="s4">1j</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>
        <span class="s5"># The test condition needs to be at least a factor of sqrt(2) smaller</span>
        <span class="s5"># because the real and imaginary parts both change</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">x</span><span class="s2">*</span><span class="s1">eps</span><span class="s2">*</span><span class="s1">nulp</span><span class="s2">/</span><span class="s4">4.</span>
        <span class="s1">assert_array_almost_equal_nulp</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">, </span><span class="s1">y </span><span class="s2">+ </span><span class="s1">y</span><span class="s2">*</span><span class="s4">1j</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>

        <span class="s1">epsneg </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">epsneg</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x </span><span class="s2">- </span><span class="s1">x</span><span class="s2">*</span><span class="s1">epsneg</span><span class="s2">*</span><span class="s1">nulp</span><span class="s2">/</span><span class="s4">2.</span>
        <span class="s1">assert_array_almost_equal_nulp</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">, </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">y</span><span class="s2">*</span><span class="s4">1j</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal_nulp</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">, </span><span class="s1">y </span><span class="s2">+ </span><span class="s1">x</span><span class="s2">*</span><span class="s4">1j</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x </span><span class="s2">- </span><span class="s1">x</span><span class="s2">*</span><span class="s1">epsneg</span><span class="s2">*</span><span class="s1">nulp</span><span class="s2">/</span><span class="s4">4.</span>
        <span class="s1">assert_array_almost_equal_nulp</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">, </span><span class="s1">y </span><span class="s2">+ </span><span class="s1">y</span><span class="s2">*</span><span class="s4">1j</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_complex128_fail</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">nulp </span><span class="s2">= </span><span class="s4">5</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s4">20</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">50</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s4">10</span><span class="s2">**</span><span class="s1">x</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[-</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">]</span>
        <span class="s1">xi </span><span class="s2">= </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">x</span><span class="s2">*</span><span class="s4">1j</span>

        <span class="s1">eps </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">eps</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">x</span><span class="s2">*</span><span class="s1">eps</span><span class="s2">*</span><span class="s1">nulp</span><span class="s2">*</span><span class="s4">2.</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">assert_array_almost_equal_nulp</span><span class="s2">,</span>
                      <span class="s1">xi</span><span class="s2">, </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">y</span><span class="s2">*</span><span class="s4">1j</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">assert_array_almost_equal_nulp</span><span class="s2">,</span>
                      <span class="s1">xi</span><span class="s2">, </span><span class="s1">y </span><span class="s2">+ </span><span class="s1">x</span><span class="s2">*</span><span class="s4">1j</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>
        <span class="s5"># The test condition needs to be at least a factor of sqrt(2) smaller</span>
        <span class="s5"># because the real and imaginary parts both change</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">x</span><span class="s2">*</span><span class="s1">eps</span><span class="s2">*</span><span class="s1">nulp</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">assert_array_almost_equal_nulp</span><span class="s2">,</span>
                      <span class="s1">xi</span><span class="s2">, </span><span class="s1">y </span><span class="s2">+ </span><span class="s1">y</span><span class="s2">*</span><span class="s4">1j</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>

        <span class="s1">epsneg </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">epsneg</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x </span><span class="s2">- </span><span class="s1">x</span><span class="s2">*</span><span class="s1">epsneg</span><span class="s2">*</span><span class="s1">nulp</span><span class="s2">*</span><span class="s4">2.</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">assert_array_almost_equal_nulp</span><span class="s2">,</span>
                      <span class="s1">xi</span><span class="s2">, </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">y</span><span class="s2">*</span><span class="s4">1j</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">assert_array_almost_equal_nulp</span><span class="s2">,</span>
                      <span class="s1">xi</span><span class="s2">, </span><span class="s1">y </span><span class="s2">+ </span><span class="s1">x</span><span class="s2">*</span><span class="s4">1j</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x </span><span class="s2">- </span><span class="s1">x</span><span class="s2">*</span><span class="s1">epsneg</span><span class="s2">*</span><span class="s1">nulp</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">assert_array_almost_equal_nulp</span><span class="s2">,</span>
                      <span class="s1">xi</span><span class="s2">, </span><span class="s1">y </span><span class="s2">+ </span><span class="s1">y</span><span class="s2">*</span><span class="s4">1j</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_complex64_pass</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">nulp </span><span class="s2">= </span><span class="s4">5</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s4">20</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">50</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s4">10</span><span class="s2">**</span><span class="s1">x</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[-</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">]</span>
        <span class="s1">xi </span><span class="s2">= </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">x</span><span class="s2">*</span><span class="s4">1j</span>

        <span class="s1">eps </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">eps</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">x</span><span class="s2">*</span><span class="s1">eps</span><span class="s2">*</span><span class="s1">nulp</span><span class="s2">/</span><span class="s4">2.</span>
        <span class="s1">assert_array_almost_equal_nulp</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">, </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">y</span><span class="s2">*</span><span class="s4">1j</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal_nulp</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">, </span><span class="s1">y </span><span class="s2">+ </span><span class="s1">x</span><span class="s2">*</span><span class="s4">1j</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">x</span><span class="s2">*</span><span class="s1">eps</span><span class="s2">*</span><span class="s1">nulp</span><span class="s2">/</span><span class="s4">4.</span>
        <span class="s1">assert_array_almost_equal_nulp</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">, </span><span class="s1">y </span><span class="s2">+ </span><span class="s1">y</span><span class="s2">*</span><span class="s4">1j</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>

        <span class="s1">epsneg </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">epsneg</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x </span><span class="s2">- </span><span class="s1">x</span><span class="s2">*</span><span class="s1">epsneg</span><span class="s2">*</span><span class="s1">nulp</span><span class="s2">/</span><span class="s4">2.</span>
        <span class="s1">assert_array_almost_equal_nulp</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">, </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">y</span><span class="s2">*</span><span class="s4">1j</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal_nulp</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">, </span><span class="s1">y </span><span class="s2">+ </span><span class="s1">x</span><span class="s2">*</span><span class="s4">1j</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x </span><span class="s2">- </span><span class="s1">x</span><span class="s2">*</span><span class="s1">epsneg</span><span class="s2">*</span><span class="s1">nulp</span><span class="s2">/</span><span class="s4">4.</span>
        <span class="s1">assert_array_almost_equal_nulp</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">, </span><span class="s1">y </span><span class="s2">+ </span><span class="s1">y</span><span class="s2">*</span><span class="s4">1j</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_complex64_fail</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">nulp </span><span class="s2">= </span><span class="s4">5</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s4">20</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">50</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s4">10</span><span class="s2">**</span><span class="s1">x</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[-</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">]</span>
        <span class="s1">xi </span><span class="s2">= </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">x</span><span class="s2">*</span><span class="s4">1j</span>

        <span class="s1">eps </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">eps</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">x</span><span class="s2">*</span><span class="s1">eps</span><span class="s2">*</span><span class="s1">nulp</span><span class="s2">*</span><span class="s4">2.</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">assert_array_almost_equal_nulp</span><span class="s2">,</span>
                      <span class="s1">xi</span><span class="s2">, </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">y</span><span class="s2">*</span><span class="s4">1j</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">assert_array_almost_equal_nulp</span><span class="s2">,</span>
                      <span class="s1">xi</span><span class="s2">, </span><span class="s1">y </span><span class="s2">+ </span><span class="s1">x</span><span class="s2">*</span><span class="s4">1j</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">x</span><span class="s2">*</span><span class="s1">eps</span><span class="s2">*</span><span class="s1">nulp</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">assert_array_almost_equal_nulp</span><span class="s2">,</span>
                      <span class="s1">xi</span><span class="s2">, </span><span class="s1">y </span><span class="s2">+ </span><span class="s1">y</span><span class="s2">*</span><span class="s4">1j</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>

        <span class="s1">epsneg </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">epsneg</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x </span><span class="s2">- </span><span class="s1">x</span><span class="s2">*</span><span class="s1">epsneg</span><span class="s2">*</span><span class="s1">nulp</span><span class="s2">*</span><span class="s4">2.</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">assert_array_almost_equal_nulp</span><span class="s2">,</span>
                      <span class="s1">xi</span><span class="s2">, </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">y</span><span class="s2">*</span><span class="s4">1j</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">assert_array_almost_equal_nulp</span><span class="s2">,</span>
                      <span class="s1">xi</span><span class="s2">, </span><span class="s1">y </span><span class="s2">+ </span><span class="s1">x</span><span class="s2">*</span><span class="s4">1j</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x </span><span class="s2">- </span><span class="s1">x</span><span class="s2">*</span><span class="s1">epsneg</span><span class="s2">*</span><span class="s1">nulp</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">assert_array_almost_equal_nulp</span><span class="s2">,</span>
                      <span class="s1">xi</span><span class="s2">, </span><span class="s1">y </span><span class="s2">+ </span><span class="s1">y</span><span class="s2">*</span><span class="s4">1j</span><span class="s2">, </span><span class="s1">nulp</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestULP</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">assert_array_max_ulp</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">maxulp</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_single</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Generate 1 + small deviation, check that adding eps gives a few UNL</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s4">10</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">+= </span><span class="s4">0.01 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s4">10</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">eps </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">).</span><span class="s1">eps</span>
        <span class="s1">assert_array_max_ulp</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">+</span><span class="s1">eps</span><span class="s2">, </span><span class="s1">maxulp</span><span class="s2">=</span><span class="s4">20</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_double</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Generate 1 + small deviation, check that adding eps gives a few UNL</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s4">10</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">+= </span><span class="s4">0.01 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s4">10</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">eps </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">).</span><span class="s1">eps</span>
        <span class="s1">assert_array_max_ulp</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">+</span><span class="s1">eps</span><span class="s2">, </span><span class="s1">maxulp</span><span class="s2">=</span><span class="s4">200</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_inf</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">]:</span>
            <span class="s1">inf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">big </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">).</span><span class="s1">max</span><span class="s2">])</span>
            <span class="s1">assert_array_max_ulp</span><span class="s2">(</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">big</span><span class="s2">, </span><span class="s1">maxulp</span><span class="s2">=</span><span class="s4">200</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_nan</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Test that nan is 'far' from small, tiny, inf, max and min</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">]:</span>
            <span class="s0">if </span><span class="s1">dt </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">:</span>
                <span class="s1">maxulp </span><span class="s2">= </span><span class="s4">1e6</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">maxulp </span><span class="s2">= </span><span class="s4">1e12</span>
            <span class="s1">inf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">nan </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">big </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">).</span><span class="s1">max</span><span class="s2">])</span>
            <span class="s1">tiny </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">).</span><span class="s1">tiny</span><span class="s2">])</span>
            <span class="s1">zero </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">PZERO</span><span class="s2">]).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">nzero </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">NZERO</span><span class="s2">]).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">,</span>
                          <span class="s0">lambda</span><span class="s2">: </span><span class="s1">assert_array_max_ulp</span><span class="s2">(</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">inf</span><span class="s2">,</span>
                          <span class="s1">maxulp</span><span class="s2">=</span><span class="s1">maxulp</span><span class="s2">))</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">,</span>
                          <span class="s0">lambda</span><span class="s2">: </span><span class="s1">assert_array_max_ulp</span><span class="s2">(</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">big</span><span class="s2">,</span>
                          <span class="s1">maxulp</span><span class="s2">=</span><span class="s1">maxulp</span><span class="s2">))</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">,</span>
                          <span class="s0">lambda</span><span class="s2">: </span><span class="s1">assert_array_max_ulp</span><span class="s2">(</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">tiny</span><span class="s2">,</span>
                          <span class="s1">maxulp</span><span class="s2">=</span><span class="s1">maxulp</span><span class="s2">))</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">,</span>
                          <span class="s0">lambda</span><span class="s2">: </span><span class="s1">assert_array_max_ulp</span><span class="s2">(</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">zero</span><span class="s2">,</span>
                          <span class="s1">maxulp</span><span class="s2">=</span><span class="s1">maxulp</span><span class="s2">))</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">,</span>
                          <span class="s0">lambda</span><span class="s2">: </span><span class="s1">assert_array_max_ulp</span><span class="s2">(</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">nzero</span><span class="s2">,</span>
                          <span class="s1">maxulp</span><span class="s2">=</span><span class="s1">maxulp</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">TestStringEqual</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_simple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_string_equal</span><span class="s2">(</span><span class="s6">&quot;hello&quot;</span><span class="s2">, </span><span class="s6">&quot;hello&quot;</span><span class="s2">)</span>
        <span class="s1">assert_string_equal</span><span class="s2">(</span><span class="s6">&quot;hello</span><span class="s0">\n</span><span class="s6">multiline&quot;</span><span class="s2">, </span><span class="s6">&quot;hello</span><span class="s0">\n</span><span class="s6">multiline&quot;</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">exc_info</span><span class="s2">:</span>
            <span class="s1">assert_string_equal</span><span class="s2">(</span><span class="s6">&quot;foo</span><span class="s0">\n</span><span class="s6">bar&quot;</span><span class="s2">, </span><span class="s6">&quot;hello</span><span class="s0">\n</span><span class="s6">bar&quot;</span><span class="s2">)</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">exc_info</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">, </span><span class="s6">&quot;Differences in strings:</span><span class="s0">\n</span><span class="s6">- foo</span><span class="s0">\n</span><span class="s6">+ hello&quot;</span><span class="s2">)</span>

        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">,</span>
                      <span class="s0">lambda</span><span class="s2">: </span><span class="s1">assert_string_equal</span><span class="s2">(</span><span class="s6">&quot;foo&quot;</span><span class="s2">, </span><span class="s6">&quot;hello&quot;</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_regex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_string_equal</span><span class="s2">(</span><span class="s6">&quot;a+*b&quot;</span><span class="s2">, </span><span class="s6">&quot;a+*b&quot;</span><span class="s2">)</span>

        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">,</span>
                      <span class="s0">lambda</span><span class="s2">: </span><span class="s1">assert_string_equal</span><span class="s2">(</span><span class="s6">&quot;aaa&quot;</span><span class="s2">, </span><span class="s6">&quot;a+b&quot;</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">assert_warn_len_equal</span><span class="s2">(</span><span class="s1">mod</span><span class="s2">, </span><span class="s1">n_in_context</span><span class="s2">):</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">mod_warns </span><span class="s2">= </span><span class="s1">mod</span><span class="s2">.</span><span class="s1">__warningregistry__</span>
    <span class="s0">except </span><span class="s1">AttributeError</span><span class="s2">:</span>
        <span class="s5"># the lack of a __warningregistry__</span>
        <span class="s5"># attribute means that no warning has</span>
        <span class="s5"># occurred; this can be triggered in</span>
        <span class="s5"># a parallel test scenario, while in</span>
        <span class="s5"># a serial test scenario an initial</span>
        <span class="s5"># warning (and therefore the attribute)</span>
        <span class="s5"># are always created first</span>
        <span class="s1">mod_warns </span><span class="s2">= {}</span>

    <span class="s1">num_warns </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">mod_warns</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s6">'version' </span><span class="s0">in </span><span class="s1">mod_warns</span><span class="s2">:</span>
        <span class="s5"># Python 3 adds a 'version' entry to the registry,</span>
        <span class="s5"># do not count it.</span>
        <span class="s1">num_warns </span><span class="s2">-= </span><span class="s4">1</span>

    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">num_warns</span><span class="s2">, </span><span class="s1">n_in_context</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_warn_len_equal_call_scenarios</span><span class="s2">():</span>
    <span class="s5"># assert_warn_len_equal is called under</span>
    <span class="s5"># varying circumstances depending on serial</span>
    <span class="s5"># vs. parallel test scenarios; this test</span>
    <span class="s5"># simply aims to probe both code paths and</span>
    <span class="s5"># check that no assertion is uncaught</span>

    <span class="s5"># parallel scenario -- no warning issued yet</span>
    <span class="s0">class </span><span class="s1">mod</span><span class="s2">:</span>
        <span class="s0">pass</span>

    <span class="s1">mod_inst </span><span class="s2">= </span><span class="s1">mod</span><span class="s2">()</span>

    <span class="s1">assert_warn_len_equal</span><span class="s2">(</span><span class="s1">mod</span><span class="s2">=</span><span class="s1">mod_inst</span><span class="s2">,</span>
                          <span class="s1">n_in_context</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>

    <span class="s5"># serial test scenario -- the __warningregistry__</span>
    <span class="s5"># attribute should be present</span>
    <span class="s0">class </span><span class="s1">mod</span><span class="s2">:</span>
        <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__warningregistry__ </span><span class="s2">= {</span><span class="s6">'warning1'</span><span class="s2">:</span><span class="s4">1</span><span class="s2">,</span>
                                        <span class="s6">'warning2'</span><span class="s2">:</span><span class="s4">2</span><span class="s2">}</span>

    <span class="s1">mod_inst </span><span class="s2">= </span><span class="s1">mod</span><span class="s2">()</span>
    <span class="s1">assert_warn_len_equal</span><span class="s2">(</span><span class="s1">mod</span><span class="s2">=</span><span class="s1">mod_inst</span><span class="s2">,</span>
                          <span class="s1">n_in_context</span><span class="s2">=</span><span class="s4">2</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_get_fresh_mod</span><span class="s2">():</span>
    <span class="s5"># Get this module, with warning registry empty</span>
    <span class="s1">my_mod </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">[</span><span class="s1">__name__</span><span class="s2">]</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">my_mod</span><span class="s2">.</span><span class="s1">__warningregistry__</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
    <span class="s0">except </span><span class="s1">AttributeError</span><span class="s2">:</span>
        <span class="s5"># will not have a __warningregistry__ unless warning has been</span>
        <span class="s5"># raised in the module at some point</span>
        <span class="s0">pass</span>
    <span class="s0">return </span><span class="s1">my_mod</span>


<span class="s0">def </span><span class="s1">test_clear_and_catch_warnings</span><span class="s2">():</span>
    <span class="s5"># Initial state of module, no warnings</span>
    <span class="s1">my_mod </span><span class="s2">= </span><span class="s1">_get_fresh_mod</span><span class="s2">()</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">my_mod</span><span class="s2">, </span><span class="s6">'__warningregistry__'</span><span class="s2">, {}), {})</span>
    <span class="s0">with </span><span class="s1">clear_and_catch_warnings</span><span class="s2">(</span><span class="s1">modules</span><span class="s2">=[</span><span class="s1">my_mod</span><span class="s2">]):</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">simplefilter</span><span class="s2">(</span><span class="s6">'ignore'</span><span class="s2">)</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">'Some warning'</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">my_mod</span><span class="s2">.</span><span class="s1">__warningregistry__</span><span class="s2">, {})</span>
    <span class="s5"># Without specified modules, don't clear warnings during context.</span>
    <span class="s5"># catch_warnings doesn't make an entry for 'ignore'.</span>
    <span class="s0">with </span><span class="s1">clear_and_catch_warnings</span><span class="s2">():</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">simplefilter</span><span class="s2">(</span><span class="s6">'ignore'</span><span class="s2">)</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">'Some warning'</span><span class="s2">)</span>
    <span class="s1">assert_warn_len_equal</span><span class="s2">(</span><span class="s1">my_mod</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>

    <span class="s5"># Manually adding two warnings to the registry:</span>
    <span class="s1">my_mod</span><span class="s2">.</span><span class="s1">__warningregistry__ </span><span class="s2">= {</span><span class="s6">'warning1'</span><span class="s2">: </span><span class="s4">1</span><span class="s2">,</span>
                                  <span class="s6">'warning2'</span><span class="s2">: </span><span class="s4">2</span><span class="s2">}</span>

    <span class="s5"># Confirm that specifying module keeps old warning, does not add new</span>
    <span class="s0">with </span><span class="s1">clear_and_catch_warnings</span><span class="s2">(</span><span class="s1">modules</span><span class="s2">=[</span><span class="s1">my_mod</span><span class="s2">]):</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">simplefilter</span><span class="s2">(</span><span class="s6">'ignore'</span><span class="s2">)</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">'Another warning'</span><span class="s2">)</span>
    <span class="s1">assert_warn_len_equal</span><span class="s2">(</span><span class="s1">my_mod</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>

    <span class="s5"># Another warning, no module spec it clears up registry</span>
    <span class="s0">with </span><span class="s1">clear_and_catch_warnings</span><span class="s2">():</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">simplefilter</span><span class="s2">(</span><span class="s6">'ignore'</span><span class="s2">)</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">'Another warning'</span><span class="s2">)</span>
    <span class="s1">assert_warn_len_equal</span><span class="s2">(</span><span class="s1">my_mod</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_suppress_warnings_module</span><span class="s2">():</span>
    <span class="s5"># Initial state of module, no warnings</span>
    <span class="s1">my_mod </span><span class="s2">= </span><span class="s1">_get_fresh_mod</span><span class="s2">()</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">my_mod</span><span class="s2">, </span><span class="s6">'__warningregistry__'</span><span class="s2">, {}), {})</span>

    <span class="s0">def </span><span class="s1">warn_other_module</span><span class="s2">():</span>
        <span class="s5"># Apply along axis is implemented in python; stacklevel=2 means</span>
        <span class="s5"># we end up inside its module, not ours.</span>
        <span class="s0">def </span><span class="s1">warn</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">):</span>
            <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">&quot;Some warning 2&quot;</span><span class="s2">, </span><span class="s1">stacklevel</span><span class="s2">=</span><span class="s4">2</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">arr</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">apply_along_axis</span><span class="s2">(</span><span class="s1">warn</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">])</span>

    <span class="s5"># Test module based warning suppression:</span>
    <span class="s1">assert_warn_len_equal</span><span class="s2">(</span><span class="s1">my_mod</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sup</span><span class="s2">:</span>
        <span class="s1">sup</span><span class="s2">.</span><span class="s1">record</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">)</span>
        <span class="s5"># suppress warning from other module (may have .pyc ending),</span>
        <span class="s5"># if apply_along_axis is moved, had to be changed.</span>
        <span class="s1">sup</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">module</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">lib</span><span class="s2">.</span><span class="s1">shape_base</span><span class="s2">)</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">&quot;Some warning&quot;</span><span class="s2">)</span>
        <span class="s1">warn_other_module</span><span class="s2">()</span>
    <span class="s5"># Check that the suppression did test the file correctly (this module</span>
    <span class="s5"># got filtered)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">sup</span><span class="s2">.</span><span class="s1">log</span><span class="s2">), </span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">sup</span><span class="s2">.</span><span class="s1">log</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">message</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s6">&quot;Some warning&quot;</span><span class="s2">)</span>
    <span class="s1">assert_warn_len_equal</span><span class="s2">(</span><span class="s1">my_mod</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">sup </span><span class="s2">= </span><span class="s1">suppress_warnings</span><span class="s2">()</span>
    <span class="s5"># Will have to be changed if apply_along_axis is moved:</span>
    <span class="s1">sup</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">module</span><span class="s2">=</span><span class="s1">my_mod</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">sup</span><span class="s2">:</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">'Some warning'</span><span class="s2">)</span>
    <span class="s1">assert_warn_len_equal</span><span class="s2">(</span><span class="s1">my_mod</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
    <span class="s5"># And test repeat works:</span>
    <span class="s1">sup</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">module</span><span class="s2">=</span><span class="s1">my_mod</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">sup</span><span class="s2">:</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">'Some warning'</span><span class="s2">)</span>
    <span class="s1">assert_warn_len_equal</span><span class="s2">(</span><span class="s1">my_mod</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>

    <span class="s5"># Without specified modules</span>
    <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">():</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">simplefilter</span><span class="s2">(</span><span class="s6">'ignore'</span><span class="s2">)</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">'Some warning'</span><span class="s2">)</span>
    <span class="s1">assert_warn_len_equal</span><span class="s2">(</span><span class="s1">my_mod</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_suppress_warnings_type</span><span class="s2">():</span>
    <span class="s5"># Initial state of module, no warnings</span>
    <span class="s1">my_mod </span><span class="s2">= </span><span class="s1">_get_fresh_mod</span><span class="s2">()</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">my_mod</span><span class="s2">, </span><span class="s6">'__warningregistry__'</span><span class="s2">, {}), {})</span>

    <span class="s5"># Test module based warning suppression:</span>
    <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sup</span><span class="s2">:</span>
        <span class="s1">sup</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">)</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">'Some warning'</span><span class="s2">)</span>
    <span class="s1">assert_warn_len_equal</span><span class="s2">(</span><span class="s1">my_mod</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">sup </span><span class="s2">= </span><span class="s1">suppress_warnings</span><span class="s2">()</span>
    <span class="s1">sup</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">sup</span><span class="s2">:</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">'Some warning'</span><span class="s2">)</span>
    <span class="s1">assert_warn_len_equal</span><span class="s2">(</span><span class="s1">my_mod</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
    <span class="s5"># And test repeat works:</span>
    <span class="s1">sup</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">module</span><span class="s2">=</span><span class="s1">my_mod</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">sup</span><span class="s2">:</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">'Some warning'</span><span class="s2">)</span>
    <span class="s1">assert_warn_len_equal</span><span class="s2">(</span><span class="s1">my_mod</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>

    <span class="s5"># Without specified modules</span>
    <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">():</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">simplefilter</span><span class="s2">(</span><span class="s6">'ignore'</span><span class="s2">)</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">'Some warning'</span><span class="s2">)</span>
    <span class="s1">assert_warn_len_equal</span><span class="s2">(</span><span class="s1">my_mod</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_suppress_warnings_decorate_no_record</span><span class="s2">():</span>
    <span class="s1">sup </span><span class="s2">= </span><span class="s1">suppress_warnings</span><span class="s2">()</span>
    <span class="s1">sup</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">sup</span>
    <span class="s0">def </span><span class="s1">warn</span><span class="s2">(</span><span class="s1">category</span><span class="s2">):</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">'Some warning'</span><span class="s2">, </span><span class="s1">category</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">warnings</span><span class="s2">.</span><span class="s1">catch_warnings</span><span class="s2">(</span><span class="s1">record</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">w</span><span class="s2">:</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">simplefilter</span><span class="s2">(</span><span class="s6">&quot;always&quot;</span><span class="s2">)</span>
        <span class="s1">warn</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">)  </span><span class="s5"># should be supppressed</span>
        <span class="s1">warn</span><span class="s2">(</span><span class="s1">RuntimeWarning</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">w</span><span class="s2">), </span><span class="s4">1</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_suppress_warnings_record</span><span class="s2">():</span>
    <span class="s1">sup </span><span class="s2">= </span><span class="s1">suppress_warnings</span><span class="s2">()</span>
    <span class="s1">log1 </span><span class="s2">= </span><span class="s1">sup</span><span class="s2">.</span><span class="s1">record</span><span class="s2">()</span>

    <span class="s0">with </span><span class="s1">sup</span><span class="s2">:</span>
        <span class="s1">log2 </span><span class="s2">= </span><span class="s1">sup</span><span class="s2">.</span><span class="s1">record</span><span class="s2">(</span><span class="s1">message</span><span class="s2">=</span><span class="s6">'Some other warning 2'</span><span class="s2">)</span>
        <span class="s1">sup</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">message</span><span class="s2">=</span><span class="s6">'Some warning'</span><span class="s2">)</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">'Some warning'</span><span class="s2">)</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">'Some other warning'</span><span class="s2">)</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">'Some other warning 2'</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">sup</span><span class="s2">.</span><span class="s1">log</span><span class="s2">), </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">log1</span><span class="s2">), </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">log2</span><span class="s2">),</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">log2</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">message</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s6">'Some other warning 2'</span><span class="s2">)</span>

    <span class="s5"># Do it again, with the same context to see if some warnings survived:</span>
    <span class="s0">with </span><span class="s1">sup</span><span class="s2">:</span>
        <span class="s1">log2 </span><span class="s2">= </span><span class="s1">sup</span><span class="s2">.</span><span class="s1">record</span><span class="s2">(</span><span class="s1">message</span><span class="s2">=</span><span class="s6">'Some other warning 2'</span><span class="s2">)</span>
        <span class="s1">sup</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">message</span><span class="s2">=</span><span class="s6">'Some warning'</span><span class="s2">)</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">'Some warning'</span><span class="s2">)</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">'Some other warning'</span><span class="s2">)</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">'Some other warning 2'</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">sup</span><span class="s2">.</span><span class="s1">log</span><span class="s2">), </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">log1</span><span class="s2">), </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">log2</span><span class="s2">), </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">log2</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">message</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s6">'Some other warning 2'</span><span class="s2">)</span>

    <span class="s5"># Test nested:</span>
    <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sup</span><span class="s2">:</span>
        <span class="s1">sup</span><span class="s2">.</span><span class="s1">record</span><span class="s2">()</span>
        <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sup2</span><span class="s2">:</span>
            <span class="s1">sup2</span><span class="s2">.</span><span class="s1">record</span><span class="s2">(</span><span class="s1">message</span><span class="s2">=</span><span class="s6">'Some warning'</span><span class="s2">)</span>
            <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">'Some warning'</span><span class="s2">)</span>
            <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">'Some other warning'</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">sup2</span><span class="s2">.</span><span class="s1">log</span><span class="s2">), </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">sup</span><span class="s2">.</span><span class="s1">log</span><span class="s2">), </span><span class="s4">1</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_suppress_warnings_forwarding</span><span class="s2">():</span>
    <span class="s0">def </span><span class="s1">warn_other_module</span><span class="s2">():</span>
        <span class="s5"># Apply along axis is implemented in python; stacklevel=2 means</span>
        <span class="s5"># we end up inside its module, not ours.</span>
        <span class="s0">def </span><span class="s1">warn</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">):</span>
            <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">&quot;Some warning&quot;</span><span class="s2">, </span><span class="s1">stacklevel</span><span class="s2">=</span><span class="s4">2</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">arr</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">apply_along_axis</span><span class="s2">(</span><span class="s1">warn</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">])</span>

    <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sup</span><span class="s2">:</span>
        <span class="s1">sup</span><span class="s2">.</span><span class="s1">record</span><span class="s2">()</span>
        <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">(</span><span class="s6">&quot;always&quot;</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
                <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">&quot;Some warning&quot;</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">sup</span><span class="s2">.</span><span class="s1">log</span><span class="s2">), </span><span class="s4">2</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sup</span><span class="s2">:</span>
        <span class="s1">sup</span><span class="s2">.</span><span class="s1">record</span><span class="s2">()</span>
        <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">(</span><span class="s6">&quot;location&quot;</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
                <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">&quot;Some warning&quot;</span><span class="s2">)</span>
                <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">&quot;Some warning&quot;</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">sup</span><span class="s2">.</span><span class="s1">log</span><span class="s2">), </span><span class="s4">2</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sup</span><span class="s2">:</span>
        <span class="s1">sup</span><span class="s2">.</span><span class="s1">record</span><span class="s2">()</span>
        <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">(</span><span class="s6">&quot;module&quot;</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
                <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">&quot;Some warning&quot;</span><span class="s2">)</span>
                <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">&quot;Some warning&quot;</span><span class="s2">)</span>
                <span class="s1">warn_other_module</span><span class="s2">()</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">sup</span><span class="s2">.</span><span class="s1">log</span><span class="s2">), </span><span class="s4">2</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sup</span><span class="s2">:</span>
        <span class="s1">sup</span><span class="s2">.</span><span class="s1">record</span><span class="s2">()</span>
        <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">(</span><span class="s6">&quot;once&quot;</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
                <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">&quot;Some warning&quot;</span><span class="s2">)</span>
                <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">&quot;Some other warning&quot;</span><span class="s2">)</span>
                <span class="s1">warn_other_module</span><span class="s2">()</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">sup</span><span class="s2">.</span><span class="s1">log</span><span class="s2">), </span><span class="s4">2</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_tempdir</span><span class="s2">():</span>
    <span class="s0">with </span><span class="s1">tempdir</span><span class="s2">() </span><span class="s0">as </span><span class="s1">tdir</span><span class="s2">:</span>
        <span class="s1">fpath </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">tdir</span><span class="s2">, </span><span class="s6">'tmp'</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">fpath</span><span class="s2">, </span><span class="s6">'w'</span><span class="s2">):</span>
            <span class="s0">pass</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s0">not </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isdir</span><span class="s2">(</span><span class="s1">tdir</span><span class="s2">))</span>

    <span class="s1">raised </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">tempdir</span><span class="s2">() </span><span class="s0">as </span><span class="s1">tdir</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">()</span>
    <span class="s0">except </span><span class="s1">ValueError</span><span class="s2">:</span>
        <span class="s1">raised </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">raised</span><span class="s2">)</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s0">not </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isdir</span><span class="s2">(</span><span class="s1">tdir</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_temppath</span><span class="s2">():</span>
    <span class="s0">with </span><span class="s1">temppath</span><span class="s2">() </span><span class="s0">as </span><span class="s1">fpath</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">fpath</span><span class="s2">, </span><span class="s6">'w'</span><span class="s2">):</span>
            <span class="s0">pass</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s0">not </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isfile</span><span class="s2">(</span><span class="s1">fpath</span><span class="s2">))</span>

    <span class="s1">raised </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">temppath</span><span class="s2">() </span><span class="s0">as </span><span class="s1">fpath</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">()</span>
    <span class="s0">except </span><span class="s1">ValueError</span><span class="s2">:</span>
        <span class="s1">raised </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">raised</span><span class="s2">)</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s0">not </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isfile</span><span class="s2">(</span><span class="s1">fpath</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">my_cacw</span><span class="s2">(</span><span class="s1">clear_and_catch_warnings</span><span class="s2">):</span>

    <span class="s1">class_modules </span><span class="s2">= (</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">[</span><span class="s1">__name__</span><span class="s2">],)</span>


<span class="s0">def </span><span class="s1">test_clear_and_catch_warnings_inherit</span><span class="s2">():</span>
    <span class="s5"># Test can subclass and add default modules</span>
    <span class="s1">my_mod </span><span class="s2">= </span><span class="s1">_get_fresh_mod</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">my_cacw</span><span class="s2">():</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">simplefilter</span><span class="s2">(</span><span class="s6">'ignore'</span><span class="s2">)</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">'Some warning'</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">my_mod</span><span class="s2">.</span><span class="s1">__warningregistry__</span><span class="s2">, {})</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s0">not </span><span class="s1">HAS_REFCOUNT</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s6">&quot;Python lacks refcounts&quot;</span><span class="s2">)</span>
<span class="s0">class </span><span class="s1">TestAssertNoGcCycles</span><span class="s2">:</span>
    <span class="s3">&quot;&quot;&quot; Test assert_no_gc_cycles &quot;&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">test_passes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">no_cycle</span><span class="s2">():</span>
            <span class="s1">b </span><span class="s2">= []</span>
            <span class="s1">b</span><span class="s2">.</span><span class="s1">append</span><span class="s2">([])</span>
            <span class="s0">return </span><span class="s1">b</span>

        <span class="s0">with </span><span class="s1">assert_no_gc_cycles</span><span class="s2">():</span>
            <span class="s1">no_cycle</span><span class="s2">()</span>

        <span class="s1">assert_no_gc_cycles</span><span class="s2">(</span><span class="s1">no_cycle</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_asserts</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">make_cycle</span><span class="s2">():</span>
            <span class="s1">a </span><span class="s2">= []</span>
            <span class="s1">a</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">a</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">a</span>

        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">assert_no_gc_cycles</span><span class="s2">():</span>
                <span class="s1">make_cycle</span><span class="s2">()</span>

        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">):</span>
            <span class="s1">assert_no_gc_cycles</span><span class="s2">(</span><span class="s1">make_cycle</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">slow</span>
    <span class="s0">def </span><span class="s1">test_fails</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot; 
        Test that in cases where the garbage cannot be collected, we raise an 
        error, instead of hanging forever trying to clear it. 
        &quot;&quot;&quot;</span>

        <span class="s0">class </span><span class="s1">ReferenceCycleInDel</span><span class="s2">:</span>
            <span class="s3">&quot;&quot;&quot; 
            An object that not only contains a reference cycle, but creates new 
            cycles whenever it's garbage-collected and its __del__ runs 
            &quot;&quot;&quot;</span>
            <span class="s1">make_cycle </span><span class="s2">= </span><span class="s0">True</span>

            <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">cycle </span><span class="s2">= </span><span class="s1">self</span>

            <span class="s0">def </span><span class="s1">__del__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
                <span class="s5"># break the current cycle so that `self` can be freed</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">cycle </span><span class="s2">= </span><span class="s0">None</span>

                <span class="s0">if </span><span class="s1">ReferenceCycleInDel</span><span class="s2">.</span><span class="s1">make_cycle</span><span class="s2">:</span>
                    <span class="s5"># but create a new one so that the garbage collector has more</span>
                    <span class="s5"># work to do.</span>
                    <span class="s1">ReferenceCycleInDel</span><span class="s2">()</span>

        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">w </span><span class="s2">= </span><span class="s1">weakref</span><span class="s2">.</span><span class="s1">ref</span><span class="s2">(</span><span class="s1">ReferenceCycleInDel</span><span class="s2">())</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">):</span>
                    <span class="s5"># this will be unable to get a baseline empty garbage</span>
                    <span class="s1">assert_no_gc_cycles</span><span class="s2">(</span><span class="s0">lambda</span><span class="s2">: </span><span class="s0">None</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">AssertionError</span><span class="s2">:</span>
                <span class="s5"># the above test is only necessary if the GC actually tried to free</span>
                <span class="s5"># our object anyway, which python 2.7 does not.</span>
                <span class="s0">if </span><span class="s1">w</span><span class="s2">() </span><span class="s0">is not None</span><span class="s2">:</span>
                    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s6">&quot;GC does not call __del__ on cyclic objects&quot;</span><span class="s2">)</span>
                    <span class="s0">raise</span>

        <span class="s0">finally</span><span class="s2">:</span>
            <span class="s5"># make sure that we stop creating reference cycles</span>
            <span class="s1">ReferenceCycleInDel</span><span class="s2">.</span><span class="s1">make_cycle </span><span class="s2">= </span><span class="s0">False</span>
</pre>
</body>
</html>